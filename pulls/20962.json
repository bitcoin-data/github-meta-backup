{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962",
    "id": 557314396,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NTU3MzE0Mzk2",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20962",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/20962.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/20962.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/b6166568a306ef41da33b5f97623d9678dd1a36c",
    "number": 20962,
    "state": "closed",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "Alter the ChaCha20Poly1305@Bitcoin AEAD to the new specification",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "During discussions and reviews of BIP324 (p2p transport encryption), a more efficient AEAD [was proposed](https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52#gistcomment-3527113).\r\n\r\nThe main difference is how the construct implements re-keying. Since both, the original and the new BIP324 AEAD will not repeat the key handshake over time (no re-keying on the ECDH level), a simpler form of *direct* re-keying has been proposed.\r\n\r\nThe new AEAD uses a ChaCha20 stream cipher where byte 4064 till byte 4096 (last 32 bytes in a 4096 window) are used to re-key the same instance. Re-keying in that context means re-setting the ChaCha20 key (thus setting the constant \"expand 32-byte k\" again, resetting the counter) to the last 32bytes of the current 4096 chunk. We never encrypt more than 4096bytes with the same key. On every re-key, we increase the IV by 1 (a sequence number).\r\nThis should allow forward secrecy in the same way as the old (and slightly cumbersome) rekeying approach.\r\n\r\nThe AEAD is currently only used in tests. The serializer and deserializer for the V2 transport are in #23233.\r\n\r\nBIP324 proposal can be found here: https://gist.github.com/dhruv/5b1275751bc98f3b64bcafce7876b489",
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "created_at": "2021-01-19T10:06:25Z",
    "updated_at": "2022-06-13T15:42:10Z",
    "closed_at": "2022-06-13T15:42:10Z",
    "mergeable_state": "unknown",
    "merge_commit_sha": "5854ef26d336e3827e5d9f971434b812d8e362c1",
    "assignee": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "assignees": [
      {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      }
    ],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "jonasschnelli:2020/12/aead_v2",
      "ref": "2020/12/aead_v2",
      "sha": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "user": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 9264454,
        "node_id": "MDEwOlJlcG9zaXRvcnk5MjY0NDU0",
        "name": "bitcoin",
        "full_name": "jonasschnelli/bitcoin",
        "owner": {
          "login": "jonasschnelli",
          "id": 178464,
          "node_id": "MDQ6VXNlcjE3ODQ2NA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/jonasschnelli",
          "html_url": "https://github.com/jonasschnelli",
          "followers_url": "https://api.github.com/users/jonasschnelli/followers",
          "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
          "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
          "repos_url": "https://api.github.com/users/jonasschnelli/repos",
          "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/jonasschnelli/bitcoin",
        "fork": true,
        "url": "https://api.github.com/repos/jonasschnelli/bitcoin",
        "archive_url": "https://api.github.com/repos/jonasschnelli/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/jonasschnelli/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/jonasschnelli/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/jonasschnelli/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/jonasschnelli/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/jonasschnelli/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/jonasschnelli/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/jonasschnelli/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/jonasschnelli/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/jonasschnelli/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/jonasschnelli/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/jonasschnelli/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/jonasschnelli/bitcoin/events",
        "forks_url": "https://api.github.com/repos/jonasschnelli/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/jonasschnelli/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/jonasschnelli/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/jonasschnelli/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/jonasschnelli/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/jonasschnelli/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/jonasschnelli/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/jonasschnelli/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/jonasschnelli/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/jonasschnelli/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/jonasschnelli/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/jonasschnelli/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/jonasschnelli/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/jonasschnelli/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/jonasschnelli/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/jonasschnelli/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:jonasschnelli/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/jonasschnelli/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/jonasschnelli/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/jonasschnelli/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/jonasschnelli/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/jonasschnelli/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/jonasschnelli/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/jonasschnelli/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/jonasschnelli/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/jonasschnelli/bitcoin/hooks",
        "svn_url": "https://github.com/jonasschnelli/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "C++",
        "forks_count": 5,
        "stargazers_count": 10,
        "watchers_count": 10,
        "size": 194164,
        "default_branch": "master",
        "open_issues_count": 5,
        "is_template": false,
        "topics": [],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2022-08-07T18:33:53Z",
        "created_at": "2013-04-06T18:21:51Z",
        "updated_at": "2023-05-19T06:34:35Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "37633d2f61697fc719390767aae740ece978b074",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 34324,
        "stargazers_count": 69819,
        "watchers_count": 69819,
        "size": 233879,
        "default_branch": "master",
        "open_issues_count": 627,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T22:42:00Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-06-07T04:47:18Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 1123,
    "deletions": 922,
    "changed_files": 20,
    "commits": 6,
    "review_comments": 61,
    "comments": 14
  },
  "events": [
    {
      "event": "labeled",
      "id": 4221721855,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQyMjE3MjE4NTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4221721855",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-19T10:06:25Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "assigned",
      "id": 4221721907,
      "node_id": "MDEzOkFzc2lnbmVkRXZlbnQ0MjIxNzIxOTA3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4221721907",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-19T10:06:26Z",
      "assignee": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "commented",
      "id": 766463849,
      "node_id": "MDEyOklzc3VlQ29tbWVudDc2NjQ2Mzg0OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766463849",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-24T23:59:36Z",
      "updated_at": "2022-05-24T08:14:12Z",
      "author_association": "MEMBER",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25172](https://github.com/bitcoin/bitcoin/pull/25172) (refactor: use std:: prefix for std lib funcs by fanquake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-766463849",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "labeled",
      "id": 4249623713,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQyNDk2MjM3MTM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4249623713",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-26T09:06:19Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4265047310,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDI2NTA0NzMxMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4265047310",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-29T08:47:35Z"
    },
    {
      "event": "commented",
      "id": 769666976,
      "node_id": "MDEyOklzc3VlQ29tbWVudDc2OTY2Njk3Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769666976",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-29T08:47:43Z",
      "updated_at": "2021-01-29T08:47:43Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased",
      "user": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-769666976",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "unlabeled",
      "id": 4265417092,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50NDI2NTQxNzA5Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4265417092",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-29T10:16:02Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 634965008,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjM0OTY1MDA4",
      "url": null,
      "actor": null,
      "commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "utACK;\r\n\r\nthis PR matches to the best of my understanding what is outlined in the BIP. \r\nI saw no significant formatting problems\r\n\r\nThat's basically where my expertise stops. However, I'm not sure that we should be using the p2p tag since this is pure crypto but https://github.com/bitcoin/bitcoin/pull/15649 had p2p tag so I guess that's okay.\r\n\r\nIs this PR waiting on some other PR / BIP change, or is the blocker here review by sipa and others?",
      "user": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-634965008",
      "submitted_at": "2021-04-13T19:45:58Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "commented",
      "id": 846598517,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg0NjU5ODUxNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846598517",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-23T17:36:26Z",
      "updated_at": "2021-05-23T17:36:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "@sipa @jonasschnelli Is there a reason why this PR has stalled?",
      "user": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-846598517",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "mentioned",
      "id": 4783563213,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NDc4MzU2MzIxMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4783563213",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-23T17:36:26Z"
    },
    {
      "event": "subscribed",
      "id": 4783563214,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQ3ODM1NjMyMTQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4783563214",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-23T17:36:26Z"
    },
    {
      "event": "mentioned",
      "id": 4783563215,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NDc4MzU2MzIxNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4783563215",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-23T17:36:26Z"
    },
    {
      "event": "subscribed",
      "id": 4783563216,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQ3ODM1NjMyMTY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4783563216",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-23T17:36:26Z"
    },
    {
      "event": "reviewed",
      "id": 693173094,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjkzMTczMDk0",
      "url": null,
      "actor": null,
      "commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Approach ACK c22f607b62af59969b9378d4cd8ed72b866dec11\r\n\r\nI reviewed the code to reconcile with the [new, accepted recommendation in BIP324](https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52#gistcomment-3599931) and ran the test.\r\n\r\nThe test vector changes are harder to review. I am happy to re-implement the AEAD in python so we can fuzz the C++ implementation against it(different language and author) if that is useful.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-693173094",
      "submitted_at": "2021-06-28T18:11:09Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "labeled",
      "id": 5178135789,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDUxNzgxMzU3ODk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5178135789",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-19T03:18:32Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5196423469,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NTE5NjQyMzQ2OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5196423469",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-23T19:29:21Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5196592722,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NTE5NjU5MjcyMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5196592722",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-23T20:05:48Z"
    },
    {
      "event": "commented",
      "id": 904108753,
      "node_id": "IC_kwDOABII584145rR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904108753",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-23T20:39:25Z",
      "updated_at": "2021-08-23T20:39:25Z",
      "author_association": "MEMBER",
      "body": "I will be taking on this PR. Rebased with master. Addressed my own comments. Ready for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-904108753",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "unlabeled",
      "id": 5197058519,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50NTE5NzA1ODUxOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5197058519",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-23T21:31:36Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 738693637,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzM4NjkzNjM3",
      "url": null,
      "actor": null,
      "commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Approach ACK.\r\nIt would be nice to remove a few redundant lines of code.",
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-738693637",
      "submitted_at": "2021-08-25T19:14:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5289630383,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAE7SVqv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5289630383",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-12T21:46:48Z"
    },
    {
      "event": "commented",
      "id": 917716402,
      "node_id": "IC_kwDOABII5842sz2y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917716402",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-12T21:48:47Z",
      "updated_at": "2021-09-12T21:48:47Z",
      "author_association": "MEMBER",
      "body": "Comments from @stratospher addressed. Ready for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-917716402",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "mentioned",
      "id": 5289631906,
      "node_id": "MEE_lADOABII584vBWqTzwAAAAE7SWCi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5289631906",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-12T21:48:48Z"
    },
    {
      "event": "subscribed",
      "id": 5289631907,
      "node_id": "SE_lADOABII584vBWqTzwAAAAE7SWCj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5289631907",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-12T21:48:48Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5438834070,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAFELgWW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5438834070",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-10T03:40:42Z"
    },
    {
      "event": "commented",
      "id": 939406631,
      "node_id": "IC_kwDOABII5843_jUn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/939406631",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-10T04:52:13Z",
      "updated_at": "2021-10-10T04:52:13Z",
      "author_association": "MEMBER",
      "body": "Addressed https://github.com/bitcoin/bitcoin/pull/23233#discussion_r725442331 - ready for further review",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-939406631",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "reviewed",
      "id": 780869719,
      "node_id": "PRR_kwDOABII584uiyBX",
      "url": null,
      "actor": null,
      "commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK 0b93e3d\r\n\r\nIt’s super awesome to see BIP 324 shaping up! This PR captures the ChaCha20Forward4064-Poly1305@Bitcoin cipher suite proposed in BIP 324 beautifully.\r\n\r\n|  | BIP 324 | PR |\r\n| --- | ----------- |----------- |\r\n| Prerequisites | <ol><li>ChaCha20 PRF</li><li>Poly1305 MAC</li><li>ChaCha20Forward4064-Poly1305@Bitcoin cipher suite</li><li>2 separate instances of ChaCha20Forward4064 DRBG using keys k1 and k2 called F and V respectively.</li></ol>| Defined in: <ol><li>chacha20.h</li><li>poly1305.h</li><li>chacha_poly_aead.h</li><li>F is [m_chacha_header](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/crypto/chacha_poly_aead.h#L119) and V is [m_chacha_main](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/crypto/chacha_poly_aead.h#L120)</li></ol>|\r\n| Encryption | ![1](https://user-images.githubusercontent.com/44024636/137513924-0c9cbea1-4ff2-420d-97fd-118c42f91f62.png) | [Crypt()](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/crypto/chacha_poly_aead.h#L136) is in line with the BIP's specifications.|\r\n| Decryption |![2](https://user-images.githubusercontent.com/44024636/137514021-9dd9f701-1c91-4e9e-9e2d-a10c1c232521.png)| [Crypt()](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/crypto/chacha_poly_aead.h#L136) handles both encryption and decryption.|\r\n\r\nI noticed some more refactoring which could be done.",
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-780869719",
      "submitted_at": "2021-10-15T15:41:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "labeled",
      "id": 5501064154,
      "node_id": "LE_lADOABII584vBWqTzwAAAAFH45Pa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5501064154",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-21T20:42:21Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5506435162,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAFINYha",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5506435162",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-22T18:09:17Z"
    },
    {
      "event": "commented",
      "id": 949861062,
      "node_id": "IC_kwDOABII5844nbrG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/949861062",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-22T18:15:22Z",
      "updated_at": "2021-10-22T18:15:22Z",
      "author_association": "MEMBER",
      "body": "Thank you for the great diagrams, @stratospher ! They'll come in handy at a future review club meeting and in docs.\r\n\r\nReview comments addressed. Rebased. Ready for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-949861062",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "mentioned",
      "id": 5506461560,
      "node_id": "MEE_lADOABII584vBWqTzwAAAAFINe94",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5506461560",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-22T18:15:22Z"
    },
    {
      "event": "subscribed",
      "id": 5506461563,
      "node_id": "SE_lADOABII584vBWqTzwAAAAFINe97",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5506461563",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-22T18:15:22Z"
    },
    {
      "event": "unlabeled",
      "id": 5506867219,
      "node_id": "UNLE_lADOABII584vBWqTzwAAAAFIPCAT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5506867219",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-10-22T19:54:55Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 787368071,
      "node_id": "PRR_kwDOABII584u7kiH",
      "url": null,
      "actor": null,
      "commit_id": "380b137556b5b14ba9de45db850cfdbd1c43991d",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "0xB10C",
        "id": 19157360,
        "node_id": "MDQ6VXNlcjE5MTU3MzYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/19157360?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/0xB10C",
        "html_url": "https://github.com/0xB10C",
        "followers_url": "https://api.github.com/users/0xB10C/followers",
        "following_url": "https://api.github.com/users/0xB10C/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/0xB10C/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/0xB10C/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/0xB10C/subscriptions",
        "organizations_url": "https://api.github.com/users/0xB10C/orgs",
        "repos_url": "https://api.github.com/users/0xB10C/repos",
        "events_url": "https://api.github.com/users/0xB10C/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/0xB10C/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-787368071",
      "submitted_at": "2021-10-23T07:31:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5570633912,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAFMCSC4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5570633912",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-11-04T19:34:35Z"
    },
    {
      "event": "commented",
      "id": 961356337,
      "node_id": "IC_kwDOABII5845TSIx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961356337",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-11-04T19:35:15Z",
      "updated_at": "2021-11-04T19:35:28Z",
      "author_association": "MEMBER",
      "body": "Addressed comments. Rebased against master to get the changes from #22735 which are needed to bring them into #23233 (downstream of this PR branch). Ready for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-961356337",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "reviewed",
      "id": 799468594,
      "node_id": "PRR_kwDOABII584vpuwy",
      "url": null,
      "actor": null,
      "commit_id": "6a651b5352e7444ad55e04e2738d241f8ef72518",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "",
      "user": {
        "login": "ryihan",
        "id": 54474184,
        "node_id": "MDQ6VXNlcjU0NDc0MTg0",
        "avatar_url": "https://avatars.githubusercontent.com/u/54474184?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryihan",
        "html_url": "https://github.com/ryihan",
        "followers_url": "https://api.github.com/users/ryihan/followers",
        "following_url": "https://api.github.com/users/ryihan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryihan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryihan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryihan/subscriptions",
        "organizations_url": "https://api.github.com/users/ryihan/orgs",
        "repos_url": "https://api.github.com/users/ryihan/repos",
        "events_url": "https://api.github.com/users/ryihan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryihan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-799468594",
      "submitted_at": "2021-11-06T18:59:25Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5929637393,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAFhbxYR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5929637393",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-01-21T04:39:52Z"
    },
    {
      "event": "commented",
      "id": 1018176974,
      "node_id": "IC_kwDOABII5848sCXO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1018176974",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-01-21T04:46:59Z",
      "updated_at": "2022-01-21T04:46:59Z",
      "author_association": "MEMBER",
      "body": "Addressed some comments for this PR left over at #23233 by @laanwj:\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/23233#discussion_r771579687\r\nhttps://github.com/bitcoin/bitcoin/pull/23233#discussion_r771538159\r\n\r\nI also rebased against master because at one point I had trouble running fuzz tests(but it turned out to be unrelated).\r\n\r\nReady for further review.\r\n",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1018176974",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "mentioned",
      "id": 5929659648,
      "node_id": "MEE_lADOABII584vBWqTzwAAAAFhb20A",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5929659648",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-01-21T04:46:59Z"
    },
    {
      "event": "subscribed",
      "id": 5929659652,
      "node_id": "SE_lADOABII584vBWqTzwAAAAFhb20E",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5929659652",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-01-21T04:46:59Z"
    },
    {
      "event": "labeled",
      "id": 5978767249,
      "node_id": "LE_lADOABII584vBWqTzwAAAAFkXL-R",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5978767249",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-01-31T08:08:22Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 5992697793,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAFlMU_B",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5992697793",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-02T02:50:03Z"
    },
    {
      "event": "commented",
      "id": 1027525478,
      "node_id": "IC_kwDOABII5849Pstm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027525478",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-02T02:50:12Z",
      "updated_at": "2022-02-02T02:51:40Z",
      "author_association": "MEMBER",
      "body": "Rebased. Ready for further review.\r\n\r\n`git range-diff 02e1d8d06f 41deee4 8b474d1`",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1027525478",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "unlabeled",
      "id": 5993051689,
      "node_id": "UNLE_lADOABII584vBWqTzwAAAAFlNrYp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5993051689",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-02T04:25:56Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1058157143,
      "node_id": "IC_kwDOABII584_EjJX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1058157143",
      "actor": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-03T15:28:19Z",
      "updated_at": "2022-03-03T15:28:19Z",
      "author_association": "MEMBER",
      "body": "Concept ACK, will review soon.",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1058157143",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 6278532835,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAF2Os7j",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6278532835",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-21T20:08:19Z"
    },
    {
      "event": "commented",
      "id": 1074367550,
      "node_id": "IC_kwDOABII585ACYw-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1074367550",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-21T20:12:08Z",
      "updated_at": "2022-03-21T22:04:03Z",
      "author_association": "MEMBER",
      "body": "Thanks to @stratospher for finding a bug in the test code. We were using `WriteLE32` to write the 3 byte header plaintext _after_ the payload. This was overwriting the first byte in the payload.\r\n\r\n`git range-diff 91d12344b 8b474d1 97b768f`\r\n\r\nReady for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1074367550",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "mentioned",
      "id": 6278555392,
      "node_id": "MEE_lADOABII584vBWqTzwAAAAF2OycA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6278555392",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-21T20:12:08Z"
    },
    {
      "event": "subscribed",
      "id": 6278555395,
      "node_id": "SE_lADOABII584vBWqTzwAAAAF2OycD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6278555395",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-21T20:12:08Z"
    },
    {
      "event": "added_to_project",
      "id": 6310085239,
      "node_id": "ATPE_lADOABII584vBWqTzwAAAAF4HEJ3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6310085239",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-03-25T21:16:23Z",
      "project_card": {
        "id": 79693737,
        "url": "https://api.github.com/projects/columns/cards/79693737",
        "project_id": 13452186,
        "project_url": "https://api.github.com/projects/13452186",
        "column_name": "Needs review"
      }
    },
    {
      "event": "reviewed",
      "id": 993416434,
      "node_id": "PRR_kwDOABII5847NlTy",
      "url": null,
      "actor": null,
      "commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-993416434",
      "submitted_at": "2022-06-02T11:52:18Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "reviewed",
      "id": 993432468,
      "node_id": "PRR_kwDOABII5847NpOU",
      "url": null,
      "actor": null,
      "commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-993432468",
      "submitted_at": "2022-06-02T12:06:30Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "reviewed",
      "id": 993435603,
      "node_id": "PRR_kwDOABII5847Np_T",
      "url": null,
      "actor": null,
      "commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-993435603",
      "submitted_at": "2022-06-02T12:09:10Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "reviewed",
      "id": 993439660,
      "node_id": "PRR_kwDOABII5847Nq-s",
      "url": null,
      "actor": null,
      "commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#pullrequestreview-993439660",
      "submitted_at": "2022-06-02T12:12:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ2N2NhY2M4ZjFmNTVkYmM2YWYwOTUzOWUwOTI3ODQ2MmNmYjE1ZjM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/467cacc8f1f55dbc6af09539e09278462cfb15f3",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/467cacc8f1f55dbc6af09539e09278462cfb15f3",
      "tree": {
        "sha": "205ba2f83c4bc1ac722f042eca9ecabeec23471d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/205ba2f83c4bc1ac722f042eca9ecabeec23471d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/37633d2f61697fc719390767aae740ece978b074",
          "sha": "37633d2f61697fc719390767aae740ece978b074",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/37633d2f61697fc719390767aae740ece978b074"
        }
      ],
      "message": "Reduce wasted pseudorandom bytes in ChaCha20",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T21:54:50Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T19:51:27Z"
      },
      "sha": "467cacc8f1f55dbc6af09539e09278462cfb15f3"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGMxYTMwM2MyODEzZmEwMTY1ZDRhYTg2YTkyYjI1YWUyYTc1YzE4NGI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1a303c2813fa0165d4aa86a92b25ae2a75c184b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c1a303c2813fa0165d4aa86a92b25ae2a75c184b",
      "tree": {
        "sha": "685bc9009e90e8a4974df6ecfe9e62e170440e16",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/685bc9009e90e8a4974df6ecfe9e62e170440e16"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/467cacc8f1f55dbc6af09539e09278462cfb15f3",
          "sha": "467cacc8f1f55dbc6af09539e09278462cfb15f3",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/467cacc8f1f55dbc6af09539e09278462cfb15f3"
        }
      ],
      "message": "RFC8439 nonce and counter for ChaCha20",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T21:55:52Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-05-10T22:34:37Z"
      },
      "sha": "c1a303c2813fa0165d4aa86a92b25ae2a75c184b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQ2MzRiOTlhMGE2YjllZjJmMmUxZWNkNzM3MjFkMjExNGRkZDQ0NjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465",
      "tree": {
        "sha": "37f5aac894659c168d4922e354537eca75c82b81",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/37f5aac894659c168d4922e354537eca75c82b81"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1a303c2813fa0165d4aa86a92b25ae2a75c184b",
          "sha": "c1a303c2813fa0165d4aa86a92b25ae2a75c184b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c1a303c2813fa0165d4aa86a92b25ae2a75c184b"
        }
      ],
      "message": "RFC8439 implementation and tests",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T21:55:52Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-09T21:59:28Z"
      },
      "sha": "d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGFiYTRmODcwMTJjMmNhZmE2MjY1Y2ZhMWI5ZTNhZWQxZTgxY2NjOWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b",
      "tree": {
        "sha": "38ba9da6591131511921d1938842f20a321b44bd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/38ba9da6591131511921d1938842f20a321b44bd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465",
          "sha": "d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d634b99a0a6b9ef2f2e1ecd73721d2114ddd4465"
        }
      ],
      "message": "Adding forward secure FSChaCha20",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T21:55:52Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-09T22:00:55Z"
      },
      "sha": "aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGFhZjUxNjY4MmNjNmJjYTc0ZmNkZTU4OWNmMGEwNzJkODgxMGIwOTY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aaf516682cc6bca74fcde589cf0a072d8810b096",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/aaf516682cc6bca74fcde589cf0a072d8810b096",
      "tree": {
        "sha": "0614ae5f3f9402e56da492ad754837910f1aec39",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0614ae5f3f9402e56da492ad754837910f1aec39"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b",
          "sha": "aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/aba4f87012c2cafa6265cfa1b9e3aed1e81ccc9b"
        }
      ],
      "message": "BIP324 Cipher Suite",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-13T03:49:43Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-01-06T08:48:08Z"
      },
      "sha": "aaf516682cc6bca74fcde589cf0a072d8810b096"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI2MTY2NTY4YTMwNmVmNDFkYTMzYjVmOTc2MjNkOTY3OGRkMWEzNmM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6166568a306ef41da33b5f97623d9678dd1a36c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b6166568a306ef41da33b5f97623d9678dd1a36c",
      "tree": {
        "sha": "718b21563b04cc3c4e8868a463a535577692f502",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/718b21563b04cc3c4e8868a463a535577692f502"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aaf516682cc6bca74fcde589cf0a072d8810b096",
          "sha": "aaf516682cc6bca74fcde589cf0a072d8810b096",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/aaf516682cc6bca74fcde589cf0a072d8810b096"
        }
      ],
      "message": "RFC8439Encrypt can take multiple plaintexts",
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-13T03:49:45Z"
      },
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2022-06-12T21:09:24Z"
      },
      "sha": "b6166568a306ef41da33b5f97623d9678dd1a36c"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 6792752317,
      "node_id": "HRFPE_lADOABII584vBWqTzwAAAAGU4Sy9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6792752317",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-13T03:50:37Z"
    },
    {
      "event": "commented",
      "id": 1153434783,
      "node_id": "IC_kwDOABII585EwASf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1153434783",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-13T03:53:10Z",
      "updated_at": "2022-06-13T04:00:03Z",
      "author_association": "MEMBER",
      "body": "First commit is from #25354 and should be reviewed there. This PR just depends on it.\r\n\r\nUpdated the implementation of the BIP324 Cipher Suite to be in accordance with the latest draft in the working group(still pending public release). The changes to intent and code from the original PR are large and since I didn't originally open this PR, I can't change the PR description. I suspect it makes sense to close this PR and open a new one, but we'd lose the history. I'd welcome thoughts on that from reviewers and maintainers.\r\n\r\nReady for further review.",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1153434783",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "commented",
      "id": 1154082386,
      "node_id": "IC_kwDOABII585EyeZS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1154082386",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-13T15:42:09Z",
      "updated_at": "2022-06-13T15:42:09Z",
      "author_association": "MEMBER",
      "body": "Superseded by #25361 because:\r\n- I'd like to keep the PR description up to date myself\r\n- The code and the purpose of the PR have deviated significantly",
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-1154082386",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20962"
    },
    {
      "event": "closed",
      "id": 6797245599,
      "node_id": "CE_lADOABII584vBWqTzwAAAAGVJbyf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6797245599",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-13T15:42:10Z"
    },
    {
      "event": "moved_columns_in_project",
      "id": 6797880293,
      "node_id": "MCIPE_lADOABII584vBWqTzwAAAAGVL2vl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6797880293",
      "actor": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-13T17:16:08Z",
      "project_card": {
        "id": 79693737,
        "url": "https://api.github.com/projects/columns/cards/79693737",
        "project_id": 13452186,
        "project_url": "https://api.github.com/projects/13452186",
        "column_name": "Closed unmerged (Superseded)",
        "previous_column_name": "Needs review"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659021347",
      "pull_request_review_id": 693173094,
      "id": 659021347,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTAyMTM0Nw==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 125,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Should this be `K_2`?",
      "created_at": "2021-06-25T20:32:30Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659021347",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659021347"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 76,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659066917",
      "pull_request_review_id": 693173094,
      "id": 659066917,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTA2NjkxNw==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n \n-    /** decrypts the 3 bytes AAD data and decodes it into a uint32_t field */\n-    bool GetLength(uint32_t* len24_out, uint64_t seqnr_aad, int aad_pos, const uint8_t* ciphertext);\n+    /** decrypts the 3 bytes AAD data (the packet length) and decodes it into a uint32_t field\n+        the ciphertext will not be manipulated but the AEAD state changes (can't be called multiple times)",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 195,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "(nit): \"AEAD state changes (can't be called multiple times)\" -> \"AAD keystream will advance. As a result, DecryptLength() cannot be called multiple times to get the same result. The caller must cache the result for re-use.\"",
      "created_at": "2021-06-25T22:29:19Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659066917",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659066917"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659072624",
      "pull_request_review_id": 693173094,
      "id": 659072624,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTA3MjYyNA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 190,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `[[nodiscard]]` ?\r\n\r\nAlso, can we add to the comments: \"Returns true if encipher succeeds. Upon failure, the data at `dest` should not be used\"",
      "created_at": "2021-06-25T22:49:13Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659072624",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659072624"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 133,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659072639",
      "pull_request_review_id": 693173094,
      "id": 659072639,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTA3MjYzOQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n \n-    /** decrypts the 3 bytes AAD data and decodes it into a uint32_t field */\n-    bool GetLength(uint32_t* len24_out, uint64_t seqnr_aad, int aad_pos, const uint8_t* ciphertext);\n+    /** decrypts the 3 bytes AAD data (the packet length) and decodes it into a uint32_t field\n+        the ciphertext will not be manipulated but the AEAD state changes (can't be called multiple times)\n+        Ciphertext needs to stay encrypted due to the MAC check that will follow (requires encrypted length)\n+        */\n+    bool DecryptLength(uint32_t* len24_out, const uint8_t* ciphertext);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 198,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Could this function signature be `[[nodiscard]] uint32_t DecryptLength(const uint8_t* ciphertext)` ? I'm curious why we return value using the pointer argument ?",
      "created_at": "2021-06-25T22:49:19Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659072639",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659072639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 139,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659089284",
      "pull_request_review_id": 693173094,
      "id": 659089284,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTA4OTI4NA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 160,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Would it make sense for this to be done in a constructor since this class implements re-keying internally and ideally, the user should not call this function more than once on an instance?",
      "created_at": "2021-06-26T00:07:58Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659089284",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659089284"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 111,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659123550",
      "pull_request_review_id": 693173094,
      "id": 659123550,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTEyMzU1MA==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "To make sure I am understanding this correctly (did try it in godbolt): \r\n\r\n`ReadLE32(&m_keystream[m_keystream_pos])` will interpret 4 bytes starting at `m_keystream_pos` as a little endian encoded `uint32_t`. This means the LSB of the `uint32_t` will be the byte at `m_keystream[m_keystream_pos]`. The XOR with unsigned char will only use this LSB. Perhaps this was done for batching but not needed right now?\r\n\r\nI applied the patch below and `crypto_tests/chacha20_poly1305_aead_testvector` passed.\r\n\r\n```diff\r\ndiff --git a/src/crypto/chacha_poly_aead.cpp b/src/crypto/chacha_poly_aead.cpp\r\nindex bf261df55..139168fd7 100644\r\n--- a/src/crypto/chacha_poly_aead.cpp\r\n+++ b/src/crypto/chacha_poly_aead.cpp\r\n@@ -46,8 +46,7 @@ void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output,\r\n \r\n     // TODO: speedup with a block approach (rather then looping over every byte)\r\n     while (bytes > message_pos) {\r\n-        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\r\n-        m_keystream_pos++;\r\n+        output[message_pos] = input[message_pos] ^ m_keystream[m_keystream_pos++];\r\n         message_pos++;\r\n         if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\r\n             // we reached the end of the keystream\r\n```",
      "created_at": "2021-06-26T05:40:07Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659123550",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659123550"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659123909",
      "pull_request_review_id": 693173094,
      "id": 659123909,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTEyMzkwOQ==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Could we leave a comment here that `SetKey()` also sets the counter and IV to zero?",
      "created_at": "2021-06-26T05:44:24Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659123909",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659123909"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 53,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659124563",
      "pull_request_review_id": 693173094,
      "id": 659124563,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTEyNDU2Mw==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n+\n+ChaCha20ReKey4096::~ChaCha20ReKey4096() {\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n+\n ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n {\n     assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_main.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_header.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-\n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n }\n \n-bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)\n+bool ChaCha20Poly1305AEAD::Crypt(unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 62,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Would it be useful to completely hide the details of the encrypted length from the user of this class? \r\n\r\nThat way, for encryption:\r\n`src=plaintext; dest=encrypted length + ciphertext + MAC`\r\n\r\nfor decryption:\r\n`src=encrypted length + ciphertext + MAC; dest=plaintext`\r\n\r\nThis would:\r\n- Eliminate the awkwardness around the user of this class accidentally calling `DecryptLength` multiple times.\r\n- Eliminate the possibility that the user of this class forgets to terminate the connection if the decrypted length does not match the length of the payload.\r\n\r\nOr perhaps I am missing a reason the user of the class might need to know the decrypted length.",
      "created_at": "2021-06-26T05:51:55Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659124563",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659124563"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659125693",
      "pull_request_review_id": 693173094,
      "id": 659125693,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTEyNTY5Mw==",
      "diff_hunk": "@@ -52,18 +86,24 @@ bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int\n \n     unsigned char expected_tag[POLY1305_TAGLEN], poly_key[POLY1305_KEYLEN];\n     memset(poly_key, 0, sizeof(poly_key));\n-    m_chacha_main.SetIV(seqnr_payload);\n \n-    // block counter 0 for the poly1305 key\n-    // use lower 32bytes for the poly1305 key\n-    // (throws away 32 unused bytes (upper 32) from this ChaCha20 round)\n-    m_chacha_main.Seek(0);\n-    m_chacha_main.Crypt(poly_key, poly_key, sizeof(poly_key));\n+    // 1. AAD (the encrypted packet length), use the header-keystream\n+    if (is_encrypt) {\n+        m_chacha_header.Crypt(src, dest, 3);\n+    } else {\n+        // we must use ChaCha20Poly1305AEAD::DecryptLength before calling ChaCha20Poly1305AEAD::Crypt\n+        // thus the length has already been encrypted, avoid doing it again and messing up the keystream position",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "should this be \"the length has already been decrypted\"?",
      "created_at": "2021-06-26T06:01:59Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659125693",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659125693"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 95,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659179980",
      "pull_request_review_id": 693173094,
      "id": 659179980,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE3OTk4MA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 109,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "(nit): \"IV of 0 and a block counter of 0 and a sequence number 0 as IV\" -> \"sequence number 0 as IV and a block counter of 0\"",
      "created_at": "2021-06-26T15:22:14Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659179980",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659179980"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 60,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659180419",
      "pull_request_review_id": 693173094,
      "id": 659180419,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE4MDQxOQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 133,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In #18242, I see that the bytes are accessible as a `Span` and `Span::size()` seems available. Would it be useful to say something like: \"If the decrypted length does not match the payload length, the connection MUST be immediately terminated?\" \r\n\r\nAt first I thought that is implicitly delegated to the MAC, but we don't seem to confirm that the length is correct when encrypting either.",
      "created_at": "2021-06-26T15:27:30Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659180419",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659180419"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 81,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659180737",
      "pull_request_review_id": 693173094,
      "id": 659180737,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE4MDczNw==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 147,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "(nit): \"Finally, calculate a MAC tag and append it.\" -> \"Finally, calculate a MAC tag(using poly1305 key from stream keyed with K_1) and append it.\"",
      "created_at": "2021-06-26T15:30:22Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659180737",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659180737"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 98,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659181005",
      "pull_request_review_id": 693173094,
      "id": 659181005,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE4MTAwNQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 139,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "should \"(with K_2, the packet sequence number as nonce and a starting block counter of 1)\" now be just \"(using stream keyed with K_2)\"? IIUC, the block counter could be anything in `[0, 7]` (since 8 * 512 = 4096), right?",
      "created_at": "2021-06-26T15:32:54Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r659181005",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659181005"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660004965",
      "pull_request_review_id": 693173094,
      "id": 660004965,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDAwNDk2NQ==",
      "diff_hunk": "@@ -629,56 +616,27 @@ static void TestChaCha20Poly1305AEAD(bool must_succeed, unsigned int expected_aa\n     BOOST_CHECK_EQUAL(expected_ciphertext_and_mac.size(), ciphertext_buf.size());\n     BOOST_CHECK(memcmp(ciphertext_buf.data(), expected_ciphertext_and_mac.data(), ciphertext_buf.size()) == 0);\n \n-    // manually construct the AAD keystream\n-    cmp_ctx.SetIV(seqnr_aad);\n-    cmp_ctx.Seek(0);\n-    cmp_ctx.Keystream(cmp_ctx_buffer.data(), 64);\n-    BOOST_CHECK(memcmp(expected_aad_keystream.data(), cmp_ctx_buffer.data(), expected_aad_keystream.size()) == 0);\n-    // crypt the 3 length bytes and compare the length\n-    uint32_t len_cmp = 0;\n-    len_cmp = (ciphertext_buf[0] ^ cmp_ctx_buffer[aad_pos + 0]) |\n-              (ciphertext_buf[1] ^ cmp_ctx_buffer[aad_pos + 1]) << 8 |\n-              (ciphertext_buf[2] ^ cmp_ctx_buffer[aad_pos + 2]) << 16;\n-    BOOST_CHECK_EQUAL(len_cmp, expected_aad_length);\n-\n-    // encrypt / decrypt 1000 packets\n+    BOOST_CHECK(aead_in.DecryptLength(&out_len, ciphertext_buf.data()));",
      "path": "src/test/crypto_tests.cpp",
      "position": null,
      "original_position": 59,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": null,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This line implies that the decrypted length is len(AAD) + len(payload). I interpreted, [this](https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52#v2-messages-structure) to mean that the decrypted length is the length of the ciphertext of the payload alone.\r\n\r\nIf this is intentional, can we make it clearer in the BIP? IIUC, typically, in other protocols, the length in the preamble is the length of the payload that follows. Did we want to do it that way?",
      "created_at": "2021-06-28T18:01:16Z",
      "updated_at": "2021-06-28T18:11:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r660004965",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660004965"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 619,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694251569",
      "pull_request_review_id": 736492544,
      "id": 694251569,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1MTU2OQ==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659123909,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:32:06Z",
      "updated_at": "2021-08-23T19:32:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694251569",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694251569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 53,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694252767",
      "pull_request_review_id": 736494013,
      "id": 694252767,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1Mjc2Nw==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n+\n+ChaCha20ReKey4096::~ChaCha20ReKey4096() {\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n+\n ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n {\n     assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_main.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_header.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-\n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n }\n \n-bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)\n+bool ChaCha20Poly1305AEAD::Crypt(unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 62,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659124563,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Or perhaps I am missing a reason the user of the class might need to know the decrypted length.\r\n\r\nI was missing the reason: Tried to do this and realized that the interface for `TransportDeserializer` actually requires the client of this class to be aware of the length because the bytes come in as a stream. ",
      "created_at": "2021-08-23T19:33:59Z",
      "updated_at": "2021-08-23T19:33:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694252767",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694252767"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255045",
      "pull_request_review_id": 736496703,
      "id": 694255045,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NTA0NQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 133,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659180419,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thinking through this more, I realized that:\r\n- Sender errors in encrypted length cannot be corrected since the bytes for multiple p2p messages are in a single TCP stream. Such sender errors are protocol errors.\r\n- MITM errors/attacks will be caught by the MAC check.\r\n",
      "created_at": "2021-08-23T19:37:20Z",
      "updated_at": "2021-08-23T19:37:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694255045",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255045"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 81,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255584",
      "pull_request_review_id": 736497369,
      "id": 694255584,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NTU4NA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 125,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659021347,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:38:14Z",
      "updated_at": "2021-08-23T19:38:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694255584",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255584"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 76,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255829",
      "pull_request_review_id": 736497647,
      "id": 694255829,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NTgyOQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n \n-    /** decrypts the 3 bytes AAD data and decodes it into a uint32_t field */\n-    bool GetLength(uint32_t* len24_out, uint64_t seqnr_aad, int aad_pos, const uint8_t* ciphertext);\n+    /** decrypts the 3 bytes AAD data (the packet length) and decodes it into a uint32_t field\n+        the ciphertext will not be manipulated but the AEAD state changes (can't be called multiple times)",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 195,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659066917,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:38:37Z",
      "updated_at": "2021-08-23T19:38:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694255829",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255914",
      "pull_request_review_id": 736497751,
      "id": 694255914,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NTkxNA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 190,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659072624,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:38:45Z",
      "updated_at": "2021-08-23T19:38:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694255914",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255914"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 133,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255961",
      "pull_request_review_id": 736497826,
      "id": 694255961,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NTk2MQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n \n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20ReKey4096 m_chacha_main;                                      // payload and poly1305 key-derivation cipher instance\n+    ChaCha20ReKey4096 m_chacha_header;                                    // AAD cipher instance (encrypted length)\n \n public:\n     ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n         */\n-    bool Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n+    bool Crypt(unsigned char* dest, size_t dest_len, const unsigned char* src, size_t src_len, bool is_encrypt);\n \n-    /** decrypts the 3 bytes AAD data and decodes it into a uint32_t field */\n-    bool GetLength(uint32_t* len24_out, uint64_t seqnr_aad, int aad_pos, const uint8_t* ciphertext);\n+    /** decrypts the 3 bytes AAD data (the packet length) and decodes it into a uint32_t field\n+        the ciphertext will not be manipulated but the AEAD state changes (can't be called multiple times)\n+        Ciphertext needs to stay encrypted due to the MAC check that will follow (requires encrypted length)\n+        */\n+    bool DecryptLength(uint32_t* len24_out, const uint8_t* ciphertext);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 198,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659072639,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:38:52Z",
      "updated_at": "2021-08-23T19:38:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694255961",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694255961"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 139,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256303",
      "pull_request_review_id": 736498251,
      "id": 694256303,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NjMwMw==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.\n+*/\n+\n+const int KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20ReKey4096 {\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+public:\n+    ~ChaCha20ReKey4096();\n+    void SetKey(const unsigned char* key, size_t keylen);",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 160,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659089284,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:39:27Z",
      "updated_at": "2021-08-23T19:39:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694256303",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256303"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 111,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256461",
      "pull_request_review_id": 736498448,
      "id": 694256461,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NjQ2MQ==",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659123550,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:39:44Z",
      "updated_at": "2021-08-23T19:39:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694256461",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256461"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256688",
      "pull_request_review_id": 736498726,
      "id": 694256688,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NjY4OA==",
      "diff_hunk": "@@ -52,18 +86,24 @@ bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int\n \n     unsigned char expected_tag[POLY1305_TAGLEN], poly_key[POLY1305_KEYLEN];\n     memset(poly_key, 0, sizeof(poly_key));\n-    m_chacha_main.SetIV(seqnr_payload);\n \n-    // block counter 0 for the poly1305 key\n-    // use lower 32bytes for the poly1305 key\n-    // (throws away 32 unused bytes (upper 32) from this ChaCha20 round)\n-    m_chacha_main.Seek(0);\n-    m_chacha_main.Crypt(poly_key, poly_key, sizeof(poly_key));\n+    // 1. AAD (the encrypted packet length), use the header-keystream\n+    if (is_encrypt) {\n+        m_chacha_header.Crypt(src, dest, 3);\n+    } else {\n+        // we must use ChaCha20Poly1305AEAD::DecryptLength before calling ChaCha20Poly1305AEAD::Crypt\n+        // thus the length has already been encrypted, avoid doing it again and messing up the keystream position",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659125693,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:40:06Z",
      "updated_at": "2021-08-23T19:40:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694256688",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256688"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 95,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256838",
      "pull_request_review_id": 736498917,
      "id": 694256838,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NjgzOA==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 109,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659179980,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:40:21Z",
      "updated_at": "2021-08-23T19:40:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694256838",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694256838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 60,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694257137",
      "pull_request_review_id": 736499289,
      "id": 694257137,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NzEzNw==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as\n+* nonce and a starting block counter of 1).\n+*\n+* Detection of an invalid MAC MUST lead to immediate connection termination.\n+*\n+* To send a packet, first encode the 3 byte length and encrypt it using the\n+* ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+* (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+* length. Finally, calculate a MAC tag and append it.",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 147,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659180737,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:40:52Z",
      "updated_at": "2021-08-23T19:40:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694257137",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694257137"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 98,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694257391",
      "pull_request_review_id": 736499604,
      "id": 694257391,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1NzM5MQ==",
      "diff_hunk": "@@ -36,111 +37,106 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)\n+*\n+* The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+* keyed with K_1 and K_2 and IV of 0 and a block counter of 0 and a sequence\n+* number 0 as IV. After encrypting 4064 bytes, the following 32 bytes are used to\n+* re-key the ChaCha20 context.\n+*\n+* Byte-level forward security is possible by precomputing 4096 bytes of stream\n+* output, caching it, resetting the key to the final 32 bytes of the output, and\n+* then wiping the remaining 4064 bytes of cached data as it gets used.\n+*\n+* For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+* K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+* generate a Poly1305 key.\n+*\n+* If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+* 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+* incrementing the sequence number + 1 and set is as IV (little endian encoding).\n+*\n+* For the payload, use the ChaCha20 stream keyed with K_1 and apply the same\n+* re-key rules.\n+*\n+*\n+* ==== Packet Handling ====\n+*\n+* When receiving a packet, the length must be decrypted first. When 3 bytes of\n+* ciphertext length have been received, they MUST be decrypted.\n+*\n+* Once the entire packet has been received, the MAC MUST be checked before\n+* decryption. A per-packet Poly1305 key is generated as described above and the\n+* MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n+* packet length and the payload together. The calculated MAC is then compared in\n+* constant time with the one appended to the packet and the packet decrypted\n+* using ChaCha20 as described above (with K_2, the packet sequence number as",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 139,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659181005,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-08-23T19:41:18Z",
      "updated_at": "2021-08-23T19:41:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694257391",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694257391"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694258297",
      "pull_request_review_id": 736500815,
      "id": 694258297,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI1ODI5Nw==",
      "diff_hunk": "@@ -629,56 +616,27 @@ static void TestChaCha20Poly1305AEAD(bool must_succeed, unsigned int expected_aa\n     BOOST_CHECK_EQUAL(expected_ciphertext_and_mac.size(), ciphertext_buf.size());\n     BOOST_CHECK(memcmp(ciphertext_buf.data(), expected_ciphertext_and_mac.data(), ciphertext_buf.size()) == 0);\n \n-    // manually construct the AAD keystream\n-    cmp_ctx.SetIV(seqnr_aad);\n-    cmp_ctx.Seek(0);\n-    cmp_ctx.Keystream(cmp_ctx_buffer.data(), 64);\n-    BOOST_CHECK(memcmp(expected_aad_keystream.data(), cmp_ctx_buffer.data(), expected_aad_keystream.size()) == 0);\n-    // crypt the 3 length bytes and compare the length\n-    uint32_t len_cmp = 0;\n-    len_cmp = (ciphertext_buf[0] ^ cmp_ctx_buffer[aad_pos + 0]) |\n-              (ciphertext_buf[1] ^ cmp_ctx_buffer[aad_pos + 1]) << 8 |\n-              (ciphertext_buf[2] ^ cmp_ctx_buffer[aad_pos + 2]) << 16;\n-    BOOST_CHECK_EQUAL(len_cmp, expected_aad_length);\n-\n-    // encrypt / decrypt 1000 packets\n+    BOOST_CHECK(aead_in.DecryptLength(&out_len, ciphertext_buf.data()));",
      "path": "src/test/crypto_tests.cpp",
      "position": null,
      "original_position": 59,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 660004965,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The BIP, the unit test and the bench test have been updated to be consistently clear that the encrypted length is `len(ciphertext_payload)` and not `len(ciphertext_payload + ciphertext_aad)`",
      "created_at": "2021-08-23T19:42:54Z",
      "updated_at": "2021-08-23T19:42:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r694258297",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694258297"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 619,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696008360",
      "pull_request_review_id": 738693637,
      "id": 696008360,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjAwODM2MA==",
      "diff_hunk": "@@ -6,6 +6,7 @@\n #define BITCOIN_CRYPTO_CHACHA_POLY_AEAD_H\n \n #include <crypto/chacha20.h>\n+#include <crypto/poly1305.h>\n \n #include <cmath>\n ",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 7,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`AAD_PACKAGES_PER_ROUND` is defined but not used anywhere. Couldn't we remove it?",
      "created_at": "2021-08-25T18:23:49Z",
      "updated_at": "2021-08-25T19:14:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r696008360",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696008360"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 11,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696015556",
      "pull_request_review_id": 738693637,
      "id": 696015556,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjAxNTU1Ng==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Since we're already initialising `m_seqnr` with 0 in the class definition of `ChaCha20Forward4064`, https://github.com/bitcoin/bitcoin/blob/424e0100fbea0ac8106b25a9b23698f2c2cd7a4f/src/crypto/chacha_poly_aead.h#L107  Couldn't we remove this line from the constructor?",
      "created_at": "2021-08-25T18:33:58Z",
      "updated_at": "2021-08-25T19:14:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r696015556",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696015556"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696016509",
      "pull_request_review_id": 738693637,
      "id": 696016509,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjAxNjUwOQ==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Since we're already initialising `m_keystream_pos` with 0 in the class definition of `ChaCha20Forward4064`, https://github.com/bitcoin/bitcoin/blob/424e0100fbea0ac8106b25a9b23698f2c2cd7a4f/src/crypto/chacha_poly_aead.h#L108 Couldn't we remove this line from the constructor?",
      "created_at": "2021-08-25T18:35:28Z",
      "updated_at": "2021-08-25T19:14:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r696016509",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696016509"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696022694",
      "pull_request_review_id": 738693637,
      "id": 696022694,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjAyMjY5NA==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20Forward4064::Crypt(const unsigned char* input, unsigned char* output, size_t bytes)\n+{\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ m_keystream[m_keystream_pos];\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE - CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+\n+            // m_ctx.SetKey() sets both IV and counter to zero, but we need the IV to increment.\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n \n-    m_chacha_header.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    m_chacha_main.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n+ChaCha20Forward4064::~ChaCha20Forward4064()\n+{\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n \n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n+ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1,\n+                                           size_t K_1_len,\n+                                           const unsigned char* K_2,\n+                                           size_t K_2_len) : m_chacha_header(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN), m_chacha_main(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN)\n+{\n+    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 68,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "We are checking whether the key length is 32 on this line https://github.com/bitcoin/bitcoin/blob/424e0100fbea0ac8106b25a9b23698f2c2cd7a4f/src/crypto/chacha_poly_aead.cpp#L33 when the constructors of `m_chacha_header` and `m_chacha_main` get called. So couldn't we remove these 2 lines?",
      "created_at": "2021-08-25T18:44:41Z",
      "updated_at": "2021-08-25T19:14:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r696022694",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696022694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": 78,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917217",
      "pull_request_review_id": 752218440,
      "id": 706917217,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjkxNzIxNw==",
      "diff_hunk": "@@ -6,6 +6,7 @@\n #define BITCOIN_CRYPTO_CHACHA_POLY_AEAD_H\n \n #include <crypto/chacha20.h>\n+#include <crypto/poly1305.h>\n \n #include <cmath>\n ",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 7,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": 696008360,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good catch. Fixed.",
      "created_at": "2021-09-12T21:47:09Z",
      "updated_at": "2021-09-12T21:47:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r706917217",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917217"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 11,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917227",
      "pull_request_review_id": 752218448,
      "id": 706917227,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjkxNzIyNw==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": 696015556,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-09-12T21:47:15Z",
      "updated_at": "2021-09-12T21:47:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r706917227",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917227"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917252",
      "pull_request_review_id": 752218464,
      "id": 706917252,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjkxNzI1Mg==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": 696016509,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-09-12T21:47:30Z",
      "updated_at": "2021-09-12T21:47:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r706917252",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917252"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917333",
      "pull_request_review_id": 752218529,
      "id": 706917333,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjkxNzMzMw==",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20Forward4064::Crypt(const unsigned char* input, unsigned char* output, size_t bytes)\n+{\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ m_keystream[m_keystream_pos];\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE - CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+\n+            // m_ctx.SetKey() sets both IV and counter to zero, but we need the IV to increment.\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n \n-    m_chacha_header.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    m_chacha_main.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n+ChaCha20Forward4064::~ChaCha20Forward4064()\n+{\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n \n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n+ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1,\n+                                           size_t K_1_len,\n+                                           const unsigned char* K_2,\n+                                           size_t K_2_len) : m_chacha_header(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN), m_chacha_main(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN)\n+{\n+    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 68,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": 696022694,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I find these asserts clarifying and afaict, C++ asserts are optimized away in release builds so it's not slowing anything down. Leaving these in here for now.",
      "created_at": "2021-09-12T21:48:21Z",
      "updated_at": "2021-09-12T21:48:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r706917333",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706917333"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": 78,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710606026",
      "pull_request_review_id": 756952958,
      "id": 710606026,
      "node_id": "PRRC_kwDOABII584qWvzK",
      "diff_hunk": "@@ -27,20 +28,58 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const unsigned char* key, size_t keylen)\n {\n-    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20Forward4064::Crypt(const unsigned char* input, unsigned char* output, size_t bytes)\n+{\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ m_keystream[m_keystream_pos];\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE - CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+\n+            // m_ctx.SetKey() sets both IV and counter to zero, but we need the IV to increment.\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n \n-    m_chacha_header.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-    m_chacha_main.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n+ChaCha20Forward4064::~ChaCha20Forward4064()\n+{\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n \n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n+ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1,\n+                                           size_t K_1_len,\n+                                           const unsigned char* K_2,\n+                                           size_t K_2_len) : m_chacha_header(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN), m_chacha_main(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN)\n+{\n+    assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n+    assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 68,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "424e0100fbea0ac8106b25a9b23698f2c2cd7a4f",
      "in_reply_to_id": 696022694,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Update: Turns out this was mistaken. assert() is not optimized away in optimized Bitcoin Core builds.",
      "created_at": "2021-09-17T00:27:34Z",
      "updated_at": "2021-09-17T00:27:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r710606026",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710606026"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": 78,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729856909",
      "pull_request_review_id": 780869719,
      "id": 729856909,
      "node_id": "PRRC_kwDOABII584rgLuN",
      "diff_hunk": "@@ -6,13 +6,13 @@\n #define BITCOIN_CRYPTO_CHACHA_POLY_AEAD_H\n \n #include <crypto/chacha20.h>\n+#include <crypto/poly1305.h>\n \n #include <cmath>",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 6,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": " `#include <cmath>` isn't being used.",
      "created_at": "2021-10-15T14:11:57Z",
      "updated_at": "2021-10-15T15:41:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729856909",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729856909"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 11,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729859127",
      "pull_request_review_id": 780869719,
      "id": 729859127,
      "node_id": "PRRC_kwDOABII584rgMQ3",
      "diff_hunk": "@@ -36,111 +36,113 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 113,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "a typo for semantics? :)",
      "created_at": "2021-10-15T14:14:46Z",
      "updated_at": "2021-10-15T15:41:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729859127",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729859127"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 56,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729868620",
      "pull_request_review_id": 780869719,
      "id": 729868620,
      "node_id": "PRRC_kwDOABII584rgOlM",
      "diff_hunk": "@@ -4,6 +4,7 @@\n \n #include <crypto/chacha_poly_aead.h>\n \n+#include <crypto/common.h>\n #include <crypto/poly1305.h>\n #include <support/cleanse.h>\n ",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "These imports can be removed since they aren't used:\r\n\r\n- `#include <string.h>`\r\n- `#include <cstdio>`\r\n- `#include <limits>`",
      "created_at": "2021-10-15T14:25:50Z",
      "updated_at": "2021-10-15T15:41:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729868620",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729868620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 10,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729912610",
      "pull_request_review_id": 780869719,
      "id": 729912610,
      "node_id": "PRRC_kwDOABII584rgZUi",
      "diff_hunk": "@@ -21,9 +21,6 @@ FUZZ_TARGET(crypto_chacha20_poly1305_aead)\n     const std::vector<uint8_t> k2 = ConsumeFixedLengthByteVector(fuzzed_data_provider, CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/test/fuzz/crypto_chacha20_poly1305_aead.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "These header files aren't used too and can be removed:\r\n\r\n- [`#include <cassert>`](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/test/fuzz/crypto_chacha20_poly1305_aead.cpp#L11)\r\n- [`#include <limits>`](https://github.com/bitcoin/bitcoin/blob/89b2499014fdf6b097e53119ae44e8376d957aef/src/test/fuzz/crypto_chacha20_poly1305_aead.cpp#L13)\r\n\r\nEDIT: I'm a bit confused about whether cassert needs to be removed. Even though an assert statement isn't used anywhere in the fuzz test file, it maybe needed in the fuzzing environment? ",
      "created_at": "2021-10-15T15:17:00Z",
      "updated_at": "2021-10-17T19:00:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729912610",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729912610"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729913514",
      "pull_request_review_id": 780869719,
      "id": 729913514,
      "node_id": "PRRC_kwDOABII584rgZiq",
      "diff_hunk": "@@ -19,43 +19,29 @@ static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n static const unsigned char k1[32] = {0};",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`#include <limits>` can be removed since it's [usage](https://github.com/bitcoin/bitcoin/blob/281cf995547f7683a9e9186bc6384a9fb6035d10/src/bench/chacha_poly_aead.cpp#L53) in the file has been removed.",
      "created_at": "2021-10-15T15:18:10Z",
      "updated_at": "2021-10-15T15:41:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729913514",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729913514"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729916359",
      "pull_request_review_id": 780869719,
      "id": 729916359,
      "node_id": "PRRC_kwDOABII584rgaPH",
      "diff_hunk": "@@ -19,43 +19,29 @@ static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n static const unsigned char k1[32] = {0};\n static const unsigned char k2[32] = {0};\n \n-static ChaCha20Poly1305AEAD aead(k1, 32, k2, 32);\n-\n static void CHACHA20_POLY1305_AEAD(benchmark::Bench& bench, size_t buffersize, bool include_decryption)\n {\n-    std::vector<unsigned char> in(buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN + POLY1305_TAGLEN, 0);\n-    std::vector<unsigned char> out(buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN + POLY1305_TAGLEN, 0);\n-    uint64_t seqnr_payload = 0;\n-    uint64_t seqnr_aad = 0;\n-    int aad_pos = 0;\n-    uint32_t len = 0;\n+    ChaCha20Poly1305AEAD aead_in(k1, 32, k2, 32);\n+    ChaCha20Poly1305AEAD aead_out(k1, 32, k2, 32);\n+\n+    auto plaintext_len = buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    auto ciphertext_len = plaintext_len + POLY1305_TAGLEN;\n+\n+    std::vector<unsigned char> in(plaintext_len, 0);\n+    std::vector<unsigned char> out(ciphertext_len, 0);\n+\n     bench.batch(buffersize).unit(\"byte\").run([&] {\n         // encrypt or decrypt the buffer with a static key\n-        const bool crypt_ok_1 = aead.Crypt(seqnr_payload, seqnr_aad, aad_pos, out.data(), out.size(), in.data(), buffersize, true);\n+        const bool crypt_ok_1 = aead_out.Crypt(out.data(), ciphertext_len, in.data(), plaintext_len, true);\n         assert(crypt_ok_1);\n \n         if (include_decryption) {\n             // if we decrypt, include the GetLength\n-            const bool get_length_ok = aead.GetLength(&len, seqnr_aad, aad_pos, in.data());\n-            assert(get_length_ok);\n-            const bool crypt_ok_2 = aead.Crypt(seqnr_payload, seqnr_aad, aad_pos, out.data(), out.size(), in.data(), buffersize, true);\n+            auto len = aead_in.DecryptLength(out.data());",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": null,
      "user": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "[This comment](https://github.com/bitcoin/bitcoin/pull/20962#issuecomment-939406631) suggestion can be applied here too.",
      "created_at": "2021-10-15T15:22:01Z",
      "updated_at": "2021-10-15T15:41:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r729916359",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729916359"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734750164",
      "pull_request_review_id": 787142011,
      "id": 734750164,
      "node_id": "PRRC_kwDOABII584ry2XU",
      "diff_hunk": "@@ -6,13 +6,13 @@\n #define BITCOIN_CRYPTO_CHACHA_POLY_AEAD_H\n \n #include <crypto/chacha20.h>\n+#include <crypto/poly1305.h>\n \n #include <cmath>",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 6,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729856909,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2021-10-22T18:10:52Z",
      "updated_at": "2021-10-22T18:10:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734750164",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734750164"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 11,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734750236",
      "pull_request_review_id": 787142121,
      "id": 734750236,
      "node_id": "PRRC_kwDOABII584ry2Yc",
      "diff_hunk": "@@ -36,111 +36,113 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate\n+* instances of chacha20.\n+*\n+* The instance keyed by K_1 is a stream cipher that is used for the per-message\n+* metadata, specifically for the poly1305 authentication key as well as for the\n+* length encryption. The second instance, keyed by K_2, is used to encrypt the\n+* entire payload.\n+*\n+* Two separate cipher instances are used here so as to keep the packet lengths\n+* confidential (best effort; for passive observing) but not create an oracle for\n+* the packet payload cipher by decrypting and using the packet length prior to\n+* checking the MAC. By using an independently-keyed cipher instance to encrypt\n+* the length, an active attacker seeking to exploit the packet input handling as\n+* a decryption oracle can learn nothing about the payload contents or its MAC\n+* (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+* can still obtain the message length (ex. active ciphertext bit flipping or\n+* traffic shemantics analysis)",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 113,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729859127,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": ":) done.",
      "created_at": "2021-10-22T18:11:00Z",
      "updated_at": "2021-10-22T18:11:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734750236",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734750236"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 56,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734751354",
      "pull_request_review_id": 787143636,
      "id": 734751354,
      "node_id": "PRRC_kwDOABII584ry2p6",
      "diff_hunk": "@@ -4,6 +4,7 @@\n \n #include <crypto/chacha_poly_aead.h>\n \n+#include <crypto/common.h>\n #include <crypto/poly1305.h>\n #include <support/cleanse.h>\n ",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729868620,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Need `string.h` for `size_t`: https://en.cppreference.com/w/c/types/size_t\r\nAdded `cstring` for `memset`: https://en.cppreference.com/w/cpp/string/byte/memset\r\n\r\nRemoved `cstdio` and `limits`",
      "created_at": "2021-10-22T18:12:54Z",
      "updated_at": "2021-10-22T18:13:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734751354",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734751354"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 10,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752019",
      "pull_request_review_id": 787144510,
      "id": 734752019,
      "node_id": "PRRC_kwDOABII584ry20T",
      "diff_hunk": "@@ -21,9 +21,6 @@ FUZZ_TARGET(crypto_chacha20_poly1305_aead)\n     const std::vector<uint8_t> k2 = ConsumeFixedLengthByteVector(fuzzed_data_provider, CHACHA20_POLY1305_AEAD_KEY_LEN);",
      "path": "src/test/fuzz/crypto_chacha20_poly1305_aead.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729912610,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-10-22T18:14:00Z",
      "updated_at": "2021-10-22T18:14:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734752019",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752019"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752108",
      "pull_request_review_id": 787144598,
      "id": 734752108,
      "node_id": "PRRC_kwDOABII584ry21s",
      "diff_hunk": "@@ -19,43 +19,29 @@ static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n static const unsigned char k1[32] = {0};",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729913514,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-10-22T18:14:06Z",
      "updated_at": "2021-10-22T18:14:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734752108",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752398",
      "pull_request_review_id": 787144980,
      "id": 734752398,
      "node_id": "PRRC_kwDOABII584ry26O",
      "diff_hunk": "@@ -19,43 +19,29 @@ static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n static const unsigned char k1[32] = {0};\n static const unsigned char k2[32] = {0};\n \n-static ChaCha20Poly1305AEAD aead(k1, 32, k2, 32);\n-\n static void CHACHA20_POLY1305_AEAD(benchmark::Bench& bench, size_t buffersize, bool include_decryption)\n {\n-    std::vector<unsigned char> in(buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN + POLY1305_TAGLEN, 0);\n-    std::vector<unsigned char> out(buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN + POLY1305_TAGLEN, 0);\n-    uint64_t seqnr_payload = 0;\n-    uint64_t seqnr_aad = 0;\n-    int aad_pos = 0;\n-    uint32_t len = 0;\n+    ChaCha20Poly1305AEAD aead_in(k1, 32, k2, 32);\n+    ChaCha20Poly1305AEAD aead_out(k1, 32, k2, 32);\n+\n+    auto plaintext_len = buffersize + CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    auto ciphertext_len = plaintext_len + POLY1305_TAGLEN;\n+\n+    std::vector<unsigned char> in(plaintext_len, 0);\n+    std::vector<unsigned char> out(ciphertext_len, 0);\n+\n     bench.batch(buffersize).unit(\"byte\").run([&] {\n         // encrypt or decrypt the buffer with a static key\n-        const bool crypt_ok_1 = aead.Crypt(seqnr_payload, seqnr_aad, aad_pos, out.data(), out.size(), in.data(), buffersize, true);\n+        const bool crypt_ok_1 = aead_out.Crypt(out.data(), ciphertext_len, in.data(), plaintext_len, true);\n         assert(crypt_ok_1);\n \n         if (include_decryption) {\n             // if we decrypt, include the GetLength\n-            const bool get_length_ok = aead.GetLength(&len, seqnr_aad, aad_pos, in.data());\n-            assert(get_length_ok);\n-            const bool crypt_ok_2 = aead.Crypt(seqnr_payload, seqnr_aad, aad_pos, out.data(), out.size(), in.data(), buffersize, true);\n+            auto len = aead_in.DecryptLength(out.data());",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "0b93e3d2e8ec8f495bc316df6dd6dcc690fc4b54",
      "in_reply_to_id": 729916359,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ah, I was looking for another place this was useful and didn't remember correctly. Thanks, @stratospher !",
      "created_at": "2021-10-22T18:14:33Z",
      "updated_at": "2021-10-22T18:14:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734752398",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734752398"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734937517",
      "pull_request_review_id": 787368071,
      "id": 734937517,
      "node_id": "PRRC_kwDOABII584rzkGt",
      "diff_hunk": "@@ -36,111 +34,113 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 97,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "380b137556b5b14ba9de45db850cfdbd1c43991d",
      "in_reply_to_id": null,
      "user": {
        "login": "0xB10C",
        "id": 19157360,
        "node_id": "MDQ6VXNlcjE5MTU3MzYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/19157360?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/0xB10C",
        "html_url": "https://github.com/0xB10C",
        "followers_url": "https://api.github.com/users/0xB10C/followers",
        "following_url": "https://api.github.com/users/0xB10C/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/0xB10C/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/0xB10C/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/0xB10C/subscriptions",
        "organizations_url": "https://api.github.com/users/0xB10C/orgs",
        "repos_url": "https://api.github.com/users/0xB10C/repos",
        "events_url": "https://api.github.com/users/0xB10C/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/0xB10C/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "indention seem to be off-by-one for the remainder of this comment and a `*` is missing in line 37",
      "created_at": "2021-10-23T07:31:27Z",
      "updated_at": "2021-10-23T07:31:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r734937517",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/734937517"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743145219",
      "pull_request_review_id": 798182555,
      "id": 743145219,
      "node_id": "PRRC_kwDOABII584sS38D",
      "diff_hunk": "@@ -36,111 +34,113 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  *\n  * ==== Detailed Construction ====\n  *\n- * The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n- * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n- * instances of chacha20.\n- *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n- *\n- * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n- *\n- * ==== Packet Handling ====\n- *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n- *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n- *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n- *\n- * Once the entire packet has been received, the MAC MUST be checked before\n- * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n- * packet length and the payload together. The calculated MAC is then compared in\n- * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n- *\n- * Detection of an invalid MAC MUST lead to immediate connection termination.\n- *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n- */\n+The chacha20-poly1305@bitcoin cipher requires two 256 bits of key material as\n+* output from the key exchange. Each key (K_1 and K_2) are used by two separate",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 97,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "380b137556b5b14ba9de45db850cfdbd1c43991d",
      "in_reply_to_id": 734937517,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "thanks for the catch. fixed.",
      "created_at": "2021-11-04T19:34:35Z",
      "updated_at": "2021-11-04T19:34:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r743145219",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743145219"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887864881",
      "pull_request_review_id": 993416434,
      "id": 887864881,
      "node_id": "PRRC_kwDOABII5840674x",
      "diff_hunk": "@@ -53,18 +85,24 @@ bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int\n \n     unsigned char expected_tag[POLY1305_TAGLEN], poly_key[POLY1305_KEYLEN];\n     memset(poly_key, 0, sizeof(poly_key));\n-    m_chacha_main.SetIV(seqnr_payload);\n \n-    // block counter 0 for the poly1305 key\n-    // use lower 32bytes for the poly1305 key\n-    // (throws away 32 unused bytes (upper 32) from this ChaCha20 round)\n-    m_chacha_main.Seek(0);\n-    m_chacha_main.Crypt(poly_key, poly_key, sizeof(poly_key));\n+    // 1. AAD (the encrypted packet length), use the header-keystream\n+    if (is_encrypt) {\n+        m_chacha_header.Crypt(src, dest, 3);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 94,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": null,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The `ChaCha20Poly1305AEAD::Crypt` function uses argument order `dest`, `len`, `src`\r\nThe `ChaCha20Forward4064::Crypt` function uses argument order `input`, `output`, `bytes`\r\nLet's standardize on one, please.",
      "created_at": "2022-06-02T11:52:17Z",
      "updated_at": "2022-06-02T11:52:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r887864881",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887864881"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 91,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887873124",
      "pull_request_review_id": 993428109,
      "id": 887873124,
      "node_id": "PRRC_kwDOABII5840695k",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n+\n+ChaCha20ReKey4096::~ChaCha20ReKey4096() {\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n+\n ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n {\n     assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_main.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_header.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-\n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n }\n \n-bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)\n+bool ChaCha20Poly1305AEAD::Crypt(unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 62,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659124563,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes, I had a similar idea, it's a bit awkward like this. But apparently there's a good reason.",
      "created_at": "2022-06-02T12:02:32Z",
      "updated_at": "2022-06-02T12:02:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r887873124",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887873124"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887876110",
      "pull_request_review_id": 993432468,
      "id": 887876110,
      "node_id": "PRRC_kwDOABII58406-oO",
      "diff_hunk": "@@ -3,59 +3,43 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n \n+#include <assert.h>\n #include <bench/bench.h>\n #include <crypto/chacha_poly_aead.h>\n #include <crypto/poly1305.h> // for the POLY1305_TAGLEN constant\n #include <hash.h>\n \n-#include <assert.h>\n-#include <limits>\n+#include <vector>\n \n /* Number of bytes to process per iteration */\n static constexpr uint64_t BUFFER_SIZE_TINY = 64;\n static constexpr uint64_t BUFFER_SIZE_SMALL = 256;\n static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n \n-static const unsigned char k1[32] = {0};\n-static const unsigned char k2[32] = {0};\n-\n-static ChaCha20Poly1305AEAD aead(k1, 32, k2, 32);\n+static std::vector<unsigned char> zero_key(32, 0x00);",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": null,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Having this mutable is slightly risky. Can we add `const` or `constexpr`?\r\nEdit: ok, this is \"only\" bench code, but still.",
      "created_at": "2022-06-02T12:06:30Z",
      "updated_at": "2022-06-02T12:07:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r887876110",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887876110"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887878270",
      "pull_request_review_id": 993435603,
      "id": 887878270,
      "node_id": "PRRC_kwDOABII58406_J-",
      "diff_hunk": "@@ -27,20 +26,53 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const Span<unsigned char> key)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": null,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "If your intent is to have the contents of the Span const (which I think it is), this should be `Span<const unsigned char>`.\r\n(more of these below)",
      "created_at": "2022-06-02T12:09:10Z",
      "updated_at": "2022-06-02T12:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r887878270",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887878270"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887881231",
      "pull_request_review_id": 993439660,
      "id": 887881231,
      "node_id": "PRRC_kwDOABII58406_4P",
      "diff_hunk": "@@ -40,107 +39,109 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n  * instances of chacha20.\n  *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n+ * The instance keyed by K_1 is a stream cipher that is used for the per-message\n+ * metadata, specifically for the poly1305 authentication key as well as for the\n+ * length encryption. The second instance, keyed by K_2, is used to encrypt the\n+ * entire payload.\n  *\n  * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n+ * confidential (best effort; for passive observing) but not create an oracle for\n+ * the packet payload cipher by decrypting and using the packet length prior to\n+ * checking the MAC. By using an independently-keyed cipher instance to encrypt\n+ * the length, an active attacker seeking to exploit the packet input handling as\n+ * a decryption oracle can learn nothing about the payload contents or its MAC\n+ * (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+ * can still obtain the message length (ex. active ciphertext bit flipping or\n+ * traffic semantics analysis)\n  *\n- * ==== Packet Handling ====\n+ * The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+ * keyed with K_1 and K_2 and sequence number 0 as IV and a block counter of 0.\n+ * After encrypting 4064 bytes, the following 32 bytes are used to\n+ * re-key the ChaCha20 context.\n  *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n+ * Byte-level forward security is possible by precomputing 4096 bytes of stream\n+ * output, caching it, resetting the key to the final 32 bytes of the output, and\n+ * then wiping the remaining 4064 bytes of cached data as it gets used.\n+ *\n+ * For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+ * K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+ * generate a Poly1305 key.\n  *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n+ * If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+ * 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+ * incrementing the sequence number + 1 and set is as IV (little endian encoding).\n  *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n+ * For the payload, use the ChaCha20 stream keyed with K_2 and apply the same\n+ * re-key rules.\n+ *\n+ *\n+ * ==== Packet Handling ====\n+ *\n+ * When receiving a packet, the length must be decrypted first. When 3 bytes of\n+ * ciphertext length have been received, they MUST be decrypted.\n  *\n  * Once the entire packet has been received, the MAC MUST be checked before\n  * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n+ * MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n  * packet length and the payload together. The calculated MAC is then compared in\n  * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n+ * using ChaCha20 as described above (using stream keyed with K_2).\n  *\n  * Detection of an invalid MAC MUST lead to immediate connection termination.\n  *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n+ * To send a packet, first encode the 3 byte length and encrypt it using the\n+ * ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+ * (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+ * length. Finally, calculate a MAC tag (using poly1305 key from stream keyed with K_1)\n+ * and append it.\n  */\n \n+const size_t KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20Forward4064\n+{\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+\n+public:\n+    ChaCha20Forward4064(const Span<unsigned char> key);\n+    ~ChaCha20Forward4064();\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n+\n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length) and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_main;                                      // payload\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20Forward4064 m_chacha_header; // AAD cipher instance (encrypted length) and poly1305 key-derivation cipher instance\n+    ChaCha20Forward4064 m_chacha_main;   // payload\n \n public:\n-    ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n+    ChaCha20Poly1305AEAD(const Span<unsigned char> K_F, const Span<unsigned char> K_V);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n+\n+        Returns true if encipher succeeds. Upon failure, the data at dest should not be used.",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 177,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": null,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Is \"encipher\" a word? If it means the same, I prefer \"encrypt or decrypt\".",
      "created_at": "2022-06-02T12:12:39Z",
      "updated_at": "2022-06-02T12:13:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r887881231",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887881231"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 133,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895303646",
      "pull_request_review_id": 1003753351,
      "id": 895303646,
      "node_id": "PRRC_kwDOABII5841XT_e",
      "diff_hunk": "@@ -53,18 +85,24 @@ bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int\n \n     unsigned char expected_tag[POLY1305_TAGLEN], poly_key[POLY1305_KEYLEN];\n     memset(poly_key, 0, sizeof(poly_key));\n-    m_chacha_main.SetIV(seqnr_payload);\n \n-    // block counter 0 for the poly1305 key\n-    // use lower 32bytes for the poly1305 key\n-    // (throws away 32 unused bytes (upper 32) from this ChaCha20 round)\n-    m_chacha_main.Seek(0);\n-    m_chacha_main.Crypt(poly_key, poly_key, sizeof(poly_key));\n+    // 1. AAD (the encrypted packet length), use the header-keystream\n+    if (is_encrypt) {\n+        m_chacha_header.Crypt(src, dest, 3);",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 94,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": 887864881,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done. New implementation uses spans and I went with `input, output` everywhere.",
      "created_at": "2022-06-13T03:43:51Z",
      "updated_at": "2022-06-13T03:43:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r895303646",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895303646"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 91,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895303936",
      "pull_request_review_id": 1003753751,
      "id": 895303936,
      "node_id": "PRRC_kwDOABII5841XUEA",
      "diff_hunk": "@@ -27,20 +26,53 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n-ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n+ChaCha20Forward4064::ChaCha20Forward4064(const Span<unsigned char> key)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": 887878270,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done across the board.",
      "created_at": "2022-06-13T03:45:05Z",
      "updated_at": "2022-06-13T03:45:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r895303936",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895303936"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895304058",
      "pull_request_review_id": 1003753908,
      "id": 895304058,
      "node_id": "PRRC_kwDOABII5841XUF6",
      "diff_hunk": "@@ -40,107 +39,109 @@ static constexpr int AAD_PACKAGES_PER_ROUND = 21;        /* 64 / 3 round down*/\n  * output from the key exchange. Each key (K_1 and K_2) are used by two separate\n  * instances of chacha20.\n  *\n- * The instance keyed by K_1 is a stream cipher that is used only to encrypt the 3\n- * byte packet length field and has its own sequence number. The second instance,\n- * keyed by K_2, is used in conjunction with poly1305 to build an AEAD\n- * (Authenticated Encryption with Associated Data) that is used to encrypt and\n- * authenticate the entire packet.\n+ * The instance keyed by K_1 is a stream cipher that is used for the per-message\n+ * metadata, specifically for the poly1305 authentication key as well as for the\n+ * length encryption. The second instance, keyed by K_2, is used to encrypt the\n+ * entire payload.\n  *\n  * Two separate cipher instances are used here so as to keep the packet lengths\n- * confidential but not create an oracle for the packet payload cipher by\n- * decrypting and using the packet length prior to checking the MAC. By using an\n- * independently-keyed cipher instance to encrypt the length, an active attacker\n- * seeking to exploit the packet input handling as a decryption oracle can learn\n- * nothing about the payload contents or its MAC (assuming key derivation,\n- * ChaCha20 and Poly1305 are secure).\n- *\n- * The AEAD is constructed as follows: for each packet, generate a Poly1305 key by\n- * taking the first 256 bits of ChaCha20 stream output generated using K_2, an IV\n- * consisting of the packet sequence number encoded as an LE uint64 and a ChaCha20\n- * block counter of zero. The K_2 ChaCha20 block counter is then set to the\n- * little-endian encoding of 1 (i.e. {1, 0, 0, 0, 0, 0, 0, 0}) and this instance\n- * is used for encryption of the packet payload.\n+ * confidential (best effort; for passive observing) but not create an oracle for\n+ * the packet payload cipher by decrypting and using the packet length prior to\n+ * checking the MAC. By using an independently-keyed cipher instance to encrypt\n+ * the length, an active attacker seeking to exploit the packet input handling as\n+ * a decryption oracle can learn nothing about the payload contents or its MAC\n+ * (assuming key derivation, ChaCha20 and Poly1305 are secure). Active observers\n+ * can still obtain the message length (ex. active ciphertext bit flipping or\n+ * traffic semantics analysis)\n  *\n- * ==== Packet Handling ====\n+ * The AEAD is constructed as follows: generate two ChaCha20 streams, initially\n+ * keyed with K_1 and K_2 and sequence number 0 as IV and a block counter of 0.\n+ * After encrypting 4064 bytes, the following 32 bytes are used to\n+ * re-key the ChaCha20 context.\n  *\n- * When receiving a packet, the length must be decrypted first. When 3 bytes of\n- * ciphertext length have been received, they may be decrypted.\n+ * Byte-level forward security is possible by precomputing 4096 bytes of stream\n+ * output, caching it, resetting the key to the final 32 bytes of the output, and\n+ * then wiping the remaining 4064 bytes of cached data as it gets used.\n+ *\n+ * For each packet, use 3 bytes from the remaining ChaCha20 stream generated using\n+ * K_1 to encrypt the length. Use additional 32 bytes of the same stream to\n+ * generate a Poly1305 key.\n  *\n- * A ChaCha20 round always calculates 64bytes which is sufficient to crypt 21\n- * times a 3 bytes length field (21*3 = 63). The length field sequence number can\n- * thus be used 21 times (keystream caching).\n+ * If we reach bytes 4064 on the ChaCha20 stream, use the next 32 bytes (byte\n+ * 4065-4096) and set is as the new ChaCha20 key, reset the counter to 0 while\n+ * incrementing the sequence number + 1 and set is as IV (little endian encoding).\n  *\n- * The length field must be enc-/decrypted with the ChaCha20 keystream keyed with\n- * K_1 defined by block counter 0, the length field sequence number in little\n- * endian and a keystream position from 0 to 60.\n+ * For the payload, use the ChaCha20 stream keyed with K_2 and apply the same\n+ * re-key rules.\n+ *\n+ *\n+ * ==== Packet Handling ====\n+ *\n+ * When receiving a packet, the length must be decrypted first. When 3 bytes of\n+ * ciphertext length have been received, they MUST be decrypted.\n  *\n  * Once the entire packet has been received, the MAC MUST be checked before\n  * decryption. A per-packet Poly1305 key is generated as described above and the\n- * MAC tag calculated using Poly1305 with this key over the ciphertext of the\n+ * MAC tag is calculated using Poly1305 with this key over the ciphertext of the\n  * packet length and the payload together. The calculated MAC is then compared in\n  * constant time with the one appended to the packet and the packet decrypted\n- * using ChaCha20 as described above (with K_2, the packet sequence number as\n- * nonce and a starting block counter of 1).\n+ * using ChaCha20 as described above (using stream keyed with K_2).\n  *\n  * Detection of an invalid MAC MUST lead to immediate connection termination.\n  *\n- * To send a packet, first encode the 3 byte length and encrypt it using K_1 as\n- * described above. Encrypt the packet payload (using K_2) and append it to the\n- * encrypted length. Finally, calculate a MAC tag and append it.\n- *\n- * The initiating peer MUST use <code>K_1_A, K_2_A</code> to encrypt messages on\n- * the send channel, <code>K_1_B, K_2_B</code> MUST be used to decrypt messages on\n- * the receive channel.\n- *\n- * The responding peer MUST use <code>K_1_A, K_2_A</code> to decrypt messages on\n- * the receive channel, <code>K_1_B, K_2_B</code> MUST be used to encrypt messages\n- * on the send channel.\n- *\n- * Optimized implementations of ChaCha20-Poly1305@bitcoin are relatively fast in\n- * general, therefore it is very likely that encrypted messages require not more\n- * CPU cycles per bytes then the current unencrypted p2p message format\n- * (ChaCha20/Poly1305 versus double SHA256).\n- *\n- * The initial packet sequence numbers are 0.\n- *\n- * K_2 ChaCha20 cipher instance (payload) must never reuse a {key, nonce} for\n- * encryption nor may it be used to encrypt more than 2^70 bytes under the same\n- * {key, nonce}.\n- *\n- * K_1 ChaCha20 cipher instance (length field/AAD) must never reuse a {key, nonce,\n- * position-in-keystream} for encryption nor may it be used to encrypt more than\n- * 2^70 bytes under the same {key, nonce}.\n- *\n- * We use message sequence numbers for both communication directions.\n+ * To send a packet, first encode the 3 byte length and encrypt it using the\n+ * ChaCha20 stream keyed with K_1 as described above. Encrypt the packet payload\n+ * (using the ChaCha20 stream keyed with K_2) and append it to the encrypted\n+ * length. Finally, calculate a MAC tag (using poly1305 key from stream keyed with K_1)\n+ * and append it.\n  */\n \n+const size_t KEYSTREAM_SIZE = 4096;\n+\n+class ChaCha20Forward4064\n+{\n+private:\n+    ChaCha20 m_ctx;\n+    uint64_t m_seqnr{0};\n+    size_t m_keystream_pos{0};\n+    unsigned char m_keystream[KEYSTREAM_SIZE] = {0};\n+\n+public:\n+    ChaCha20Forward4064(const Span<unsigned char> key);\n+    ~ChaCha20Forward4064();\n+    void Crypt(const unsigned char* input, unsigned char* output, size_t bytes);\n+};\n+\n class ChaCha20Poly1305AEAD\n {\n private:\n-    ChaCha20 m_chacha_header;                                    // AAD cipher instance (encrypted length) and poly1305 key-derivation cipher instance\n-    ChaCha20 m_chacha_main;                                      // payload\n-    unsigned char m_aad_keystream_buffer[CHACHA20_ROUND_OUTPUT]; // aad keystream cache\n-    uint64_t m_cached_aad_seqnr;                                 // aad keystream cache hint\n+    ChaCha20Forward4064 m_chacha_header; // AAD cipher instance (encrypted length) and poly1305 key-derivation cipher instance\n+    ChaCha20Forward4064 m_chacha_main;   // payload\n \n public:\n-    ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len);\n+    ChaCha20Poly1305AEAD(const Span<unsigned char> K_F, const Span<unsigned char> K_V);\n \n     explicit ChaCha20Poly1305AEAD(const ChaCha20Poly1305AEAD&) = delete;\n \n     /** Encrypts/decrypts a packet\n-        seqnr_payload, the message sequence number\n-        seqnr_aad, the messages AAD sequence number which allows reuse of the AAD keystream\n-        aad_pos, position to use in the AAD keystream to encrypt the AAD\n         dest, output buffer, must be of a size equal or larger then CHACHA20_POLY1305_AEAD_AAD_LEN + payload (+ POLY1305_TAG_LEN in encryption) bytes\n         destlen, length of the destination buffer\n         src, the AAD+payload to encrypt or the AAD+payload+MAC to decrypt\n         src_len, the length of the source buffer\n         is_encrypt, set to true if we encrypt (creates and appends the MAC instead of verifying it)\n+\n+        Returns true if encipher succeeds. Upon failure, the data at dest should not be used.",
      "path": "src/crypto/chacha_poly_aead.h",
      "position": null,
      "original_position": 177,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": 887881231,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2022-06-13T03:45:31Z",
      "updated_at": "2022-06-13T03:45:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r895304058",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895304058"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 133,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895305398",
      "pull_request_review_id": 1003755623,
      "id": 895305398,
      "node_id": "PRRC_kwDOABII5841XUa2",
      "diff_hunk": "@@ -3,59 +3,43 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n \n+#include <assert.h>\n #include <bench/bench.h>\n #include <crypto/chacha_poly_aead.h>\n #include <crypto/poly1305.h> // for the POLY1305_TAGLEN constant\n #include <hash.h>\n \n-#include <assert.h>\n-#include <limits>\n+#include <vector>\n \n /* Number of bytes to process per iteration */\n static constexpr uint64_t BUFFER_SIZE_TINY = 64;\n static constexpr uint64_t BUFFER_SIZE_SMALL = 256;\n static constexpr uint64_t BUFFER_SIZE_LARGE = 1024 * 1024;\n \n-static const unsigned char k1[32] = {0};\n-static const unsigned char k2[32] = {0};\n-\n-static ChaCha20Poly1305AEAD aead(k1, 32, k2, 32);\n+static std::vector<unsigned char> zero_key(32, 0x00);",
      "path": "src/bench/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "97b768f95236c8460673fa9122bce19b89753399",
      "in_reply_to_id": 887876110,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2022-06-13T03:50:43Z",
      "updated_at": "2022-06-13T03:50:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r895305398",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895305398"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895306515",
      "pull_request_review_id": 1003757071,
      "id": 895306515,
      "node_id": "PRRC_kwDOABII5841XUsT",
      "diff_hunk": "@@ -27,19 +28,52 @@ int timingsafe_bcmp(const unsigned char* b1, const unsigned char* b2, size_t n)\n \n #endif // TIMINGSAFE_BCMP\n \n+void ChaCha20ReKey4096::SetKey(const unsigned char* key, size_t keylen) {\n+    assert(keylen == 32);\n+    m_ctx.SetKey(key, keylen);\n+\n+    // set initial sequence number\n+    m_seqnr = 0;\n+    m_ctx.SetIV(m_seqnr);\n+\n+    // precompute first chunk of keystream\n+    m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+    m_keystream_pos = 0;\n+}\n+\n+void ChaCha20ReKey4096::Crypt(const unsigned char* input, unsigned char* output, size_t bytes) {\n+    size_t message_pos = 0;\n+\n+    // TODO: speedup with a block approach (rather then looping over every byte)\n+    while (bytes > message_pos) {\n+        output[message_pos] = input[message_pos] ^ ReadLE32(&m_keystream[m_keystream_pos]);\n+        m_keystream_pos++;\n+        message_pos++;\n+        if (m_keystream_pos == KEYSTREAM_SIZE-CHACHA20_POLY1305_AEAD_KEY_LEN) {\n+            // we reached the end of the keystream\n+            // rekey with the remaining and last 32 bytes and precompute the next 4096 bytes\n+            m_ctx.SetKey(&m_keystream[m_keystream_pos], CHACHA20_POLY1305_AEAD_KEY_LEN);\n+            m_ctx.SetIV(++m_seqnr);\n+            m_ctx.Keystream(m_keystream, KEYSTREAM_SIZE);\n+            // reset keystream position\n+            m_keystream_pos = 0;\n+        }\n+    }\n+}\n+\n+ChaCha20ReKey4096::~ChaCha20ReKey4096() {\n+    memory_cleanse(m_keystream, KEYSTREAM_SIZE);\n+}\n+\n ChaCha20Poly1305AEAD::ChaCha20Poly1305AEAD(const unsigned char* K_1, size_t K_1_len, const unsigned char* K_2, size_t K_2_len)\n {\n     assert(K_1_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     assert(K_2_len == CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_main.SetKey(K_1, CHACHA20_POLY1305_AEAD_KEY_LEN);\n     m_chacha_header.SetKey(K_2, CHACHA20_POLY1305_AEAD_KEY_LEN);\n-\n-    // set the cached sequence number to uint64 max which hints for an unset cache.\n-    // we can't hit uint64 max since the rekey rule (which resets the sequence number) is 1GB\n-    m_cached_aad_seqnr = std::numeric_limits<uint64_t>::max();\n }\n \n-bool ChaCha20Poly1305AEAD::Crypt(uint64_t seqnr_payload, uint64_t seqnr_aad, int aad_pos, unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)\n+bool ChaCha20Poly1305AEAD::Crypt(unsigned char* dest, size_t dest_len /* length of the output buffer for sanity checks */, const unsigned char* src, size_t src_len, bool is_encrypt)",
      "path": "src/crypto/chacha_poly_aead.cpp",
      "position": null,
      "original_position": 62,
      "commit_id": "b6166568a306ef41da33b5f97623d9678dd1a36c",
      "original_commit_id": "c22f607b62af59969b9378d4cd8ed72b866dec11",
      "in_reply_to_id": 659124563,
      "user": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dhruv/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dhruv/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah, we need a way to know the boundaries of the messages coming in a single stream.",
      "created_at": "2022-06-13T03:55:10Z",
      "updated_at": "2022-06-13T03:55:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20962#discussion_r895306515",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895306515"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20962"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    }
  ]
}