{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
    "id": 1363708248,
    "node_id": "PR_kwDOABII585RSIlY",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/27746",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/27746.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/27746.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/a959bf6608d16ad14da961a6007ede5f15877deb",
    "number": 27746,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "Draft: rework validation logic for assumeutxo",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This PR proposes a clean up of the relationship between block storage and the chainstate objects, by moving the decision of whether to store a block on disk to something that is not chainstate-specific.  Philosophically, the decision of whether to store a block on disk is related to validation rules that do not require any UTXO state; for anti-DoS reasons we were using some chainstate-specific heuristics, and those have been reworked here to achieve the proposed separation.\r\n\r\nThis PR also fixes a bug in how a chainstate's `setBlockIndexCandidates` was being initialized; it should always have all the HAVE_DATA block index entries that have more work than the chain tip.  During startup, we were not fully populating `setBlockIndexCandidates` in some scenarios involving multiple chainstates.\r\n\r\nFurther, this PR establishes a concept that whenever we have 2 chainstates, that we always know what the snapshotted chain's base block is: the block hash must be an element of our block index. Given that, we can establish a new invariant that the background validation chainstate only needs to consider blocks leading to that snapshotted block entry as potential candidates for its tip. As a followup I would imagine that when writing net_processing logic to download blocks for the background chainstate, that we would use this concept to only download blocks towards the snapshotted entry as well.\r\n\r\nThis code needs a lot of cleanup and test fixes and so I've marked it as a draft -- help from reviewers would be welcome!",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2023-05-24T19:57:32Z",
    "updated_at": "2023-06-06T23:46:09Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "f13f025085a445ea962d05758a39fadff80cfd98",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "sdaftuar:2023-05-assumeutxo-validation-improvements",
      "ref": "2023-05-assumeutxo-validation-improvements",
      "sha": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 28761781,
        "node_id": "MDEwOlJlcG9zaXRvcnkyODc2MTc4MQ==",
        "name": "bitcoin",
        "full_name": "sdaftuar/bitcoin",
        "owner": {
          "login": "sdaftuar",
          "id": 7463573,
          "node_id": "MDQ6VXNlcjc0NjM1NzM=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sdaftuar",
          "html_url": "https://github.com/sdaftuar",
          "followers_url": "https://api.github.com/users/sdaftuar/followers",
          "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
          "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
          "repos_url": "https://api.github.com/users/sdaftuar/repos",
          "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/sdaftuar/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sdaftuar/bitcoin",
        "archive_url": "https://api.github.com/repos/sdaftuar/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sdaftuar/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sdaftuar/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sdaftuar/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sdaftuar/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sdaftuar/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sdaftuar/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sdaftuar/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sdaftuar/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sdaftuar/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sdaftuar/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sdaftuar/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sdaftuar/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sdaftuar/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sdaftuar/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sdaftuar/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sdaftuar/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sdaftuar/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sdaftuar/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sdaftuar/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sdaftuar/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sdaftuar/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sdaftuar/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sdaftuar/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sdaftuar/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sdaftuar/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sdaftuar/bitcoin/hooks",
        "svn_url": "https://github.com/sdaftuar/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 3,
        "watchers_count": 3,
        "size": 245665,
        "default_branch": "master",
        "open_issues_count": 1,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T22:41:53Z",
        "created_at": "2015-01-04T02:52:13Z",
        "updated_at": "2023-02-11T10:16:01Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "8cc65f093c0cf7a27b3bfc6da90fd7a6ac8f5e48",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 34341,
        "stargazers_count": 69825,
        "watchers_count": 69825,
        "size": 234259,
        "default_branch": "master",
        "open_issues_count": 627,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-07T15:59:50Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-06-07T15:20:57Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
      }
    },
    "author_association": "MEMBER",
    "draft": true,
    "additions": 255,
    "deletions": 158,
    "changed_files": 12,
    "commits": 9,
    "review_comments": 5,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 1561858383,
      "node_id": "IC_kwDOABII585dGBFP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T20:05:01Z",
      "updated_at": "2023-05-24T20:05:01Z",
      "author_association": "MEMBER",
      "body": "Great! Thanks for this. I'm active in these neighborhoods today as well, since adding some `-stopatheight`/restart logic to the functional tests in #27596 has turned up some issues with `CheckBlockIndex()`, which are maybe related to some of the changes here. So I'll be looking at this shortly.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1561858383",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGE3YWVhMmJlZWNiMDYxMGNmMDlhMGVhNTlmNmYzYTY5MWVjZTE4YmY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a7aea2beecb0610cf09a0ea59f6f3a691ece18bf",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a7aea2beecb0610cf09a0ea59f6f3a691ece18bf",
      "tree": {
        "sha": "cad68a15a2a46ea0d04856bf1760cdf74538b9a3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cad68a15a2a46ea0d04856bf1760cdf74538b9a3"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a13f3746dccd9c4ec16d6bfe9b33ebd26e3238e1",
          "sha": "a13f3746dccd9c4ec16d6bfe9b33ebd26e3238e1",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a13f3746dccd9c4ec16d6bfe9b33ebd26e3238e1"
        }
      ],
      "message": "Explicitly track maximum block height stored in undo files\n\nWhen writing a new block to disk, if we have filled up the current block file,\nthen we flush and truncate that block file (to free allocated but unused\nspace) before advancing to the next one. When this happens, we have to\ndetermine whether to also flush and truncate the corresponding undo file.\n\nUndo data is only written when blocks are connected, not when blocks are\nreceived. Thus it's possible that the corresponding undo file already has all\nthe data it will ever have, and we should flush/truncate it as we adadvance\nfiles; or it's possible that there is more data we expect to write, and should\ntherefore defer flush/truncation until undo data is later written.\n\nPrior to this commit, we made the determination of whether the undo file was\nfull of all requisite data by comparing against the chain tip. This patch\nreplaces that dependence on validation data structures by instead just tracking\nthe highest height of any block written to in the undo file as we go.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T20:29:37Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-04-28T22:50:33Z"
      },
      "sha": "a7aea2beecb0610cf09a0ea59f6f3a691ece18bf"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGY1MGZhMjQ4ZjFkOTA0YmU1ZjMzYTI5YzgzN2Y3NGEyY2NhOGFiYzA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f50fa248f1d904be5f33a29c837f74a2cca8abc0",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f50fa248f1d904be5f33a29c837f74a2cca8abc0",
      "tree": {
        "sha": "5a344373364b250039cdf21c77d19d967ce27efd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5a344373364b250039cdf21c77d19d967ce27efd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a7aea2beecb0610cf09a0ea59f6f3a691ece18bf",
          "sha": "a7aea2beecb0610cf09a0ea59f6f3a691ece18bf",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a7aea2beecb0610cf09a0ea59f6f3a691ece18bf"
        }
      ],
      "message": "Remove CChain dependency in node/blockstorage",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T20:29:40Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-04-28T23:31:56Z"
      },
      "sha": "f50fa248f1d904be5f33a29c837f74a2cca8abc0"
    },
    {
      "event": "labeled",
      "id": 9332774600,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIsRtbI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9332774600",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T21:14:58Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9333086286,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAIsS5hO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9333086286",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T21:55:45Z"
    },
    {
      "event": "unlabeled",
      "id": 9333565467,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAIsUugb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9333565467",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T23:18:48Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1562326140,
      "node_id": "IC_kwDOABII585dHzR8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-25T06:05:23Z",
      "updated_at": "2023-05-31T18:14:01Z",
      "author_association": "MEMBER",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27711](https://github.com/bitcoin/bitcoin/pull/27711) (kernel: Remove shutdown from kernel library by TheCharlatan)\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1562326140",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "commented",
      "id": 1570566067,
      "node_id": "IC_kwDOABII585dnO-z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-31T16:41:24Z",
      "updated_at": "2023-05-31T16:41:24Z",
      "author_association": "MEMBER",
      "body": "The first two commits up to f50fa248f1d904be5f33a29c837f74a2cca8abc0 look good to me.\r\n\r\nHow do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n\r\n> Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nIn any case moving `AcceptBlock` from `Chainstate` to `ChainstateManager` seems an improvement.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1570566067",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "reviewed",
      "id": 1453921658,
      "node_id": "PRR_kwDOABII585WqRV6",
      "url": null,
      "actor": null,
      "commit_id": "379467ac0a8b73035f83f957396bda1255873c2f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "If you can split 534b6f99a3779465678f39ed2704da6049c6469d in ~half that would make it a bit easier to review. Maybe start with anything that's trivial to move, and then do the more involved changes in the second commit.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1453921658",
      "submitted_at": "2023-05-31T18:44:51Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1453931065,
      "node_id": "PRR_kwDOABII585WqTo5",
      "url": null,
      "actor": null,
      "commit_id": "379467ac0a8b73035f83f957396bda1255873c2f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1453931065",
      "submitted_at": "2023-05-31T19:10:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "labeled",
      "id": 9414285155,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIxIpdj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9414285155",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-02T13:25:10Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "commented",
      "id": 1577187405,
      "node_id": "IC_kwDOABII585eAfhN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T17:23:57Z",
      "updated_at": "2023-06-05T17:23:57Z",
      "author_association": "MEMBER",
      "body": "> How do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n> \r\n> > Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nI think of `BlockManager` as being a generic backend database of block (and undo) data, while any validation-related logic should live in `Chainstate` (if it relies on chainstate-specific information) or somewhere else (either a static function in validation or in `ChainstateManager` as I propose here) if not.\r\n\r\nI think `AcceptBlock` could also be a static function in `validation.cpp`; I mostly just wanted to get it out of `Chainstate` because I think that having block storage be coupled to a particular chainstate is a confusing idea, but I can go either way on whether it belongs in ChainstateManager or not.",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1577187405",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUzMTY1ZDBkNWE0OGUwMjdjODkyYjY1MTBhMWEyNDQwYzc0NGVmYzM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/53165d0d5a48e027c892b6510a1a2440c744efc3",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/53165d0d5a48e027c892b6510a1a2440c744efc3",
      "tree": {
        "sha": "11270fc5f163dff5cfa98eb4e9417671dbcf701f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/11270fc5f163dff5cfa98eb4e9417671dbcf701f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f50fa248f1d904be5f33a29c837f74a2cca8abc0",
          "sha": "f50fa248f1d904be5f33a29c837f74a2cca8abc0",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f50fa248f1d904be5f33a29c837f74a2cca8abc0"
        }
      ],
      "message": "Move block-arrival information / preciousblock counters to ChainstateManager\n\nBlock arrival information (and the preciousblock RPC, a related concept) are\nboth chainstate-agnostic, so these are moved to ChainstateManager.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T12:34:33Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T11:50:51Z"
      },
      "sha": "53165d0d5a48e027c892b6510a1a2440c744efc3"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc5MmEwZDY2ODM0ZTVkYzQ4M2RhNzYyY2JiNWM3M2I5MjQ3MDUzMDE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/792a0d66834e5dc483da762cbb5c73b924705301",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/792a0d66834e5dc483da762cbb5c73b924705301",
      "tree": {
        "sha": "c16a821302734e225cb6707ee4b61f19d74092ef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c16a821302734e225cb6707ee4b61f19d74092ef"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/53165d0d5a48e027c892b6510a1a2440c744efc3",
          "sha": "53165d0d5a48e027c892b6510a1a2440c744efc3",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/53165d0d5a48e027c892b6510a1a2440c744efc3"
        }
      ],
      "message": "Add wrapper for adding entries to a chainstates block index candidates",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T13:17:10Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T13:10:10Z"
      },
      "sha": "792a0d66834e5dc483da762cbb5c73b924705301"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc4MzdmNTIxZGIwYmExNmU0Yjk0NmM3Nzg5ZmZjNzcxYTg0NTY2N2Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7837f521db0ba16e4b946c7789ffc771a845667f",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7837f521db0ba16e4b946c7789ffc771a845667f",
      "tree": {
        "sha": "a57a5cbc952257d1fcddef635865dd9636df898f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a57a5cbc952257d1fcddef635865dd9636df898f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/792a0d66834e5dc483da762cbb5c73b924705301",
          "sha": "792a0d66834e5dc483da762cbb5c73b924705301",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/792a0d66834e5dc483da762cbb5c73b924705301"
        }
      ],
      "message": "Update CheckBlockIndex invariants for snapshotted chains",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:25:28Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T17:56:00Z"
      },
      "sha": "7837f521db0ba16e4b946c7789ffc771a845667f"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk0MDM5OGVlMWMwZjg5NjFiZjkwN2ExMDkyNGQ5ZTc0OTk3ZWY1ZjE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/940398ee1c0f8961bf907a10924d9e74997ef5f1",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/940398ee1c0f8961bf907a10924d9e74997ef5f1",
      "tree": {
        "sha": "4cb86a91c29351b0b626ed81dce4fc613dd4f397",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4cb86a91c29351b0b626ed81dce4fc613dd4f397"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7837f521db0ba16e4b946c7789ffc771a845667f",
          "sha": "7837f521db0ba16e4b946c7789ffc771a845667f",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7837f521db0ba16e4b946c7789ffc771a845667f"
        }
      ],
      "message": "test: Clear block index flags when testing snapshots\n\nWhen simulating a snapshot, remove the HAVE_DATA status for blocks below the\nsnapshot height, to simulate never having downloaded them at all.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:35:37Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:35:37Z"
      },
      "sha": "940398ee1c0f8961bf907a10924d9e74997ef5f1"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDkzZDVhN2E1YmMxMDY1YWQ3ZTJkODUwNzk0MTk2YzNmOTM0MGU0MDI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/93d5a7a5bc1065ad7e2d850794196c3f9340e402",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/93d5a7a5bc1065ad7e2d850794196c3f9340e402",
      "tree": {
        "sha": "a25685a268f42b2e61e5bb5047cc5197f84d9dce",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a25685a268f42b2e61e5bb5047cc5197f84d9dce"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/940398ee1c0f8961bf907a10924d9e74997ef5f1",
          "sha": "940398ee1c0f8961bf907a10924d9e74997ef5f1",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/940398ee1c0f8961bf907a10924d9e74997ef5f1"
        }
      ],
      "message": "Move block-storage-related logic to ChainstateManager\n\nThe idea is to fully separate the notion of which blocks are stored on disk,\nand what data is in our block index, from what tip a chainstate might be able\nto get to. The snapshot-chainstate (if we have one) can use different validation\nrules than the background-validation-chainstate in order to treat blocks that\nare assumed to be valid as legitimate for advancing the chain. So, we can use\nchainstate-agnostic logic to download and store blocks, and let the chainstates\nfigure out for themselves when to advance the tip.\n\nThis commit is missing validation logic (probably something in\nFindMostWorkChain and TryAddBlockIndexCandidate) to do the appropriate\nfiltering so that the two chainstates are able to proceed according to their\ndifferent rules. See comment in validation.cpp.\n\nNote: some of the invariants in CheckBlockIndex are modified, but more work is\nneeded (ie to move CheckBlockIndex to ChainstateManager, as most of what\nCheckBlockIndex is doing is checking the consistency of the block index, which\nis outside of Chainstate).",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:37:01Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T12:24:43Z"
      },
      "sha": "93d5a7a5bc1065ad7e2d850794196c3f9340e402"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk5ZTI4YjFhNThiOTg2NGU0ZjM5M2EyYTA2NWVmNjNmMTJlYjhiODU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/99e28b1a58b9864e4f393a2a065ef63f12eb8b85",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/99e28b1a58b9864e4f393a2a065ef63f12eb8b85",
      "tree": {
        "sha": "637df3aa33a97d17f9b0884a0afd224eb156db3d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/637df3aa33a97d17f9b0884a0afd224eb156db3d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/93d5a7a5bc1065ad7e2d850794196c3f9340e402",
          "sha": "93d5a7a5bc1065ad7e2d850794196c3f9340e402",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/93d5a7a5bc1065ad7e2d850794196c3f9340e402"
        }
      ],
      "message": "Tighten requirements for adding elements to setBlockIndexCandidates\n\nWhen using assumeutxo with a snapshot chainstate, we only need the background\nchainstate to consider blocks that are on the chain leading to the snapshotted\nblock.\n\nNote that this introduces the new invariant that we can only have a snapshot\nchainstate where the snapshotted blockhash is in our block index. Not all unit\ntests were enforcing this, so some are removed and will need to be reworked.\nSee FIXME in validation_chainstatemanager_tests.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:37:09Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T17:38:32Z"
      },
      "sha": "99e28b1a58b9864e4f393a2a065ef63f12eb8b85"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGE5NTliZjY2MDhkMTZhZDE0ZGE5NjFhNjAwN2VkZTVmMTU4NzdkZWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a959bf6608d16ad14da961a6007ede5f15877deb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a959bf6608d16ad14da961a6007ede5f15877deb",
      "tree": {
        "sha": "1e1cb1419397f531e5078bbb8686ab09f6b2553c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1e1cb1419397f531e5078bbb8686ab09f6b2553c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/99e28b1a58b9864e4f393a2a065ef63f12eb8b85",
          "sha": "99e28b1a58b9864e4f393a2a065ef63f12eb8b85",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/99e28b1a58b9864e4f393a2a065ef63f12eb8b85"
        }
      ],
      "message": "Fix initialization of setBlockIndexCandidates when working with multiple chainstates\n\nWhen using assumeutxo and multiple chainstates are active, the background\nchainstate should consider all HAVE_DATA blocks on the snapshotted chain that\nhave more work than the tip as potential candidates.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:37:09Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T17:56:37Z"
      },
      "sha": "a959bf6608d16ad14da961a6007ede5f15877deb"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9451556627,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAIzW08T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9451556627",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-06T22:41:59Z"
    },
    {
      "event": "labeled",
      "id": 9451878107,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIzYDbb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9451878107",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-06T23:46:09Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654",
      "pull_request_review_id": 1453921658,
      "id": 1212154654,
      "node_id": "PRRC_kwDOABII585IQAMe",
      "diff_hunk": "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 115,
      "original_position": 101,
      "commit_id": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: this function seems to come out of nowhere and is only used in a test. ",
      "created_at": "2023-05-31T18:43:09Z",
      "updated_at": "2023-05-31T18:44:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 953,
      "original_line": 953,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483",
      "pull_request_review_id": 1453931065,
      "id": 1212161483,
      "node_id": "PRRC_kwDOABII585IQB3L",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": 45,
      "original_position": 36,
      "commit_id": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: maybe use this refactor as an opportunity to add a comment explaining the somewhat obtuse line above",
      "created_at": "2023-05-31T18:48:56Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3451,
      "original_line": 3451,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200",
      "pull_request_review_id": 1453931065,
      "id": 1212164200,
      "node_id": "PRRC_kwDOABII585IQCho",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d if it's broken in master, can we fix it _before_ refactoring? Alternatively there could be a `This will be fixed in the next commit` comment.\r\n\r\nI'm also confused by the comment. `TryAddBlockIndexCandidate` is only called from `ReceivedBlockTransactions` after it sets `BLOCK_VALID_TRANSACTIONS`. So are you saying we're currently too strict? Was there a regression somewhere? \r\n",
      "created_at": "2023-05-31T18:50:12Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301",
      "pull_request_review_id": 1453931065,
      "id": 1212173301,
      "node_id": "PRRC_kwDOABII585IQEv1",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: `\"active\" :\"background\"`?",
      "created_at": "2023-05-31T18:54:47Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629",
      "pull_request_review_id": 1453931065,
      "id": 1212186629,
      "node_id": "PRRC_kwDOABII585IQIAF",
      "diff_hunk": "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 307,
      "original_position": 206,
      "commit_id": "a959bf6608d16ad14da961a6007ede5f15877deb",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d Previously `LoadExternalBlockFile` was only called on the `ActiveChainstate()`, now you're looping over both. This is ok? If possible, it would be good to move the change to `LoadExternalBlockFile` into a separate commit.",
      "created_at": "2023-05-31T19:06:19Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4636,
      "original_line": 4636,
      "side": "RIGHT"
    }
  ]
}