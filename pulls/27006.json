{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006",
    "id": 1223555165,
    "node_id": "PR_kwDOABII585I7fhd",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/27006",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/27006.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/27006.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/acddd4204654812a0e741e04a758be0f362c5ccb",
    "number": 27006,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "reduce cs_main scope, guard block index 'nFile' under a local mutex",
    "user": {
      "login": "furszy",
      "id": 5377650,
      "node_id": "MDQ6VXNlcjUzNzc2NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/furszy",
      "html_url": "https://github.com/furszy",
      "followers_url": "https://api.github.com/users/furszy/followers",
      "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
      "organizations_url": "https://api.github.com/users/furszy/orgs",
      "repos_url": "https://api.github.com/users/furszy/repos",
      "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/furszy/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "By not having to lock `cs_main` every time we try to access block\r\nposition on disk, we can avoid slowing down concurrent tasks due\r\nto threads waiting for the global lock to be released.\r\n\r\nAlso, solves a edge case race inside `ReadBlockFromDisk` where\r\nwe obtain the file position locking `cs_main` and then try to access\r\nthe file without it (the file could no longer exist if pruning occurred\r\njust in-between these two actions).\r\n\r\nContext from where this comes from #26966.",
    "labels": [
      {
        "id": 955867938,
        "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
        "name": "Needs rebase",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2023-01-31T16:10:54Z",
    "updated_at": "2023-05-05T16:58:25Z",
    "mergeable_state": "unknown",
    "merge_commit_sha": "b78316f4dafbe51b7e74d2e970edc20a91a71e7a",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "furszy:2022_reduce_cs_main_scope_blockindex_nfile",
      "ref": "2022_reduce_cs_main_scope_blockindex_nfile",
      "sha": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 143624913,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDM2MjQ5MTM=",
        "name": "bitcoin-core",
        "full_name": "furszy/bitcoin-core",
        "owner": {
          "login": "furszy",
          "id": 5377650,
          "node_id": "MDQ6VXNlcjUzNzc2NTA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/furszy",
          "html_url": "https://github.com/furszy",
          "followers_url": "https://api.github.com/users/furszy/followers",
          "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
          "organizations_url": "https://api.github.com/users/furszy/orgs",
          "repos_url": "https://api.github.com/users/furszy/repos",
          "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/furszy/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/furszy/bitcoin-core",
        "description": "Bitcoin-Core",
        "fork": true,
        "url": "https://api.github.com/repos/furszy/bitcoin-core",
        "archive_url": "https://api.github.com/repos/furszy/bitcoin-core/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/furszy/bitcoin-core/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/furszy/bitcoin-core/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/furszy/bitcoin-core/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/furszy/bitcoin-core/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/furszy/bitcoin-core/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/furszy/bitcoin-core/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/furszy/bitcoin-core/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/furszy/bitcoin-core/contributors",
        "deployments_url": "https://api.github.com/repos/furszy/bitcoin-core/deployments",
        "downloads_url": "https://api.github.com/repos/furszy/bitcoin-core/downloads",
        "events_url": "https://api.github.com/repos/furszy/bitcoin-core/events",
        "forks_url": "https://api.github.com/repos/furszy/bitcoin-core/forks",
        "git_commits_url": "https://api.github.com/repos/furszy/bitcoin-core/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/furszy/bitcoin-core/git/tags%7B/sha%7D",
        "git_url": "git://github.com/furszy/bitcoin-core.git",
        "issue_comment_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/furszy/bitcoin-core/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/furszy/bitcoin-core/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/furszy/bitcoin-core/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/furszy/bitcoin-core/languages",
        "merges_url": "https://api.github.com/repos/furszy/bitcoin-core/merges",
        "milestones_url": "https://api.github.com/repos/furszy/bitcoin-core/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/furszy/bitcoin-core/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/furszy/bitcoin-core/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/furszy/bitcoin-core/releases%7B/id%7D",
        "ssh_url": "git@github.com:furszy/bitcoin-core.git",
        "stargazers_url": "https://api.github.com/repos/furszy/bitcoin-core/stargazers",
        "statuses_url": "https://api.github.com/repos/furszy/bitcoin-core/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/furszy/bitcoin-core/subscribers",
        "subscription_url": "https://api.github.com/repos/furszy/bitcoin-core/subscription",
        "tags_url": "https://api.github.com/repos/furszy/bitcoin-core/tags",
        "teams_url": "https://api.github.com/repos/furszy/bitcoin-core/teams",
        "trees_url": "https://api.github.com/repos/furszy/bitcoin-core/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/furszy/bitcoin-core.git",
        "hooks_url": "https://api.github.com/repos/furszy/bitcoin-core/hooks",
        "svn_url": "https://github.com/furszy/bitcoin-core",
        "homepage": "",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 380259,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T20:18:24Z",
        "created_at": "2018-08-05T15:28:43Z",
        "updated_at": "2023-02-27T18:01:49Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "7753efcbcf3ca2e1b46f167936e11cc580e28c7a",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 34325,
        "stargazers_count": 69818,
        "watchers_count": 69818,
        "size": 233879,
        "default_branch": "master",
        "open_issues_count": 626,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-07T07:29:24Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-06-07T06:49:43Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 186,
    "deletions": 37,
    "changed_files": 13,
    "commits": 3,
    "review_comments": 15,
    "comments": 8
  },
  "events": [
    {
      "event": "commented",
      "id": 1410662315,
      "node_id": "IC_kwDOABII585UFP-r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410662315",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T16:10:57Z",
      "updated_at": "2023-05-05T06:18:08Z",
      "author_association": "MEMBER",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1342121063) |\n| Approach NACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1368758608) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27576](https://github.com/bitcoin/bitcoin/pull/27576) (kernel: Remove args, chainparams, chainparamsbase from kernel library by TheCharlatan)\n* [#27570](https://github.com/bitcoin/bitcoin/pull/27570) (refactor: Remove need to pass chainparams to BlockManager methods by MarcoFalke)\n* [#27469](https://github.com/bitcoin/bitcoin/pull/27469) (wallet: improve IBD sync time by skipping block scanning prior birth time by furszy)\n* [#27125](https://github.com/bitcoin/bitcoin/pull/27125) (refactor, kernel: Decouple ArgsManager from blockstorage by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1410662315",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "renamed",
      "id": 8401376480,
      "node_id": "RTE_lADOABII585dQgnQzwAAAAH0wtTg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8401376480",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T16:10:58Z",
      "rename": {
        "from": "reduce cs_main scope, guard block index 'nFile' under a local mutex ",
        "to": "reduce cs_main scope, guard block index 'nFile' under a local mutex"
      }
    },
    {
      "event": "reviewed",
      "id": 1277605951,
      "node_id": "PRR_kwDOABII585MJrg_",
      "url": null,
      "actor": null,
      "commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1277605951",
      "submitted_at": "2023-01-31T16:32:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ3YmM5OWNkZGM1MThkYzQxNzQxYzVkY2MxN2Y5ZTYyOWUxNjI0NDk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/47bc99cddc518dc41741c5dcc17f9e629e162449",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/47bc99cddc518dc41741c5dcc17f9e629e162449",
      "tree": {
        "sha": "ab9106f2348856eb1f86898cb7b8b0d622ae05e3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ab9106f2348856eb1f86898cb7b8b0d622ae05e3"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree ab9106f2348856eb1f86898cb7b8b0d622ae05e3\nparent ea41abade4b752d9f72a472cd66d7bf330e46ce2\nauthor furszy <matiasfurszyfer@protonmail.com> 1675179191 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1675349206 -0300\n\nblockindex: do not point to file 0 if data does not exist\n\nbetter to store an invalid file number to describe\nblock indexes with no data on disk.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmPbzNcACgkQXdI8zGhq\npiMB8RAAz+FVMwBxcQVh4Mw+0a+ltdkGjSyKlsP0CxHGXiOHdVswu4T4EQPenANu\nA4zhRK5ieEbZoT/wB49wZ6awbDUcHCre1GbXwM5lDLQV2M1APZbu4YZNZvCa6anN\n/Z+syAIrK+XdERQvD+iqdYnxBJxDBrVVN0Y9jsTV4rd9PrkT3WxpALiBzmkYTpcf\n33P0xCNgqjVbnRlklaMbrCK02p+mJ4G79UFNTmDDDvtYs0XS1R4Gd9s3916oelWu\nBskQU6eeqX4wuwRNbuRPNuwm1JR03QUHyxLSXHmLm38d0Tx15Nwbbdyj3LMzImrC\nNcUGL3siHkYuhR2kbvSo5Fkfz11xQNvZcK6+G5P1/Nd9TCG353IH2pRC7ypdFVtP\n+B/Ydw5efRckoOHZ6RFl/09sE0t0e94OORkwzewaNysanaXxoP5X7LP9ZnHrOnni\n0qNq4WhzkIl7xLbRBRJ1KeU/Pdxv3AKO4V4+QJEF+6Fr88oiG0BMEghNQlO00OtA\nWYJcNEsh061nLYEfeEKYkPFXVlgFpVakdI8T5CVgnkorsQqLDpHi+W63kywYYJVS\nk2I47nCk7mLnFMyG3ScM3c87hAbNOv17j+0WGdnVR2L2bS2yTik/bJBG66/FSVZk\n8mrw+9jOl+g3upvD7lgGIZGwa1ZyXe1Q72nY9xNYeghSCs0vKpo=\n=um9H\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ea41abade4b752d9f72a472cd66d7bf330e46ce2",
          "sha": "ea41abade4b752d9f72a472cd66d7bf330e46ce2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ea41abade4b752d9f72a472cd66d7bf330e46ce2"
        }
      ],
      "message": "blockindex: do not point to file 0 if data does not exist\n\nbetter to store an invalid file number to describe\nblock indexes with no data on disk.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-02-02T14:46:46Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-01-31T15:33:11Z"
      },
      "sha": "47bc99cddc518dc41741c5dcc17f9e629e162449"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 8424502193,
      "node_id": "HRFPE_lADOABII585dQgnQzwAAAAH2I7Ox",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8424502193",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-02T18:58:14Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDY1N2UzMDg2YWQ4MTcxZjc5OWE3ZWI0MjI2YzZkMWMyZGQ1NjJhMzk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/657e3086ad8171f799a7eb4226c6d1c2dd562a39",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/657e3086ad8171f799a7eb4226c6d1c2dd562a39",
      "tree": {
        "sha": "158cc47eed8119bc774b7d7e745b3ca896961ac7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/158cc47eed8119bc774b7d7e745b3ca896961ac7"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 158cc47eed8119bc774b7d7e745b3ca896961ac7\nparent 47bc99cddc518dc41741c5dcc17f9e629e162449\nauthor furszy <matiasfurszyfer@protonmail.com> 1675341811 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1675367016 -0300\n\nsync: implement annotated shared_mutex\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmPcEmgACgkQXdI8zGhq\npiMbKw//SqFCB38btrGU22rp0hDDuFWMf5rvp6KGCxoyoXaTLUPNSw+OGKjKXufy\nvFQF1z1tVSsJGd9/ctS7Z41J3hbbZd3stBABUTqXsttlrGgZN7DFzgdIbNTmL8iT\nxtNbqQCkSaTEbwOJBDxkAz+EXJ1SOx82aJvImRPTkcjeecAhJD62FX9GsW6VZfY/\nL4PspLfyUDt6TvUaWrIOfcSAeAGDLejMUHx4FcLVD0aC00BLckxL9F6OAClmVx81\nAlWpLytbc2M3+SCbFyPi42oXplM8LWYNK4pV6shMEFNktg4x/08m6XWz06vZJc0m\nbaeftLmX7C7fG7xufvv+61bCCuD3V1XFuhQ7OVmzOtBTjQK3Dj3xHUCs+10oObRh\nFK2SzWh23Izk/s9n+8F+XMgiehtP/FbYtt/zhcv9U/lzyy8BfnRn8D7D3cRvgEmT\nbILw6cWlklf8Rh6C9mNz66yH1bjWmdlvbpjdtMBxYb4AGB8KHb9c7g2yK20L20Ax\nncapgA1lTCRgvOS3FU0hp6zdvumXQyT8/JI6EhJC1GZQSvUGQ0h8Ow63tlN8YT7R\nPa3fwZUmX6DGDAf7eFUUzE8x6Efc15BTSSt1igbO7BisfM9bCLD1OCbIPoY+i8m5\nT0sLx5bzkJDlmlC4Neuqq/KXBcqzYiAT01Qm1PSO3yAIFxavyOw=\n=EmPK\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/47bc99cddc518dc41741c5dcc17f9e629e162449",
          "sha": "47bc99cddc518dc41741c5dcc17f9e629e162449",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/47bc99cddc518dc41741c5dcc17f9e629e162449"
        }
      ],
      "message": "sync: implement annotated shared_mutex",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-02-02T19:43:36Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-02-02T12:43:31Z"
      },
      "sha": "657e3086ad8171f799a7eb4226c6d1c2dd562a39"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGFjZGRkNDIwNDY1NDgxMmEwZTc0MWUwNGE3NThiZTBmMzYyYzVjY2I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/acddd4204654812a0e741e04a758be0f362c5ccb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/acddd4204654812a0e741e04a758be0f362c5ccb",
      "tree": {
        "sha": "5fbb45fc8b7a679582260d47265a94fb0290174c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5fbb45fc8b7a679582260d47265a94fb0290174c"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 5fbb45fc8b7a679582260d47265a94fb0290174c\nparent 657e3086ad8171f799a7eb4226c6d1c2dd562a39\nauthor furszy <matiasfurszyfer@protonmail.com> 1674923195 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1675367016 -0300\n\nreduce cs_main scope, guard block index 'nFile' under a read/write mutex\n\nBy not having to lock cs_main every time we access block data on disk,\nwe can avoid slowing down concurrent tasks due to threads waiting\nfor the lock to be released.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmPcEmgACgkQXdI8zGhq\npiOv6A/+Lx4MEweu0pgjOwC+KQ3bT/X9hh6A1kGWtavelUo0Lvm9lEc0Yn6gq4hC\nkRX3BgfU6AD49xgU3auBdx1VPcx8uYLcwCxWr4Zc07n4BqXK3Ppoxg0A5ym8waPO\nJ0PCFp8TMkWvik1pExmgZ7GxqeQHB2iSDluVsrOZ4td67ekZJY0jYXjDKUdwClvk\nsa9KpIgyzVi/wAzu34+2xfSO+wsVMyoP2oZsZaiLlkBd8QqjSWCzjD8SiGwsvSS0\nQZmQu5iqVPZiUyPHhKQH3F1vgGFaX2IpnjJQFReyB1CEhX2C7yK28bWXXvxLwBoM\nm03gcn5wiTvW6Wh70ZNY23w/zVnQxjbe+Tb81BObcY0Ng0i58T1VaPIG8HqjpIBv\nVIUh1Wlce4a1QO0XEuTM73j3onDmIutCimGFnKQvk3vdDvjNuue4Xz/fEnCC0pCX\nLmeMhDcuU97E1cFDfn45BDQtK0i9+38qi5HELoh79D6LEu0zZ52X2NYlqvDCP5XG\naW84TRFIm/pTAKzAAEJml2VmwgF0BaQOGOfsXYeUEL2kSR/CidJ2c1xFHOcz1I1Y\noOAoifbdLh1dbAUMlxYSNWGPVaCvht/Avi86npTvaM+2rb9dYuCd05nLO51CUf8e\nX1dzG4O8bvpKNtQ3pJIalGofzk4sOTrzx2rSRpGcxANdo9A0J7s=\n=ygZL\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/657e3086ad8171f799a7eb4226c6d1c2dd562a39",
          "sha": "657e3086ad8171f799a7eb4226c6d1c2dd562a39",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/657e3086ad8171f799a7eb4226c6d1c2dd562a39"
        }
      ],
      "message": "reduce cs_main scope, guard block index 'nFile' under a read/write mutex\n\nBy not having to lock cs_main every time we access block data on disk,\nwe can avoid slowing down concurrent tasks due to threads waiting\nfor the lock to be released.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-02-02T19:43:36Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-01-28T16:26:35Z"
      },
      "sha": "acddd4204654812a0e741e04a758be0f362c5ccb"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 8424920915,
      "node_id": "HRFPE_lADOABII585dQgnQzwAAAAH2KhdT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8424920915",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-02T19:44:13Z"
    },
    {
      "event": "reviewed",
      "id": 1319432351,
      "node_id": "PRR_kwDOABII585OpPCf",
      "url": null,
      "actor": null,
      "commit_id": "47bc99cddc518dc41741c5dcc17f9e629e162449",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1319432351",
      "submitted_at": "2023-03-01T09:41:26Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
    },
    {
      "event": "reviewed",
      "id": 1342108027,
      "node_id": "PRR_kwDOABII585P_vF7",
      "url": null,
      "actor": null,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "LarryRuane",
        "id": 8321330,
        "node_id": "MDQ6VXNlcjgzMjEzMzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/LarryRuane",
        "html_url": "https://github.com/LarryRuane",
        "followers_url": "https://api.github.com/users/LarryRuane/followers",
        "following_url": "https://api.github.com/users/LarryRuane/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/LarryRuane/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/LarryRuane/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
        "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
        "repos_url": "https://api.github.com/users/LarryRuane/repos",
        "events_url": "https://api.github.com/users/LarryRuane/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1342108027",
      "submitted_at": "2023-03-15T18:10:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
    },
    {
      "event": "reviewed",
      "id": 1342121063,
      "node_id": "PRR_kwDOABII585P_yRn",
      "url": null,
      "actor": null,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\nIs my understanding correct that 1) replacing `cs_main` with `g_cs_blockindex_data` and 2) having `g_cs_blockindex_data` be a shared instead of recursive/exclusive mutex are orthogonal improvements? I think it makes sense for both of them to happen in this PR, just wondering.",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1342121063",
      "submitted_at": "2023-03-15T18:17:33Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
    },
    {
      "event": "commented",
      "id": 1481222148,
      "node_id": "IC_kwDOABII585YSagE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1481222148",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-03-23T13:44:39Z",
      "updated_at": "2023-03-23T13:44:39Z",
      "author_association": "MEMBER",
      "body": "> Concept ACK\r\n> \r\n> Is my understanding correct that 1) replacing `cs_main` with `g_cs_blockindex_data` and 2) having `g_cs_blockindex_data` be a shared instead of recursive/exclusive mutex are orthogonal improvements? I think it makes sense for both of them to happen in this PR, just wondering.\r\n\r\nMoving `cs_main` to an blockstorage local exclusive mutex would still be an improvement from the current state, yeah. The networking threads (and pretty much the entire node) shouldn't get blocked because the user called the `getblock` RPC command.\r\n\r\nBut, the usage of an exclusive mutex here still means no concurrent block data access. Which is a shame as accessing block 124 on disk shouldn't block the entire node from accessing block 750,000 on disk (nor any other block). They are on different files.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1481222148",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "reviewed",
      "id": 1368758608,
      "node_id": "PRR_kwDOABII585RlZlQ",
      "url": null,
      "actor": null,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK on reducing `cs_main` scope.\r\n\r\nApproach NACK for adding new globals. It is not worth going with a worse design to \"rush in\" an improvement for a feature that may or may not happen (#26966). I would prefer to go with a more sustainable approach from the get go, otherwise this will need to be refactored in the long run.\r\n\r\nI don't see why the mutex could not be a member of `BlockManager`. Like you say in https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1481222148, giving `BlockManager` its own internal lock(s) instead of `cs_main` is the preferable long term design. ",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#pullrequestreview-1368758608",
      "submitted_at": "2023-04-03T10:34:38Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
    },
    {
      "event": "commented",
      "id": 1494553264,
      "node_id": "IC_kwDOABII585ZFRKw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1494553264",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-04-03T15:39:19Z",
      "updated_at": "2023-04-03T15:39:19Z",
      "author_association": "MEMBER",
      "body": "Hey dergoegge, thanks for the feedback.\r\n\r\n> Approach NACK for adding new globals. It is not worth going with a worse design to \"rush in\" an improvement for a feature that may or may not happen ([#26966](https://github.com/bitcoin/bitcoin/pull/26966)). I would prefer to go with a more sustainable approach from the get go, otherwise this will need to be refactored in the long run.\r\n\r\nNo rush here.\r\n[#26966](https://github.com/bitcoin/bitcoin/pull/26966) is only one clear use case. It isn’t the main one actually, there are other areas that shouldn’t be locking the net messages reception / validation thread because of a disk read: e.g. “getblock”, “getblocktxn” and compact block net messages, the current indexes sync process (all of them), `getblock`/`gettxoutproof` RPC commands. They all are locking the node at every single block read.\r\n\r\n> I don't see why the mutex could not be a member of BlockManager. Like you say in [#27006 (comment)](https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1481222148), giving BlockManager its own internal lock(s) instead of cs_main is the preferable long term design.\r\n\r\nI'm not opposed to it but there are few problems with that approach:\r\n\r\n- `BlockStorage` depends on `CBlockIndex` and not in the other way around, so moving the mutex to `BlockStorage` would leave `CBlockIndex` members with no thread safety analysis annotations.\r\n\r\n- The `ReadBlockFromDisk` and `UndoReadFromDisk` functions are currently global functions. They do not have access to the BlockManager class members.\r\n\r\nThe second point can be fixed by refactoring the functions into the class but the first one is more complex. We have to avoid adding a `chain.h` <-> `blockstorage.h` cyclic dependency.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1494553264",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "commented",
      "id": 1496041020,
      "node_id": "IC_kwDOABII585ZK8Y8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1496041020",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-04-04T14:08:17Z",
      "updated_at": "2023-04-04T14:08:17Z",
      "author_association": "MEMBER",
      "body": "> It isn’t the main one actually, there are other areas that shouldn’t be locking the net messages reception / validation thread because of a disk read: e.g. “getblock”, “getblocktxn” and compact block net messages, the current indexes sync process (all of them), getblock/gettxoutproof RPC commands. They all are locking the node at every single block read.\r\n\r\nThis has been the case for 10+ years, if we're gonna change it then we should take the time to do it without adding to our technical debt.\r\n\r\n> I'm not opposed to it but there are few problems with that approach:\r\n\r\nI agree that it is more work but it is worth doing imo and we are clearly in no rush.\r\n\r\n> The ReadBlockFromDisk and UndoReadFromDisk functions are currently global functions. They do not have access to the BlockManager class members.\r\n\r\nThis is being done in #27125.\r\n\r\n> the first one is more complex. We have to avoid adding a chain.h <-> blockstorage.h cyclic dependency.\r\n\r\nMove `CBlockIndex` to a new header file and have `chain` and `blockstorage` include that?\r\n",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1496041020",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "commented",
      "id": 1496122583,
      "node_id": "IC_kwDOABII585ZLQTX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1496122583",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-04-04T14:56:51Z",
      "updated_at": "2023-04-04T14:58:21Z",
      "author_association": "MEMBER",
      "body": "> > It isn’t the main one actually, there are other areas that shouldn’t be locking the net messages reception / validation thread because of a disk read: e.g. “getblock”, “getblocktxn” and compact block net messages, the current indexes sync process (all of them), getblock/gettxoutproof RPC commands. They all are locking the node at every single block read.\r\n> \r\n> This has been the case for 10+ years, if we're gonna change it then we should take the time to do it without adding to our technical debt.\r\n\r\nI never said the opposite. Not sure why the \"rush\" term is being used here really. I haven't said anything like \"this is great, we must have it now\".. (nor here nor anywhere in the repository).\r\n\r\nI was trying to give you more context, answering to your \"It is not worth going with a worse design to \"rush in\" an improvement for a feature that may or may not happen (https://github.com/bitcoin/bitcoin/pull/26966)\".\r\n\r\nI'm happy to continue discussing stuff and improve what needs to be improved.\r\n\r\n> > the first one is more complex. We have to avoid adding a chain.h <-> blockstorage.h cyclic dependency.\r\n> \r\n> Move `CBlockIndex` to a new header file and have `chain` and `blockstorage` include that?\r\n\r\nHow that solves the problem?\r\n\r\nPlacing the mutex inside block storage means that any field that is guarded by this new mutex will need block storage dependency. So don't care where we place `CBlockIndex`, it will need blockstorage dependency to use the thread analysis annotation. Which will cause a cyclic dependency.\r\n\r\nA possible solution would be to place the mutex in a separate file. So blockstorage and `CBlockIndex` can include it independently.\r\n\r\nOr.. thinking out loud: something somewhat \"radical\" could be move `nFile`, `nData` and `nUndoData` members out of `CBlockIndex`, into the blockstorage class. We could place them into an unordered map <block_id, FileData>.\r\n\r\nWhich, in a first glance, sounds quite positive. As we are currently mixing two concepts into the same container. `CBlockIndex` currently is used to store the chain in a sort of linked list structure while it also contains the position of the block data on disk.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1496122583",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "commented",
      "id": 1496245186,
      "node_id": "IC_kwDOABII585ZLuPC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1496245186",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-04-04T16:10:08Z",
      "updated_at": "2023-04-04T16:10:08Z",
      "author_association": "MEMBER",
      "body": "> I never said the opposite. Not sure why the \"rush\" term is being used here really. I haven't said anything like \"this is great, we must have it now\".. (nor here nor anywhere in the repository).\r\n\r\nI'm sorry didn't mean to put words in your mouth. It seemed rushed to me because you are going with an \"easier\" solution here rather than the more complex but (imo) worth while long term design.\r\n\r\n> it will need blockstorage dependency to use the thread analysis annotation\r\n\r\nI was thinking of not adding the annotations in this case. Which is not great but seems better to me than adding more globals.\r\n\r\n> Or.. thinking out loud: something somewhat \"radical\" could be move nFile, nData and nUndoData members out of CBlockIndex, into the blockstorage class. We could place them into an unordered map <block_id, FileData>.\r\n\r\nThis separates the concerns nicely and lets us add annotations, I would be happy with this :) The only thing that's a bit weird then is maintaining the on-disk format for the block index entries but that seems workable.",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1496245186",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "commented",
      "id": 1497934186,
      "node_id": "IC_kwDOABII585ZSKlq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1497934186",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-04-05T18:28:26Z",
      "updated_at": "2023-04-05T18:28:26Z",
      "author_association": "MEMBER",
      "body": "> > I never said the opposite. Not sure why the \"rush\" term is being used here really. I haven't said anything like \"this is great, we must have it now\".. (nor here nor anywhere in the repository).\r\n> \r\n> I'm sorry didn't mean to put words in your mouth. It seemed rushed to me because you are going with an \"easier\" solution here rather than the more complex but (imo) worth while long term design.\r\n\r\nWell, this PR didn't have any long term design goal discussion prior to your arrival.\r\nI'm happy that it happened as it pushed us to think about the \"radical\" change mentioned above.\r\n\r\n> > it will need blockstorage dependency to use the thread analysis annotation\r\n> \r\n> I was thinking of not adding the annotations in this case. Which is not great but seems better to me than adding more globals.\r\n\r\nI'm on the other side of the fence actually. While globals aren't ideal, particularly for testing, I prefer them over loosing thread safety analysis as it is essential to prevent deadlocks.\r\n\r\n> > Or.. thinking out loud: something somewhat \"radical\" could be move nFile, nData and nUndoData members out of CBlockIndex, into the blockstorage class. We could place them into an unordered map <block_id, FileData>.\r\n> \r\n> This separates the concerns nicely and lets us add annotations, I would be happy with this :) The only thing that's a bit weird then is maintaining the on-disk format for the block index entries but that seems workable.\r\n\r\nYeah, the read shouldn’t be that hard. And a db upgrade mechanism is doable too.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1497934186",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    },
    {
      "event": "labeled",
      "id": 9178783705,
      "node_id": "LE_lADOABII585dQgnQzwAAAAIjGR_Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9178783705",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-05T16:58:24Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1536532195,
      "node_id": "IC_kwDOABII585blZ7j",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1536532195",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-05T16:58:25Z",
      "updated_at": "2023-05-05T16:58:25Z",
      "author_association": "MEMBER",
      "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n🐙 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#issuecomment-1536532195",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27006"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092197196",
      "pull_request_review_id": 1277605951,
      "id": 1092197196,
      "node_id": "PRRC_kwDOABII585BGZtM",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": null,
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Huh? Does this create a mutex for every block? What is the memory footprint?",
      "created_at": "2023-01-31T16:32:40Z",
      "updated_at": "2023-01-31T16:32:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1092197196",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092197196"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092379688",
      "pull_request_review_id": 1277874987,
      "id": 1092379688,
      "node_id": "PRRC_kwDOABII585BHGQo",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "yeah, good topic. I was so focused on accessing disk concurrently that forgot that we have 800k block indexes loaded in memory all the time.\r\nThe mutex size is 64 bytes, so.. a mutex per block index is a no go.\r\n\r\nCould move it to a single global mutex for block indexes file data access, which would still decouple it from `cs_main` (which is a good step forward) but.. it's still not the best solution for concurrent access.",
      "created_at": "2023-01-31T19:22:02Z",
      "updated_at": "2023-01-31T19:22:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1092379688",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092379688"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092498210",
      "pull_request_review_id": 1278046331,
      "id": 1092498210,
      "node_id": "PRRC_kwDOABII585BHjMi",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Could move it to a single global mutex for block indexes file data access, which would still decouple it from cs_main (which is a good step forward) but.. it's still not the best solution for concurrent access.\n\nReaders/Writer lock?",
      "created_at": "2023-01-31T21:26:50Z",
      "updated_at": "2023-01-31T21:26:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1092498210",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1092498210"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094618214",
      "pull_request_review_id": 1281191696,
      "id": 1094618214,
      "node_id": "PRRC_kwDOABII585BPoxm",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Working on it 👌🏼 ",
      "created_at": "2023-02-02T14:39:49Z",
      "updated_at": "2023-02-02T14:39:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1094618214",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1094618214"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098733722",
      "pull_request_review_id": 1287214126,
      "id": 1098733722,
      "node_id": "PRRC_kwDOABII585BfVia",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "^ is this done, or still in progress?",
      "created_at": "2023-02-07T14:27:16Z",
      "updated_at": "2023-02-07T14:27:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1098733722",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098733722"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098745121",
      "pull_request_review_id": 1287231129,
      "id": 1098745121,
      "node_id": "PRRC_kwDOABII585BfYUh",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> ^ is this done, or still in progress?\r\n\r\nYeah, have pushed the readers/writer lock in the last update.\r\n\r\nStill, have to say that code elegancy wise, I'm not totally happy with the `sync.h` shared lock wrapper. Planning to give it another look later this week.",
      "created_at": "2023-02-07T14:35:49Z",
      "updated_at": "2023-02-07T14:35:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1098745121",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098745121"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098769193",
      "pull_request_review_id": 1287266827,
      "id": 1098769193,
      "node_id": "PRRC_kwDOABII585BfeMp",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Why not do a mutex per blockfile (rather than CBlockIndex entry, which would indeed be crazy)? There are hundreds to thousands of those, so keeping a map of blockfile number to mutex shouldn't be unreasonable.",
      "created_at": "2023-02-07T14:53:23Z",
      "updated_at": "2023-02-07T14:53:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1098769193",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098769193"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098814063",
      "pull_request_review_id": 1287334544,
      "id": 1098814063,
      "node_id": "PRRC_kwDOABII585BfpJv",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "While that would be better than the initial per `CBlockIndex` entry mutex, it's not as good as a single RW lock (which is the current PR state).\r\n\r\nEssentially, we aim to allow concurrent access for read-only operations, while write operations that are not performed regularly require exclusive access (which is the RW lock purpose).\r\n\r\nTo place it more in our code. The only time where the `CBlockIndex` file position can be modified during the entire software lifecycle is pruning, and it's done only once. And because of that single infrequent scenario, we have been forced to lock `cs_main` every time that a process accesses the block index file position.\r\n\r\nSo, by guarding this single specific case with an exclusive lock, the rest of the read-only operations can be processed concurrently by sharing ownership of the readers-only lock.",
      "created_at": "2023-02-07T15:26:22Z",
      "updated_at": "2023-02-07T16:06:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1098814063",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098814063"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098864968",
      "pull_request_review_id": 1287410612,
      "id": 1098864968,
      "node_id": "PRRC_kwDOABII585Bf1lI",
      "diff_hunk": "@@ -162,14 +162,16 @@ class CBlockIndex\n     //! height of the entry in the chain. The genesis block has height 0\n     int nHeight{0};\n \n+    const std::shared_ptr<Mutex> cs_data = std::make_shared<Mutex>();",
      "path": "src/chain.h",
      "position": null,
      "original_position": 4,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "6f41153d3cb9a7bad52473ec68b7dc200cce2667",
      "in_reply_to_id": 1092197196,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "A little add to my last comment:\r\n\r\nI think that if we ever add other use cases that modify the block index file position more frequently (like re-ordering/compacting block data on disk or re-downloading blocks), then a more fine-grained RW lock per block file would be a nice idea.\r\n\r\n-- the comment came to my mind because one of my long-term projects introduces the pruned blocks re-download feature.. --",
      "created_at": "2023-02-07T16:02:38Z",
      "updated_at": "2023-02-07T16:02:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1098864968",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1098864968"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1121419524",
      "pull_request_review_id": 1319432351,
      "id": 1121419524,
      "node_id": "PRRC_kwDOABII585C14EE",
      "diff_hunk": "@@ -127,7 +127,7 @@ void BlockManager::PruneOneBlockFile(const int fileNumber)\n         if (pindex->nFile == fileNumber) {\n             pindex->nStatus &= ~BLOCK_HAVE_DATA;\n             pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n-            pindex->nFile = 0;\n+            pindex->nFile = -1;",
      "path": "src/node/blockstorage.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "47bc99cddc518dc41741c5dcc17f9e629e162449",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "47bc99cddc518dc41741c5dcc17f9e629e162449 This is probably fine, but there's a bunch a places that we have to make sure are never reached. For example in `FindBlockPos(` we do `_blockfile_info[nFile]` where `nFile = ... pos.nFile`. I'll have to review that a bit more.",
      "created_at": "2023-03-01T09:41:26Z",
      "updated_at": "2023-03-01T09:41:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1121419524",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1121419524"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 130,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137557817",
      "pull_request_review_id": 1342108027,
      "id": 1137557817,
      "node_id": "PRRC_kwDOABII585DzcE5",
      "diff_hunk": "@@ -16,9 +16,8 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     if (index) {\n         info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n         info.height = index->nHeight;\n-        LOCK(::cs_main);\n-        info.file_number = index->nFile;\n-        info.data_pos = index->nDataPos;\n+        info.file_number = index->GetFileNum();\n+        info.data_pos = index->GetDataPos();",
      "path": "src/kernel/chain.cpp",
      "position": 8,
      "original_position": 8,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "in_reply_to_id": null,
      "user": {
        "login": "LarryRuane",
        "id": 8321330,
        "node_id": "MDQ6VXNlcjgzMjEzMzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/LarryRuane",
        "html_url": "https://github.com/LarryRuane",
        "followers_url": "https://api.github.com/users/LarryRuane/followers",
        "following_url": "https://api.github.com/users/LarryRuane/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/LarryRuane/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/LarryRuane/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
        "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
        "repos_url": "https://api.github.com/users/LarryRuane/repos",
        "events_url": "https://api.github.com/users/LarryRuane/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Shouldn't these be fetched atomically? Maybe there should be a getter that returns all three values, similar to how there's a setter (`CBlockIndex::SetFileData`) than sets all three atomically.",
      "created_at": "2023-03-15T18:10:40Z",
      "updated_at": "2023-03-15T18:10:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1137557817",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137557817"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": 19,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138503518",
      "pull_request_review_id": 1343524711,
      "id": 1138503518,
      "node_id": "PRRC_kwDOABII585D3C9e",
      "diff_hunk": "@@ -16,9 +16,8 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     if (index) {\n         info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n         info.height = index->nHeight;\n-        LOCK(::cs_main);\n-        info.file_number = index->nFile;\n-        info.data_pos = index->nDataPos;\n+        info.file_number = index->GetFileNum();\n+        info.data_pos = index->GetDataPos();",
      "path": "src/kernel/chain.cpp",
      "position": 8,
      "original_position": 8,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "in_reply_to_id": 1137557817,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Starting to feel like a struct for those 3 members would be appropriate",
      "created_at": "2023-03-16T11:26:58Z",
      "updated_at": "2023-03-16T11:26:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1138503518",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1138503518"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": 19,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146202462",
      "pull_request_review_id": 1354635917,
      "id": 1146202462,
      "node_id": "PRRC_kwDOABII585EUale",
      "diff_hunk": "@@ -16,9 +16,8 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     if (index) {\n         info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n         info.height = index->nHeight;\n-        LOCK(::cs_main);\n-        info.file_number = index->nFile;\n-        info.data_pos = index->nDataPos;\n+        info.file_number = index->GetFileNum();\n+        info.data_pos = index->GetDataPos();",
      "path": "src/kernel/chain.cpp",
      "position": 8,
      "original_position": 8,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "in_reply_to_id": 1137557817,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Shouldn't these be fetched atomically? Maybe there should be a getter that returns all three values, similar to how there's a setter (`CBlockIndex::SetFileData`) than sets all three atomically.\r\n\r\n@LarryRuane I didn't add it merely to not introduce that many changes but could be done too. The members set is guarded by `cs_main` (for now) so there is no possible race.\r\n\r\n> Starting to feel like a struct for those 3 members would be appropriate\r\n\r\nWhy exactly?. So far in the code, we either want the block data position or the block undo data position, we don't get both at the same time because they represent different files on disk (thus why they are returned inside `FlatFilePos`, the struct groups only one of them with the file number).\r\n\r\nIn other words, nData + nFile maps to a \"blk<nFile>.dat\", while nUndoData + nFile maps to an specific \"rev<nFile>.dat\".",
      "created_at": "2023-03-23T13:30:47Z",
      "updated_at": "2023-03-23T13:30:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1146202462",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146202462"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": 19,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1154827107",
      "pull_request_review_id": 1367490327,
      "id": 1154827107,
      "node_id": "PRRC_kwDOABII585E1UNj",
      "diff_hunk": "@@ -16,9 +16,8 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     if (index) {\n         info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n         info.height = index->nHeight;\n-        LOCK(::cs_main);\n-        info.file_number = index->nFile;\n-        info.data_pos = index->nDataPos;\n+        info.file_number = index->GetFileNum();\n+        info.data_pos = index->GetDataPos();",
      "path": "src/kernel/chain.cpp",
      "position": 8,
      "original_position": 8,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "in_reply_to_id": 1137557817,
      "user": {
        "login": "LarryRuane",
        "id": 8321330,
        "node_id": "MDQ6VXNlcjgzMjEzMzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/LarryRuane",
        "html_url": "https://github.com/LarryRuane",
        "followers_url": "https://api.github.com/users/LarryRuane/followers",
        "following_url": "https://api.github.com/users/LarryRuane/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/LarryRuane/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/LarryRuane/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
        "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
        "repos_url": "https://api.github.com/users/LarryRuane/repos",
        "events_url": "https://api.github.com/users/LarryRuane/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Are you sure these are protected by `cs_main`, is it? Running `gdb test_bitcoin` on the PR branch (leaving some irrelevant stuff out):\r\n```\r\n(gdb) b MakeBlockInfo\r\n(gdb) run\r\nThread 29 \"b-basic block f\" hit Breakpoint 1, kernel::MakeBlockInfo (index=0x55555749b018, data=0x0) at kernel/chain.cpp:14\r\n#0  kernel::MakeBlockInfo (index=0x55555749b018, data=0x0) at kernel/chain.cpp:14\r\n#1  0x000055555623fa81 in BaseIndex::ThreadSync (this=0x7fffffffad00) at index/base.cpp:201\r\n(gdb) p cs_main\r\n$1 = {\r\n  <std::recursive_mutex> = {\r\n    <std::__recursive_mutex_base> = {\r\n      _M_mutex = {\r\n        __data = {\r\n          __lock = 0,\r\n          __count = 0,\r\n          __owner = 0,\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n```\r\nI agree with you that a new struct should just be `nFile` and ` nDataPos` (or `nPos`). This struct can be used for either block data or rev data.\r\n",
      "created_at": "2023-03-31T19:35:39Z",
      "updated_at": "2023-03-31T19:35:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1154827107",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1154827107"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": 19,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156452551",
      "pull_request_review_id": 1369794474,
      "id": 1156452551,
      "node_id": "PRRC_kwDOABII585E7hDH",
      "diff_hunk": "@@ -16,9 +16,8 @@ interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data\n     if (index) {\n         info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n         info.height = index->nHeight;\n-        LOCK(::cs_main);\n-        info.file_number = index->nFile;\n-        info.data_pos = index->nDataPos;\n+        info.file_number = index->GetFileNum();\n+        info.data_pos = index->GetDataPos();",
      "path": "src/kernel/chain.cpp",
      "position": 8,
      "original_position": 8,
      "commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "original_commit_id": "acddd4204654812a0e741e04a758be0f362c5ccb",
      "in_reply_to_id": 1137557817,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Are you sure these are protected by cs_main, is it?\r\n\r\nThe members' write process, not the read. If the read would be protected by `cs_main`, this PR wouldn't make any sense :p.\r\nThe two places are: the `CBlockIndex` creation time and `CBlockIndex` pruning time.\r\n\r\nStill, those `cs_main` locks can also be removed in a follow-up PR. I haven't removed them here because they require further changes.\r\n\r\nNot sure if I'm understanding your concern here. You are thinking on a race in-between `GetFileNum` and `GetDataPos`?\r\nBecause, if that is the concern, the error that could arise from it is harmless. The read block call would just return false, and callers would continue. But, to not even have to think about such error, we could just call `GetFilePos()` instead of the two getters.\r\n\r\n> I agree with you that a new struct should just be nFile and  nDataPos (or nPos). This struct can be used for either block data or rev data.\r\n\r\nThere is already a method for that: `CBlockIndex::GetFilePos`.",
      "created_at": "2023-04-03T20:59:43Z",
      "updated_at": "2023-04-03T20:59:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27006#discussion_r1156452551",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156452551"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27006"
        }
      },
      "start_line": 19,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    }
  ]
}