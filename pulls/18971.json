{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
    "id": 417675766,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NDE3Njc1NzY2",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18971",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/18971.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/18971.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/a2a30a569e4742c53c9f22ec588cf911c9c857f9",
    "number": 18971,
    "state": "closed",
    "locked": true,
    "maintainer_can_modify": false,
    "title": "wallet: Refactor the classes in wallet/db.{cpp/h}",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The data storage layer of the wallet is fairly complicated and not well encapsulated or modularized. This makes it difficult for us to introduce new data storage methods. So this PR refactors it such that there is a clear way to introduce other storage options. This is also intended to clean up the logic of the database layer so that it is easier to follow and reason about.\r\n\r\nIn the database, there are 3 classes: `BerkeleyBatch`, `BerkeleyDatabase`, and `BerkeleyEnvironment`. `BerkeleyDatabase` is typenamed to `WalletDatabase`. The goal is to introduce two abstract classes: `WalletDatabase` and `DatabaseBatch`. These will be implemented by `BerkeleyDatabase` and `BerkeleyBatch`. This abstract classes can be inherited by other storage methods. All of the database specific things should be hidden in those classes.\r\n\r\nTo achieve this, we move the database handling things in `BerkeleyBatch` and turn it purely into a data accessor for the `BerkeleyDatabase`. Particularly, various static functions that operated on a `BerkeleyDatabase` are changed to be member functions of `BerkeleyDatabase`. `Read`, `Write`, `Erase`, and `Exists` are refactored to have separate functions that can be overridden by other classes. Instead of `GetCursor` returning a BDB specific `Dbc` object, new `CreateCursor` and `CloseCursor` functions are added and the cursor is handled internally within the `BerkeleyBatch`. We are then able to introduce the `DatabaseBatch` abstract class.\r\n\r\nFunctionality is further moved out of `BerkeleyBatch` into `BerkeleyDatabase`. Notably the `Db` handle creation is moved from `BerkeleyBatch`'s constructor and to a new `Open` function in `BerkeleyDatabase`. `BerkeleyDatabase` will also handle closing with a new `Close` function instead of having this be part of `Flush`.\r\n\r\nAdditionally, the existence of `BerkeleyEnvironment` is hidden inside of `BerkeleyDatabase`. `mapFileUseCount` is removed. Instead `WalletDatabase` will track it's use count with `m_refcount`. This is incremented by newly introduced `AddRef` and `RemoveRef` functions. `m_refcount` is used to ensure that the database and environment are not closed while the database may still be in use.\r\n\r\nInstead of each `BerkeleyEnvironment` tracking the fileids of the databases in that environment, a global map `g_fileids` is used. Since we were already going through every open fileid for the uniqeness check, it doesn't matter what `BerkeleyEnvironment` has a database with a particular fileid. All we care about is that there is a database in any of the environments that has the same fileid of the database that is currently being opened.\r\n\r\nLastly, `BerkeleyBatch, `BerkeleyDatabase`, and `BerkeleyEnvironment` are moved into new files `wallet/bdb.{cpp/h}`. `WalletDatabase` and `DatabaseBatch` are in `wallet/db.{cpp/h}`. This just gives better organization of the code so they aren't all mixed together.\r\n\r\n***\r\n\r\nI've started breaking this down into separate PRs. Some of the simpler stuff is moved up to the front so they can be merged first.\r\n\r\n* [x] Mostly simple moveonly things: #19290\r\n  * walletdb: Make SpliWalletFilePath non-static\r\n  * walletdb: Add IsBDBWalletLoaded to look for BDB wallets specifically\r\n  * walletdb: move IsWalletLoaded to walletdb.cpp\r\n  * walletdb: moveonly: Move BerkeleyBatch Cursor and Txn funcs to cpp\r\n  * walletdb: Move BDB specific things into bdb.{cpp/h}\r\n\r\nThese PRs are independent of each other and can be merged out of order after #19290 is merged\r\n* [x] Refactor Read, Write, Erase, Exists: #19292\r\n  * walletdb: refactor Read, Write, Erase, and Exists into non-template func\r\n* [x] Handle cursor internally: #19308\r\n  * walletdb: Handle cursor internally\r\n* [x] Make Create, CreateMock, and CreateDummy standalone: #19310\r\n  * Add Create*WalletDatabase functions\r\n  * scripted-diff: Replace WalletDatabase::Create* with CreateWalletDatabase\r\n  * Remove WalletDatabase::Create, CreateMock, and CreateDummy\r\n* [x] Move BerkeleyBatch static functions: #19324\r\n  * walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\r\n  * walletdb: Move PeriodicFlush into WalletDatabase\r\n  * walletdb: Move Rewrite into BerkeleyDatabase\r\n\r\nThese PRs require the previous listed to be merged first and need to be merged in order\r\n* [x] Introduce `DatabaseBatch`: #19325\r\n  * walletdb: Refactor DatabaseBatch abstract class from BerkeleyBatch\r\n  * walletdb: Add MakeBatch function to BerkeleyDatabase and use it\r\n* [x] Introduce `WalletDatabase`: #19334\r\n  * walletdb: Move BerkeleyDatabase::Flush(true) to Close()\r\n  * walletdb: Introduce AddRef and RemoveRef functions\r\n  * walletdb: Add BerkeleyDatabase::Open dummy function\r\n  * walletdb: Introduce WalletDatabase abstract class\r\n* [ ] Cleanup the separation: #19335\r\n  * walletdb: track database file use as m_refcount within BerkeleyDatabase\r\n  * walletdb: Move Db->open to BerkeleyDatabase::Open\r\n  * walletdb: Use a global g_fileids instead of m_fileids for each env\r\n  * walletdb: Remove BerkeleyBatch friend class from BerkeleyDatabase\r\n\r\nI will continue to break this down as things get merged.",
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "active_lock_reason": "resolved",
    "created_at": "2020-05-14T00:04:15Z",
    "updated_at": "2022-08-30T14:09:27Z",
    "closed_at": "2020-06-20T02:33:14Z",
    "mergeable_state": "unknown",
    "merge_commit_sha": "93ce82356034608203a2e36440fdf14273ed2df7",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "achow101:refactor-storage",
      "ref": "refactor-storage",
      "sha": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 45006379,
        "node_id": "MDEwOlJlcG9zaXRvcnk0NTAwNjM3OQ==",
        "name": "bitcoin",
        "full_name": "achow101/bitcoin",
        "owner": {
          "login": "achow101",
          "id": 3782274,
          "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/achow101",
          "html_url": "https://github.com/achow101",
          "followers_url": "https://api.github.com/users/achow101/followers",
          "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
          "organizations_url": "https://api.github.com/users/achow101/orgs",
          "repos_url": "https://api.github.com/users/achow101/repos",
          "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/achow101/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/achow101/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/achow101/bitcoin",
        "archive_url": "https://api.github.com/repos/achow101/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/achow101/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/achow101/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/achow101/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/achow101/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/achow101/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/achow101/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/achow101/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/achow101/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/achow101/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/achow101/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/achow101/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/achow101/bitcoin/events",
        "forks_url": "https://api.github.com/repos/achow101/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/achow101/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/achow101/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/achow101/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/achow101/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/achow101/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/achow101/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/achow101/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/achow101/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/achow101/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/achow101/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/achow101/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/achow101/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/achow101/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/achow101/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/achow101/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:achow101/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/achow101/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/achow101/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/achow101/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/achow101/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/achow101/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/achow101/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/achow101/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/achow101/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/achow101/bitcoin/hooks",
        "svn_url": "https://github.com/achow101/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 10,
        "stargazers_count": 34,
        "watchers_count": 34,
        "size": 238743,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-02T17:43:24Z",
        "created_at": "2015-10-27T00:20:28Z",
        "updated_at": "2023-05-16T00:18:41Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "d4f9ae00252ba44909a61db0f606be6fddf904c1",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 34324,
        "stargazers_count": 69818,
        "watchers_count": 69818,
        "size": 233879,
        "default_branch": "master",
        "open_issues_count": 627,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T22:42:00Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-06-07T03:51:27Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 442,
    "deletions": 322,
    "changed_files": 11,
    "commits": 14,
    "review_comments": 100,
    "comments": 21
  },
  "events": [
    {
      "event": "labeled",
      "id": 3334339595,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzMzQzMzk1OTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3334339595",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-14T00:06:24Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 628309919,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyODMwOTkxOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628309919",
      "actor": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-14T00:08:17Z",
      "updated_at": "2020-05-14T00:08:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628309919",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "commented",
      "id": 628358883,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyODM1ODg4Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628358883",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-14T03:06:58Z",
      "updated_at": "2020-06-19T22:01:58Z",
      "author_association": "MEMBER",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19325 (wallet: Refactor BerkeleyDatabase to introduce DatabaseBatch abstract class by achow101)\n* #19324 (wallet: Move BerkeleyBatch static functions to BerkeleyDatabase by achow101)\n* #19320 (wallet: Replace CDataStream& with Span<char> where possible by MarcoFalke)\n* #19308 (wallet: BerkeleyBatch Handle cursor internally by achow101)\n* #18907 (walletdb: Don't remove database transaction logs and instead error by achow101)\n* #18904 (Don't call lsn_reset in periodic flush by bvbfan)\n* #18608 (refactor: Remove CAddressBookData::destdata by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628358883",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "commented",
      "id": 628920481,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyODkyMDQ4MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628920481",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-14T22:33:20Z",
      "updated_at": "2020-05-14T22:33:20Z",
      "author_association": "MEMBER",
      "body": "Strong concept ACK for the effort and end result, but I'm scared it looks like the intermediate commits here are moving and changing code at the same time instead of just leaving code where it is or moving it in trivial to review `--color-moved` MOVEONLY commits. This was previously a hurdle for me in https://github.com/bitcoin/bitcoin/pull/16341#issuecomment-541330425, but maybe the problem is less severe here because it looks like the moves are happening in single commits, not in harder to reconcile add and remove commits.\r\n\r\nI would definitely appreciate it (can't speak for other reviewers) if this PR could be updated to use MOVEONLY commits (multiple small ones throughout or a big one at the beginning or end), but I'll give this a try and maybe the review will be easier than I'm expecting 👍 ",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628920481",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3338991988,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzMzODk5MTk4OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3338991988",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T01:27:01Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3339009252,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzMzOTAwOTI1Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3339009252",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T01:37:10Z"
    },
    {
      "event": "commented",
      "id": 628975249,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyODk3NTI0OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628975249",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T01:39:03Z",
      "updated_at": "2020-05-15T01:39:03Z",
      "author_association": "MEMBER",
      "body": "> but I'm scared it looks like the intermediate commits here are moving and changing code at the same time instead of just leaving code where it is or moving it in trivial to review\r\n\r\nI only found one commit which was moving and changing behavior at the same time. This was `wallet: Move cursor functions to WalletDatabase and handle internally` which I have now split into `walletdb: Handle cursor internally` (changes behavior) and `walletdb: Move cursor functions to WalletDatabase` (move).",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628975249",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "commented",
      "id": 629222719,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTIyMjcxOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629222719",
      "actor": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T13:01:18Z",
      "updated_at": "2020-05-15T13:01:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "The patch changes ref counting of db files. Now `Acquire` is called only in `Rewrite` since previous batch do it. Now ref count is always 0 (except you call Rewrite) which makes whole read/write racy.",
      "user": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629222719",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "commented",
      "id": 629349300,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTM0OTMwMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629349300",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T16:15:26Z",
      "updated_at": "2020-05-15T16:15:26Z",
      "author_association": "MEMBER",
      "body": "> The patch changes ref counting of db files. Now `Acquire` is called only in `Rewrite` since previous batch do it. Now ref count is always 0 (except you call Rewrite) which makes whole read/write racy.\r\n\r\n`Acquire` is called by `WalletBatch`'s constructor so the ref count is still incremented every time the database is being used. And `Release` is called by `WalletBatch`'s destructor.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629349300",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "reviewed",
      "id": 412921503,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTIxNTAz",
      "url": null,
      "actor": null,
      "commit_id": "0f991e733516fa26e1ceaca10a5b582093950e53",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-412921503",
      "submitted_at": "2020-05-15T19:44:03Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "reviewed",
      "id": 412923311,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTIzMzEx",
      "url": null,
      "actor": null,
      "commit_id": "8ef1b45b4d3de71214da1a6bc6e09f6e9a14d7d4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-412923311",
      "submitted_at": "2020-05-15T19:46:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "commented",
      "id": 629535592,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTUzNTU5Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629535592",
      "actor": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T22:39:29Z",
      "updated_at": "2020-05-15T22:39:29Z",
      "author_association": "MEMBER",
      "body": "@achow101 re @ryanofsky's comment, I set out to expand and clarify https://github.com/bitcoin/bitcoin/pull/18971/commits/67e30b2b42b4d710739e6fe303cbca69be68032c into several simpler move-only commits. \r\n\r\nYou can use `git diff 67e30b2b42b4d710739e6fe303cbca69be68032c 125796d8e60b8e740857e427cbaad4aa23f74b52` to compare the results, as there are some changes I've left out, and slight difference, e.g. I took the approach of exposing `WalletBatch::ReadKeyValue`, but they don't affect the later commits.\r\n\r\nhttps://github.com/achow101/bitcoin/compare/refactor-storage...Empact:refactor-storage-moveonly",
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629535592",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "mentioned",
      "id": 3342875579,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzM0Mjg3NTU3OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342875579",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T22:39:29Z"
    },
    {
      "event": "subscribed",
      "id": 3342875581,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzNDI4NzU1ODE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342875581",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T22:39:29Z"
    },
    {
      "event": "mentioned",
      "id": 3342875583,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzM0Mjg3NTU4Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342875583",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T22:39:29Z"
    },
    {
      "event": "subscribed",
      "id": 3342875584,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzNDI4NzU1ODQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342875584",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T22:39:29Z"
    },
    {
      "event": "commented",
      "id": 629553130,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTU1MzEzMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629553130",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T23:55:37Z",
      "updated_at": "2020-05-15T23:55:37Z",
      "author_association": "MEMBER",
      "body": "@Empact Thanks for doing that! Unfortunately I worked out my own way of doing the separation before I saw your comment. My version was pushed to #18918.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629553130",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "mentioned",
      "id": 3342994484,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzM0Mjk5NDQ4NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342994484",
      "actor": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T23:55:37Z"
    },
    {
      "event": "subscribed",
      "id": 3342994485,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzNDI5OTQ0ODU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3342994485",
      "actor": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-15T23:55:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3343190868,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM0MzE5MDg2OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3343190868",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-16T03:58:42Z"
    },
    {
      "event": "commented",
      "id": 629828484,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTgyODQ4NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629828484",
      "actor": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-17T16:58:37Z",
      "updated_at": "2020-05-17T16:58:37Z",
      "author_association": "CONTRIBUTOR",
      "body": "> `Acquire` is called by `WalletBatch`'s constructor so the ref count is still incremented every time the database is being used. And `Release` is called by `WalletBatch`'s destructor.\r\n\r\nGot'cha, sorry about that, i've not notice it. I still have concern about touching db env in multi threading. `BerkeleyDatabase` should guard every env usage, for example in contructor with shared env, the easiest test is to call `CreateWalletFromFile` from distinct threads with same db location, it will crash at \r\n`auto inserted = this->env->m_databases.emplace(strFile, std::ref(*this));`\r\nbefore actual assert in next line.",
      "user": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629828484",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "commented",
      "id": 630104158,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYzMDEwNDE1OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630104158",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-18T10:53:00Z",
      "updated_at": "2020-05-18T10:53:00Z",
      "author_association": "MEMBER",
      "body": "Concept ACK",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-630104158",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3348530501,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM0ODUzMDUwMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3348530501",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-18T18:12:57Z"
    },
    {
      "event": "reviewed",
      "id": 414600810,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NjAwODEw",
      "url": null,
      "actor": null,
      "commit_id": "6c47d41779ec5b335acf75652228d541b7a5b67a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK. A quick scan of each commit looks reasonable. I was looking at this area of the codebase the other day with an eye to fixing the TODOs in tool_wallet.py and these changes look like the code would be better organised and easier to modify and reason about.",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-414600810",
      "submitted_at": "2020-05-19T16:06:35Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3353231259,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM1MzIzMTI1OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3353231259",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-19T18:44:19Z"
    },
    {
      "event": "commented",
      "id": 632235166,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYzMjIzNTE2Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632235166",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-21T17:19:36Z",
      "updated_at": "2020-05-21T17:19:36Z",
      "author_association": "MEMBER",
      "body": "Not sure what's causing the travis failure. It seems to be caused for a non-existent fileid when `get_fileid` is called, but I can't figure out why that would be the case nor can I replicate it locally.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-632235166",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3362537082,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM2MjUzNzA4Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3362537082",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-21T22:16:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3370997832,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM3MDk5NzgzMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3370997832",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-25T18:22:23Z"
    },
    {
      "event": "commented",
      "id": 634021594,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDAyMTU5NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634021594",
      "actor": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-26T13:22:35Z",
      "updated_at": "2020-05-26T13:23:00Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Not sure what's causing the travis failure. It seems to be caused for a non-existent fileid when `get_fileid` is called, but I can't figure out why that would be the case nor can I replicate it locally.\r\n\r\n`get_fileid` should not be called in mock db (some older bdb version in Travis?)",
      "user": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634021594",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3374920004,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM3NDkyMDAwNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3374920004",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-26T18:51:24Z"
    },
    {
      "event": "commented",
      "id": 634211030,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDIxMTAzMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634211030",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-26T18:52:10Z",
      "updated_at": "2020-05-26T18:52:10Z",
      "author_association": "MEMBER",
      "body": "> `get_fileid` should not be called in mock db\r\n\r\nAh, that's probably it. Thanks. Odd that I can't get the error locally though.\r\n\r\n> (some older bdb version in Travis?)\r\n\r\nIt's actually newer. Travis typically uses BDB provided by Ubuntu which is 5.3. I have 4.8 installed on my system.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634211030",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3376217829,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM3NjIxNzgyOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3376217829",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-27T03:20:01Z"
    },
    {
      "event": "commented",
      "id": 634578411,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDU3ODQxMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634578411",
      "actor": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-27T10:42:26Z",
      "updated_at": "2020-05-27T10:42:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "> It's actually newer. Travis typically uses BDB provided by Ubuntu which is 5.3. I have 4.8 installed on my system.\r\n\r\nI can't reproduce it either, bdb 5.3.28.",
      "user": {
        "login": "bvbfan",
        "id": 8323581,
        "node_id": "MDQ6VXNlcjgzMjM1ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bvbfan",
        "html_url": "https://github.com/bvbfan",
        "followers_url": "https://api.github.com/users/bvbfan/followers",
        "following_url": "https://api.github.com/users/bvbfan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bvbfan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bvbfan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
        "organizations_url": "https://api.github.com/users/bvbfan/orgs",
        "repos_url": "https://api.github.com/users/bvbfan/repos",
        "events_url": "https://api.github.com/users/bvbfan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bvbfan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634578411",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "reviewed",
      "id": 419340191,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MzQwMTkx",
      "url": null,
      "actor": null,
      "commit_id": "289aa21c6a6c11ce172a92f878a3ede6652fc2e4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Started review (will update list below with progress). Nice cleanups so far\r\n\r\n- [X] e9dff450d65983644f5c60e1c6aa1f65ade5619e walletdb: Combine VerifyDatabaseFile and VerifyEnvironment (1/20)\r\n- [X] e1c46d4de66d57a703a9aa1b4d1b2bd65e182445 walletdb: Move PeriodicFlush into WalletDatabase (2/20)\r\n- [X] 3cdb7fd9d1e92f07c04c325c9b585ff736162198 walletdb: Move Db->open to BerkeleyDatabase::Open (3/20)\r\n- [X] b6a6e0292c226f67b9ee177f9732a936aa7a0d7e walletdb: Use a global g_fileids instead of m_fileids for each env (4/20)\r\n- [X] 8726d373e165087789933eb03383dd7feee31d3f walletdb: Add BerkeleyDatabase::Release (5/20)\r\n- [X] 2c663e453104b2f49849d8bc80727e98abda8055 walletdb: Move log consolidation into BerkeleyEnvironment::Close (6/20)\r\n- [X] f3b553f36e83c44a4edb51710ae673d6b9b3e573 walletdb: Change BerkeleyDatabase::Flush to Close (7/20)\r\n- [X] 9603e233c9c4049a267282615b5e4f31600656e6 walletdb: track database file use as m_refcount within BerkeleyDatabase (8/20)\r\n- [X] 17009d1e73ce894f9f5d5441c472e87efaee6163 walletdb: Replace BerkeleyDatabase::Flush with BerkeleyBatch::Flush (9/20)\r\n- [X] 2711caa2a2d4f04b848c25b614b353a1a08351b0 walletdb: Handle cursor internally (10/20)\r\n- [X] 7d8b1b42702357d5c25e5825dfc47326bad0568f walletdb: Move cursor functions to WalletDatabase (11/20)\r\n- [X] 75f3532a70abf4331aba212f979a2e8be02d191c walletdb: Move Rewrite into BerkeleyDatabase (12/20)\r\n- [X] e1ebc69a5e6628cadf480dfd6d787a6c9f631b86 walletdb: Move Txn* functions into WalletDatabase (13/20)\r\n- [X] 7f6608ba7ac54935ddebec9b49817fc4a26e749e walletdb: Move Read, Write, Erase, and Exists into BerkeleyDatabase (14/20)\r\n- [X] 64a5a29d692378df443ae599b81c1f4547ec3d03 walletdb: Remove BerkeleyBatch and have WalletBatch use WalletDatabase (15/20)\r\n- [X] aac3483e9e0423b3414cfaf84f37041a200d773c walletdb: refactor Read, Write, Erase, and Exists into non-template func (16/20)\r\n- [X] 6091f36d30f1fd9feec4bef6677ce514b5d20b2c walletdb: Move BerkeleyDatabase::Create, CreateDummy, and CreateMock out (17/20)\r\n- [X] 4c6c9080d48ec5810e7d36348f7c730a586e9fb5 walletdb: Make WalletDatabase abstract class (18/20)\r\n- [X] d858c9b23699edaa27166071fc0c88f55911fea8 wallet: Add IsBDBWalletLoaded to look for BDB wallets specifically (19/20)\r\n- [X] b4c2765fd19e5dd8c823febd65ad5e62a58c8260 Move BDB specific things into bdb.{cpp/h} (20/20)\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-419340191",
      "submitted_at": "2020-05-27T15:48:06Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "added_to_project",
      "id": 3384233236,
      "node_id": "MDE5OkFkZGVkVG9Qcm9qZWN0RXZlbnQzMzg0MjMzMjM2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3384233236",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-28T19:06:56Z",
      "project_card": {
        "id": 39100840,
        "url": "https://api.github.com/projects/columns/cards/39100840",
        "project_id": 481835,
        "project_url": "https://api.github.com/projects/481835",
        "column_name": "Blockers"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3384599835,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM4NDU5OTgzNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3384599835",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-28T20:48:44Z"
    },
    {
      "event": "reviewed",
      "id": 421187137,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTg3MTM3",
      "url": null,
      "actor": null,
      "commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Updated https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-419340191",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-421187137",
      "submitted_at": "2020-05-29T20:09:32Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "reviewed",
      "id": 421530443,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTMwNDQz",
      "url": null,
      "actor": null,
      "commit_id": "4decfab19f26cf21be6da1a371220e918c0d2dc8",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-421530443",
      "submitted_at": "2020-05-31T21:49:56Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "reviewed",
      "id": 421542040,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTQyMDQw",
      "url": null,
      "actor": null,
      "commit_id": "f06619ecd41d08484e02e41fc06a840b9057fcb6",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-421542040",
      "submitted_at": "2020-06-01T00:16:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3394518460,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM5NDUxODQ2MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3394518460",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-01T19:16:28Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3395554030,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM5NTU1NDAzMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3395554030",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-02T02:15:19Z"
    },
    {
      "event": "labeled",
      "id": 3398411151,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzOTg0MTExNTE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3398411151",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-02T16:10:18Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3398571520,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzM5ODU3MTUyMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3398571520",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-02T16:45:44Z"
    },
    {
      "event": "unlabeled",
      "id": 3398892217,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50MzM5ODg5MjIxNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3398892217",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-02T18:15:32Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 422974932,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTc0OTMy",
      "url": null,
      "actor": null,
      "commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Reviewed the first couple of commits up to 3cdb7fd9d1e92f07c04c325c9b585ff736162198, will resume later.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-422974932",
      "submitted_at": "2020-06-02T19:48:45Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "reviewed",
      "id": 426287040,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Mjg3MDQw",
      "url": null,
      "actor": null,
      "commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Updated https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-419340191",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-426287040",
      "submitted_at": "2020-06-08T22:54:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "reviewed",
      "id": 427008108,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDA4MTA4",
      "url": null,
      "actor": null,
      "commit_id": "75f3532a70abf4331aba212f979a2e8be02d191c",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Code review almost-ACK b4c2765fd19e5dd8c823febd65ad5e62a58c8260 (just various individual comments should be addressed).\r\n\r\nThis is a nice code improvement that enables new features (#19077, #19137, #19102)\r\n\r\nMy biggest comment in terms of scope is about sharing cursor and transaction objects. Sharing these seems fragile if not buggy (https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437330343). It seems like it would also shrink down the PR to just make the Batch cursor & transaction & read/write/erase methods virtual instead of trying to cram them into the already complicated Database class. Database class would just need a virtual `unique_ptr<Batch> Database::MakeBatch()` method returning the right Batch subclass for the database subclass.\r\n\r\nI'm also surprised how the moveonly commits in this PR come after the change commits, rather than before. I'd be curious if you have a good workflow for updates because it seems like every update to one of the early change commits would require repeatedly making the same updates in the later move commits.\r\n\r\nAnyway these are all fairly minor comments. The changes here are great and definitely much better than everything that was here before.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-427008108",
      "submitted_at": "2020-06-09T13:44:32Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3426391639,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQyNjM5MTYzOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3426391639",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-09T18:56:15Z"
    },
    {
      "event": "commented",
      "id": 641520202,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTUyMDIwMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/641520202",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-09T19:21:15Z",
      "updated_at": "2020-06-09T19:34:06Z",
      "author_association": "MEMBER",
      "body": "> My biggest comment in terms of scope is about sharing cursor and transaction objects. Sharing these seems fragile if not buggy ([#18971 (comment)](https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437330343)). It seems like it would also shrink down the PR to just make the Batch cursor & transaction & read/write/erase methods virtual instead of trying to cram them into the already complicated Database class. Database class would just need a virtual `unique_ptr<Batch> Database::MakeBatch()` method returning the right Batch subclass for the database subclass.\r\n\r\nI'll look into it. However I'm wary of having parallel inheritances like this. It also doesn't seem like it would be useful because we barely use transactions and cursors. Transactions are only used during encryption and cursors are only used for initial loading, rewrite, and zapwallettx.\r\n\r\n> I'd be curious if you have a good workflow for updates because it seems like every update to one of the early change commits would require repeatedly making the same updates in the later move commits.\r\n\r\nNo and it's very painful.\r\n\r\n",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-641520202",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3426744450,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQyNjc0NDQ1MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3426744450",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-09T20:40:04Z"
    },
    {
      "event": "reviewed",
      "id": 429840163,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODQwMTYz",
      "url": null,
      "actor": null,
      "commit_id": "1b354344ebfc68506484f688f042b0588e83f1c4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Code review ACK 47dc8d6aff04e4f4c3ed0b4eb28fca0596d020e6. Looks very good. I suggested changes but they aren't too important and could all be followups.\r\n\r\n> > I'd be curious if you have a good workflow for updates because it seems like every update to one of the early change commits would require repeatedly making the same updates in the later move commits.\r\n> \r\n> No and it's very painful.\r\n\r\nSorry for that. My experience is it's less painful with a one or two big move commits up front (which can also be merged earlier) and the refactoring changes after the moves. But just having the moves separate at all has really helped me review this PR, so I definitely appreciate the effort!",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-429840163",
      "submitted_at": "2020-06-12T22:46:42Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3446460996,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ0NjQ2MDk5Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3446460996",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T22:33:35Z"
    },
    {
      "event": "commented",
      "id": 644424649,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NDQyNDY0OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/644424649",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T22:35:56Z",
      "updated_at": "2020-06-15T22:37:23Z",
      "author_association": "MEMBER",
      "body": "I've redone the refactor to keep `BerkeleyBatch` and introduce `DatabaseBatch` as an abstract class. Database transactions, cursors, and modifications occur via `BerkeleyBatch`.\r\n\r\nThis change also results in changes to the `Flush` and `Close` logic. I've decided to keep the `shutdown` argument in `BerkeleyEnvironment::Flush`. So `BerkeleyDatabase::Flush` calls that with `shutdown == false` and `BerkeleyDatabase::Close` calls it with `shutdown == true`. This makes the changes there far fewer and should be easier to review. The commit to move the log consolidation has been removed.\r\n\r\nThe commits have also been reordered so that moves occur first so this is less painful to modify later.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-644424649",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3446469107,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ0NjQ2OTEwNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3446469107",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T22:37:15Z"
    },
    {
      "event": "commented",
      "id": 644443992,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NDQ0Mzk5Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/644443992",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T23:33:12Z",
      "updated_at": "2020-06-15T23:33:12Z",
      "author_association": "MEMBER",
      "body": "Can the move-only stuff be split up in its own pr? That seems like something a lot more people could review than the bdb-refactors.",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-644443992",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3446629289,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ0NjYyOTI4OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3446629289",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T23:44:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3446633308,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ0NjYzMzMwOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3446633308",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-15T23:46:38Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3446753135,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ0Njc1MzEzNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3446753135",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-16T00:46:08Z"
    },
    {
      "event": "commented",
      "id": 644467482,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NDQ2NzQ4Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/644467482",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-16T00:58:20Z",
      "updated_at": "2020-06-18T20:48:43Z",
      "author_association": "MEMBER",
      "body": "Updating this list in the OP now.\r\n\r\nI've started breaking this down into separate PRs. Some of the simpler stuff is moved up to the front so they can be merged first.\r\n\r\n* Mostly simple moveonly things: #19290 (merged)\r\n  * walletdb: Make SpliWalletFilePath non-static\r\n  * walletdb: Add IsBDBWalletLoaded to look for BDB wallets specifically\r\n  * walletdb: move IsWalletLoaded to walletdb.cpp\r\n  * walletdb: moveonly: Move BerkeleyBatch Cursor and Txn funcs to cpp\r\n  * walletdb: Move BDB specific things into bdb.{cpp/h}\r\n* Refactor Read, Write, Erase, Exists: #19292 (merged)\r\n  * walletdb: refactor Read, Write, Erase, and Exists into non-template func\r\n* Handle cursor internally: #19308\r\n  * walletdb: Handle cursor internally\r\n* Make Create, CreateMock, and CreateDummy standalone: #19310 (merged)\r\n  * Add Create*WalletDatabase functions\r\n  * scripted-diff: Replace WalletDatabase::Create* with CreateWalletDatabase\r\n  * Remove WalletDatabase::Create, CreateMock, and CreateDummy\r\n\r\nI will continue to break this down as things get merged.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-644467482",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "referenced",
      "id": 3452780846,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM0NTI3ODA4NDY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3452780846",
      "actor": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "62d863f9157df54bfb109d68114ada8130ecd3f0",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/62d863f9157df54bfb109d68114ada8130ecd3f0",
      "created_at": "2020-06-17T09:49:56Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3453900373,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1MzkwMDM3Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3453900373",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-17T14:34:19Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3454499468,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1NDQ5OTQ2OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3454499468",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-17T16:46:00Z"
    },
    {
      "event": "reviewed",
      "id": 432544614,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTQ0NjE0",
      "url": null,
      "actor": null,
      "commit_id": "c89ec975fef761bdb39093c37178f37b38b2763d",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Start rereviewing (will update list below with progress).\r\n- [X] cc05c351c0e4a62eed81996b5370e64b28b985fe walletdb: Handle cursor internally (1/15)\r\n- [ ] 11f7966982364911f4ee88df787961b110d24a38 Add Create*WalletDatabase functions (2/15)\r\n- [ ] 2dd5707793a448b6425490e17847d4b12cb53020 scripted-diff: Replace WalletDatabase::Create* with CreateWalletDatabase (3/15)\r\n- [ ] 37c656b671ba1e17df5f8cfb2ae7776555e61313 Remove WalletDatabase::Create, CreateMock, and CreateDummy (4/15)\r\n- [ ] 622b5cbddfab6496f4334271a8aedeaff3a6999d walletdb: Combine VerifyDatabaseFile and VerifyEnvironment (5/15)\r\n- [ ] 73888f0bf833d28d951a3cf597c772c7a3d87228 walletdb: Move PeriodicFlush into WalletDatabase (6/15)\r\n- [ ] 8c903f535019b4820cd2259eb1d77033d32b066a walletdb: Move Db->open to BerkeleyDatabase::Open (7/15)\r\n- [ ] b0e0ecca36728c79e985acfbafc6737d5d87570f walletdb: Use a global g_fileids instead of m_fileids for each env (8/15)\r\n- [ ] 54ee8905d23213d6165fe45601627d2aadee1bb7 walletdb: Move BerkeleyDatabase::Flush(true) to Close() (9/15)\r\n- [ ] c5b005f34ccc0d0a40486da37394a3556e1fa14b walletdb: Add BerkeleyDatabase::RemoveRef (10/15)\r\n- [ ] baca4d0769b63578a8e4a94beb01f8f750c1fb6f walletdb: track database file use as m_refcount within BerkeleyDatabase (11/15)\r\n- [ ] 029b13023dd3b695bcbf65a8fa4e89640b86ddd9 walletdb: Move Rewrite into BerkeleyDatabase (12/15)\r\n- [ ] 58fc08efd4641cdeec74e9af1dd71a12fd09efbc walletdb: Remove BerkeleyBatch friend class from BerkeleyDatabase (13/15)\r\n- [ ] b11e2ad21ed264307e746fb198c5ddeb8f23c954 walletdb: Add MakeBatch function to BerkeleyDatabase and use it (14/15)\r\n- [ ] d850984306f8b605ae5a35dd19018b734f2bbd55 walletdb: Introduce WalletDatabase and DatabaseBatch abstract classes (15/15)",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#pullrequestreview-432544614",
      "submitted_at": "2020-06-17T17:20:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3454738885,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1NDczODg4NQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3454738885",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-17T17:49:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3454771956,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1NDc3MTk1Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3454771956",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-17T17:58:58Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3454825857,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1NDgyNTg1Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3454825857",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-17T18:14:19Z"
    },
    {
      "event": "removed_from_project",
      "id": 3458392065,
      "node_id": "MDIzOlJlbW92ZWRGcm9tUHJvamVjdEV2ZW50MzQ1ODM5MjA2NQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3458392065",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T14:25:16Z",
      "project_card": {
        "id": 39100840,
        "url": "https://api.github.com/projects/columns/cards/39100840",
        "project_id": 481835,
        "project_url": "https://api.github.com/projects/481835",
        "column_name": "Blockers"
      }
    },
    {
      "event": "labeled",
      "id": 3458695635,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDM0NTg2OTU2MzU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3458695635",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T15:24:44Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3458724568,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1ODcyNDU2OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3458724568",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T15:30:34Z"
    },
    {
      "event": "unlabeled",
      "id": 3459342934,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50MzQ1OTM0MjkzNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3459342934",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T17:34:25Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "referenced",
      "id": 3459947805,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM0NTk5NDc4MDU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3459947805",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "dbd7a91fdf3ff801fe5e4107e8346d0d6d11a899",
      "commit_url": "https://api.github.com/repos/MarcoFalke/b-c/commits/dbd7a91fdf3ff801fe5e4107e8346d0d6d11a899",
      "created_at": "2020-06-18T20:31:34Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ZjkzNTNjZWMzMWY5OTk4NWE4ODUxNTNlNDc2NDJlMGRlY2EyZGM0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8f9353cec31f99985a885153e47642e0deca2dc4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8f9353cec31f99985a885153e47642e0deca2dc4",
      "tree": {
        "sha": "bd91378cd5c30f9f67de1efe28919c8749e40b44",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bd91378cd5c30f9f67de1efe28919c8749e40b44"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dbd7a91fdf3ff801fe5e4107e8346d0d6d11a899",
          "sha": "dbd7a91fdf3ff801fe5e4107e8346d0d6d11a899",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/dbd7a91fdf3ff801fe5e4107e8346d0d6d11a899"
        }
      ],
      "message": "walletdb: Handle cursor internally\n\nInstead of returning a Dbc (BDB cursor object) and having the caller\ndeal with the cursor, make BerkeleyBatch handle the cursor internally.\n\nThis prepares BerkeleyBatch to work with other database systems as Dbc\nobjects are BDB specific.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T20:36:11Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-05-15T01:17:01Z"
      },
      "sha": "8f9353cec31f99985a885153e47642e0deca2dc4"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3459965915,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ1OTk2NTkxNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3459965915",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T20:37:10Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzozMWQzOWU3NjU1YjgxNGRiOTRlYTNhYmU5NGM5MzJkOGQxYjk3N2U2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/31d39e7655b814db94ea3abe94c932d8d1b977e6",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/31d39e7655b814db94ea3abe94c932d8d1b977e6",
      "tree": {
        "sha": "b2ebe36ab7452b6e4799dab2fd1568975bbe8eef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b2ebe36ab7452b6e4799dab2fd1568975bbe8eef"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8f9353cec31f99985a885153e47642e0deca2dc4",
          "sha": "8f9353cec31f99985a885153e47642e0deca2dc4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8f9353cec31f99985a885153e47642e0deca2dc4"
        }
      ],
      "message": "walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\n\nCombine these two functions into a single Verify function that is a\nmember of WalletDatabase. Additionally, these are no longer static.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T23:42:04Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T18:37:29Z"
      },
      "sha": "31d39e7655b814db94ea3abe94c932d8d1b977e6"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzowYmJmZDA2NTJmNGE2YjU2ZGZmN2YwN2Y3ODZkY2VlNjgzMjM3NjUy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0bbfd0652f4a6b56dff7f07f786dcee683237652",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0bbfd0652f4a6b56dff7f07f786dcee683237652",
      "tree": {
        "sha": "0a0227f2b12d79be5b348740cae27ed520186567",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0a0227f2b12d79be5b348740cae27ed520186567"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/31d39e7655b814db94ea3abe94c932d8d1b977e6",
          "sha": "31d39e7655b814db94ea3abe94c932d8d1b977e6",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/31d39e7655b814db94ea3abe94c932d8d1b977e6"
        }
      ],
      "message": "walletdb: Move PeriodicFlush into WalletDatabase\n\nMake PeriodicFlush a non-static member of WalletDatabase instead of\nWalletBatch.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T23:44:45Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T18:39:26Z"
      },
      "sha": "0bbfd0652f4a6b56dff7f07f786dcee683237652"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzphOTI3ZjI5ODIzMjFlOTg4NmZjNzA2YzhjMTViYzJlMjc2NDZjYjY5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a927f2982321e9886fc706c8c15bc2e27646cb69",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a927f2982321e9886fc706c8c15bc2e27646cb69",
      "tree": {
        "sha": "a3577f7a997d7166a0c4d51933b42eed89374ade",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a3577f7a997d7166a0c4d51933b42eed89374ade"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0bbfd0652f4a6b56dff7f07f786dcee683237652",
          "sha": "0bbfd0652f4a6b56dff7f07f786dcee683237652",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0bbfd0652f4a6b56dff7f07f786dcee683237652"
        }
      ],
      "message": "walletdb: Move Rewrite into BerkeleyDatabase\n\nMake Rewrite actually a member of BerkeleyDatabase instead of a static\nfunction in BerkeleyBatch",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T23:44:45Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T19:31:02Z"
      },
      "sha": "a927f2982321e9886fc706c8c15bc2e27646cb69"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYWQ2ZmFmMjQ1ODliNzc3Y2Q0YzdjOGE0ZjQ0MDY2ZjExZjk2N2M5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fad6faf24589b777cd4c7c8a4f44066f11f967c9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fad6faf24589b777cd4c7c8a4f44066f11f967c9",
      "tree": {
        "sha": "9ef031ba589f81bea3e969542d09e907f9fe6f86",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9ef031ba589f81bea3e969542d09e907f9fe6f86"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a927f2982321e9886fc706c8c15bc2e27646cb69",
          "sha": "a927f2982321e9886fc706c8c15bc2e27646cb69",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a927f2982321e9886fc706c8c15bc2e27646cb69"
        }
      ],
      "message": "walletdb: Refactor DatabaseBatch abstract class from BerkeleyBatch",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T23:44:45Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-18T20:15:33Z"
      },
      "sha": "fad6faf24589b777cd4c7c8a4f44066f11f967c9"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3460442724,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ2MDQ0MjcyNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3460442724",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-18T23:51:58Z"
    },
    {
      "event": "commented",
      "id": 646541014,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NjU0MTAxNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646541014",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-19T09:41:09Z",
      "updated_at": "2020-06-19T09:41:09Z",
      "author_association": "MEMBER",
      "body": "I get similar errors as [Travis](https://travis-ci.org/github/bitcoin/bitcoin/jobs/699909476) on macOS (`./configure --enable-debug --with-incompatible-bdb --enable-werror`):\r\n```\r\n./wallet/bdb.h:167:17: error: non-static data member 'm_file_path' of 'BerkeleyDatabase' shadows member inherited from type 'WalletDatabase' [-Werror,-Wshadow-field]\r\n1687    std::string m_file_path;\r\n1688                ^\r\n1689./wallet/db.h:166:17: note: declared here\r\n1690    std::string m_file_path;\r\n1691                ^\r\n```\r\n\r\nAnd:\r\n```\r\n./wallet/walletdb.h:208:17: warning: moving a temporary object prevents copy elision [-Wpessimizing-move]\r\n        m_batch(std::move(database.MakeBatch(pszMode, _fFlushOnClose))),\r\n                ^\r\n```",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-646541014",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZTYyZTZlYmFhM2M0MWJiZTcyODljM2M3NzhlMDRmYjg3NDBiYWVm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1e62e6ebaa3c41bbe7289c3c778e04fb8740baef",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1e62e6ebaa3c41bbe7289c3c778e04fb8740baef",
      "tree": {
        "sha": "f517311a2b903e8ff0f30277320a21d12a52c9cf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f517311a2b903e8ff0f30277320a21d12a52c9cf"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fad6faf24589b777cd4c7c8a4f44066f11f967c9",
          "sha": "fad6faf24589b777cd4c7c8a4f44066f11f967c9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fad6faf24589b777cd4c7c8a4f44066f11f967c9"
        }
      ],
      "message": "walletdb: Add MakeBatch function to BerkeleyDatabase and use it\n\nInstead of having WalletBatch construct the BerkeleyBatch, have\nBerkeleyDatabase do it and return a std::unique_ptr<BerkeleyBatch>",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-19T15:17:23Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T20:54:58Z"
      },
      "sha": "1e62e6ebaa3c41bbe7289c3c778e04fb8740baef"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3462902420,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ2MjkwMjQyMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3462902420",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-19T15:17:43Z"
    },
    {
      "event": "commented",
      "id": 646692750,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NjY5Mjc1MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646692750",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-19T15:17:46Z",
      "updated_at": "2020-06-19T15:17:46Z",
      "author_association": "MEMBER",
      "body": "> I get similar errors as Travis on macOS\r\n\r\nShould be fixed now.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-646692750",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "added_to_project",
      "id": 3463691047,
      "node_id": "MDE5OkFkZGVkVG9Qcm9qZWN0RXZlbnQzNDYzNjkxMDQ3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3463691047",
      "actor": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-19T19:42:23Z",
      "project_card": {
        "id": 40412971,
        "url": "https://api.github.com/projects/columns/cards/40412971",
        "project_id": 4755961,
        "project_url": "https://api.github.com/projects/4755961",
        "column_name": "PRs"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNDIzOGRjZmE2MzVhNDJlZGQ0ZDJiMTY0ZjkxYzNjYmZjZDY2ZmI0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/34238dcfa635a42edd4d2b164f91c3cbfcd66fb4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/34238dcfa635a42edd4d2b164f91c3cbfcd66fb4",
      "tree": {
        "sha": "8f91f4ec080ca9176335fbdb70e237f2731bfe9e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8f91f4ec080ca9176335fbdb70e237f2731bfe9e"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1e62e6ebaa3c41bbe7289c3c778e04fb8740baef",
          "sha": "1e62e6ebaa3c41bbe7289c3c778e04fb8740baef",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1e62e6ebaa3c41bbe7289c3c778e04fb8740baef"
        }
      ],
      "message": "walletdb: Move BerkeleyDatabase::Flush(true) to Close()\n\nInstead of having Flush optionally shutdown the database and\nenvironment, add a Close() function that does that.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T00:40:44Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T21:59:24Z"
      },
      "sha": "34238dcfa635a42edd4d2b164f91c3cbfcd66fb4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YjkyMmRkMzFkNTQ4ZmUzOWJiYThhZmQ3MDA0NTMzYTdlOGZhMmJk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b922dd31d548fe39bba8afd7004533a7e8fa2bd",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6b922dd31d548fe39bba8afd7004533a7e8fa2bd",
      "tree": {
        "sha": "3244fcbcc0f47836ea9087c7c91a43e83cb39fe2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3244fcbcc0f47836ea9087c7c91a43e83cb39fe2"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/34238dcfa635a42edd4d2b164f91c3cbfcd66fb4",
          "sha": "34238dcfa635a42edd4d2b164f91c3cbfcd66fb4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/34238dcfa635a42edd4d2b164f91c3cbfcd66fb4"
        }
      ],
      "message": "walletdb: Introduce AddRef and RemoveRef functions\n\nRefactor mapFileUseCount increment and decrement to separate functions\nAddRef and RemoveRef",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T01:38:03Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T00:51:07Z"
      },
      "sha": "6b922dd31d548fe39bba8afd7004533a7e8fa2bd"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4YzAxNDE2MTQyM2ExMWZkNzVmOTc2YWEwOTRkOWJmNjY0MmE0ODc1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8c014161423a11fd75f976aa094d9bf6642a4875",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8c014161423a11fd75f976aa094d9bf6642a4875",
      "tree": {
        "sha": "1a4e7612d398b3403cd1957ffa32ac0c13590670",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1a4e7612d398b3403cd1957ffa32ac0c13590670"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b922dd31d548fe39bba8afd7004533a7e8fa2bd",
          "sha": "6b922dd31d548fe39bba8afd7004533a7e8fa2bd",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/6b922dd31d548fe39bba8afd7004533a7e8fa2bd"
        }
      ],
      "message": "walletdb: Add BerkeleyDatabase::Open dummy function\n\nAdds an Open function for the class abstraction that does nothing for\nnow.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T01:38:24Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T00:55:07Z"
      },
      "sha": "8c014161423a11fd75f976aa094d9bf6642a4875"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYzJiNWFiNzFmYWZhZTYxZDJjNWEwODZjNjgxY2EzZDg2MTUxZDVk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ec2b5ab71fafae61d2c5a086c681ca3d86151d5d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ec2b5ab71fafae61d2c5a086c681ca3d86151d5d",
      "tree": {
        "sha": "4d22ef79b034a40f4300c725bfbba909cffd3368",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4d22ef79b034a40f4300c725bfbba909cffd3368"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8c014161423a11fd75f976aa094d9bf6642a4875",
          "sha": "8c014161423a11fd75f976aa094d9bf6642a4875",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8c014161423a11fd75f976aa094d9bf6642a4875"
        }
      ],
      "message": "walletdb: Introduce WalletDatabase abstract class\n\nMake WalletDatabase actually an abstract class and not just a typedef\nfor BerkeleyDatabase. Have BerkeleyDatabase inherit this class.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T01:38:24Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T20:24:00Z"
      },
      "sha": "ec2b5ab71fafae61d2c5a086c681ca3d86151d5d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2OWMwZTVjZDZmMDA5OGRkYTBhMGFhNDdjNDcwNGE0NjI3MzM5MWYw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/69c0e5cd6f0098dda0a0aa47c4704a46273391f0",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/69c0e5cd6f0098dda0a0aa47c4704a46273391f0",
      "tree": {
        "sha": "b1826b99dd16ac513404f95d92f81196af45f81f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b1826b99dd16ac513404f95d92f81196af45f81f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ec2b5ab71fafae61d2c5a086c681ca3d86151d5d",
          "sha": "ec2b5ab71fafae61d2c5a086c681ca3d86151d5d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ec2b5ab71fafae61d2c5a086c681ca3d86151d5d"
        }
      ],
      "message": "walletdb: track database file use as m_refcount within BerkeleyDatabase\n\nInstead of having BerkeleyEnvironment track the file use count, make\nBerkeleyDatabase do it itself.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T01:57:36Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-05-13T18:09:26Z"
      },
      "sha": "69c0e5cd6f0098dda0a0aa47c4704a46273391f0"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzozZmEzYjA5ZGFjOGNjODZhMmI5MDBiOWYyZGU0NDhjOThjYjBkNDZi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b",
      "tree": {
        "sha": "734b78e0729aacb8473fcc3db140ec592f3ff23f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/734b78e0729aacb8473fcc3db140ec592f3ff23f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/69c0e5cd6f0098dda0a0aa47c4704a46273391f0",
          "sha": "69c0e5cd6f0098dda0a0aa47c4704a46273391f0",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/69c0e5cd6f0098dda0a0aa47c4704a46273391f0"
        }
      ],
      "message": "walletdb: Move Db->open to BerkeleyDatabase::Open\n\nInstead of opening the Db handle in BerkeleyBatch, make BerkeleyDatabase\ndo that.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T01:57:37Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-05-11T02:41:34Z"
      },
      "sha": "3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiYzQ5ODVmYzExM2E2OGM4ODNkOGUwMmIyMGUxYWRiY2E4ODVjMDg4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bc4985fc113a68c883d8e02b20e1adbca885c088",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bc4985fc113a68c883d8e02b20e1adbca885c088",
      "tree": {
        "sha": "2e5ba0657be52bc73df564d7be1e571f9e032b1b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2e5ba0657be52bc73df564d7be1e571f9e032b1b"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b",
          "sha": "3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/3fa3b09dac8cc86a2b900b9f2de448c98cb0d46b"
        }
      ],
      "message": "walletdb: Use a global g_fileids instead of m_fileids for each env\n\nFile ids were basically global anyways, it doesn't make sense to have\nthem be environment specific if we're going to loop through all the\nenvironments anyways.",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T02:12:13Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-05-12T23:51:20Z"
      },
      "sha": "bc4985fc113a68c883d8e02b20e1adbca885c088"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzphMmEzMGE1NjllNDc0MmM1M2M5ZjIyZWM1ODhjZjkxMWM5Yzg1N2Y5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "tree": {
        "sha": "7968447c5161c40bed15980187d219206833fe17",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7968447c5161c40bed15980187d219206833fe17"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bc4985fc113a68c883d8e02b20e1adbca885c088",
          "sha": "bc4985fc113a68c883d8e02b20e1adbca885c088",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bc4985fc113a68c883d8e02b20e1adbca885c088"
        }
      ],
      "message": "walletdb: Remove BerkeleyBatch friend class from BerkeleyDatabase",
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-20T02:12:25Z"
      },
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-06-15T20:14:57Z"
      },
      "sha": "a2a30a569e4742c53c9f22ec588cf911c9c857f9"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 3464282116,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MzQ2NDI4MjExNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3464282116",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-20T02:16:26Z"
    },
    {
      "event": "commented",
      "id": 646923772,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY0NjkyMzc3Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646923772",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-20T02:33:14Z",
      "updated_at": "2020-06-20T02:34:37Z",
      "author_association": "MEMBER",
      "body": "This PR is now superseded by the PRs listed in the OP. Even though the final one, #19335, is the same diff and commits as this one, I wanted to have it be separate without the history from this PR as it is conceptually unrelated to this refactor. The refactoring into the abstract classes occurs in #19334.\r\n\r\nAll of the PRs that were dependent on this one will be rebased onto #19334",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-646923772",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18971"
    },
    {
      "event": "closed",
      "id": 3464293150,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzQ2NDI5MzE1MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3464293150",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-06-20T02:33:14Z"
    },
    {
      "event": "referenced",
      "id": 3502611617,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1MDI2MTE2MTc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3502611617",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "26291745aed080cb2d8576736a23869df603dec2",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/26291745aed080cb2d8576736a23869df603dec2",
      "created_at": "2020-07-01T14:00:43Z"
    },
    {
      "event": "referenced",
      "id": 3513710525,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1MTM3MTA1MjU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3513710525",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "171f4a516bd62d255d11f3bde4305a41323a2fac",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/171f4a516bd62d255d11f3bde4305a41323a2fac",
      "created_at": "2020-07-05T22:07:44Z"
    },
    {
      "event": "referenced",
      "id": 3544406918,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1NDQ0MDY5MTg=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3544406918",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "a924f61caea8833b2afd3d4105fc7cd6f424d6c6",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a924f61caea8833b2afd3d4105fc7cd6f424d6c6",
      "created_at": "2020-07-14T14:22:55Z"
    },
    {
      "event": "referenced",
      "id": 3544514495,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1NDQ1MTQ0OTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3544514495",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "fa48d2e3084b07d4e00cf2d2327e8f97c8f01d88",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/fa48d2e3084b07d4e00cf2d2327e8f97c8f01d88",
      "created_at": "2020-07-14T14:46:28Z"
    },
    {
      "event": "moved_columns_in_project",
      "id": 3559553954,
      "node_id": "MDI2Ok1vdmVkQ29sdW1uc0luUHJvamVjdEV2ZW50MzU1OTU1Mzk1NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3559553954",
      "actor": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-07-17T19:23:47Z",
      "project_card": {
        "id": 40412971,
        "url": "https://api.github.com/projects/columns/cards/40412971",
        "project_id": 4755961,
        "project_url": "https://api.github.com/projects/4755961",
        "column_name": "Design",
        "previous_column_name": "PRs"
      }
    },
    {
      "event": "referenced",
      "id": 3578289926,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1NzgyODk5MjY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3578289926",
      "actor": {
        "login": "meshcollider",
        "id": 3211283,
        "node_id": "MDQ6VXNlcjMyMTEyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/meshcollider",
        "html_url": "https://github.com/meshcollider",
        "followers_url": "https://api.github.com/users/meshcollider/followers",
        "following_url": "https://api.github.com/users/meshcollider/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/meshcollider/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/meshcollider/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
        "organizations_url": "https://api.github.com/users/meshcollider/orgs",
        "repos_url": "https://api.github.com/users/meshcollider/repos",
        "events_url": "https://api.github.com/users/meshcollider/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/meshcollider/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "9d4b3d86b694ac6e56495e1955f6bf5ff584cbb9",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9d4b3d86b694ac6e56495e1955f6bf5ff584cbb9",
      "created_at": "2020-07-23T03:22:53Z"
    },
    {
      "event": "referenced",
      "id": 3584495681,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1ODQ0OTU2ODE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3584495681",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "855dce67868f9ecca7db1deeab29437a431d08df",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/855dce67868f9ecca7db1deeab29437a431d08df",
      "created_at": "2020-07-24T15:49:42Z"
    },
    {
      "event": "referenced",
      "id": 3599845209,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM1OTk4NDUyMDk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3599845209",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "8db23349fe9b512e6801d59d17052c5a7a1c64df",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8db23349fe9b512e6801d59d17052c5a7a1c64df",
      "created_at": "2020-07-29T16:24:31Z"
    },
    {
      "event": "referenced",
      "id": 3606894959,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM2MDY4OTQ5NTk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3606894959",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "fbe47717c0b6175352758facd1ecded386a7be78",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/fbe47717c0b6175352758facd1ecded386a7be78",
      "created_at": "2020-07-31T05:10:53Z"
    },
    {
      "event": "locked",
      "id": 7287986327,
      "node_id": "LOE_lADOABII584k01j-zwAAAAGyZdiX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7287986327",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-30T14:09:27Z",
      "lock_reason": "resolved"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426012118",
      "pull_request_review_id": 412921503,
      "id": 426012118,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjExOA==",
      "diff_hunk": "@@ -103,6 +105,207 @@ static void WalletShowInfo(CWallet* wallet_instance)\n     tfm::format(std::cout, \"Address Book: %zu\\n\", wallet_instance->m_address_book.size());\n }\n \n+/* End of headers, beginning of key/value data */\n+static const char *HEADER_END = \"HEADER=END\";\n+/* End of key/value data */\n+static const char *DATA_END = \"DATA=END\";\n+\n+static bool SalvageWallet(fs::path path)",
      "path": "src/wallet/wallettool.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "0f991e733516fa26e1ceaca10a5b582093950e53",
      "in_reply_to_id": null,
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `const fs::path&`\r\n\r\nin commit: d4a55140ea3e47ee6e4c93c484c7c72cfed741dd",
      "created_at": "2020-05-15T19:44:02Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426012118",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426012118"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426013423",
      "pull_request_review_id": 412923311,
      "id": 426013423,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMzQyMw==",
      "diff_hunk": "@@ -54,7 +54,6 @@ void WalletInit::AddWalletOptions() const\n     gArgs.AddArg(\"-paytxfee=<amt>\", strprintf(\"Fee (in %s/kB) to add to transactions you send (default: %s)\",\n                                                             CURRENCY_UNIT, FormatMoney(CFeeRate{DEFAULT_PAY_TX_FEE}.GetFeePerK())), ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n     gArgs.AddArg(\"-rescan\", \"Rescan the block chain for missing wallet transactions on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n-    gArgs.AddArg(\"-salvagewallet\", \"Attempt to recover private keys from a corrupt wallet on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);",
      "path": "src/wallet/init.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "8ef1b45b4d3de71214da1a6bc6e09f6e9a14d7d4",
      "in_reply_to_id": null,
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "IMO \"Attempt to recover private keys from a corrupt wallet\" explains salvage more clearly than \"Perform salvage operations on a wallet file\". I understand that's specific to `RecoverKeysOnlyFilter`, but perhaps its possible to clarify the documentation?\r\n\r\n",
      "created_at": "2020-05-15T19:46:53Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426013423",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426013423"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 57,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067977",
      "pull_request_review_id": 412994378,
      "id": 426067977,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Nzk3Nw==",
      "diff_hunk": "@@ -103,6 +105,207 @@ static void WalletShowInfo(CWallet* wallet_instance)\n     tfm::format(std::cout, \"Address Book: %zu\\n\", wallet_instance->m_address_book.size());\n }\n \n+/* End of headers, beginning of key/value data */\n+static const char *HEADER_END = \"HEADER=END\";\n+/* End of key/value data */\n+static const char *DATA_END = \"DATA=END\";\n+\n+static bool SalvageWallet(fs::path path)",
      "path": "src/wallet/wallettool.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "0f991e733516fa26e1ceaca10a5b582093950e53",
      "in_reply_to_id": 426012118,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This commit is part of #18918 so comments should be left there.",
      "created_at": "2020-05-15T22:08:15Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067977",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067977"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067999",
      "pull_request_review_id": 412994405,
      "id": 426067999,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Nzk5OQ==",
      "diff_hunk": "@@ -54,7 +54,6 @@ void WalletInit::AddWalletOptions() const\n     gArgs.AddArg(\"-paytxfee=<amt>\", strprintf(\"Fee (in %s/kB) to add to transactions you send (default: %s)\",\n                                                             CURRENCY_UNIT, FormatMoney(CFeeRate{DEFAULT_PAY_TX_FEE}.GetFeePerK())), ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n     gArgs.AddArg(\"-rescan\", \"Rescan the block chain for missing wallet transactions on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n-    gArgs.AddArg(\"-salvagewallet\", \"Attempt to recover private keys from a corrupt wallet on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);",
      "path": "src/wallet/init.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "8ef1b45b4d3de71214da1a6bc6e09f6e9a14d7d4",
      "in_reply_to_id": 426013423,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This commit is part of #18918 so comments should be left there.",
      "created_at": "2020-05-15T22:08:20Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067999",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067999"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 57,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427420606",
      "pull_request_review_id": 414600810,
      "id": 427420606,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyMDYwNg==",
      "diff_hunk": "@@ -287,11 +290,47 @@ class WalletBatch\n     //! Abort current transaction\n     bool TxnAbort();\n private:\n-    BerkeleyBatch m_batch;\n     WalletDatabase& m_database;\n };\n \n //! Compacts BDB state so that wallet.dat is self-contained (if there are changes)\n void MaybeCompactWalletDB();\n \n+//! State of scanning the wallet during ReadKeyValue\n+class CWalletScanState {\n+public:\n+    unsigned int nKeys{0};\n+    unsigned int nCKeys{0};\n+    unsigned int nWatchKeys{0};\n+    unsigned int nKeyMeta{0};\n+    unsigned int m_unknown_records{0};\n+    bool fIsEncrypted{false};\n+    bool fAnyUnordered{false};\n+    std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_active_external_spks;\n+    std::map<OutputType, uint256> m_active_internal_spks;\n+    std::map<uint256, DescriptorCache> m_descriptor_caches;\n+    std::map<std::pair<uint256, CKeyID>, CKey> m_descriptor_keys;\n+    std::map<std::pair<uint256, CKeyID>, std::pair<CPubKey, std::vector<unsigned char>>> m_descriptor_crypt_keys;\n+\n+    CWalletScanState() {\n+    }\n+};\n+\n+//! Unserialize a give Key-Value pair and load it into the wallet and wallet scan state\n+bool ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n+             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);",
      "path": "src/wallet/walletdb.h",
      "position": null,
      "original_position": 110,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "6c47d41779ec5b335acf75652228d541b7a5b67a",
      "in_reply_to_id": null,
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "When building with clang --enable-debug -Werror I'm seeing the following compiler error:\r\n\r\n```cpp\r\n./wallet/walletdb.h:322:112: error: member access into incomplete type 'CWallet'\r\n             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);\r\n                                                                                                               ^\r\n./wallet/ismine.h:14:7: note: forward declaration of 'CWallet'\r\nclass CWallet;\r\n      ^\r\n1 error generated.\r\n```",
      "created_at": "2020-05-19T16:05:32Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427420606",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427420606"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 322,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427423048",
      "pull_request_review_id": 414603837,
      "id": 427423048,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyMzA0OA==",
      "diff_hunk": "@@ -287,11 +290,47 @@ class WalletBatch\n     //! Abort current transaction\n     bool TxnAbort();\n private:\n-    BerkeleyBatch m_batch;\n     WalletDatabase& m_database;\n };\n \n //! Compacts BDB state so that wallet.dat is self-contained (if there are changes)\n void MaybeCompactWalletDB();\n \n+//! State of scanning the wallet during ReadKeyValue\n+class CWalletScanState {\n+public:\n+    unsigned int nKeys{0};\n+    unsigned int nCKeys{0};\n+    unsigned int nWatchKeys{0};\n+    unsigned int nKeyMeta{0};\n+    unsigned int m_unknown_records{0};\n+    bool fIsEncrypted{false};\n+    bool fAnyUnordered{false};\n+    std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_active_external_spks;\n+    std::map<OutputType, uint256> m_active_internal_spks;\n+    std::map<uint256, DescriptorCache> m_descriptor_caches;\n+    std::map<std::pair<uint256, CKeyID>, CKey> m_descriptor_keys;\n+    std::map<std::pair<uint256, CKeyID>, std::pair<CPubKey, std::vector<unsigned char>>> m_descriptor_crypt_keys;\n+\n+    CWalletScanState() {\n+    }\n+};\n+\n+//! Unserialize a give Key-Value pair and load it into the wallet and wallet scan state\n+bool ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n+             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);",
      "path": "src/wallet/walletdb.h",
      "position": null,
      "original_position": 110,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "6c47d41779ec5b335acf75652228d541b7a5b67a",
      "in_reply_to_id": 427420606,
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "(It may not be directly related to this PR; saw a similar build error in another wallet PR today.)",
      "created_at": "2020-05-19T16:09:00Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427423048",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427423048"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 322,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431230059",
      "pull_request_review_id": 419340191,
      "id": 431230059,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIzMDA1OQ==",
      "diff_hunk": "@@ -3680,17 +3680,7 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n \n     // Keep same database environment instance across Verify/Recover calls below.\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n-\n-    try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n-    } catch (const fs::filesystem_error& e) {",
      "path": "src/wallet/wallet.cpp",
      "position": 25,
      "original_position": 9,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "289aa21c6a6c11ce172a92f878a3ede6652fc2e4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (289aa21c6a6c11ce172a92f878a3ede6652fc2e4)\r\n\r\nHere and below filesystem_error is no longer caught. Would suggest adding it back to preserve error handling behavior (I could be missing something but it looks like BerkeleyEnvironment::Open could still throw this error)",
      "created_at": "2020-05-27T15:26:21Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431230059",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431230059"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3714,
      "original_line": 3714,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431245932",
      "pull_request_review_id": 419340191,
      "id": 431245932,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI0NTkzMg==",
      "diff_hunk": "@@ -351,13 +351,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "d0ccd47c355319ec9709c52cdcdf0be78a26ac25",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Db->open to BerkeleyDatabase::Open\" (d0ccd47c355319ec9709c52cdcdf0be78a26ac25)\r\n\r\nNote: seems like there two small changes to behavior here when IsDummy is true: CLIENT_VERSION is written and strFile member is set, but both changes seem good.",
      "created_at": "2020-05-27T15:46:34Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431245932",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431245932"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 366,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432114397",
      "pull_request_review_id": 420480068,
      "id": 432114397,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDM5Nw==",
      "diff_hunk": "@@ -3680,17 +3680,7 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n \n     // Keep same database environment instance across Verify/Recover calls below.\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n-\n-    try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n-    } catch (const fs::filesystem_error& e) {",
      "path": "src/wallet/wallet.cpp",
      "position": 25,
      "original_position": 9,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "289aa21c6a6c11ce172a92f878a3ede6652fc2e4",
      "in_reply_to_id": 431230059,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Added it back.",
      "created_at": "2020-05-28T20:48:20Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432114397",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432114397"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3714,
      "original_line": 3714,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432660562",
      "pull_request_review_id": 421187137,
      "id": 432660562,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MDU2Mg==",
      "diff_hunk": "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 45,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nNote: Was looking into history of why the previous code was calling CheckUniqueFileid in a loop instead of doing a map lookup. Looks like it was done to keep changes minimal in https://github.com/bitcoin/bitcoin/pull/11687/commits/d8a99f65e53019becdd8d2631396012bafb29741 and avoid needing to change CheckUniqueFileid. Looping or mapping was never needed before that commit because only one environment at a time could be opened.",
      "created_at": "2020-05-29T18:22:45Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432660562",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432660562"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 425,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432665557",
      "pull_request_review_id": 421187137,
      "id": 432665557,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2NTU1Nw==",
      "diff_hunk": "@@ -27,22 +27,7 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n-\n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n-    }\n-\n-    for (const auto& item : env.m_fileids) {\n-        if (fileid == item.second && &fileid != &item.second) {\n-            throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (duplicates fileid %s from %s)\", filename,\n-                HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n-        }\n-    }\n-}\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nWould be good to add GUARDED_BY(cs_db) if possible",
      "created_at": "2020-05-29T18:33:08Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432665557",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432665557"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 30,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432669086",
      "pull_request_review_id": 421187137,
      "id": 432669086,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2OTA4Ng==",
      "diff_hunk": "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);\n+            m_file_path = (env->Directory() / strFile).string();\n+\n+            if (!env->IsMock()) {\n+                // Check that the BDB file id has not already been loaded in any BDB environment\n+                // to avoid BDB data consistency bugs that happen when different data\n+                // files in the same environment have the same fileid. All BDB environments are\n+                // checked to prevent bitcoin from opening the same data file through another\n+                // environment when the file is referenced through equivalent but\n+                // not obviously identical symlinked or hard linked or bind mounted\n+                // paths. In the future a more relaxed check for equal inode and\n+                // device ids could be done instead, which would allow opening\n+                // different backup copies of a wallet at the same time. Maybe even\n+                // more ideally, an exclusive lock for accessing the database could\n+                // be implemented, so no equality checks are needed at all. (Newer\n+                // versions of BDB have an set_lk_exclusive method for this\n+                // purpose, but the older version we use does not.)\n+                WalletDatabaseFileId fileid;\n+                int fileid_ret = pdb_temp->get_mpf()->get_fileid(fileid.value);\n+                if (fileid_ret != 0) {\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (get_fileid failed with %d)\", strFile, fileid_ret));\n+                }\n+                for (const auto& item : g_fileids) {\n+                    if (fileid == item.second && item.first != m_file_path) {\n+                        throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (duplicates fileid %s from %s)\", strFile,\n+                            HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n+                    }\n+                }\n+                g_fileids[m_file_path] = fileid;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 73,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nThis is just a style comment, but there's already a lot going on in this method, and it might be nice to move this long comment and block of code out to a `void AddUniqueFileId(Db& db, const std::string& path)` helper function that gets file id, checks it and adds it to the map",
      "created_at": "2020-05-29T18:40:46Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432669086",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432669086"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432677500",
      "pull_request_review_id": 421187137,
      "id": 432677500,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY3NzUwMA==",
      "diff_hunk": "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Add BerkeleyDatabase::Release\" (bd13bec012a56447e0dae9e46ba3693bcc2b561d)\r\n\r\nNote: Maybe this comment could be extended to say how Release should be used. The commit message has a longer comment, but I'm not sure I understand it. Particularly: \"Flush can be done before Release, and Close after.\" I don't see how calling close after release could be safe because it it would decrement the use count twice. Is the idea that caller should do something like Open Change Release, Open Change Release, Open Change Close? It'd be good to have some kind of RAII WalletBatch type class to force correct usage, if something like this isn't already added later",
      "created_at": "2020-05-29T18:58:22Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432677500",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432677500"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432686357",
      "pull_request_review_id": 421187137,
      "id": 432686357,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4NjM1Nw==",
      "diff_hunk": "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 32,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nWhy is this calling g_dbenvs.erase? It seems like it is redundant with env = nullptr assignment below which should trigger erasing in BerkeleyEnvironment::~BerkeleyEnvironment destructor. It also seems unsafe if there's another database open in the same environment.",
      "created_at": "2020-05-29T19:18:46Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432686357",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432686357"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 365,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432690287",
      "pull_request_review_id": 421187137,
      "id": 432690287,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MDI4Nw==",
      "diff_hunk": "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 69,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nQ: If there are multiple databases open in the same environment, previously logs would be consolidated and removed if any database was closed and no other database was writing, but now it will not consolidate logs until the last database in the environment is closed? This seems fine, but it would be good if the commit message was clearer about what the exact change in behavior is since this doesn't seem purely like a refactoring.\r\n\r\nAlso, maybe the commit could be split up. It seems like log consolidation code moving from here to the environment destructor could be done independently of the flush/close api change. I could be missing the connection, though.",
      "created_at": "2020-05-29T19:28:01Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432690287",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432690287"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 637,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432694132",
      "pull_request_review_id": 421187137,
      "id": 432694132,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5NDEzMg==",
      "diff_hunk": "@@ -720,22 +728,16 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n     }\n }\n \n-void BerkeleyDatabase::Flush(bool shutdown)\n+void BerkeleyDatabase::Close()\n {\n     if (!IsDummy()) {\n-        env->Flush(shutdown);\n-        if (shutdown) {\n-            LOCK(cs_db);\n-            g_dbenvs.erase(env->Directory().string());\n-            env = nullptr;\n-        } else {\n-            // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the\n-            // first database shutdown when multiple databases are open in the same\n-            // environment, should replace raw database `env` pointers with shared or weak\n-            // pointers, or else separate the database and environment shutdowns so\n-            // environments can be shut down after databases.\n-            g_fileids.erase(m_file_path);\n-        }\n+        env->Flush();\n+        // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 105,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nTodo was actually already implemented and should be dropped. It was added in 2d796faf62095e83f74337c26e7e1a8c3957cf3c https://github.com/bitcoin/bitcoin/pull/14320#discussion_r227811095 and implemented in f1f4bb7345b90853ec5037478173601035593d26 #11911",
      "created_at": "2020-05-29T19:36:58Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432694132",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432694132"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 735,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432704579",
      "pull_request_review_id": 421187137,
      "id": 432704579,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwNDU3OQ==",
      "diff_hunk": "@@ -652,30 +646,23 @@ bool BerkeleyDatabase::PeriodicFlush()\n     {\n         // Don't do this if any databases are in use\n         int nRefCount = 0;\n-        std::map<std::string, int>::iterator mit = env->mapFileUseCount.begin();\n-        while (mit != env->mapFileUseCount.end())\n-        {\n-            nRefCount += (*mit).second;\n-            mit++;\n+        for (auto& db_it : env->m_databases) {\n+            nRefCount += db_it.second.get().m_refcount;\n         }\n \n         if (nRefCount == 0)\n         {\n             boost::this_thread::interruption_point();\n-            std::map<std::string, int>::iterator mi = env->mapFileUseCount.find(strFile);\n-            if (mi != env->mapFileUseCount.end())\n-            {\n-                LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n-                int64_t nStart = GetTimeMillis();\n+            LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n+            int64_t nStart = GetTimeMillis();\n \n-                // Flush wallet file so it's self contained\n-                env->CloseDb(strFile);\n-                env->CheckpointLSN(strFile);\n+            // Flush wallet file so it's self contained\n+            env->CloseDb(strFile);\n+            env->CheckpointLSN(strFile);\n \n-                env->mapFileUseCount.erase(mi++);\n-                LogPrint(BCLog::WALLETDB, \"Flushed %s %dms\\n\", strFile, GetTimeMillis() - nStart);\n-                ret = true;\n-            }\n+            m_refcount = 0;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 130,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9cfb631f808aa6ccb10ab31d4b8325bd940a8916)\r\n\r\nWhat's this doing? It seems like either this should already be 0 or it would be unsafe to overwrite if not already 0",
      "created_at": "2020-05-29T19:53:37Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432704579",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432704579"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 663,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432708264",
      "pull_request_review_id": 421187137,
      "id": 432708264,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwODI2NA==",
      "diff_hunk": "@@ -531,11 +529,10 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n     while (true) {\n         {\n             LOCK(cs_db);\n-            if (!env->mapFileUseCount.count(strFile) || env->mapFileUseCount[strFile] == 0) {\n+            if (database.m_refcount == 0) {\n                 // Flush log data to the dat file\n                 env->CloseDb(strFile);\n                 env->CheckpointLSN(strFile);\n-                env->mapFileUseCount.erase(strFile);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 66,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9cfb631f808aa6ccb10ab31d4b8325bd940a8916)\r\n\r\nNote: seems this commit drops distinction between use count being 0 and use count not existing (no map entry). I think 0 use count meant the database wasn't in use but wasn't flushed yet, and no use count meant it was flushed. I think the last piece of code which used this distinction was the log_archive code removed in the previous commit 1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "created_at": "2020-05-29T20:01:52Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432708264",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432708264"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 534,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432987494",
      "pull_request_review_id": 421530443,
      "id": 432987494,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk4NzQ5NA==",
      "diff_hunk": "@@ -3682,15 +3682,11 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n \n     try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n+        return database->Verify(error_string);\n     } catch (const fs::filesystem_error& e) {\n         error_string = Untranslated(strprintf(\"Error loading wallet %s. %s\", location.GetName(), fsbridge::get_filesystem_error_message(e)));\n         return false;\n     }\n-\n-    return WalletBatch::VerifyDatabaseFile(wallet_path, error_string);",
      "path": "src/wallet/wallet.cpp",
      "position": 30,
      "original_position": 13,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "4decfab19f26cf21be6da1a371220e918c0d2dc8",
      "in_reply_to_id": null,
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: assert as unreachable?",
      "created_at": "2020-05-31T21:49:56Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432987494",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432987494"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3719,
      "original_line": 3719,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432999447",
      "pull_request_review_id": 421542040,
      "id": 432999447,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5OTQ0Nw==",
      "diff_hunk": "@@ -141,10 +142,14 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::vector<bilingual_str> warnings;",
      "path": "src/wallet/wallettool.cpp",
      "position": null,
      "original_position": 46,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f06619ecd41d08484e02e41fc06a840b9057fcb6",
      "in_reply_to_id": null,
      "user": {
        "login": "Empact",
        "id": 5470,
        "node_id": "MDQ6VXNlcjU0NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Empact",
        "html_url": "https://github.com/Empact",
        "followers_url": "https://api.github.com/users/Empact/followers",
        "following_url": "https://api.github.com/users/Empact/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Empact/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Empact/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
        "organizations_url": "https://api.github.com/users/Empact/orgs",
        "repos_url": "https://api.github.com/users/Empact/repos",
        "events_url": "https://api.github.com/users/Empact/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Empact/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: this is unused",
      "created_at": "2020-06-01T00:16:40Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432999447",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432999447"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433411606",
      "pull_request_review_id": 422080385,
      "id": 433411606,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMTYwNg==",
      "diff_hunk": "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "in_reply_to_id": 432677500,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think you are confusing `BerkeleyBatch` and `BerkeleyDatabase`. `Release` is called by `BerkeleyBatch::Close`, not `BerkeleyDatabase::Close`.\r\n\r\nIn a later commit, a corresponding `Acquire` function is added. In this commit, the thing that `Acquire` does is part of `Open`. The idea with the refcount is thusly: when something tries to use the database, it increments the refcount. When it is done, it decrements the refcount. The goal is to prevent the database from closing while something is still using the database. When `WalletBatch` is initialized, it calls `BerkeleyDatabase::Open` via `BerkeleyBatch`'s constructor. When `WalletBatch` is done and no longer being used, it calls `BerkeleyBatch::Close` which calls `BerkeleyDatabase::Release`. Then both the `BerkeleyBatch` and `WalletBatch` are destructed. The `BerkeleyDatabase` remains open so that future uses of the database don't need to reopen it and for other concurrent `WalletBatch`s to do their work.\r\n\r\nSo the flow with `BerkeleyDatabase` is `Open`, changes, `Release`, `Close`.",
      "created_at": "2020-06-01T18:28:29Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433411606",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433411606"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433417571",
      "pull_request_review_id": 422087985,
      "id": 433417571,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNzU3MQ==",
      "diff_hunk": "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 32,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432686357,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not entirely sure, but this is moved code.\r\n\r\nThis was originally called during `BerkeleyDatabase::Flush(true)`, i.e. when the database and environment are being closed. So I moved it into the destructor to go along with the other environment closing changes.",
      "created_at": "2020-06-01T18:39:57Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433417571",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433417571"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 365,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433425570",
      "pull_request_review_id": 422098277,
      "id": 433425570,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTU3MA==",
      "diff_hunk": "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 69,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432690287,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Q: If there are multiple databases open in the same environment, previously logs would be consolidated and removed if any database was closed and no other database was writing, but now it will not consolidate logs until the last database in the environment is closed?\r\n\r\nI don't think that's what happened previously either. `Flush(true)` seems to have been only called during a bitcoind shutdown, not during typical wallet unloading. So previously, even after a wallet was unloaded, it's log files were never consolidated and removed. So this behavior ends up being retained. I don't think there is a behavior change here, although the it is difficult to work out exactly when the database and environment are actually being flushed and closed.",
      "created_at": "2020-06-01T18:55:04Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433425570",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433425570"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 637,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433435981",
      "pull_request_review_id": 422111876,
      "id": 433435981,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNTk4MQ==",
      "diff_hunk": "@@ -27,22 +27,7 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n-\n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n-    }\n-\n-    for (const auto& item : env.m_fileids) {\n-        if (fileid == item.second && &fileid != &item.second) {\n-            throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (duplicates fileid %s from %s)\", filename,\n-                HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n-        }\n-    }\n-}\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "in_reply_to_id": 432665557,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-01T19:16:31Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433435981",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433435981"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 30,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436045",
      "pull_request_review_id": 422111945,
      "id": 433436045,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjA0NQ==",
      "diff_hunk": "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);\n+            m_file_path = (env->Directory() / strFile).string();\n+\n+            if (!env->IsMock()) {\n+                // Check that the BDB file id has not already been loaded in any BDB environment\n+                // to avoid BDB data consistency bugs that happen when different data\n+                // files in the same environment have the same fileid. All BDB environments are\n+                // checked to prevent bitcoin from opening the same data file through another\n+                // environment when the file is referenced through equivalent but\n+                // not obviously identical symlinked or hard linked or bind mounted\n+                // paths. In the future a more relaxed check for equal inode and\n+                // device ids could be done instead, which would allow opening\n+                // different backup copies of a wallet at the same time. Maybe even\n+                // more ideally, an exclusive lock for accessing the database could\n+                // be implemented, so no equality checks are needed at all. (Newer\n+                // versions of BDB have an set_lk_exclusive method for this\n+                // purpose, but the older version we use does not.)\n+                WalletDatabaseFileId fileid;\n+                int fileid_ret = pdb_temp->get_mpf()->get_fileid(fileid.value);\n+                if (fileid_ret != 0) {\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (get_fileid failed with %d)\", strFile, fileid_ret));\n+                }\n+                for (const auto& item : g_fileids) {\n+                    if (fileid == item.second && item.first != m_file_path) {\n+                        throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (duplicates fileid %s from %s)\", strFile,\n+                            HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n+                    }\n+                }\n+                g_fileids[m_file_path] = fileid;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 73,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "in_reply_to_id": 432669086,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-01T19:16:37Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436045",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436045"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436141",
      "pull_request_review_id": 422112081,
      "id": 433436141,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjE0MQ==",
      "diff_hunk": "@@ -720,22 +728,16 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n     }\n }\n \n-void BerkeleyDatabase::Flush(bool shutdown)\n+void BerkeleyDatabase::Close()\n {\n     if (!IsDummy()) {\n-        env->Flush(shutdown);\n-        if (shutdown) {\n-            LOCK(cs_db);\n-            g_dbenvs.erase(env->Directory().string());\n-            env = nullptr;\n-        } else {\n-            // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the\n-            // first database shutdown when multiple databases are open in the same\n-            // environment, should replace raw database `env` pointers with shared or weak\n-            // pointers, or else separate the database and environment shutdowns so\n-            // environments can be shut down after databases.\n-            g_fileids.erase(m_file_path);\n-        }\n+        env->Flush();\n+        // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 105,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432694132,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Removed it",
      "created_at": "2020-06-01T19:16:50Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436141",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436141"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 735,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436200",
      "pull_request_review_id": 422112156,
      "id": 433436200,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjIwMA==",
      "diff_hunk": "@@ -652,30 +646,23 @@ bool BerkeleyDatabase::PeriodicFlush()\n     {\n         // Don't do this if any databases are in use\n         int nRefCount = 0;\n-        std::map<std::string, int>::iterator mit = env->mapFileUseCount.begin();\n-        while (mit != env->mapFileUseCount.end())\n-        {\n-            nRefCount += (*mit).second;\n-            mit++;\n+        for (auto& db_it : env->m_databases) {\n+            nRefCount += db_it.second.get().m_refcount;\n         }\n \n         if (nRefCount == 0)\n         {\n             boost::this_thread::interruption_point();\n-            std::map<std::string, int>::iterator mi = env->mapFileUseCount.find(strFile);\n-            if (mi != env->mapFileUseCount.end())\n-            {\n-                LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n-                int64_t nStart = GetTimeMillis();\n+            LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n+            int64_t nStart = GetTimeMillis();\n \n-                // Flush wallet file so it's self contained\n-                env->CloseDb(strFile);\n-                env->CheckpointLSN(strFile);\n+            // Flush wallet file so it's self contained\n+            env->CloseDb(strFile);\n+            env->CheckpointLSN(strFile);\n \n-                env->mapFileUseCount.erase(mi++);\n-                LogPrint(BCLog::WALLETDB, \"Flushed %s %dms\\n\", strFile, GetTimeMillis() - nStart);\n-                ret = true;\n-            }\n+            m_refcount = 0;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 130,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "in_reply_to_id": 432704579,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Removed",
      "created_at": "2020-06-01T19:16:57Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436200",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436200"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 663,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436314",
      "pull_request_review_id": 422112303,
      "id": 433436314,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjMxNA==",
      "diff_hunk": "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 69,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432690287,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Also split this commit as you suggested.",
      "created_at": "2020-06-01T19:17:10Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436314",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436314"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 637,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436356",
      "pull_request_review_id": 422112361,
      "id": 433436356,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjM1Ng==",
      "diff_hunk": "@@ -3682,15 +3682,11 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n \n     try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n+        return database->Verify(error_string);\n     } catch (const fs::filesystem_error& e) {\n         error_string = Untranslated(strprintf(\"Error loading wallet %s. %s\", location.GetName(), fsbridge::get_filesystem_error_message(e)));\n         return false;\n     }\n-\n-    return WalletBatch::VerifyDatabaseFile(wallet_path, error_string);",
      "path": "src/wallet/wallet.cpp",
      "position": 30,
      "original_position": 13,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "4decfab19f26cf21be6da1a371220e918c0d2dc8",
      "in_reply_to_id": 432987494,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-01T19:17:17Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436356",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436356"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3719,
      "original_line": 3719,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436421",
      "pull_request_review_id": 422112433,
      "id": 433436421,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjQyMQ==",
      "diff_hunk": "@@ -141,10 +142,14 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::vector<bilingual_str> warnings;",
      "path": "src/wallet/wallettool.cpp",
      "position": null,
      "original_position": 46,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f06619ecd41d08484e02e41fc06a840b9057fcb6",
      "in_reply_to_id": 432999447,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Removed",
      "created_at": "2020-06-01T19:17:24Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436421",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436421"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434111610",
      "pull_request_review_id": 422974932,
      "id": 434111610,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExMTYxMA==",
      "diff_hunk": "@@ -349,13 +349,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {\n+    pdb = database.m_db.get();\n+    strFile = database.strFile;\n+    if (strchr(pszMode, 'c') != nullptr && !Exists(std::string(\"version\"))) {\n+        bool fTmp = fReadOnly;\n+        fReadOnly = false;\n+        Write(std::string(\"version\"), CLIENT_VERSION);\n+        fReadOnly = fTmp;\n+    }\n+}\n+\n+void BerkeleyDatabase::Open(const char* pszMode)\n+{\n+    m_read_only = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 3cdb7fd9d1e92f07c04c325c9b585ff736162198: it's a bit odd that you're introducing `m_read_only` here because it's not read anywhere yet. 64a5a29d692378df443ae599b81c1f4547ec3d03 seems a better place to introduce it.",
      "created_at": "2020-06-02T19:03:33Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r434111610",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434111610"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 368,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434130529",
      "pull_request_review_id": 422974932,
      "id": 434130529,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMDUyOQ==",
      "diff_hunk": "@@ -377,19 +389,19 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n                 DbMpoolFile* mpf = pdb_temp->get_mpf();\n                 ret = mpf->set_flags(DB_MPOOL_NOFILE, 1);\n                 if (ret != 0) {\n-                    throw std::runtime_error(strprintf(\"BerkeleyBatch: Failed to configure for no temp file backing for database %s\", strFilename));\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Failed to configure for no temp file backing for database %s\", strFile));\n                 }\n             }\n \n             ret = pdb_temp->open(nullptr,                             // Txn pointer\n-                            fMockDb ? nullptr : strFilename.c_str(),  // Filename\n-                            fMockDb ? strFilename.c_str() : \"main\",   // Logical db name\n+                            fMockDb ? nullptr : strFile.c_str(),  // Filename\n+                            fMockDb ? strFile.c_str() : \"main\",   // Logical db name",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 55,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "3cdb7fd9d1e92f07c04c325c9b585ff736162198 nit: rename breaks comment indent (it's still broken in `bdb.cpp` after the move)",
      "created_at": "2020-06-02T19:37:04Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r434130529",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434130529"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 398,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434132604",
      "pull_request_review_id": 422974932,
      "id": 434132604,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMjYwNA==",
      "diff_hunk": "@@ -349,13 +349,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {\n+    pdb = database.m_db.get();\n+    strFile = database.strFile;\n+    if (strchr(pszMode, 'c') != nullptr && !Exists(std::string(\"version\"))) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "3cdb7fd9d1e92f07c04c325c9b585ff736162198  nit: the `fCreate` helper variable makes this more readable. It's introduced in a later commit, but might as well do it here.",
      "created_at": "2020-06-02T19:41:18Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r434132604",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434132604"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 358,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436743379",
      "pull_request_review_id": 426287040,
      "id": 436743379,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0MzM3OQ==",
      "diff_hunk": "@@ -25,24 +26,39 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids GUARDED_BY(cs_db);\n \n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n+static void AddUniqueFileId(Db& db, const std::string& path, const std::string& filename)",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (b6a6e0292c226f67b9ee177f9732a936aa7a0d7e)\r\n\r\nMinor: it would be better to drop `filename` argument and just print `path` value instead in all the error messages below currently using `filename`. When this code was originally written, there was only one environment so it made sense to print just the `filename` without the environment path. But now that `-wallet` values are usually environment paths, not filenames in a shared environment, `filename` isn't descriptive or unique anymore.",
      "created_at": "2020-06-08T14:15:49Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436743379",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436743379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 31,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436769899",
      "pull_request_review_id": 426287040,
      "id": 436769899,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2OTg5OQ==",
      "diff_hunk": "@@ -25,24 +26,39 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids GUARDED_BY(cs_db);\n \n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n+static void AddUniqueFileId(Db& db, const std::string& path, const std::string& filename)\n+{\n+    LOCK(cs_db);\n+    // Check that the BDB file id has not already been loaded in any BDB environment\n+    // to avoid BDB data consistency bugs that happen when different data\n+    // files in the same environment have the same fileid. All BDB environments are",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 25,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (b6a6e0292c226f67b9ee177f9732a936aa7a0d7e)\r\n\r\nMinor: It would be good to restore the new paragraph break before \"All BDB environments\" and replace \"All BDB environments are checked to prevent...\" with \"In addition to disallowing opening databases with the same fileid in the same environment, also disallow opening databases with the same fileid in other environments to prevent...\"\r\n\r\nThe first sentence here is talking about a necessary fix (from #11476) for a BDB corruption issue. The second sentence and rest of the paragraph is talking about a different, clumsy workaround (from https://github.com/bitcoin/bitcoin/pull/11687#event-1366258575) to try to prevent bitcoin from reopening an already opened wallet, which it would be better to remove and replace with some type of exclusive lock",
      "created_at": "2020-06-08T14:52:58Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436769899",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436769899"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436849879",
      "pull_request_review_id": 426287040,
      "id": 436849879,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0OTg3OQ==",
      "diff_hunk": "@@ -445,7 +444,6 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             m_db.reset(pdb_temp.release());\n \n         }\n-        ++env->mapFileUseCount[strFile];",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 42,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9603e233c9c4049a267282615b5e4f31600656e6",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9603e233c9c4049a267282615b5e4f31600656e6)\r\n\r\nNote: Line is moved outside this function to the only caller, BerkeleyBatch::BerkeleyBatch",
      "created_at": "2020-06-08T16:49:40Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436849879",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436849879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 448,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436855238",
      "pull_request_review_id": 426287040,
      "id": 436855238,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NTIzOA==",
      "diff_hunk": "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "in_reply_to_id": 432677500,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Add BerkeleyDatabase::Release\" (8726d373e165087789933eb03383dd7feee31d3f)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432677500\r\n\r\n> So the flow with `BerkeleyDatabase` is `Open`, changes, `Release`, `Close`.\r\n\r\nThank you! I was missing the idea that Release wouldn't actively close anything, just lazily indicate that it could be closed.\r\n\r\nMaybe just add \"and that it could be flushed or closed\" to the first sentence in the comment. I might also rename Acquire/Release to AddRef/RemoveRef to suggest that these are accounting functions and not functions that actually acquire or release resources.  ",
      "created_at": "2020-06-08T16:58:47Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436855238",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436855238"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436856577",
      "pull_request_review_id": 426287040,
      "id": 436856577,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NjU3Nw==",
      "diff_hunk": "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 32,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432686357,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (f3b553f36e83c44a4edb51710ae673d6b9b3e573)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432686357\r\n\r\n> Not entirely sure, but this is moved code.\r\n> \r\n> This was originally called during `BerkeleyDatabase::Flush(true)`, i.e. when the database and environment are being closed. So I moved it into the destructor to go along with the other environment closing changes.\r\n\r\nThanks for explaining. It looks like the previous code has the same bug and could also inappropriately erase a g_dbenvs entry for an environment with multiple open databases. However, the previous code was less likely to cause problems, because it only ran when the whole node was shutting down (fShutdown=true). Now that this code runs not just when completely shutting down (e.g. it also runs during unloadwallet calls), it could cause new corruption issues if a g_dbenvs entry is missing and there's a later loadwallet call.\r\n\r\nSo I think you want to drop g_dbenvs.erase() here and just let the BerkeleyEnvironment destructor do the erasing. I think you could drop the `env = nullptr` here too.\r\n\r\n",
      "created_at": "2020-06-08T17:01:05Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436856577",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436856577"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 365,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436856857",
      "pull_request_review_id": 426287040,
      "id": 436856857,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Njg1Nw==",
      "diff_hunk": "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 69,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432690287,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move log consolidation into BerkeleyEnvironment::Close\" (2c663e453104b2f49849d8bc80727e98abda8055)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432690287\r\n\r\n> I don't think there is a behavior change here, although the it is difficult to work out exactly when the database and environment are actually being flushed and closed.\r\n\r\nThanks I missed that Flush(true) was wasn't called on unload.\r\n\r\nI think it's good if the commit message at least says what the change intends without getting into details, so reviewers have something to check and so we know if changes are going in a consistent direction.\r\n\r\nIn this case would suggest adding something like: \"With this change, logs are now consolidated whenever the last database in an environment is closed (e.g. a in unloadwallet RPC call), instead of only during node shutdown and wallet encryption.\" to commit message for \"walletdb: Move log consolidation into BerkeleyEnvironment::Close\" (2c663e453104b2f49849d8bc80727e98abda8055).",
      "created_at": "2020-06-08T17:01:34Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436856857",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436856857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 637,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436940102",
      "pull_request_review_id": 426287040,
      "id": 436940102,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0MDEwMg==",
      "diff_hunk": "@@ -430,7 +430,12 @@ bool CWallet::HasWalletSpend(const uint256& txid) const\n \n void CWallet::Flush(bool shutdown)\n {\n-    database->Flush(shutdown);\n+    if (database) {\n+        database->Close();\n+        if (shutdown) {\n+            database.reset();",
      "path": "src/wallet/wallet.cpp",
      "position": null,
      "original_position": 17,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f3b553f36e83c44a4edb51710ae673d6b9b3e573",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (f3b553f36e83c44a4edb51710ae673d6b9b3e573)\r\n\r\nI don't think it makes sense to add this new database.reset() here. The only two places calling this function with shutdown=true are immediately deleting the whole CWallet[1][2], so having this condition and branch just seems like adding complexity for no reason. If there is a reason why we want a CWallet instance with a null database pointer, saying what that reason is in a comment on the database.reset() call here would be helpful.\r\n\r\n[1] https://github.com/bitcoin/bitcoin/blob/f3b553f36e83c44a4edb51710ae673d6b9b3e573/src/wallet/wallet.cpp#L116-L117\r\n[2] https://github.com/bitcoin/bitcoin/blob/f3b553f36e83c44a4edb51710ae673d6b9b3e573/src/init.cpp#L284-L296",
      "created_at": "2020-06-08T19:14:44Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436940102",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436940102"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436976128",
      "pull_request_review_id": 426287040,
      "id": 436976128,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NjEyOA==",
      "diff_hunk": "@@ -740,7 +742,8 @@ void BerkeleyDatabase::Flush(bool shutdown)\n             // environment, should replace raw database `env` pointers with shared or weak\n             // pointers, or else separate the database and environment shutdowns so\n             // environments can be shut down after databases.\n-            env->m_fileids.erase(strFile);\n+            LOCK(cs_db);\n+            g_fileids.erase(m_file_path);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 93,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (b6a6e0292c226f67b9ee177f9732a936aa7a0d7e)\r\n\r\nThis isn't actually the right place to be erasing the fileid entry. A Fileid entry is created when a database is opened (when BerkeleyDatabase::m_db is set in BerkeleyDatabase::Open) and it should be erased when the database is closed (when BerkeleyDatabase::m_db is deleted in BerkeleyEnvironment::CloseDb and BerkeleyEnvironment::CloseDb).\r\n\r\nSo I think this whole else block should be dropped and g_fileids.erase calls just added the two places where m_db.reset() is called.\r\n\r\nIt looks like this code *mostly* worked before because the fileids.erase here was usually paired with a CloseDb call inside the env->Flush(shutdown) line above calling m_db.reset(). But with bad timing, a g_fileids entry could be erased without a database close, resulting in missing \"duplicates fileid\" errors, and a database could be closed without deleting a g_fileids entry resulting in spurious \"duplicates fileid\" errors. Better not to carry this strangeness forward, and simply pair all m_db and g_fileids updates together.\r\n\r\n",
      "created_at": "2020-06-08T20:20:05Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436976128",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436976128"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 746,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437012889",
      "pull_request_review_id": 426287040,
      "id": 437012889,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAxMjg4OQ==",
      "diff_hunk": "@@ -384,6 +384,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f3b553f36e83c44a4edb51710ae673d6b9b3e573",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (f3b553f36e83c44a4edb51710ae673d6b9b3e573)\r\n\r\nCould you add an `assert(!m_db);` here as well? The Close() call above *should* be properly closing the database but this depends on a big strand of spaghetti that an assert might prevent getting chewed up in the future.",
      "created_at": "2020-06-08T21:31:00Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437012889",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437012889"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 393,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437020063",
      "pull_request_review_id": 426287040,
      "id": 437020063,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyMDA2Mw==",
      "diff_hunk": "@@ -371,6 +369,7 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr), m_database(database)\n {\n     database.Open(pszMode);\n+    database.Acquire();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9603e233c9c4049a267282615b5e4f31600656e6",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9603e233c9c4049a267282615b5e4f31600656e6)\r\n\r\nI think you need to call Acquire() here before Open() not after. Now that the reference count is no longer protected by the cs_db mutex there is a race condition where rewrite/flush/backup functions could start running between the Open and Acquire calls here and and start rewriting/flushing/backing up while this batch is active.",
      "created_at": "2020-06-08T21:47:27Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437020063",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437020063"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437028132",
      "pull_request_review_id": 426287040,
      "id": 437028132,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyODEzMg==",
      "diff_hunk": "@@ -755,9 +740,11 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n-    {\n-        LOCK(cs_db);\n-        --env->mapFileUseCount[strFile];\n-    }\n+    m_refcount--;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 156,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9603e233c9c4049a267282615b5e4f31600656e6",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9603e233c9c4049a267282615b5e4f31600656e6)\r\n\r\nEven though `m_refcount` is atomic you still have to lock cs_db while updating it, otherwise the `m_db_in_use.notify_all()` call may result in a lost wakeup and infinite hang if the `m_db_in_use.wait()` lambda happens to run at the same time `m_refcount` is decremented and return `false` (see https://stackoverflow.com/a/41875321 or https://github.com/isocpp/CppCoreGuidelines/issues/554).",
      "created_at": "2020-06-08T22:07:20Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437028132",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437028132"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 743,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437039174",
      "pull_request_review_id": 426287040,
      "id": 437039174,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAzOTE3NA==",
      "diff_hunk": "@@ -550,17 +550,17 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                         fSuccess = false;\n                     }\n \n-                    Dbc* pcursor = db.GetCursor();\n-                    if (pcursor)\n+                    if (db.CreateCursor())",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "2711caa2a2d4f04b848c25b614b353a1a08351b0",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (2711caa2a2d4f04b848c25b614b353a1a08351b0)\r\n\r\nBehavior isn't changing in this commit, but error handling here is broken, right? This should be returning failure if creating a cursor doesn't succeed, not just pretending it succeeded and not reading anything.",
      "created_at": "2020-06-08T22:37:01Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437039174",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437039174"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 553,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437039991",
      "pull_request_review_id": 426287040,
      "id": 437039991,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAzOTk5MQ==",
      "diff_hunk": "@@ -332,27 +333,32 @@ class BerkeleyBatch\n         return (ret == 0);\n     }\n \n-    Dbc* GetCursor()\n+    bool CreateCursor()\n     {\n         if (!pdb)\n-            return nullptr;\n-        Dbc* pcursor = nullptr;\n-        int ret = pdb->cursor(nullptr, &pcursor, 0);\n+            return false;\n+        m_cursor = nullptr;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "2711caa2a2d4f04b848c25b614b353a1a08351b0",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (2711caa2a2d4f04b848c25b614b353a1a08351b0)\r\n\r\nI think this needs to either return false if m_cursor is not null or assert that it is null, otherwise calling this at the wrong time will silently leak memory",
      "created_at": "2020-06-08T22:39:23Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437039991",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437039991"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 340,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437308991",
      "pull_request_review_id": 427008108,
      "id": 437308991,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwODk5MQ==",
      "diff_hunk": "@@ -536,7 +534,8 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                 LogPrintf(\"BerkeleyBatch::Rewrite: Rewriting %s...\\n\", strFile);\n                 std::string strFileRes = strFile + \".rewrite\";\n                 { // surround usage of db with extra {}\n-                    BerkeleyBatch db(database, \"r\");\n+                    Open(\"r\");\n+                    Acquire();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "75f3532a70abf4331aba212f979a2e8be02d191c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Rewrite into BerkeleyDatabase\" (75f3532a70abf4331aba212f979a2e8be02d191c)\r\n\r\nI think Acquire and Release calls here should be dropped because they are misleading and don't do anything and add extra potential for leaks and bugs. Acquire/Release are used for shared access to a database, but this is doing exclusive access, with cs_db locked the whole time. It might be good to have a comment though. \r\n\r\n```c++\r\n// Not calling Acquire/Release here because this is an exclusive database\r\n// operation done with cs_db locked the entire time.\r\nOpen(\"r\"); \r\n```",
      "created_at": "2020-06-09T10:33:02Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437308991",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437308991"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 538,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437309866",
      "pull_request_review_id": 427008108,
      "id": 437309866,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwOTg2Ng==",
      "diff_hunk": "@@ -536,7 +534,8 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                 LogPrintf(\"BerkeleyBatch::Rewrite: Rewriting %s...\\n\", strFile);\n                 std::string strFileRes = strFile + \".rewrite\";\n                 { // surround usage of db with extra {}\n-                    BerkeleyBatch db(database, \"r\");",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 25,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "75f3532a70abf4331aba212f979a2e8be02d191c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Rewrite into BerkeleyDatabase\" (75f3532a70abf4331aba212f979a2e8be02d191c)\r\n\r\nShould remove comment previous line referring to `db` now outdated",
      "created_at": "2020-06-09T10:34:45Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437309866",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437309866"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 540,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437320102",
      "pull_request_review_id": 427008108,
      "id": 437320102,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMyMDEwMg==",
      "diff_hunk": "@@ -706,6 +706,10 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n \n void BerkeleyDatabase::Close()\n {\n+    if (m_active_txn) {\n+        m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Txn* functions into WalletDatabase\" (e1ebc69a5e6628cadf480dfd6d787a6c9f631b86)\r\n\r\nThis seems bad. If there's an ongoing transaction and the database is closed, this should raise or return some error, not silently throw away data",
      "created_at": "2020-06-09T10:54:59Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437320102",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437320102"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 710,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437330343",
      "pull_request_review_id": 427008108,
      "id": 437330343,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzMDM0Mw==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Txn* functions into WalletDatabase\" (e1ebc69a5e6628cadf480dfd6d787a6c9f631b86)\r\n\r\nThis might do more damage than the abort call in Close(). I don't think there's any point to having a shared reference count if one user of the database can silently abort a transaction created by a different user of the database.\r\n\r\nI'm skeptical of the database having these new `Dbc* m_cursor` and `DbTxn* m_active_txn` members. I suspect you're putting these in the Database class because you don't want to have more than one class with virtual methods, but it seems to me these really belong in the batch object, not the database object. It's not coherent to have a shared reference count but only allow a single cursor and a single transaction at a time, and have different batches abort each others transactions and step on each others cursors.\r\n\r\nI'm kind of surprised this code works at all. I suspect it does because wallet only makes limited use of transactions and cursors (since it loads most of the database into memory on startup) and our python tests don't call RPC methods in parallel, so the database is usually accessed from a single thread.\r\n\r\n\r\n\r\n",
      "created_at": "2020-06-09T11:15:30Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437330343",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437330343"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437342744",
      "pull_request_review_id": 427008108,
      "id": 437342744,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0Mjc0NA==",
      "diff_hunk": "@@ -124,6 +124,11 @@ class BerkeleyDatabase\n     Dbc* m_cursor = nullptr;\n     DbTxn* m_active_txn = nullptr;\n \n+    bool DBRead(CDataStream& key, CDataStream& value) const;\n+    bool DBWrite(CDataStream& key, CDataStream& value, bool overwrite=true) const;\n+    bool DBErase(CDataStream& key) const;\n+    bool DBExists(CDataStream& key) const;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "aac3483e9e0423b3414cfaf84f37041a200d773c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: refactor Read, Write, Erase, and Exists into non-template func\" (aac3483e9e0423b3414cfaf84f37041a200d773c)\r\n\r\nMinor: DBRead does need something like a `CDataStream& value` argument to write into but all the other `CDataStream&` arguments are just byte strings and could be `Span<char>` typed instead. Actually even DBRead could use `Span` if written as\r\n\r\n```c++\r\nbool DBRead(Span<const char> key, std::function<void(Span<char>)> value);\r\n```\r\n\r\nBut feel free to ignore this since I think it mostly just comes from me liking Span more than CDataStream.\r\n\r\nOther minor suggestions:\r\n\r\n- Would name these `ReadKey` `WriteKey` `EraseKey` `HasKey` because \tDB` prefix is redundant (every method here is a db method) and these are specifically accessing keys in the database, not really the database itself.\r\n\r\n- Would drop `const` method keyword if/when these become virtual methods. I think virtual const methods should usually be avoided, because `const` exposes an implementation detail of subclasses to the parent class, and can infectiously force other subclasses to do dumb things like have mutable members or add pointless indirection to work around the inherited const.",
      "created_at": "2020-06-09T11:40:30Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437342744",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437342744"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": 127,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 130,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437350249",
      "pull_request_review_id": 427008108,
      "id": 437350249,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM1MDI0OQ==",
      "diff_hunk": "@@ -215,91 +220,65 @@ class BerkeleyDatabase\n     template <typename K, typename T>\n     bool Read(const K& key, T& value)\n     {\n-        if (!m_db)\n-            return false;\n-\n         // Key\n         CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n         ssKey.reserve(1000);\n         ssKey << key;\n-        SafeDbt datKey(ssKey.data(), ssKey.size());\n \n-        // Read\n-        SafeDbt datValue;\n-        int ret = m_db->get(m_active_txn, datKey, datValue, 0);\n+        CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n         bool success = false;\n-        if (datValue.get_data() != nullptr) {\n+        bool ret = DBRead(ssKey, ssValue);\n+        if (ret) {\n             // Unserialize value\n             try {\n-                CDataStream ssValue((char*)datValue.get_data(), (char*)datValue.get_data() + datValue.get_size(), SER_DISK, CLIENT_VERSION);\n                 ssValue >> value;\n                 success = true;\n             } catch (const std::exception&) {\n                 // In this case success remains 'false'\n             }\n         }\n-        return ret == 0 && success;\n+        return ret && success;\n     }\n \n     template <typename K, typename T>\n     bool Write(const K& key, const T& value, bool fOverwrite = true)\n     {\n-        if (!m_db)\n-            return true;\n-        if (m_read_only)\n-            assert(!\"Write called on database in read-only mode\");\n-\n         // Key\n         CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n         ssKey.reserve(1000);\n         ssKey << key;\n-        SafeDbt datKey(ssKey.data(), ssKey.size());\n \n         // Value\n         CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n         ssValue.reserve(10000);\n         ssValue << value;\n-        SafeDbt datValue(ssValue.data(), ssValue.size());\n \n         // Write\n-        int ret = m_db->put(m_active_txn, datKey, datValue, (fOverwrite ? 0 : DB_NOOVERWRITE));",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "aac3483e9e0423b3414cfaf84f37041a200d773c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: refactor Read, Write, Erase, and Exists into non-template func\" (aac3483e9e0423b3414cfaf84f37041a200d773c)\r\n\r\nI like this commit! Nice to keep the template messiness and bdb messiness separate.",
      "created_at": "2020-06-09T11:55:14Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437350249",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437350249"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 265,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437356565",
      "pull_request_review_id": 427008108,
      "id": 437356565,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM1NjU2NQ==",
      "diff_hunk": "@@ -182,35 +182,47 @@ class WalletBatch\n     template <typename K, typename T>\n     bool WriteIC(const K& key, const T& value, bool fOverwrite = true)\n     {\n-        if (!m_batch.Write(key, value, fOverwrite)) {\n+        if (!m_database.Write(key, value, fOverwrite)) {\n             return false;\n         }\n         m_database.IncrementUpdateCounter();\n         if (m_database.nUpdateCounter % 1000 == 0) {\n-            m_batch.Flush();\n+            m_database.Flush();\n         }\n         return true;\n     }\n \n     template <typename K>\n     bool EraseIC(const K& key)\n     {\n-        if (!m_batch.Erase(key)) {\n+        if (!m_database.Erase(key)) {\n             return false;\n         }\n         m_database.IncrementUpdateCounter();\n         if (m_database.nUpdateCounter % 1000 == 0) {\n-            m_batch.Flush();\n+            m_database.Flush();\n         }\n         return true;\n     }\n \n+    bool m_flush_on_close;\n public:\n     explicit WalletBatch(WalletDatabase& database, const char* pszMode = \"r+\", bool _fFlushOnClose = true) :\n-        m_batch(database, pszMode, _fFlushOnClose),\n+        m_flush_on_close(_fFlushOnClose),\n         m_database(database)\n     {\n+        database.Open(pszMode);\n+        database.Acquire();",
      "path": "src/wallet/walletdb.h",
      "position": null,
      "original_position": 39,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "64a5a29d692378df443ae599b81c1f4547ec3d03",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Remove BerkeleyBatch and have WalletBatch use WalletDatabase\" (64a5a29d692378df443ae599b81c1f4547ec3d03)\r\n\r\nBelieve this should also call acquire before open not after per https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437020063",
      "created_at": "2020-06-09T12:07:05Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437356565",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437356565"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 215,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437370926",
      "pull_request_review_id": 427008108,
      "id": 437370926,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3MDkyNg==",
      "diff_hunk": "@@ -262,7 +211,121 @@ class BerkeleyDatabase\n         return DBExists(ssKey);\n     }\n \n-    bool CreateCursor()\n+    virtual bool CreateCursor() = 0;\n+    virtual bool ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool& complete) = 0;\n+    virtual void CloseCursor() = 0;\n+    virtual bool TxnBegin() = 0;\n+    virtual bool TxnCommit() = 0;\n+    virtual bool TxnAbort() = 0;\n+};\n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strFile) tuple.\n+ **/\n+class BerkeleyDatabase : public WalletDatabase\n+{\n+private:\n+    /** RAII class that automatically cleanses its data on destruction */\n+    class SafeDbt final\n+    {\n+        Dbt m_dbt;\n+\n+    public:\n+        // construct Dbt with internally-managed data\n+        SafeDbt();\n+        // construct Dbt with provided data\n+        SafeDbt(void* data, size_t size);\n+        ~SafeDbt();\n+\n+        // delegate to Dbt\n+        const void* get_data() const;\n+        u_int32_t get_size() const;\n+\n+        // conversion operator to access the underlying Dbt\n+        operator Dbt*();\n+    };\n+\n+    bool m_read_only = false;\n+\n+    Dbc* m_cursor = nullptr;\n+    DbTxn* m_active_txn = nullptr;\n+\n+    /**\n+     * Pointer to shared database environment.\n+     *\n+     * Normally there is only one BerkeleyDatabase object per\n+     * BerkeleyEnvivonment, but in the special, backwards compatible case where\n+     * multiple wallet BDB data files are loaded from the same directory, this\n+     * will point to a shared instance that gets freed when the last data file\n+     * is closed.\n+     */\n+    std::shared_ptr<BerkeleyEnvironment> env;\n+\n+    std::string strFile;\n+    std::string m_file_path;\n+\n+    /** Return whether this database handle is a dummy for testing.\n+     * Only to be used at a low level, application should ideally not care\n+     * about this.\n+     */\n+    bool IsDummy() const { return env == nullptr; }\n+\n+    bool DBRead(CDataStream& key, CDataStream& value) const override;\n+    bool DBWrite(CDataStream& key, CDataStream& value, bool overwrite=true) const override;\n+    bool DBErase(CDataStream& key) const override;\n+    bool DBExists(CDataStream& key) const override;\n+\n+public:\n+    /** Create dummy DB handle */\n+    BerkeleyDatabase() : WalletDatabase(), env(nullptr)\n+    {\n+    }\n+\n+    /** Create DB handle to real database */\n+    BerkeleyDatabase(std::shared_ptr<BerkeleyEnvironment> env, std::string filename) :\n+        WalletDatabase(), env(std::move(env)), strFile(std::move(filename))\n+    {\n+        auto inserted = this->env->m_databases.emplace(strFile, std::ref(*this));\n+        assert(inserted.second);\n+    }\n+\n+    ~BerkeleyDatabase();\n+\n+    /** Database pointer. This is initialized lazily and reset during flushes, so it can be null. */\n+    std::unique_ptr<Db> m_db;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 216,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "4c6c9080d48ec5810e7d36348f7c730a586e9fb5",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Make WalletDatabase abstract class\" (4c6c9080d48ec5810e7d36348f7c730a586e9fb5)\r\n\r\nMinor: Any particular reason this is a public member? (Only asking because I think it would be good for comprehension to declare std::shared_ptr\\<BerkeleyEnvironment> and std::unique_ptr\\<Db> members next to each other)",
      "created_at": "2020-06-09T12:27:36Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437370926",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437370926"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437376848",
      "pull_request_review_id": 427008108,
      "id": 437376848,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3Njg0OA==",
      "diff_hunk": "@@ -13,87 +13,24 @@\n #include <util/system.h>\n \n #include <atomic>\n-#include <map>\n #include <memory>\n #include <string>\n-#include <unordered_map>\n #include <vector>\n \n #if defined(__GNUC__) && !defined(__clang__)\n #pragma GCC diagnostic push\n #pragma GCC diagnostic ignored \"-Wsuggest-override\"\n #endif\n-#include <db_cxx.h>\n #if defined(__GNUC__) && !defined(__clang__)\n #pragma GCC diagnostic pop\n #endif",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 17,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b4c2765fd19e5dd8c823febd65ad5e62a58c8260",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move BDB specific things into bdb.{cpp/h}\" (b4c2765fd19e5dd8c823febd65ad5e62a58c8260)\r\n\r\nI think you can drop all this pragma stuff if you're dropping the db_cxx include",
      "created_at": "2020-06-09T12:34:19Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437376848",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437376848"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": 20,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437482994",
      "pull_request_review_id": 427231129,
      "id": 437482994,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4Mjk5NA==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Txn* functions into WalletDatabase\" ([e1ebc69](https://github.com/bitcoin/bitcoin/commit/e1ebc69a5e6628cadf480dfd6d787a6c9f631b86))\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437330343\r\n\r\n> It's not coherent to have a shared reference count but only allow a single cursor and a single transaction at a time, and have different batches abort each others transactions and step on each others cursors.\r\n\r\nI should be more specific about how I think this could be resolved. I think there are two ways:\r\n\r\n1. Add a bunch of asserts to ensure the new shared cursors and transactions aren't misused. `assert(!m_active_txn)` in TxnBegin and Close and Release, `assert(m_active_txn)` in TxnCommit, TxnAbort, Read, Write, etc. `assert(!m_cursor)` in CreateCursor, etc.\r\n\r\n2. Don't add shared cursors and transactions. Keep the methods where they are currently in `BerkeleyBatch` instead of moving them to `WalletDatabase`. Just make them them virtual overrides and have `BerkeleyBatch` inherit from a `DatabaseBatch` class. Give `WalletDatabase` a virtual `MakeBatch` method returning `unique_ptr<DatabaseBatch>` and have `WalletBatch` call it during construction and use the pointer as needed. You have two classes with virtual methods instead of one class with virtual methods, but less code moves around and the classes have clear responsibilities.\r\n\r\nAnother variants of the second approach are also possible like giving WalletBatch itself virtual methods, but the basic idea's the same.\r\n\r\n",
      "created_at": "2020-06-09T14:48:44Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437482994",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437482994"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437498374",
      "pull_request_review_id": 427260296,
      "id": 437498374,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5ODM3NA==",
      "diff_hunk": "@@ -349,13 +349,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {\n+    pdb = database.m_db.get();\n+    strFile = database.strFile;\n+    if (strchr(pszMode, 'c') != nullptr && !Exists(std::string(\"version\"))) {\n+        bool fTmp = fReadOnly;\n+        fReadOnly = false;\n+        Write(std::string(\"version\"), CLIENT_VERSION);\n+        fReadOnly = fTmp;\n+    }\n+}\n+\n+void BerkeleyDatabase::Open(const char* pszMode)\n+{\n+    m_read_only = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": 434111610,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I'd like to keep it here instead of removing and re-introducing this line.",
      "created_at": "2020-06-09T15:08:25Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437498374",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437498374"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 368,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437625076",
      "pull_request_review_id": 427419958,
      "id": 437625076,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyNTA3Ng==",
      "diff_hunk": "@@ -550,17 +550,17 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                         fSuccess = false;\n                     }\n \n-                    Dbc* pcursor = db.GetCursor();\n-                    if (pcursor)\n+                    if (db.CreateCursor())",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "2711caa2a2d4f04b848c25b614b353a1a08351b0",
      "in_reply_to_id": 437039174,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes, I think error handling is broken here. I think the intent was to ignore an error and just keep trying until it succeeds. But there's nothing to actually have the outer while loop keep going.",
      "created_at": "2020-06-09T18:13:09Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437625076",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437625076"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 553,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437634055",
      "pull_request_review_id": 427431605,
      "id": 437634055,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNDA1NQ==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Transactions are only used during encryption. Cursors are only used by loading, rewriting, and zapwallettx.",
      "created_at": "2020-06-09T18:28:24Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437634055",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437634055"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649218",
      "pull_request_review_id": 427451407,
      "id": 437649218,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTIxOA==",
      "diff_hunk": "@@ -262,7 +211,121 @@ class BerkeleyDatabase\n         return DBExists(ssKey);\n     }\n \n-    bool CreateCursor()\n+    virtual bool CreateCursor() = 0;\n+    virtual bool ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool& complete) = 0;\n+    virtual void CloseCursor() = 0;\n+    virtual bool TxnBegin() = 0;\n+    virtual bool TxnCommit() = 0;\n+    virtual bool TxnAbort() = 0;\n+};\n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strFile) tuple.\n+ **/\n+class BerkeleyDatabase : public WalletDatabase\n+{\n+private:\n+    /** RAII class that automatically cleanses its data on destruction */\n+    class SafeDbt final\n+    {\n+        Dbt m_dbt;\n+\n+    public:\n+        // construct Dbt with internally-managed data\n+        SafeDbt();\n+        // construct Dbt with provided data\n+        SafeDbt(void* data, size_t size);\n+        ~SafeDbt();\n+\n+        // delegate to Dbt\n+        const void* get_data() const;\n+        u_int32_t get_size() const;\n+\n+        // conversion operator to access the underlying Dbt\n+        operator Dbt*();\n+    };\n+\n+    bool m_read_only = false;\n+\n+    Dbc* m_cursor = nullptr;\n+    DbTxn* m_active_txn = nullptr;\n+\n+    /**\n+     * Pointer to shared database environment.\n+     *\n+     * Normally there is only one BerkeleyDatabase object per\n+     * BerkeleyEnvivonment, but in the special, backwards compatible case where\n+     * multiple wallet BDB data files are loaded from the same directory, this\n+     * will point to a shared instance that gets freed when the last data file\n+     * is closed.\n+     */\n+    std::shared_ptr<BerkeleyEnvironment> env;\n+\n+    std::string strFile;\n+    std::string m_file_path;\n+\n+    /** Return whether this database handle is a dummy for testing.\n+     * Only to be used at a low level, application should ideally not care\n+     * about this.\n+     */\n+    bool IsDummy() const { return env == nullptr; }\n+\n+    bool DBRead(CDataStream& key, CDataStream& value) const override;\n+    bool DBWrite(CDataStream& key, CDataStream& value, bool overwrite=true) const override;\n+    bool DBErase(CDataStream& key) const override;\n+    bool DBExists(CDataStream& key) const override;\n+\n+public:\n+    /** Create dummy DB handle */\n+    BerkeleyDatabase() : WalletDatabase(), env(nullptr)\n+    {\n+    }\n+\n+    /** Create DB handle to real database */\n+    BerkeleyDatabase(std::shared_ptr<BerkeleyEnvironment> env, std::string filename) :\n+        WalletDatabase(), env(std::move(env)), strFile(std::move(filename))\n+    {\n+        auto inserted = this->env->m_databases.emplace(strFile, std::ref(*this));\n+        assert(inserted.second);\n+    }\n+\n+    ~BerkeleyDatabase();\n+\n+    /** Database pointer. This is initialized lazily and reset during flushes, so it can be null. */\n+    std::unique_ptr<Db> m_db;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 216,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "4c6c9080d48ec5810e7d36348f7c730a586e9fb5",
      "in_reply_to_id": 437370926,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "BerkeleyEnvironment needs this.",
      "created_at": "2020-06-09T18:55:29Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437649218",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649218"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649732",
      "pull_request_review_id": 427452033,
      "id": 437649732,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTczMg==",
      "diff_hunk": "@@ -377,19 +389,19 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n                 DbMpoolFile* mpf = pdb_temp->get_mpf();\n                 ret = mpf->set_flags(DB_MPOOL_NOFILE, 1);\n                 if (ret != 0) {\n-                    throw std::runtime_error(strprintf(\"BerkeleyBatch: Failed to configure for no temp file backing for database %s\", strFilename));\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Failed to configure for no temp file backing for database %s\", strFile));\n                 }\n             }\n \n             ret = pdb_temp->open(nullptr,                             // Txn pointer\n-                            fMockDb ? nullptr : strFilename.c_str(),  // Filename\n-                            fMockDb ? strFilename.c_str() : \"main\",   // Logical db name\n+                            fMockDb ? nullptr : strFile.c_str(),  // Filename\n+                            fMockDb ? strFile.c_str() : \"main\",   // Logical db name",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 55,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": 434130529,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed",
      "created_at": "2020-06-09T18:56:19Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437649732",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649732"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 398,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649850",
      "pull_request_review_id": 427452203,
      "id": 437649850,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTg1MA==",
      "diff_hunk": "@@ -349,13 +349,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {\n+    pdb = database.m_db.get();\n+    strFile = database.strFile;\n+    if (strchr(pszMode, 'c') != nullptr && !Exists(std::string(\"version\"))) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "3cdb7fd9d1e92f07c04c325c9b585ff736162198",
      "in_reply_to_id": 434132604,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:56:30Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437649850",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649850"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 358,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649940",
      "pull_request_review_id": 427452322,
      "id": 437649940,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTk0MA==",
      "diff_hunk": "@@ -25,24 +26,39 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids GUARDED_BY(cs_db);\n \n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n+static void AddUniqueFileId(Db& db, const std::string& path, const std::string& filename)",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": 436743379,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:56:39Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437649940",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437649940"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 31,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650033",
      "pull_request_review_id": 427452427,
      "id": 437650033,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDAzMw==",
      "diff_hunk": "@@ -25,24 +26,39 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids GUARDED_BY(cs_db);\n \n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n+static void AddUniqueFileId(Db& db, const std::string& path, const std::string& filename)\n+{\n+    LOCK(cs_db);\n+    // Check that the BDB file id has not already been loaded in any BDB environment\n+    // to avoid BDB data consistency bugs that happen when different data\n+    // files in the same environment have the same fileid. All BDB environments are",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 25,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": 436769899,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:56:47Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437650033",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650033"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650226",
      "pull_request_review_id": 427452698,
      "id": 437650226,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDIyNg==",
      "diff_hunk": "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "in_reply_to_id": 432677500,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:57:09Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437650226",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650226"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650293",
      "pull_request_review_id": 427452796,
      "id": 437650293,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDI5Mw==",
      "diff_hunk": "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 32,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432686357,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:57:16Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437650293",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650293"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 365,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650379",
      "pull_request_review_id": 427452903,
      "id": 437650379,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDM3OQ==",
      "diff_hunk": "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 69,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "in_reply_to_id": 432690287,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:57:25Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437650379",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 637,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650692",
      "pull_request_review_id": 427453316,
      "id": 437650692,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MDY5Mg==",
      "diff_hunk": "@@ -430,7 +430,12 @@ bool CWallet::HasWalletSpend(const uint256& txid) const\n \n void CWallet::Flush(bool shutdown)\n {\n-    database->Flush(shutdown);\n+    if (database) {\n+        database->Close();\n+        if (shutdown) {\n+            database.reset();",
      "path": "src/wallet/wallet.cpp",
      "position": null,
      "original_position": 17,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f3b553f36e83c44a4edb51710ae673d6b9b3e573",
      "in_reply_to_id": 436940102,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Removed.",
      "created_at": "2020-06-09T18:57:59Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437650692",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437650692"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651334",
      "pull_request_review_id": 427454171,
      "id": 437651334,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTMzNA==",
      "diff_hunk": "@@ -740,7 +742,8 @@ void BerkeleyDatabase::Flush(bool shutdown)\n             // environment, should replace raw database `env` pointers with shared or weak\n             // pointers, or else separate the database and environment shutdowns so\n             // environments can be shut down after databases.\n-            env->m_fileids.erase(strFile);\n+            LOCK(cs_db);\n+            g_fileids.erase(m_file_path);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 93,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b6a6e0292c226f67b9ee177f9732a936aa7a0d7e",
      "in_reply_to_id": 436976128,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This can't be moved into CloseDb. However I have moved it into `BerkeleyEnvironment::Close`.",
      "created_at": "2020-06-09T18:59:09Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651334",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 746,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651412",
      "pull_request_review_id": 427454270,
      "id": 437651412,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTQxMg==",
      "diff_hunk": "@@ -384,6 +384,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "f3b553f36e83c44a4edb51710ae673d6b9b3e573",
      "in_reply_to_id": 437012889,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:18Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651412",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651412"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 393,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651487",
      "pull_request_review_id": 427454360,
      "id": 437651487,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTQ4Nw==",
      "diff_hunk": "@@ -371,6 +369,7 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr), m_database(database)\n {\n     database.Open(pszMode);\n+    database.Acquire();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9603e233c9c4049a267282615b5e4f31600656e6",
      "in_reply_to_id": 437020063,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:26Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651487",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651487"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651549",
      "pull_request_review_id": 427454414,
      "id": 437651549,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTU0OQ==",
      "diff_hunk": "@@ -755,9 +740,11 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n-    {\n-        LOCK(cs_db);\n-        --env->mapFileUseCount[strFile];\n-    }\n+    m_refcount--;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 156,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "9603e233c9c4049a267282615b5e4f31600656e6",
      "in_reply_to_id": 437028132,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:31Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651549",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651549"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 743,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651616",
      "pull_request_review_id": 427454500,
      "id": 437651616,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTYxNg==",
      "diff_hunk": "@@ -332,27 +333,32 @@ class BerkeleyBatch\n         return (ret == 0);\n     }\n \n-    Dbc* GetCursor()\n+    bool CreateCursor()\n     {\n         if (!pdb)\n-            return nullptr;\n-        Dbc* pcursor = nullptr;\n-        int ret = pdb->cursor(nullptr, &pcursor, 0);\n+            return false;\n+        m_cursor = nullptr;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 20,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "2711caa2a2d4f04b848c25b614b353a1a08351b0",
      "in_reply_to_id": 437039991,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:39Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651616",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651616"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 340,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651672",
      "pull_request_review_id": 427454568,
      "id": 437651672,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTY3Mg==",
      "diff_hunk": "@@ -536,7 +534,8 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                 LogPrintf(\"BerkeleyBatch::Rewrite: Rewriting %s...\\n\", strFile);\n                 std::string strFileRes = strFile + \".rewrite\";\n                 { // surround usage of db with extra {}\n-                    BerkeleyBatch db(database, \"r\");\n+                    Open(\"r\");\n+                    Acquire();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "75f3532a70abf4331aba212f979a2e8be02d191c",
      "in_reply_to_id": 437308991,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:45Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651672",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651672"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 538,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651724",
      "pull_request_review_id": 427454636,
      "id": 437651724,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MTcyNA==",
      "diff_hunk": "@@ -536,7 +534,8 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                 LogPrintf(\"BerkeleyBatch::Rewrite: Rewriting %s...\\n\", strFile);\n                 std::string strFileRes = strFile + \".rewrite\";\n                 { // surround usage of db with extra {}\n-                    BerkeleyBatch db(database, \"r\");",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 25,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "75f3532a70abf4331aba212f979a2e8be02d191c",
      "in_reply_to_id": 437309866,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T18:59:50Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651724",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437651724"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 540,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652048",
      "pull_request_review_id": 427455040,
      "id": 437652048,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MjA0OA==",
      "diff_hunk": "@@ -124,6 +124,11 @@ class BerkeleyDatabase\n     Dbc* m_cursor = nullptr;\n     DbTxn* m_active_txn = nullptr;\n \n+    bool DBRead(CDataStream& key, CDataStream& value) const;\n+    bool DBWrite(CDataStream& key, CDataStream& value, bool overwrite=true) const;\n+    bool DBErase(CDataStream& key) const;\n+    bool DBExists(CDataStream& key) const;",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "aac3483e9e0423b3414cfaf84f37041a200d773c",
      "in_reply_to_id": 437342744,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Renamed and removed `const`",
      "created_at": "2020-06-09T19:00:22Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437652048",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652048"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": 127,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 130,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652096",
      "pull_request_review_id": 427455115,
      "id": 437652096,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MjA5Ng==",
      "diff_hunk": "@@ -182,35 +182,47 @@ class WalletBatch\n     template <typename K, typename T>\n     bool WriteIC(const K& key, const T& value, bool fOverwrite = true)\n     {\n-        if (!m_batch.Write(key, value, fOverwrite)) {\n+        if (!m_database.Write(key, value, fOverwrite)) {\n             return false;\n         }\n         m_database.IncrementUpdateCounter();\n         if (m_database.nUpdateCounter % 1000 == 0) {\n-            m_batch.Flush();\n+            m_database.Flush();\n         }\n         return true;\n     }\n \n     template <typename K>\n     bool EraseIC(const K& key)\n     {\n-        if (!m_batch.Erase(key)) {\n+        if (!m_database.Erase(key)) {\n             return false;\n         }\n         m_database.IncrementUpdateCounter();\n         if (m_database.nUpdateCounter % 1000 == 0) {\n-            m_batch.Flush();\n+            m_database.Flush();\n         }\n         return true;\n     }\n \n+    bool m_flush_on_close;\n public:\n     explicit WalletBatch(WalletDatabase& database, const char* pszMode = \"r+\", bool _fFlushOnClose = true) :\n-        m_batch(database, pszMode, _fFlushOnClose),\n+        m_flush_on_close(_fFlushOnClose),\n         m_database(database)\n     {\n+        database.Open(pszMode);\n+        database.Acquire();",
      "path": "src/wallet/walletdb.h",
      "position": null,
      "original_position": 39,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "64a5a29d692378df443ae599b81c1f4547ec3d03",
      "in_reply_to_id": 437356565,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done",
      "created_at": "2020-06-09T19:00:28Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437652096",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652096"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 215,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652157",
      "pull_request_review_id": 427455199,
      "id": 437652157,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1MjE1Nw==",
      "diff_hunk": "@@ -13,87 +13,24 @@\n #include <util/system.h>\n \n #include <atomic>\n-#include <map>\n #include <memory>\n #include <string>\n-#include <unordered_map>\n #include <vector>\n \n #if defined(__GNUC__) && !defined(__clang__)\n #pragma GCC diagnostic push\n #pragma GCC diagnostic ignored \"-Wsuggest-override\"\n #endif\n-#include <db_cxx.h>\n #if defined(__GNUC__) && !defined(__clang__)\n #pragma GCC diagnostic pop\n #endif",
      "path": "src/wallet/db.h",
      "position": null,
      "original_position": 17,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "b4c2765fd19e5dd8c823febd65ad5e62a58c8260",
      "in_reply_to_id": 437376848,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Removed",
      "created_at": "2020-06-09T19:00:35Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437652157",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437652157"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": 20,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437707266",
      "pull_request_review_id": 427531516,
      "id": 437707266,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwNzI2Ng==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I've decided to go with option 1 and added asserts to `CreateCursor` and `TxnBegin`.\r\n\r\nI don't think it makes much sense to support multiple transactions and cursors because of our extremely limited usage of them. Transactions are only used when encrypting a wallet. Cursors are used in scenarios where there is only a single thread accessing the database already. These are in loading (both load and zapwallettx) and rewrite, which is encryption. So there won't be concurrent cursors nor concurrent transactions. Even with multiple parallel RPCs, we use locking during encryption to enforce single access, and during loading, the wallet isn't setup yet to even have multiple accesses.\r\n\r\nAdditionally, in SQLite, there aren't such a thing as multiple transactions, so having a separate `Batch/ class would make that more difficult.",
      "created_at": "2020-06-09T20:45:24Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437707266",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/437707266"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439491744",
      "pull_request_review_id": 429840163,
      "id": 439491744,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MTc0NA==",
      "diff_hunk": "@@ -631,16 +643,9 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n                 if (!fMockDb)\n                     dbenv->lsn_reset(strFile.c_str(), 0);\n                 LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: %s closed\\n\", strFile);\n-                mapFileUseCount.erase(mi++);\n-            } else\n-                mi++;",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 48,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "1b354344ebfc68506484f688f042b0588e83f1c4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1b354344ebfc68506484f688f042b0588e83f1c4)\r\n\r\nIf these lines are removed in this commit, I think this is an infinite loop. Not a serious problem since it's fixed in a later commit, but wanted to make a note",
      "created_at": "2020-06-12T15:34:24Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439491744",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439491744"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": 634,
      "start_side": "LEFT",
      "line": null,
      "original_line": 634,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439605437",
      "pull_request_review_id": 429840163,
      "id": 439605437,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNTQzNw==",
      "diff_hunk": "@@ -126,6 +145,8 @@ void BerkeleyEnvironment::Close()\n         if (database.m_db) {\n             database.m_db->close(0);\n             database.m_db.reset();\n+            LOCK(cs_db);\n+            g_fileids.erase(database.m_file_path);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "43afe48e5848a263240f6e128269d00bf932da61",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (43afe48e5848a263240f6e128269d00bf932da61)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437651334\r\n\r\n> This can't be moved into CloseDb. However I have moved it into `BerkeleyEnvironment::Close`.\r\n\r\nOh you're right, it can't go there because flushes also close the database. But now if two databases are opened in the same environment, and one is closed and reopened, I think there will be an inappropriate \"duplicates fileids\" error on reopening. Calling g_fileids.erase in ~BerkeleyDatabase seems like a way to fix it. Following change there seems to work:\r\n\r\n```diff\r\n@@ -350,6 +350,8 @@ BerkeleyDatabase::~BerkeleyDatabase()\r\n         LOCK(cs_db);\r\n         size_t erased = env->m_databases.erase(strFile);\r\n         assert(erased == 1);\r\n+        g_fileids.erase(m_file_path);\r\n+        assert(erased == 1);\r\n         assert(!m_db);\r\n     }\r\n }\r\n```",
      "created_at": "2020-06-12T19:29:22Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439605437",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439605437"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439608032",
      "pull_request_review_id": 429840163,
      "id": 439608032,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwODAzMg==",
      "diff_hunk": "@@ -584,8 +584,7 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                                 fSuccess = false;\n                         }\n                     if (fSuccess) {\n-                        db.Close();\n-                        env->CloseDb(strFile);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 61,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "cb343b8628587f7ef4949741f666b4ee06f8774d",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Rewrite into BerkeleyDatabase\" (cb343b8628587f7ef4949741f666b4ee06f8774d)\r\n\r\nNote: It's safe to drop this env->CloseDb because m_refcount is will still be 0 here, so BerkeleyDatabase::Close call below will call BerkeleyEnvironment::Flush internally which will call BerkeleyEnvironment::CloseDb",
      "created_at": "2020-06-12T19:35:48Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439608032",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439608032"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 584,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439611086",
      "pull_request_review_id": 429840163,
      "id": 439611086,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYxMTA4Ng==",
      "diff_hunk": "@@ -706,6 +706,10 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n \n void BerkeleyDatabase::Close()\n {\n+    if (m_active_txn) {\n+        m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437320102,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> In commit \"walletdb: Move Txn* functions into WalletDatabase\" ([e1ebc69](https://github.com/bitcoin/bitcoin/commit/e1ebc69a5e6628cadf480dfd6d787a6c9f631b86))\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437320102\r\n\r\nI still don't think it is safe to silently discard data when a database is closed. Suggest `assert(m_active_txn)` or adding other error handling, or moving active transaction back to the batch object for the batch destructor to scope properly",
      "created_at": "2020-06-12T19:44:19Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439611086",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439611086"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 710,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439612875",
      "pull_request_review_id": 429840163,
      "id": 439612875,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYxMjg3NQ==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Txn* functions into WalletDatabase\" (0e96b5b77c33275d287f5c33e77f87ab3f4ac868)\r\n\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437330343\r\n\r\nI don't think it is safe to silently discard data when a reference count is decremented. Suggest `assert(m_active_txn)` or adding other error handling, or moving active transaction back to the batch object for the batch destructor to scope properly",
      "created_at": "2020-06-12T19:48:53Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439612875",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439612875"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439615919",
      "pull_request_review_id": 429840163,
      "id": 439615919,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYxNTkxOQ==",
      "diff_hunk": "@@ -711,13 +711,21 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n \n void BerkeleyDatabase::Close()\n {\n+    if (m_active_txn) {\n+        m_active_txn->abort();\n+    }\n+\n     if (!IsDummy()) {\n         env->Flush();\n     }\n }\n \n void BerkeleyDatabase::Flush()\n {\n+    if (m_active_txn) {",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "0e96b5b77c33275d287f5c33e77f87ab3f4ac868",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Move Txn* functions into WalletDatabase\" (0e96b5b77c33275d287f5c33e77f87ab3f4ac868)\r\n\r\nWhat is this doing? Could you add a code comment to explain it? Maybe log something or return an error? This seems like a change in behavior, and I wouldn't expect there to be a problem checkpointing data just because a transaction's active. Maybe remove this if there isn't a particular reason to think it is necessary.\r\n\r\nTangent: I think it was confusing before that `BerkeleyBatch::Flush` did a completely different thing than `BerkeleyDatabase::Flush` and `BerkeleyEnvironment::Flush` and `CWallet::Flush`. The batch flush meant \"write memory to disk\" and the other flushes meant \"maybe close databases if they arent in use, otherwise do nothing\". Things are even more confusing now with the Batch and Database objects combined. Ideally I think we would stop saying flush and rename the methods to `Checkpoint()` and `CloseIfUnused()` respectively.",
      "created_at": "2020-06-12T19:56:40Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439615919",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439615919"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 725,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439666055",
      "pull_request_review_id": 429840163,
      "id": 439666055,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY2NjA1NQ==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437707266\r\n\r\n> Additionally, in SQLite, there aren't such a thing as multiple transactions, so having a separate `Batch/ class would make that more difficult.\r\n\r\nRIGHT. :sweat_smile: Finally I understand why you are doing this. I thought you had just gone insane wanting to cram the database and batch classes together and make all these extra changes. But I remember using sqlite in python it doesn't support more than one transaction per connection.\r\n\r\nEven so, I don't think this is the best choice or even the easier choice, because it is pushing a problem from the database layer up to the application and RPC layers. Now if there are two RPC calls happening in different threads that both want to open a transaction or a cursor, they have to coordinate with each other to see who is allowed to go first, or risk crashing the process.\r\n\r\nAlso, the C++ code is more complicated than it needs to be because instead of cursors and transactions being owned by batches and getting properly cleaned up when batches are cleaned up, now they can outlive batches, and error handling and cleanup that should be triggered when the batch goes out of scope now gets lost or delayed until a later point, making debugging more difficult. Also the nice layer separation where Batch objects are responsible for data access, and Database objects are responsible for management is lost, and more code has to move, and everything is more complicated.\r\n\r\nIf you like the current organization, then please ignore my suggestion, but here is what I would do:\r\n\r\n- For BDB, put ownership of transaction and cursor objects back in the batch objects where they are happy and belong.\r\n\r\n- For Sqlite, just have `Mutex m_cursor_mutex, m_transaction_mutex` members in the Database instance. Lock m_cursor when a batch object needs a cursor, and unlock when it's done. Similarly for m_transaction. That way if two RPC calls happen, then there aren't errors or aborts, one call just waits for the other.",
      "created_at": "2020-06-12T22:26:53Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439666055",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439666055"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439725880",
      "pull_request_review_id": 430127827,
      "id": 439725880,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNTg4MA==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439666055\r\n\r\n> Now if there are two RPC calls happening in different threads that both want to open a transaction or a cursor, they have to coordinate with each other to see who is allowed to go first, or risk crashing the process.\r\n\r\nI forgot about cs_wallet when writing this. I think with cs_wallet, two batch objects for the same database will probably not even exist at the same time, so asserts only allowing one cursor or transaction should never trigger, and there should be no need for the `m_transaction_mutex` suggestion. Something like `bool m_transaction_started` and `assert(!m_transaction_started)` for sqlite would be fine. And there wouldn't be a need for `m_cursor_mutex` in any case since there's no problem with multiple cursors, just multiple transactions.\r\n\r\nI still think it is better to keep different batch and connection objects for all the other reasons (limiting lifetime of cursor and txn objects, reporting errors earlier, smaller diff, smaller classes, separation of data access methods from database management methods), but with `cs_wallet` the multiple thread RPC request thing should be not be a real issue.",
      "created_at": "2020-06-13T09:46:44Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439725880",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439725880"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439757200",
      "pull_request_review_id": 430155607,
      "id": 439757200,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc1NzIwMA==",
      "diff_hunk": "@@ -739,6 +747,10 @@ std::string BerkeleyDatabaseVersion()\n \n void BerkeleyDatabase::Release()\n {\n+    if (m_active_txn) {\n+       m_active_txn->abort();",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "e1ebc69a5e6628cadf480dfd6d787a6c9f631b86",
      "in_reply_to_id": 437330343,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "There does happen to be a few times where there are multiple `BerkeleyBatch` objects are active, although I don't know where this is happening. You can check this by adding some print lines at the place where `mapFileUseCount` is being updated.\r\n\r\nI will probably rework this PR to keep `BerkeleyBatch` and make the move commits at the beginning so this isn't so difficult to update.",
      "created_at": "2020-06-13T18:02:14Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439757200",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439757200"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 751,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440386812",
      "pull_request_review_id": 430917709,
      "id": 440386812,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4NjgxMg==",
      "diff_hunk": "@@ -126,6 +145,8 @@ void BerkeleyEnvironment::Close()\n         if (database.m_db) {\n             database.m_db->close(0);\n             database.m_db.reset();\n+            LOCK(cs_db);\n+            g_fileids.erase(database.m_file_path);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "43afe48e5848a263240f6e128269d00bf932da61",
      "in_reply_to_id": 439605437,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Do you have a specific scenario where this could happen? This change seems to be causing a test failure.",
      "created_at": "2020-06-15T19:07:16Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r440386812",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440386812"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441652829",
      "pull_request_review_id": 432544614,
      "id": 441652829,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1MjgyOQ==",
      "diff_hunk": "@@ -103,6 +122,8 @@ void BerkeleyEnvironment::Close()\n         if (database.m_db) {\n             database.m_db->close(0);\n             database.m_db.reset();\n+            LOCK(cs_db);\n+            g_fileids.erase(database.m_file_path);",
      "path": "src/wallet/bdb.cpp",
      "position": 74,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "c89ec975fef761bdb39093c37178f37b38b2763d",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (d9cbaa21c351e266a7fc4a52774e85a8e5a3d08d)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r440386812\r\n\r\n> Do you have a specific scenario where this could happen? This change seems to be causing a test failure.\r\n\r\nThe scenario is two wallets A and B are loaded in the same environment, then A is unloaded and B is unloaded. When A is unloaded [`m_database.erase`](https://github.com/bitcoin/bitcoin/blob/d9cbaa21c351e266a7fc4a52774e85a8e5a3d08d/src/wallet/bdb.h#L118) is called so the `m_databases` loop on [line 118 above](https://github.com/bitcoin/bitcoin/blob/d9cbaa21c351e266a7fc4a52774e85a8e5a3d08d/src/wallet/bdb.cpp#L118) that runs when B is unloaded doesn't include A so A's fileid is never erased here. Next time A is loaded there will be a spurious duplicate fileid error.\r\n\r\nIIRC I tested the previous fix on 47dc8d6aff04e4f4c3ed0b4eb28fca0596d020e6 and all tests passed. With the following change on current f370c1c40ea1f152900052ab1a14c6c192350256 all tests seem to pass:\r\n\r\n```diff\r\n--- a/src/wallet/bdb.cpp\r\n+++ b/src/wallet/bdb.cpp\r\n@@ -361,6 +361,17 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\r\n     }\r\n }\r\n \r\n+BerkeleyDatabase::~BerkeleyDatabase() {\r\n+    if (env) {\r\n+        env->CloseDb(strFile);\r\n+        assert(!m_db);\r\n+        size_t erased = env->m_databases.erase(strFile);\r\n+        assert(erased == 1);\r\n+        g_fileids.erase(m_file_path);\r\n+        assert(erased == 1);\r\n+    }\r\n+}\r\n+\r\n void BerkeleyDatabase::Open(const char* pszMode)\r\n {\r\n     if (IsDummy()){\r\ndiff --git a/src/wallet/bdb.h b/src/wallet/bdb.h\r\nindex a638fbf99f9..1db5851e5f6 100644\r\n--- a/src/wallet/bdb.h\r\n+++ b/src/wallet/bdb.h\r\n@@ -112,12 +112,7 @@ public:\r\n         assert(inserted.second);\r\n     }\r\n \r\n-    ~BerkeleyDatabase() override {\r\n-        if (env) {\r\n-            size_t erased = env->m_databases.erase(strFile);\r\n-            assert(erased == 1);\r\n-        }\r\n-    }\r\n+    ~BerkeleyDatabase() override;\r\n \r\n     /** Open the database if it is not already opened. */\r\n     void Open(const char* mode) override;\r\n```",
      "created_at": "2020-06-17T15:54:54Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441652829",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441652829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 125,
      "original_line": 125,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441694302",
      "pull_request_review_id": 432544614,
      "id": 441694302,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5NDMwMg==",
      "diff_hunk": "@@ -528,17 +528,17 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                         fSuccess = false;\n                     }\n \n-                    Dbc* pcursor = db.GetCursor();\n-                    if (pcursor)\n+                    if (db.CreateCursor())",
      "path": "src/wallet/bdb.cpp",
      "position": 315,
      "original_position": 15,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc)\r\n\r\nAs noted https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437625076, the error handling for failing to get a cursor here is broken. It had been broken before this commit, but now this commit is introducing a new way for getting a cursor to fail (the case where m_cursor is not null), so this might be making the problem worse. A simple way to fix this while keeping status quo would be to assert(!m_cursor) in CreateCursor instead of returning false. Otherwise it probably would be good to do improve the error handling here and at least log or return failure.",
      "created_at": "2020-06-17T17:01:47Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441694302",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441694302"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 546,
      "original_line": 546,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441696102",
      "pull_request_review_id": 432544614,
      "id": 441696102,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5NjEwMg==",
      "diff_hunk": "@@ -217,6 +217,7 @@ class BerkeleyBatch\n     Db* pdb;\n     std::string strFile;\n     DbTxn* activeTxn;\n+    Dbc* m_cursor;",
      "path": "src/wallet/bdb.h",
      "position": 137,
      "original_position": 4,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc)\r\n\r\nCould the commit message for this say something about the motivation for this change? It seems good, but I'm also not sure I understand why it's happening.",
      "created_at": "2020-06-17T17:04:57Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441696102",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441696102"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 215,
      "original_line": 215,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441697781",
      "pull_request_review_id": 432544614,
      "id": 441697781,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5Nzc4MQ==",
      "diff_hunk": "@@ -880,8 +886,8 @@ DBErrors WalletBatch::FindWalletTx(std::vector<uint256>& vTxHash, std::list<CWal\n                 ssValue >> vWtx.back();\n             }\n         }\n-        pcursor->close();\n     } catch (...) {\n+        m_batch.CloseCursor();",
      "path": "src/wallet/walletdb.cpp",
      "position": null,
      "original_position": 74,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc)\r\n\r\nIs it intentional to close the cursor in the catch block and stop closing the cursor in the try block? It looks like it could be an accidental change",
      "created_at": "2020-06-17T17:07:43Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441697781",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441697781"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 890,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441699618",
      "pull_request_review_id": 432544614,
      "id": 441699618,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5OTYxOA==",
      "diff_hunk": "@@ -303,8 +304,9 @@ class BerkeleyBatch\n         return HasKey(ssKey);\n     }\n \n-    Dbc* GetCursor();\n-    int ReadAtCursor(Dbc* pcursor, CDataStream& ssKey, CDataStream& ssValue);\n+    bool CreateCursor();\n+    bool ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool& complete);\n+    void CloseCursor();",
      "path": "src/wallet/bdb.h",
      "position": null,
      "original_position": 16,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"walletdb: Handle cursor internally\" (84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc)\r\n\r\nWould it make sense to call CloseCursor in the BerkeleyBatch destructor? It seems like it could guard against memory leaks, and maybe avoid the need to add CloseCursor calls some of the places where they are added.",
      "created_at": "2020-06-17T17:10:54Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441699618",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441699618"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 309,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441722431",
      "pull_request_review_id": 432636150,
      "id": 441722431,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjQzMQ==",
      "diff_hunk": "@@ -103,6 +122,8 @@ void BerkeleyEnvironment::Close()\n         if (database.m_db) {\n             database.m_db->close(0);\n             database.m_db.reset();\n+            LOCK(cs_db);\n+            g_fileids.erase(database.m_file_path);",
      "path": "src/wallet/bdb.cpp",
      "position": 74,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "c89ec975fef761bdb39093c37178f37b38b2763d",
      "in_reply_to_id": 441652829,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ah, I see how that could theoretically happen. I did a bit of testing and wasn't able to trigger a spurious duplicate fileid error. I believe that's because closing database A also closed database B since nothing was using it. So to get this error, B needs to be in use.\r\n\r\nThe reason this was failing tests was because I corrected a mistake in the patch. You have `g_fileids.erase(m_file_path);` which should actually be `erased = g_fileids.erase(m_file_path);`. Otherwise the following `assert(erased == 1);` doesn't do anything. But because `BerkeleyEnvironment::Close` removes the fileid before the destructor is called, this assertion will fail.\r\n\r\nSo instead, I've dropped that assertion but still kept the `g_fileids.erase(m_file_path);`.",
      "created_at": "2020-06-17T17:49:43Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441722431",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441722431"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 125,
      "original_line": 125,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441724394",
      "pull_request_review_id": 432638666,
      "id": 441724394,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNDM5NA==",
      "diff_hunk": "@@ -880,8 +886,8 @@ DBErrors WalletBatch::FindWalletTx(std::vector<uint256>& vTxHash, std::list<CWal\n                 ssValue >> vWtx.back();\n             }\n         }\n-        pcursor->close();\n     } catch (...) {\n+        m_batch.CloseCursor();",
      "path": "src/wallet/walletdb.cpp",
      "position": null,
      "original_position": 74,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": 441697781,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes, this was intentional. I believe previously we could have had a memory leak as the cursor could possible never get closed.\r\n\r\nBefore the while loop is exited, we always close the cursor. So having this at the end of the try block isn't useful. However it is also possible that the while loop is exited by an exception, in which case the cursor would never get closed as the catch block doesn't close it, and the cursor wasn't being closed afterwards. Moving the `CloseCursor` into the catch block handles this case.",
      "created_at": "2020-06-17T17:52:57Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441724394",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441724394"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 890,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441728301",
      "pull_request_review_id": 432643711,
      "id": 441728301,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyODMwMQ==",
      "diff_hunk": "@@ -528,17 +528,17 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n                         fSuccess = false;\n                     }\n \n-                    Dbc* pcursor = db.GetCursor();\n-                    if (pcursor)\n+                    if (db.CreateCursor())",
      "path": "src/wallet/bdb.cpp",
      "position": 315,
      "original_position": 15,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": 441694302,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I've changed `CreateCursor` to assert.",
      "created_at": "2020-06-17T17:59:12Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441728301",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441728301"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 546,
      "original_line": 546,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441728698",
      "pull_request_review_id": 432644293,
      "id": 441728698,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyODY5OA==",
      "diff_hunk": "@@ -217,6 +217,7 @@ class BerkeleyBatch\n     Db* pdb;\n     std::string strFile;\n     DbTxn* activeTxn;\n+    Dbc* m_cursor;",
      "path": "src/wallet/bdb.h",
      "position": 137,
      "original_position": 4,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": 441696102,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.\r\n\r\nThis is happening because `Dbc` is BDB specific so a generic `DatabaseBatch` class can't return them.",
      "created_at": "2020-06-17T17:59:51Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441728698",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441728698"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 215,
      "original_line": 215,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441729173",
      "pull_request_review_id": 432644900,
      "id": 441729173,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyOTE3Mw==",
      "diff_hunk": "@@ -303,8 +304,9 @@ class BerkeleyBatch\n         return HasKey(ssKey);\n     }\n \n-    Dbc* GetCursor();\n-    int ReadAtCursor(Dbc* pcursor, CDataStream& ssKey, CDataStream& ssValue);\n+    bool CreateCursor();\n+    bool ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool& complete);\n+    void CloseCursor();",
      "path": "src/wallet/bdb.h",
      "position": null,
      "original_position": 16,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "84bc5c1705691f4ecdfb8bcc90eb1bc4970281dc",
      "in_reply_to_id": 441699618,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done (I put it in `Close` which is called by the desctructor).",
      "created_at": "2020-06-17T18:00:35Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441729173",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441729173"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 309,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442390278",
      "pull_request_review_id": 433501061,
      "id": 442390278,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDI3OA==",
      "diff_hunk": "@@ -126,6 +145,8 @@ void BerkeleyEnvironment::Close()\n         if (database.m_db) {\n             database.m_db->close(0);\n             database.m_db.reset();\n+            LOCK(cs_db);\n+            g_fileids.erase(database.m_file_path);",
      "path": "src/wallet/db.cpp",
      "position": null,
      "original_position": 67,
      "commit_id": "a2a30a569e4742c53c9f22ec588cf911c9c857f9",
      "original_commit_id": "43afe48e5848a263240f6e128269d00bf932da61",
      "in_reply_to_id": 439605437,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r440386812\r\n\r\n> Do you have a specific scenario where this could happen? This change seems to be causing a test failure.\r\n\r\nMarking resolved, followed up in a new thread: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441652829",
      "created_at": "2020-06-18T17:30:55Z",
      "updated_at": "2020-06-20T02:16:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r442390278",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442390278"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    }
  ]
}