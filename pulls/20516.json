{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516",
    "id": 528347891,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NTI4MzQ3ODkx",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20516",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/20516.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/20516.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/f8866e8c324be3322fa507c2ceb1de35d148d0f1",
    "number": 20516,
    "state": "closed",
    "locked": true,
    "maintainer_can_modify": false,
    "title": "Well-defined CAddress disk serialization, and addrv2 anchors.dat",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Alternative to #20509.\r\n\r\nThis makes the `CAddress` disk serialization format well defined, and uses it to enable addrv2 support in anchors.dat (in a way that's compatible with older software). The new format is:\r\n- The first 4 bytes store a format version number. Its low 19 bits are ignored (as those historically stored the `CLIENT_VERSION`), but its high 13 bits specify the actual serialization:\r\n  - 0x00000000: LE64 encoding for `nServices`, V1 encoding for `CService` (like pre-BIP155 network serialization).\r\n  - 0x20000000: CompactSize encoding for `nServices`, V2 encoding for `CService` (like BIP155 network serialization).\r\n  - Any other value triggers an unsupported format error on deserialization, and can be used for future format changes.\r\n- The `ADDRV2_FORMAT` flag in the stream's version does not determine the actual serialization format; it only sets whether or not V2 encoding is permitted.\r\n",
    "labels": [
      {
        "id": 61889416,
        "node_id": "MDU6TGFiZWw2MTg4OTQxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system",
        "name": "Build system",
        "color": "5319e7",
        "default": false
      },
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/47",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/47",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/47/labels",
      "id": 5347322,
      "node_id": "MDk6TWlsZXN0b25lNTM0NzMyMg==",
      "number": 47,
      "state": "closed",
      "title": "22.0",
      "description": "",
      "creator": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 0,
      "closed_issues": 124,
      "created_at": "2020-04-25T00:14:49Z",
      "updated_at": "2021-09-14T07:16:53Z",
      "closed_at": "2021-09-09T12:47:52Z"
    },
    "active_lock_reason": "resolved",
    "created_at": "2020-11-27T01:21:31Z",
    "updated_at": "2022-08-18T18:31:41Z",
    "closed_at": "2021-06-17T15:44:07Z",
    "mergeable_state": "unknown",
    "merged_at": "2021-06-17T15:44:07Z",
    "merge_commit_sha": "7b45c5e875cab07509aaf3974f5ad6c3888dd3ff",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "sipa:202011_disk_addr",
      "ref": "202011_disk_addr",
      "sha": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 1458655,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDU4NjU1",
        "name": "bitcoin",
        "full_name": "sipa/bitcoin",
        "owner": {
          "login": "sipa",
          "id": 548488,
          "node_id": "MDQ6VXNlcjU0ODQ4OA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sipa",
          "html_url": "https://github.com/sipa",
          "followers_url": "https://api.github.com/users/sipa/followers",
          "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
          "organizations_url": "https://api.github.com/users/sipa/orgs",
          "repos_url": "https://api.github.com/users/sipa/repos",
          "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sipa/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/sipa/bitcoin",
        "description": "Bitcoin integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sipa/bitcoin",
        "archive_url": "https://api.github.com/repos/sipa/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sipa/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sipa/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sipa/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sipa/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sipa/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sipa/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sipa/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sipa/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sipa/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sipa/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sipa/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sipa/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sipa/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sipa/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sipa/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sipa/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sipa/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sipa/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sipa/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sipa/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sipa/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sipa/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sipa/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sipa/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sipa/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sipa/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sipa/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sipa/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sipa/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sipa/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sipa/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sipa/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sipa/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sipa/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sipa/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sipa/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sipa/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sipa/bitcoin/hooks",
        "svn_url": "https://github.com/sipa/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "TypeScript",
        "forks_count": 20,
        "stargazers_count": 81,
        "watchers_count": 81,
        "size": 215860,
        "default_branch": "lows",
        "open_issues_count": 16,
        "is_template": false,
        "topics": [],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T11:52:48Z",
        "created_at": "2011-03-09T10:46:59Z",
        "updated_at": "2023-04-30T00:52:17Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "b295395664bd37e26d168c329f238237b34aef8c",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 34324,
        "stargazers_count": 69818,
        "watchers_count": 69818,
        "size": 233879,
        "default_branch": "master",
        "open_issues_count": 627,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-06-06T22:42:00Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-06-07T03:51:27Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 119,
    "deletions": 30,
    "changed_files": 3,
    "commits": 3,
    "review_comments": 37,
    "comments": 10
  },
  "events": [
    {
      "event": "review_requested",
      "id": 4044198982,
      "node_id": "MDIwOlJldmlld1JlcXVlc3RlZEV2ZW50NDA0NDE5ODk4Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4044198982",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T01:27:38Z",
      "requested_reviewer": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "commented",
      "id": 734548674,
      "node_id": "MDEyOklzc3VlQ29tbWVudDczNDU0ODY3NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734548674",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T02:24:20Z",
      "updated_at": "2021-06-14T16:16:09Z",
      "author_association": "MEMBER",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21483 (p2p: add time when deserialize file db for ReadAnchors by brunoerg)\n* #20966 (banman: save the banlist in a JSON format on disk by vasild)\n* #20509 (net: CAddress deser: use stream's version, not what's coming from disk by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734548674",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "labeled",
      "id": 4044326647,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQwNDQzMjY2NDc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4044326647",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T02:56:08Z",
      "label": {
        "name": "Build system",
        "color": "5319e7"
      }
    },
    {
      "event": "labeled",
      "id": 4044326648,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQwNDQzMjY2NDg=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4044326648",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T02:56:08Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4044338543,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDA0NDMzODU0Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4044338543",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T03:03:15Z"
    },
    {
      "event": "milestoned",
      "id": 4045964662,
      "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDQwNDU5NjQ2NjI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4045964662",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T12:35:05Z",
      "milestone": {
        "title": "22.0"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4047107393,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDA0NzEwNzM5Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4047107393",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:11:22Z"
    },
    {
      "event": "renamed",
      "id": 4047115274,
      "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50NDA0NzExNTI3NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4047115274",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:16:21Z",
      "rename": {
        "from": "Introduce well-defined CAddress disk serialization",
        "to": "Well-defined CAddress disk serialization, and addrv2 anchors.dat support"
      }
    },
    {
      "event": "renamed",
      "id": 4047115560,
      "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50NDA0NzExNTU2MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4047115560",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:16:33Z",
      "rename": {
        "from": "Well-defined CAddress disk serialization, and addrv2 anchors.dat support",
        "to": "Well-defined CAddress disk serialization, and addrv2 anchors.dat"
      }
    },
    {
      "event": "commented",
      "id": 734958654,
      "node_id": "MDEyOklzc3VlQ29tbWVudDczNDk1ODY1NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734958654",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:17:45Z",
      "updated_at": "2020-11-27T19:17:45Z",
      "author_association": "MEMBER",
      "body": "I merged the anchors.dat addrv2 support from #20514 into this PR, as doing it correctly requires changes the `Cservice` serialization from stream version based to stored version based.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734958654",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "commented",
      "id": 734965909,
      "node_id": "MDEyOklzc3VlQ29tbWVudDczNDk2NTkwOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734965909",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:49:42Z",
      "updated_at": "2020-11-27T19:49:42Z",
      "author_association": "MEMBER",
      "body": "Concept ACK.\r\n\r\nFrom the PR description and quick code reading it follows that there is no hurry to backport these changes into 0.21, right?",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734965909",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "commented",
      "id": 734966179,
      "node_id": "MDEyOklzc3VlQ29tbWVudDczNDk2NjE3OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734966179",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-27T19:50:40Z",
      "updated_at": "2020-11-27T19:50:40Z",
      "author_association": "MEMBER",
      "body": "Indeed, there is probably no hurry, unless we want to support torv3 anchors in 0.21.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-734966179",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "reviewed",
      "id": 540368109,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzY4MTA5",
      "url": null,
      "actor": null,
      "commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-540368109",
      "submitted_at": "2020-11-28T11:03:35Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "reviewed",
      "id": 540382774,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzgyNzc0",
      "url": null,
      "actor": null,
      "commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "In commit 6d16903c4c384bc15f3f29e5635bb9dccd789cb6 message:\r\n> These do no introduce incompatibilities, as no code versions exist that write\r\nany value other than 0 or 0x20000000 in the top 19 bits, and no code paths\r\nwhere the stream's version differs from the stored version.\r\n\r\ns/top 19/high 13/ ?",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-540382774",
      "submitted_at": "2020-11-28T15:38:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "reviewed",
      "id": 540383063,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzgzMDYz",
      "url": null,
      "actor": null,
      "commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-540383063",
      "submitted_at": "2020-11-28T15:43:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "reviewed",
      "id": 540385340,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzg1MzQw",
      "url": null,
      "actor": null,
      "commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-540385340",
      "submitted_at": "2020-11-28T16:27:53Z",
      "state": "DISMISSED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4054075146,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDA1NDA3NTE0Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4054075146",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-30T21:40:03Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4054078041,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDA1NDA3ODA0MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4054078041",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-30T21:40:59Z"
    },
    {
      "event": "commented",
      "id": 736073151,
      "node_id": "MDEyOklzc3VlQ29tbWVudDczNjA3MzE1MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736073151",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-11-30T21:41:03Z",
      "updated_at": "2020-11-30T21:41:03Z",
      "author_association": "MEMBER",
      "body": "Addressed comments.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-736073151",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "labeled",
      "id": 4116086513,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQxMTYwODY1MTM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4116086513",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-12-15T18:40:39Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 555578477,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NTc4NDc3",
      "url": null,
      "actor": null,
      "commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Approach ACK 80f5c5442",
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-555578477",
      "submitted_at": "2020-12-18T16:50:29Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4Y2Q4ZjM3ZGZlM2ZmYjczYTA5ZjNhZDc3MzYwM2Q5ZDg5NDUyMjQ1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8cd8f37dfe3ffb73a09f3ad773603d9d89452245",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8cd8f37dfe3ffb73a09f3ad773603d9d89452245",
      "tree": {
        "sha": "815e6a873753f17cf6a7e7bdad563d4ef220ed52",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/815e6a873753f17cf6a7e7bdad563d4ef220ed52"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b295395664bd37e26d168c329f238237b34aef8c",
          "sha": "b295395664bd37e26d168c329f238237b34aef8c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b295395664bd37e26d168c329f238237b34aef8c"
        }
      ],
      "message": "Introduce well-defined CAddress disk serialization\n\nBefore this commit, CAddress disk serialization was messy. It stored\nCLIENT_VERSION in the first 4 bytes, optionally OR'ed with ADDRV2_FORMAT.\n - All bits except ADDRV2_FORMAT were ignored, making it hard to use for actual\n   future format changes.\n - ADDRV2_FORMAT determines whether or not nServices is serialized in LE64\n   format or in CompactSize format.\n - Whether or not the embedded CService is serialized in V1 or V2 format is\n   determined by the stream's version having ADDRV2_FORMAT (as opposed to the\n   nServices encoding, which is determined by the disk version).\n\nTo improve the situation, this commit introduces the following disk\nserialization format, compatible with earlier versions, but better defined for\nfuture changes:\n - The first 4 bytes store a format version number. Its low 19 bits are ignored\n   (as it historically stored the CLIENT_VERSION), but its high 13 bits specify\n   the serialization exactly:\n   - 0x00000000: LE64 encoding for nServices, V1 encoding for CService\n   - 0x20000000: CompactSize encoding for nServices, V2 encoding for CService\n   - Any other value triggers an unsupported format error on deserialization,\n     and can be used for future format changes.\n - The ADDRV2_FORMAT flag in the stream's version does not impact the actual\n   serialization format; it only determines whether V2 encoding is permitted;\n   whether it's actually enabled depends solely on the disk version number.\n\nOperationally the changes to the deserializer are:\n - Failure when the stored format version number is unexpected.\n - The embedded CService's format is determined by the stored format version\n   number rather than the stream's version number.\n\nThese do no introduce incompatibilities, as no code versions exist that write\nany value other than 0 or 0x20000000 in the top 13 bits, and no code paths\nwhere the stream's version differs from the stored version.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2021-05-25T01:06:31Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-11-27T00:46:10Z"
      },
      "sha": "8cd8f37dfe3ffb73a09f3ad773603d9d89452245"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMmYwNTQ4YjUyYTRiMmJhM2VkZjc3ZTNmMjEzNjVmMWU4ZjI3MGE0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4",
      "tree": {
        "sha": "843fc16fb0c2747f03c2adf17bc6c7151b1bd9bd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/843fc16fb0c2747f03c2adf17bc6c7151b1bd9bd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8cd8f37dfe3ffb73a09f3ad773603d9d89452245",
          "sha": "8cd8f37dfe3ffb73a09f3ad773603d9d89452245",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8cd8f37dfe3ffb73a09f3ad773603d9d89452245"
        }
      ],
      "message": "Use addrv2 serialization in anchors.dat",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2021-05-25T01:06:35Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-11-26T21:59:44Z"
      },
      "sha": "e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmODg2NmU4YzMyNGJlMzMyMmZhNTA3YzJjZWIxZGUzNWQxNDhkMGYx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "tree": {
        "sha": "577779ec6abb8acafa18bc3d111d49b094315cdb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/577779ec6abb8acafa18bc3d111d49b094315cdb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4",
          "sha": "e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e2f0548b52a4b2ba3edf77e3f21365f1e8f270a4"
        }
      ],
      "message": "Add roundtrip fuzz tests for CAddress serialization",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2021-05-25T01:06:35Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-11-27T02:13:42Z"
      },
      "sha": "f8866e8c324be3322fa507c2ceb1de35d148d0f1"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 4789503630,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50NDc4OTUwMzYzMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4789503630",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-25T01:06:46Z"
    },
    {
      "event": "commented",
      "id": 847456308,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg0NzQ1NjMwOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847456308",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-25T01:08:39Z",
      "updated_at": "2021-05-25T01:08:39Z",
      "author_association": "MEMBER",
      "body": "Rebased, and addressed comments.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-847456308",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "unlabeled",
      "id": 4789685479,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50NDc4OTY4NTQ3OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4789685479",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-25T02:19:05Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 671138622,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjcxMTM4NjIy",
      "url": null,
      "actor": null,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-671138622",
      "submitted_at": "2021-05-28T10:01:12Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "reviewed",
      "id": 671157519,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjcxMTU3NTE5",
      "url": null,
      "actor": null,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1 tested rebased to master and built/run/restarted with DEBUG_ADDRMAN, peers.dat and anchors ser/deser seems fine",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-671157519",
      "submitted_at": "2021-05-28T10:34:10Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "reviewed",
      "id": 682355522,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjgyMzU1NTIy",
      "url": null,
      "actor": null,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Approach ACK",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-682355522",
      "submitted_at": "2021-06-12T21:36:06Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "commented",
      "id": 860114133,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDExNDEzMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860114133",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-12T21:38:53Z",
      "updated_at": "2021-06-12T21:38:53Z",
      "author_association": "MEMBER",
      "body": "@hebasto I think you need to leave a new review.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-860114133",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "mentioned",
      "id": 4881681805,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NDg4MTY4MTgwNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4881681805",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-12T21:38:53Z"
    },
    {
      "event": "subscribed",
      "id": 4881681807,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQ4ODE2ODE4MDc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4881681807",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-12T21:38:53Z"
    },
    {
      "event": "review_requested",
      "id": 4881686709,
      "node_id": "MDIwOlJldmlld1JlcXVlc3RlZEV2ZW50NDg4MTY4NjcwOQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4881686709",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-12T21:46:28Z",
      "requested_reviewer": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_dismissed",
      "id": 4881688148,
      "node_id": "MDIwOlJldmlld0Rpc21pc3NlZEV2ZW50NDg4MTY4ODE0OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4881688148",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-12T21:49:06Z",
      "dismissed_review": {
        "state": "CHANGES_REQUESTED",
        "review_id": 540385340,
        "dismissal_message": "comment resolved",
        "dismissal_commit_id": null
      }
    },
    {
      "event": "reviewed",
      "id": 682500091,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjgyNTAwMDkx",
      "url": null,
      "actor": null,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1, tested on Linux Mint 20.1 (x86_64).\r\n\r\nChecked that changes in `anchors.dat` are forward compatible. They are not backward compatible -- getting \"ERROR: DeserializeDB: Deserialize or I/O error - CAutoFile::read: end of file: iostream error\", but this is [expected](https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532091123).",
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-682500091",
      "submitted_at": "2021-06-14T03:54:40Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "commented",
      "id": 860931973,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDkzMTk3Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860931973",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-14T19:20:55Z",
      "updated_at": "2021-06-14T19:20:55Z",
      "author_association": "MEMBER",
      "body": "ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-860931973",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "commented",
      "id": 863350324,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2MzM1MDMyNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863350324",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-17T15:41:48Z",
      "updated_at": "2021-06-17T15:41:48Z",
      "author_association": "MEMBER",
      "body": "Code review ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-863350324",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "merged",
      "id": 4905128272,
      "node_id": "MDExOk1lcmdlZEV2ZW50NDkwNTEyODI3Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4905128272",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "7b45c5e875cab07509aaf3974f5ad6c3888dd3ff",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7b45c5e875cab07509aaf3974f5ad6c3888dd3ff",
      "created_at": "2021-06-17T15:44:07Z"
    },
    {
      "event": "closed",
      "id": 4905128296,
      "node_id": "MDExOkNsb3NlZEV2ZW50NDkwNTEyODI5Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4905128296",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-17T15:44:07Z"
    },
    {
      "event": "referenced",
      "id": 4911848019,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ5MTE4NDgwMTk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4911848019",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "77b2f7a0f20c227a31fb825d9f686a93da310020",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/77b2f7a0f20c227a31fb825d9f686a93da310020",
      "created_at": "2021-06-18T23:13:42Z"
    },
    {
      "event": "commented",
      "id": 864963537,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDk2MzUzNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864963537",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-21T11:37:17Z",
      "updated_at": "2021-06-21T11:37:17Z",
      "author_association": "MEMBER",
      "body": "review ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1 🕑\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nreview ACK f8866e8c324be3322fa507c2ceb1de35d148d0f1 🕑\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUipdwwAnD4R+92A+ogj6ZHCw+VUa2T+wnnhhGhfQ54cW2Hldl9pS1qTe7zPaNy8\r\nXDn9OzCwU8LHNOWlqZo+e+lRiL09CVW+E7dwwe13ioGrk7wkXw/yO+XfmWNvx/np\r\nX3sOCI8sNq+p1UHVhJLaLtPyuTa3/3/s5Vi157KUjqeBRaQZfTuFXbs6QgWzzjFb\r\nK7KIhN+LINgI0zPmJU2OBrkTvkg+HDNCDW4DWhFFR3AbAdszEKZtYzz9flZIG3X0\r\nLOP/iRBAud+o62YYazGo86iGla7LR9cToVKkOOQdTgPRT5diFmFnHxvRVizobLPb\r\nTfmA9BqB/Ws7wg6h9A6kqAN/B1O9S0uAyPoJhdsTZaQTNt7ouB+q/20jwaVwX61r\r\n0DZ5jhU0VgAkh4II1CH65oYTespndkvDvejjggyK7qFNFfUhKY7zePaMbmUu5eub\r\nNKRkX6EN6GrKqP8dD26yMkPSXov0WjIZ89ebTI8joac8brNmX1TZMe70JYUdhgl/\r\nIFgK8gnv\r\n=Ldtq\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `71c25ee05aade76e5311b5e5ffa61e3c8b280b51a49049dba2025a6d50dfe77b  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e89294010871c25ee05aade76e5311b5e5ffa61e3c8b280b51a49049dba2025a6d50dfe77bf010069790d05dfdb6d150725d6ef6125f1a08fff010251bb4e6c4adb7f527010631225ff3c108f10460d079e3f008ab760f050dcaed630083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff01094bbfe1a9c792bcad8c7f02c86f604b308f10460d079e4f0085ecfb20718f259b00083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010bfce886d7ffa7309e2f62e693d1fecdf08f10460d079e4f0085b498ee923e8d4290083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6df010c110c03beed049c37c17fd9eda42249008f10460d079e4f00894e3697875838f5a0083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#issuecomment-864963537",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20516"
    },
    {
      "event": "reviewed",
      "id": 688323665,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njg4MzIzNjY1",
      "url": null,
      "actor": null,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#pullrequestreview-688323665",
      "submitted_at": "2021-06-21T11:38:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
    },
    {
      "event": "referenced",
      "id": 6723198706,
      "node_id": "REFE_lADOABII584s0WllzwAAAAGQu97y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6723198706",
      "actor": {
        "login": "gwillen",
        "id": 458997,
        "node_id": "MDQ6VXNlcjQ1ODk5Nw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/458997?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gwillen",
        "html_url": "https://github.com/gwillen",
        "followers_url": "https://api.github.com/users/gwillen/followers",
        "following_url": "https://api.github.com/users/gwillen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gwillen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gwillen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gwillen/subscriptions",
        "organizations_url": "https://api.github.com/users/gwillen/orgs",
        "repos_url": "https://api.github.com/users/gwillen/repos",
        "events_url": "https://api.github.com/users/gwillen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gwillen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "3bef51bb0d7d4cd79f899042ffd559ef6e183583",
      "commit_url": "https://api.github.com/repos/ElementsProject/elements/commits/3bef51bb0d7d4cd79f899042ffd559ef6e183583",
      "created_at": "2022-06-01T21:22:33Z"
    },
    {
      "event": "locked",
      "id": 7216584377,
      "node_id": "LOE_lADOABII584s0WllzwAAAAGuJFa5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7216584377",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-18T18:31:41Z",
      "lock_reason": "resolved"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532026970",
      "pull_request_review_id": 540368109,
      "id": 532026970,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAyNjk3MA==",
      "diff_hunk": "@@ -23,7 +23,7 @@ bool SerializeDB(Stream& stream, const Data& data)\n {\n     // Write and commit header, data\n     try {\n-        CHashWriter hasher(SER_DISK, CLIENT_VERSION);\n+        CHashWriter hasher(SER_DISK, stream.GetVersion());",
      "path": "src/addrdb.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": null,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "501de309e682f2edddb7e51e55665e034e1a86be, while this line is touched, it seems natural to inherit the stream type as well:\r\n\r\n```suggestion\r\n        CHashWriter hasher(stream.GetType(), stream.GetVersion());\r\n```\r\n\r\nAnd `CHashVerifier` uses type of stream.",
      "created_at": "2020-11-28T11:03:35Z",
      "updated_at": "2020-11-30T21:40:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532026970",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532026970"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532053363",
      "pull_request_review_id": 540383063,
      "id": 532053363,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1MzM2Mw==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 33,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": null,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "6d16903c4c384bc15f3f29e5635bb9dccd789cb6\r\n```suggestion\r\n    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\r\n```",
      "created_at": "2020-11-28T15:43:53Z",
      "updated_at": "2020-11-30T21:40:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532053363",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532053363"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 386,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057230",
      "pull_request_review_id": 540385340,
      "id": 532057230,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NzIzMA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 31,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": null,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Maybe present `DISK_VERSION_ADDRV2` as a bit flag explicitly, i.e.\r\n```suggestion\r\n    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\r\n```\r\n?",
      "created_at": "2020-11-28T16:21:41Z",
      "updated_at": "2020-11-30T21:40:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057230",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057230"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057860",
      "pull_request_review_id": 540385340,
      "id": 532057860,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1Nzg2MA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {",
      "path": "src/protocol.h",
      "position": 66,
      "original_position": 61,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": null,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "When a new bit flag for disk serialization will be introduced in the future, a downgraded (after upgrading) node will throw an exception during deserialization. Maybe:\r\n```suggestion\r\n            } else if (stored_format_version & DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\r\n```\r\n?",
      "created_at": "2020-11-28T16:27:28Z",
      "updated_at": "2020-11-30T21:40:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057860",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532057860"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 410,
      "original_line": 410,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532091123",
      "pull_request_review_id": 540408979,
      "id": 532091123,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MTEyMw==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {",
      "path": "src/protocol.h",
      "position": 66,
      "original_position": 61,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": 532057860,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No, that would break the ability to add other formats in a compatible way.\r\n\r\nIt's supposed to throw an exception if it can't be read.",
      "created_at": "2020-11-28T18:23:55Z",
      "updated_at": "2020-11-30T21:40:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532091123",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532091123"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 410,
      "original_line": 410,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902150",
      "pull_request_review_id": 555578477,
      "id": 545902150,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMjE1MA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 23,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2 deserialization is permitted,\r\n```",
      "created_at": "2020-12-18T15:17:33Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902150",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902150"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 376,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902418",
      "pull_request_review_id": 555578477,
      "id": 545902418,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkwMjQxOA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 25,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n     *  For network serialization ADDRV2_FORMAT in the stream version determines the actual format used (as it has no\r\n```",
      "created_at": "2020-12-18T15:17:58Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545902418",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545902418"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 378,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545917692",
      "pull_request_review_id": 555578477,
      "id": 545917692,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkxNzY5Mg==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 29,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Nowadays\r\n\r\n```cpp\r\n(1 << 19) - 1\r\n```\r\n\r\ncan be written as\r\n\r\n```cpp\r\n0b00000000'00000111'11111111'11111111\r\n```\r\n\r\n(feel free to ignore)",
      "created_at": "2020-12-18T15:42:11Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545917692",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545917692"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 382,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545922062",
      "pull_request_review_id": 555578477,
      "id": 545922062,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMjA2Mg==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 31,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think it is ok to assign `ADDRV2_FORMAT` here and remove the last `static_assert` below.",
      "created_at": "2020-12-18T15:49:09Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545922062",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545922062"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545924591",
      "pull_request_review_id": 555578477,
      "id": 545924591,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyNDU5MQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 29,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Shouldn't this be 18 bytes, instead of 19? `CLIENT_VERSION` of `219900` is 18 bytes (`0b11'01011010'11111100`).",
      "created_at": "2020-12-18T15:53:15Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545924591",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545924591"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 382,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545938774",
      "pull_request_review_id": 555578477,
      "id": 545938774,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzODc3NA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 97,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The repeated code can be moved after the `if`:\r\n\r\n```suggestion\r\n        } else {\r\n            READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\r\n        }\r\n        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\r\n        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\r\n```",
      "created_at": "2020-12-18T16:16:59Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545938774",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545938774"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": 434,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545942030",
      "pull_request_review_id": 555578477,
      "id": 545942030,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0MjAzMA==",
      "diff_hunk": "@@ -161,13 +161,13 @@ bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n void DumpAnchors(const fs::path& anchors_db_path, const std::vector<CAddress>& anchors)\n {\n     LOG_TIME_SECONDS(strprintf(\"Flush %d outbound block-relay-only peer addresses to anchors.dat\", anchors.size()));\n-    SerializeFileDB(\"anchors\", anchors_db_path, anchors);\n+    SerializeFileDB(\"anchors\", anchors_db_path, anchors, CLIENT_VERSION | ADDRV2_FORMAT);",
      "path": "src/addrdb.cpp",
      "position": 76,
      "original_position": 76,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Here and below in deserialize, why add `CLIENT_VERSION` when it is going to be ignored during ser/deser (they only check `s.GetVersion() & ADDRV2_FORMAT`)?",
      "created_at": "2020-12-18T16:22:41Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545942030",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545942030"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545944869",
      "pull_request_review_id": 555578477,
      "id": 545944869,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NDg2OQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }\n-        READWRITEAS(CService, obj);\n     }\n \n     // disk and network only\n     uint32_t nTime{TIME_INIT};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 102,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Maybe this comment warrants an update, since we do not allow anything other than disk and network now.\r\n\r\nAlso, it is \"network only if s.GetVersion() != INIT_PROTO_VERSION\".",
      "created_at": "2020-12-18T16:27:27Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545944869",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545944869"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": 445,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545958131",
      "pull_request_review_id": 555578477,
      "id": 545958131,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk1ODEzMQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */",
      "path": "src/protocol.h",
      "position": 27,
      "original_position": 27,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": null,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Maybe also mention what happens during disk serialization and network deserialization:\r\n\r\nFor disk serialization, ADDRV2_FORMAT in the stream version indicates a write in that format\r\nFor network deserialization ADDRV2_FORMAT in the stream version indicates that the data is expected to be in that format",
      "created_at": "2020-12-18T16:49:44Z",
      "updated_at": "2020-12-18T16:50:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r545958131",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545958131"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 377,
      "original_line": 377,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638374077",
      "pull_request_review_id": 667296705,
      "id": 638374077,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM3NDA3Nw==",
      "diff_hunk": "@@ -23,7 +23,7 @@ bool SerializeDB(Stream& stream, const Data& data)\n {\n     // Write and commit header, data\n     try {\n-        CHashWriter hasher(SER_DISK, CLIENT_VERSION);\n+        CHashWriter hasher(SER_DISK, stream.GetVersion());",
      "path": "src/addrdb.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": 532026970,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done (ages ago).",
      "created_at": "2021-05-25T00:31:12Z",
      "updated_at": "2021-05-25T00:31:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638374077",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638374077"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638380149",
      "pull_request_review_id": 667303270,
      "id": 638380149,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4MDE0OQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 31,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545922062,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I'd rather not do that. The idea is that ADDRV2_FORMAT is irrelevant in the new code - it's purely an internal flag that has no impact on the disk format. It could be changed to whatever, or dropped entirely - but if that happens, DISK_VERSION_ADDRV2 must still remain `1 << 29`, because that's what *old* versions used as disk serialization marker.\r\n\r\nI've just removed the assert, and replaced it with a comment.",
      "created_at": "2021-05-25T00:51:38Z",
      "updated_at": "2021-05-25T00:51:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638380149",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638380149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638380334",
      "pull_request_review_id": 667303484,
      "id": 638380334,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4MDMzNA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 29,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545924591,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I guess I added one slack bit, because the version number is pretty close to needing that many already.",
      "created_at": "2021-05-25T00:52:15Z",
      "updated_at": "2021-05-25T00:52:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638380334",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638380334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 382,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384486",
      "pull_request_review_id": 667308310,
      "id": 638384486,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDQ4Ng==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 0x20000000;",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 31,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "04e3733b8dc073562e30a12f955a0430793cfe25",
      "in_reply_to_id": 532057230,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-05-25T01:06:58Z",
      "updated_at": "2021-05-25T01:06:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384486",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384529",
      "pull_request_review_id": 667308373,
      "id": 638384529,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDUyOQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 23,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545902150,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-05-25T01:07:09Z",
      "updated_at": "2021-05-25T01:07:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384529",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384529"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 376,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384569",
      "pull_request_review_id": 667308406,
      "id": 638384569,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDU2OQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 25,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545902418,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-05-25T01:07:15Z",
      "updated_at": "2021-05-25T01:07:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384569",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 378,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384617",
      "pull_request_review_id": 667308453,
      "id": 638384617,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDYxNw==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 29,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545917692,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-05-25T01:07:21Z",
      "updated_at": "2021-05-25T01:07:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384617",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384617"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 382,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384672",
      "pull_request_review_id": 667308507,
      "id": 638384672,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDY3Mg==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 97,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545938774,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2021-05-25T01:07:31Z",
      "updated_at": "2021-05-25T01:07:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384672",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384672"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": 434,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384739",
      "pull_request_review_id": 667308572,
      "id": 638384739,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDczOQ==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static constexpr uint32_t DISK_VERSION_ADDRV2 = 1 << 29;\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert(DISK_VERSION_ADDRV2 == ADDRV2_FORMAT, \"DISK_VERSION_ADDRV2 must be equal to ADDRV2_FORMAT for backward compatibility\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n+            // Invoke V2 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), ADDRV2_FORMAT);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n+            // Invoke V1 serializer for CService parent object.\n+            OverrideStream<Stream> os(&s, s.GetType(), 0);\n+            SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n         }\n-        READWRITEAS(CService, obj);\n     }\n \n     // disk and network only\n     uint32_t nTime{TIME_INIT};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 102,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545944869,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I've updated the comments here.",
      "created_at": "2021-05-25T01:07:44Z",
      "updated_at": "2021-05-25T01:07:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384739",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384739"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": 445,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384950",
      "pull_request_review_id": 667308810,
      "id": 638384950,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NDk1MA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */",
      "path": "src/protocol.h",
      "position": 27,
      "original_position": 27,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545958131,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I feel that's pretty much already mentioned (just above, and in other places). I've tried to improve the comments further.",
      "created_at": "2021-05-25T01:08:27Z",
      "updated_at": "2021-05-25T01:08:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638384950",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638384950"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 377,
      "original_line": 377,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638386087",
      "pull_request_review_id": 667310124,
      "id": 638386087,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM4NjA4Nw==",
      "diff_hunk": "@@ -161,13 +161,13 @@ bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n void DumpAnchors(const fs::path& anchors_db_path, const std::vector<CAddress>& anchors)\n {\n     LOG_TIME_SECONDS(strprintf(\"Flush %d outbound block-relay-only peer addresses to anchors.dat\", anchors.size()));\n-    SerializeFileDB(\"anchors\", anchors_db_path, anchors);\n+    SerializeFileDB(\"anchors\", anchors_db_path, anchors, CLIENT_VERSION | ADDRV2_FORMAT);",
      "path": "src/addrdb.cpp",
      "position": 76,
      "original_position": 76,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545942030,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "That's just common in the codebase; use CLIENT_VERSION for disk serializations, PROTOCOL_VERSION for network serializations.\r\n\r\nI think this whole idea of streams having a version numbers with magic meanings, and implicit (=bad) compatibility properties for anything relying on it are silly, but getting rid of it isn't for this PR.",
      "created_at": "2021-05-25T01:12:13Z",
      "updated_at": "2021-05-25T01:12:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r638386087",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638386087"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640644694",
      "pull_request_review_id": 670211080,
      "id": 640644694,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDY0NDY5NA==",
      "diff_hunk": "@@ -361,43 +362,97 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT signals that ADDRV2 deserialization is permitted,\n+     *  but the actual format is determined by the high bits in the stored version field.\n+     *  For network serialization ADDRV2_FORMAT determines the actual format used (as it has no\n+     *  embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{(1 << 19) - 1};",
      "path": "src/protocol.h",
      "position": null,
      "original_position": 29,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "80f5c544202c35a936bc04ee45e092b4325e637d",
      "in_reply_to_id": 545924591,
      "user": {
        "login": "vasild",
        "id": 266751,
        "node_id": "MDQ6VXNlcjI2Njc1MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vasild",
        "html_url": "https://github.com/vasild",
        "followers_url": "https://api.github.com/users/vasild/followers",
        "following_url": "https://api.github.com/users/vasild/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vasild/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vasild/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
        "organizations_url": "https://api.github.com/users/vasild/orgs",
        "repos_url": "https://api.github.com/users/vasild/repos",
        "events_url": "https://api.github.com/users/vasild/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vasild/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "_`s/bytes/bits/` in my comment above_\r\n\r\nI see, 18 bits would work until version 26 and 19 bits until version 52 (~15 years from now). Maybe add a few more bits (up to 29 is ok). And/or add some comment on what is that `19` (or another number if you choose to increment it).",
      "created_at": "2021-05-27T13:51:41Z",
      "updated_at": "2021-05-27T13:51:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r640644694",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640644694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 382,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641443508",
      "pull_request_review_id": 671157519,
      "id": 641443508,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MTQ0MzUwOA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": null,
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "8cd8f37 perhaps `constexpr`?\r\n",
      "created_at": "2021-05-28T10:25:22Z",
      "updated_at": "2021-05-28T10:34:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r641443508",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641443508"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650436338",
      "pull_request_review_id": 682354227,
      "id": 650436338,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzNjMzOA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Seems fine, but also pointless. I don't think anyone is going to use these comparisons in compile-time initialized objects.\r\n\r\nI'll do this if I need to retouch.",
      "created_at": "2021-06-12T21:05:07Z",
      "updated_at": "2021-06-12T21:05:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650436338",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650436338"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650436877",
      "pull_request_review_id": 682354529,
      "id": 650436877,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzNjg3Nw==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Is it possible to drop the \"changes requested\" marker here?",
      "created_at": "2021-06-12T21:11:51Z",
      "updated_at": "2021-06-12T21:11:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650436877",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650436877"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438538",
      "pull_request_review_id": 682355424,
      "id": 650438538,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzODUzOA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think that marker may be related to \"hebasto requested changes on Nov 28, 2020\" above (I don't use the \"requested changes\" review type here, at least not intentionally).",
      "created_at": "2021-06-12T21:33:30Z",
      "updated_at": "2021-06-12T21:33:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650438538",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438538"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438792",
      "pull_request_review_id": 682355544,
      "id": 650438792,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzODc5Mg==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I don't know how to drop it. My recent comment has no such an attribute.",
      "created_at": "2021-06-12T21:37:05Z",
      "updated_at": "2021-06-12T21:37:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650438792",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438901",
      "pull_request_review_id": 682355606,
      "id": 650438901,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzODkwMQ==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "@jonatack My apologies for assuming it was due to your comment!",
      "created_at": "2021-06-12T21:38:25Z",
      "updated_at": "2021-06-12T21:38:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650438901",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650438901"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650439240",
      "pull_request_review_id": 682355801,
      "id": 650439240,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzOTI0MA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It might be because https://github.com/bitcoin/bitcoin/pull/20516#discussion_r532057860 wasn't \"resolved\". This has been my superstition leading me to not use it (that, and the bright red flag).",
      "created_at": "2021-06-12T21:43:06Z",
      "updated_at": "2021-06-12T21:43:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650439240",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650439240"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650439728",
      "pull_request_review_id": 682356046,
      "id": 650439728,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDQzOTcyOA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits\n+            if (stored_format_version == 0) {\n+                use_v2 = false;\n+            } else if (stored_format_version == DISK_VERSION_ADDRV2 && (s.GetVersion() & ADDRV2_FORMAT)) {\n+                // Only support v2 deserialization if ADDRV2_FORMAT is set.\n+                use_v2 = true;\n+            } else {\n+                throw std::ios_base::failure(\"Unsupported CAddress disk format version\");\n+            }\n+            store_time = true;\n+        } else {\n+            // In the network serialization format, the encoding (v1 or v2) is determined directly by\n+            // the value of ADDRV2_FORMAT in the stream version, as no explicitly encoded version\n+            // exists in the stream.\n+            assert(s.GetType() & SER_NETWORK);\n+            use_v2 = s.GetVersion() & ADDRV2_FORMAT;\n             // The only time we serialize a CAddress object without nTime is in\n             // the initial VERSION messages which contain two CAddress records.\n             // At that point, the serialization version is INIT_PROTO_VERSION.\n             // After the version handshake, serialization version is >=\n             // MIN_PEER_PROTO_VERSION and all ADDR messages are serialized with\n             // nTime.\n-            READWRITE(obj.nTime);\n+            store_time = s.GetVersion() != INIT_PROTO_VERSION;\n         }\n-        if (nVersion & ADDRV2_FORMAT) {\n+\n+        SER_READ(obj, obj.nTime = TIME_INIT);\n+        if (store_time) READWRITE(obj.nTime);\n+        // nServices is serialized as CompactSize in V2; as uint64_t in V1.\n+        if (use_v2) {\n             uint64_t services_tmp;\n             SER_WRITE(obj, services_tmp = obj.nServices);\n             READWRITE(Using<CompactSizeFormatter<false>>(services_tmp));\n             SER_READ(obj, obj.nServices = static_cast<ServiceFlags>(services_tmp));\n         } else {\n             READWRITE(Using<CustomUintFormatter<8>>(obj.nServices));\n         }\n-        READWRITEAS(CService, obj);\n+        // Invoke V1/V2 serializer for CService parent object.\n+        OverrideStream<Stream> os(&s, s.GetType(), use_v2 ? ADDRV2_FORMAT : 0);\n+        SerReadWriteMany(os, ser_action, ReadWriteAsHelper<CService>(obj));\n     }\n \n-    // disk and network only\n+    //! Always included in serialization, except in the network format on INIT_PROTO_VERSION.\n     uint32_t nTime{TIME_INIT};\n-\n+    //! Serialized as uint64_t in V1, and as CompactSize in V2.\n     ServiceFlags nServices{NODE_NONE};\n+\n+    friend bool operator==(const CAddress& a, const CAddress& b)",
      "path": "src/protocol.h",
      "position": 114,
      "original_position": 114,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 641443508,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I don't know how to drop it.\r\n\r\nThe magic GH button is \"Dismiss review\" :)",
      "created_at": "2021-06-12T21:49:52Z",
      "updated_at": "2021-06-12T21:49:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650439728",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650439728"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 453,
      "original_line": 453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650635548",
      "pull_request_review_id": 682500091,
      "id": 650635548,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDYzNTU0OA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits",
      "path": "src/protocol.h",
      "position": 63,
      "original_position": 63,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": null,
      "user": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit:\r\n\r\nThis is the only place (besides two assertions above) where `DISK_VERSION_IGNORE_MASK` is used, and it is inverted. Isn't it more clear:\r\n\r\n```suggestion\r\n            stored_format_version &= DISK_VERSION_MASK; // ignore low bits\r\n```\r\n\r\n?",
      "created_at": "2021-06-14T03:54:11Z",
      "updated_at": "2021-06-14T03:54:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r650635548",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650635548"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 407,
      "original_line": 407,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651343218",
      "pull_request_review_id": 683437303,
      "id": 651343218,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM0MzIxOA==",
      "diff_hunk": "@@ -358,43 +359,103 @@ class CAddress : public CService\n {\n     static constexpr uint32_t TIME_INIT{100000000};\n \n+    /** Historically, CAddress disk serialization stored the CLIENT_VERSION, optionally OR'ed with\n+     *  the ADDRV2_FORMAT flag to indicate V2 serialization. The first field has since been\n+     *  disentangled from client versioning, and now instead:\n+     *  - The low bits (masked by DISK_VERSION_IGNORE_MASK) store the fixed value DISK_VERSION_INIT,\n+     *    (in case any code exists that treats it as a client version) but are ignored on\n+     *    deserialization.\n+     *  - The high bits (masked by ~DISK_VERSION_IGNORE_MASK) store actual serialization information.\n+     *    Only 0 or DISK_VERSION_ADDRV2 (equal to the historical ADDRV2_FORMAT) are valid now, and\n+     *    any other value triggers a deserialization failure. Other values can be added later if\n+     *    needed.\n+     *\n+     *  For disk deserialization, ADDRV2_FORMAT in the stream version signals that ADDRV2\n+     *  deserialization is permitted, but the actual format is determined by the high bits in the\n+     *  stored version field. For network serialization, the stream version having ADDRV2_FORMAT or\n+     *  not determines the actual format used (as it has no embedded version number).\n+     */\n+    static constexpr uint32_t DISK_VERSION_INIT{220000};\n+    static constexpr uint32_t DISK_VERSION_IGNORE_MASK{0b00000000'00000111'11111111'11111111};\n+    /** The version number written in disk serialized addresses to indicate V2 serializations.\n+     * It must be exactly 1<<29, as that is the value that historical versions used for this\n+     * (they used their internal ADDRV2_FORMAT flag here). */\n+    static constexpr uint32_t DISK_VERSION_ADDRV2{1 << 29};\n+    static_assert((DISK_VERSION_INIT & ~DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_INIT must be covered by DISK_VERSION_IGNORE_MASK\");\n+    static_assert((DISK_VERSION_ADDRV2 & DISK_VERSION_IGNORE_MASK) == 0, \"DISK_VERSION_ADDRV2 must not be covered by DISK_VERSION_IGNORE_MASK\");\n+\n public:\n     CAddress() : CService{} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn) : CService{ipIn}, nServices{nServicesIn} {};\n     CAddress(CService ipIn, ServiceFlags nServicesIn, uint32_t nTimeIn) : CService{ipIn}, nTime{nTimeIn}, nServices{nServicesIn} {};\n \n     SERIALIZE_METHODS(CAddress, obj)\n     {\n-        SER_READ(obj, obj.nTime = TIME_INIT);\n-        int nVersion = s.GetVersion();\n+        // CAddress has a distinct network serialization and a disk serialization, but it should never\n+        // be hashed (except through CHashWriter in addrdb.cpp, which sets SER_DISK), and it's\n+        // ambiguous what that would mean. Make sure no code relying on that is introduced:\n+        assert(!(s.GetType() & SER_GETHASH));\n+        bool use_v2;\n+        bool store_time;\n         if (s.GetType() & SER_DISK) {\n-            READWRITE(nVersion);\n-        }\n-        if ((s.GetType() & SER_DISK) ||\n-            (nVersion != INIT_PROTO_VERSION && !(s.GetType() & SER_GETHASH))) {\n+            // In the disk serialization format, the encoding (v1 or v2) is determined by a flag version\n+            // that's part of the serialization itself. ADDRV2_FORMAT in the stream version only determines\n+            // whether V2 is chosen/permitted at all.\n+            uint32_t stored_format_version = DISK_VERSION_INIT;\n+            if (s.GetVersion() & ADDRV2_FORMAT) stored_format_version |= DISK_VERSION_ADDRV2;\n+            READWRITE(stored_format_version);\n+            stored_format_version &= ~DISK_VERSION_IGNORE_MASK; // ignore low bits",
      "path": "src/protocol.h",
      "position": 63,
      "original_position": 63,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": 650635548,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Will do if I retouch.",
      "created_at": "2021-06-14T23:30:15Z",
      "updated_at": "2021-06-14T23:30:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r651343218",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651343218"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 407,
      "original_line": 407,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655301458",
      "pull_request_review_id": 688323665,
      "id": 655301458,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTMwMTQ1OA==",
      "diff_hunk": "@@ -251,9 +251,37 @@ FUZZ_TARGET_DESERIALIZE(messageheader_deserialize, {\n         DeserializeFromFuzzingInput(buffer, mh);\n         (void)mh.IsCommandValid();\n })\n-FUZZ_TARGET_DESERIALIZE(address_deserialize, {\n+FUZZ_TARGET_DESERIALIZE(address_deserialize_v1_notime, {",
      "path": "src/test/fuzz/deserialize.cpp",
      "position": 41,
      "original_position": 41,
      "commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "original_commit_id": "f8866e8c324be3322fa507c2ceb1de35d148d0f1",
      "in_reply_to_id": null,
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Copied the fuzz inputs in commit https://github.com/bitcoin-core/qa-assets/commit/836513af1edae5987d8d4051b60d96ac4a5b484a, so that the targets have something nice to start with.",
      "created_at": "2021-06-21T11:38:47Z",
      "updated_at": "2021-06-21T11:38:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/20516#discussion_r655301458",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655301458"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20516"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 254,
      "original_line": 254,
      "side": "RIGHT"
    }
  ]
}