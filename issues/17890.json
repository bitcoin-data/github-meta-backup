{
  "type": "issue",
  "issue": {
    "id": 546354429,
    "node_id": "MDU6SXNzdWU1NDYzNTQ0Mjk=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17890",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17890/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17890/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17890/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/17890",
    "number": 17890,
    "state": "closed",
    "state_reason": "completed",
    "title": "Non-latest rev files are sometimes re-opened but never re-flushed",
    "body": "The code currently assumes that once a block file is 'left', it and its corresponding rev file can be flushed, and won't be written to any further.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/e8e79958a7b2a0bf1b02adcce9f4d811eac37dfc/src/validation.cpp#L1742-L1743\r\n\r\n(Flushing here additionally means to get rid of pre-allocated unused space.)\r\n\r\nThis is the case for the bl(oc)k files, but it turns out to not be the case for the rev files. During an IBD up to ~200k blocks, the following excerpt (one of several) was encountered (grepping out irrelevancy):\r\n```\r\n[...]\r\n2020-01-07T14:19:09Z Pre-allocating up to position 0x7000000 in blk00013.dat\r\n2020-01-07T14:19:13Z Pre-allocating up to position 0x8000000 in blk00013.dat\r\n2020-01-07T14:19:14Z Pre-allocating up to position 0xf00000 in rev00013.dat\r\n2020-01-07T14:19:16Z Leaving block file 13: CBlockFileInfo(blocks=1099, size=134068483, heights=183531...185655, time=2012-06-08...2012-06-22)\r\n2020-01-07T14:19:16Z Pre-allocating up to position 0x1000000 in blk00014.dat\r\n2020-01-07T14:19:17Z Pre-allocating up to position 0x100000 in rev00014.dat\r\n2020-01-07T14:19:20Z Pre-allocating up to position 0x1000000 in rev00013.dat\r\n2020-01-07T14:19:20Z Pre-allocating up to position 0x2000000 in blk00014.dat\r\n2020-01-07T14:19:24Z Pre-allocating up to position 0x1100000 in rev00013.dat\r\n2020-01-07T14:19:26Z Pre-allocating up to position 0x3000000 in blk00014.dat\r\n2020-01-07T14:19:27Z Pre-allocating up to position 0x1200000 in rev00013.dat\r\n2020-01-07T14:19:30Z Pre-allocating up to position 0x200000 in rev00014.dat\r\n2020-01-07T14:19:33Z Pre-allocating up to position 0x300000 in rev00014.dat\r\n2020-01-07T14:19:35Z Pre-allocating up to position 0x400000 in rev00014.dat\r\n2020-01-07T14:19:37Z Pre-allocating up to position 0x500000 in rev00014.dat\r\n2020-01-07T14:19:39Z Pre-allocating up to position 0x600000 in rev00014.dat\r\n2020-01-07T14:19:42Z Pre-allocating up to position 0x700000 in rev00014.dat\r\n2020-01-07T14:19:43Z Pre-allocating up to position 0x4000000 in blk00014.dat\r\n2020-01-07T14:19:45Z Pre-allocating up to position 0x800000 in rev00014.dat\r\n2020-01-07T14:19:49Z Pre-allocating up to position 0x900000 in rev00014.dat\r\n[...]\r\n```\r\n\r\nBut the only time we flush (and truncate the files to their correct size) is when we leave a block, and we already left block 13 here, so the rev files above end up with pre-allocated space that is never used. This is related to #17827.\r\n\r\nThis seems to repeat itself for every file that ended up larger than expected in https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571591432. (Note: #17887 is not a fix for this issue. #17887 makes the impact much smaller by fixing a separate blow-up bug, but it does not address re-flushing re-opened rev files.)\r\n",
    "user": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/kallewoof/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/kallewoof/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 0,
    "closed_at": "2020-06-04T14:39:25Z",
    "created_at": "2020-01-07T15:41:46Z",
    "updated_at": "2022-02-15T11:16:23Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 2928074890,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDI5MjgwNzQ4OTA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2928074890",
      "actor": {
        "login": "kallewoof",
        "id": 250224,
        "node_id": "MDQ6VXNlcjI1MDIyNA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kallewoof",
        "html_url": "https://github.com/kallewoof",
        "followers_url": "https://api.github.com/users/kallewoof/followers",
        "following_url": "https://api.github.com/users/kallewoof/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kallewoof/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kallewoof/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
        "organizations_url": "https://api.github.com/users/kallewoof/orgs",
        "repos_url": "https://api.github.com/users/kallewoof/repos",
        "events_url": "https://api.github.com/users/kallewoof/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kallewoof/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-01-07T15:41:46Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "closed",
      "id": 3407210901,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzQwNzIxMDkwMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3407210901",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "011fe009f9eeeb71ab958ab53df716438871d26e",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/011fe009f9eeeb71ab958ab53df716438871d26e",
      "created_at": "2020-06-04T14:39:25Z"
    },
    {
      "event": "referenced",
      "id": 3409125328,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDM0MDkxMjUzMjg=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3409125328",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "3f5d6102a6faf95917182f06c7305646edc46b7c",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/3f5d6102a6faf95917182f06c7305646edc46b7c",
      "created_at": "2020-06-04T23:37:27Z"
    },
    {
      "event": "referenced",
      "id": 5321340883,
      "node_id": "REFE_lADOABII584gkLT9zwAAAAE9LTfT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5321340883",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "d4a9c7d6d47b6165ccf70fefee69733588d36abe",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/d4a9c7d6d47b6165ccf70fefee69733588d36abe",
      "created_at": "2021-09-17T19:59:58Z"
    },
    {
      "event": "referenced",
      "id": 5324039800,
      "node_id": "REFE_lADOABII584gkLT9zwAAAAE9VmZ4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5324039800",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "480fc90ef7fbd1006f18ee0a0c31bdb396a6b0fa",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/480fc90ef7fbd1006f18ee0a0c31bdb396a6b0fa",
      "created_at": "2021-09-19T01:46:59Z"
    },
    {
      "event": "referenced",
      "id": 5359186806,
      "node_id": "REFE_lADOABII584gkLT9zwAAAAE_brN2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5359186806",
      "actor": {
        "login": "thelazier",
        "id": 10759339,
        "node_id": "MDQ6VXNlcjEwNzU5MzM5",
        "avatar_url": "https://avatars.githubusercontent.com/u/10759339?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/thelazier",
        "html_url": "https://github.com/thelazier",
        "followers_url": "https://api.github.com/users/thelazier/followers",
        "following_url": "https://api.github.com/users/thelazier/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/thelazier/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/thelazier/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/thelazier/subscriptions",
        "organizations_url": "https://api.github.com/users/thelazier/orgs",
        "repos_url": "https://api.github.com/users/thelazier/repos",
        "events_url": "https://api.github.com/users/thelazier/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/thelazier/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f2f86ccf338a09c5cabe12b3cbc3485ba11b8b77",
      "commit_url": "https://api.github.com/repos/thelazier/dash/commits/f2f86ccf338a09c5cabe12b3cbc3485ba11b8b77",
      "created_at": "2021-09-25T05:24:07Z"
    },
    {
      "event": "locked",
      "id": 6074095826,
      "node_id": "LOE_lADOABII584gkLT9zwAAAAFqC1jS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6074095826",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T11:16:23Z",
      "lock_reason": "resolved"
    }
  ]
}