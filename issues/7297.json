{
  "type": "issue",
  "issue": {
    "id": 125017446,
    "node_id": "MDU6SXNzdWUxMjUwMTc0NDY=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/7297",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/7297/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/7297/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/7297/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/7297",
    "number": 7297,
    "state": "closed",
    "state_reason": "completed",
    "title": "EncodeHexTx of Transactions with data in sigScript  produces broken encoding",
    "body": "I'm adding support to bitcoin-tx to add scripts/data to the scriptSig of transactions attempting to spend a P2SH output.  Similarly to the operation of bitcoin-tx, I am accepting transactions as hex encoded strings and outputting the mutated transactions as hex encoded strings. \n\nAdding trivial numeric ops seems to work fine (OP_1, OP_2, etc..) but when I attempt to add byte encoded data, such as a public key to the scriptSig, the EncodeHexTx function freaks out (see attached output below). \n\nI've been able to encode, sign and spend transactions I've constructed like this using simple ops, but for some reason EncodeHexTx is behaving badly in this case.\n\nI'm adding the scriptSig and outputting the encoded transaction with code that looks like this.\n\n```\nstatic void TestAddPubKeyToScriptSig(CMutableTransaction& tx,CPubKey& key)\n{\n    tx.vin[0].scriptSig = CScript();\n    tx.vin[0].scriptSig << ToByteVector(key);\n    std::cerr<<EncodeHexTx(tx)<<std::endl;\n\n}\n```\n\nThis is the P2SH transaction I'm attempting to spend\n[p2sh_tx.txt](https://github.com/bitcoin/bitcoin/files/78752/p2sh_tx.txt)\n\nThis is the transaction that attempts to spend the P2SH transaction, before I run the above code\nto add a scriptSig with data to it. (note, I'm adding the scriptSig data to the txin that is already in this transaction)\n[redeem_before.txt](https://github.com/bitcoin/bitcoin/files/78751/redeem_before.txt)\n\nThis is the output\n[bad_encoding.txt](https://github.com/bitcoin/bitcoin/files/78750/bad_encoding.txt)\n\nBefore diving deeper into how core does hex serialization myself, I figured I'd post this as an issue in case it's something that bears scrutiny from the community. \n",
    "user": {
      "login": "aaronstjohn",
      "id": 16142314,
      "node_id": "MDQ6VXNlcjE2MTQyMzE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/16142314?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aaronstjohn",
      "html_url": "https://github.com/aaronstjohn",
      "followers_url": "https://api.github.com/users/aaronstjohn/followers",
      "following_url": "https://api.github.com/users/aaronstjohn/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/aaronstjohn/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/aaronstjohn/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/aaronstjohn/subscriptions",
      "organizations_url": "https://api.github.com/users/aaronstjohn/orgs",
      "repos_url": "https://api.github.com/users/aaronstjohn/repos",
      "events_url": "https://api.github.com/users/aaronstjohn/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/aaronstjohn/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 1,
    "closed_at": "2016-01-05T23:29:45Z",
    "created_at": "2016-01-05T17:52:17Z",
    "updated_at": "2021-09-08T12:34:29Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 169168147,
      "node_id": "MDEyOklzc3VlQ29tbWVudDE2OTE2ODE0Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/169168147",
      "actor": {
        "login": "aaronstjohn",
        "id": 16142314,
        "node_id": "MDQ6VXNlcjE2MTQyMzE0",
        "avatar_url": "https://avatars.githubusercontent.com/u/16142314?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aaronstjohn",
        "html_url": "https://github.com/aaronstjohn",
        "followers_url": "https://api.github.com/users/aaronstjohn/followers",
        "following_url": "https://api.github.com/users/aaronstjohn/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/aaronstjohn/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/aaronstjohn/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/aaronstjohn/subscriptions",
        "organizations_url": "https://api.github.com/users/aaronstjohn/orgs",
        "repos_url": "https://api.github.com/users/aaronstjohn/repos",
        "events_url": "https://api.github.com/users/aaronstjohn/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/aaronstjohn/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-01-05T23:29:44Z",
      "updated_at": "2016-01-05T23:30:06Z",
      "author_association": "NONE",
      "body": "Oops, user error on this one. I managed to overwrite the mutable transaction with junk before it ever hit the above code. Passing a correctly parsed MutableTx encodes fine.\n",
      "user": {
        "login": "aaronstjohn",
        "id": 16142314,
        "node_id": "MDQ6VXNlcjE2MTQyMzE0",
        "avatar_url": "https://avatars.githubusercontent.com/u/16142314?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aaronstjohn",
        "html_url": "https://github.com/aaronstjohn",
        "followers_url": "https://api.github.com/users/aaronstjohn/followers",
        "following_url": "https://api.github.com/users/aaronstjohn/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/aaronstjohn/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/aaronstjohn/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/aaronstjohn/subscriptions",
        "organizations_url": "https://api.github.com/users/aaronstjohn/orgs",
        "repos_url": "https://api.github.com/users/aaronstjohn/repos",
        "events_url": "https://api.github.com/users/aaronstjohn/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/aaronstjohn/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/7297#issuecomment-169168147",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/7297"
    },
    {
      "event": "closed",
      "id": 506529432,
      "node_id": "MDExOkNsb3NlZEV2ZW50NTA2NTI5NDMy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/506529432",
      "actor": {
        "login": "aaronstjohn",
        "id": 16142314,
        "node_id": "MDQ6VXNlcjE2MTQyMzE0",
        "avatar_url": "https://avatars.githubusercontent.com/u/16142314?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aaronstjohn",
        "html_url": "https://github.com/aaronstjohn",
        "followers_url": "https://api.github.com/users/aaronstjohn/followers",
        "following_url": "https://api.github.com/users/aaronstjohn/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/aaronstjohn/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/aaronstjohn/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/aaronstjohn/subscriptions",
        "organizations_url": "https://api.github.com/users/aaronstjohn/orgs",
        "repos_url": "https://api.github.com/users/aaronstjohn/repos",
        "events_url": "https://api.github.com/users/aaronstjohn/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/aaronstjohn/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-01-05T23:29:45Z"
    },
    {
      "event": "locked",
      "id": 5272012961,
      "node_id": "LOE_lADOABII584Hc51mzwAAAAE6PIih",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5272012961",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:34:29Z",
      "lock_reason": "resolved"
    }
  ]
}