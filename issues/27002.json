{
  "type": "issue",
  "issue": {
    "id": 1563372501,
    "node_id": "I_kwDOABII585dLyvV",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/27002",
    "number": 27002,
    "state": "open",
    "state_reason": null,
    "title": "listunspent, fundrawtransaction, getwalletinfo locks wallet for any other operation",
    "body": "**Actual behavior**\r\n\r\nIf you run a `listunspent`, `fundrawtransaction`, `getwalletinfo` (maybe other commands) on a big wallet (e.g. with wallet with at least  8000 transactions or more) all other operations conducted in parallel (e.g. `getnewaddress`) will be stuck until that command finishes.\r\n\r\nBecause of this issue when our wallet is sending transactions using `listunspent` and `fundrawtransactions` there is no way to get a new address via `getnewaddress` RPC call (as bitcoin waits for those calls to finish).\r\n\r\nI've got bitcoin's datadir and wallet both on NVME drives, but running `listunspent` and sometimes `getwalletinfo` is painfully slow.\r\n\r\nThe wallet itself is not that big and was created recently to migrate from bdb to the new descriptors wallet:\r\n```\r\n$ du -sh .bitcoin/desc/\r\n78M\t.bitcoin/desc/\r\n```\r\n\r\n```\r\n~$ ./bitcoin-cli -rpcwallet=desc getwalletinfo\r\n{\r\n  \"walletname\": \"desc\",\r\n  \"walletversion\": 169900,\r\n  \"format\": \"sqlite\",\r\n  \"balance\": xxx,\r\n  \"unconfirmed_balance\": xxx,\r\n  \"immature_balance\": 0.00000000,\r\n  \"txcount\": 8482,\r\n  \"keypoolsize\": 4000,\r\n  \"keypoolsize_hd_internal\": 4000,\r\n  \"paytxfee\": 0.00000000,\r\n  \"private_keys_enabled\": true,\r\n  \"avoid_reuse\": false,\r\n  \"scanning\": false,\r\n  \"descriptors\": true,\r\n  \"external_signer\": false\r\n}\r\n```\r\n\r\n```\r\n$ time ./bitcoin-cli -rpcwallet=desc listunspent|grep txid|wc -l\r\n224\r\n\r\nreal\t1m15.596s\r\nuser\t0m0.008s\r\nsys\t0m0.000s\r\n```\r\n\r\n**Expected behavior**\r\n\r\n`listunspent` or `fundrawtransaction` shouldn't lock the wallet at least for getting new address, maybe other operations as well?\r\n\r\n**To reproduce**\r\n\r\n* create a new descriptors wallet and generate 17K addresses there\r\n* create at least 8K transactions in and out\r\n* try to run `listunspent` or `fundrawtransaction` and in parallel `getnewaddress`\r\n* `getnewaddress` will take 60 seconds or more to return an address until either of `listunspent` or `fundrawtransaction` finishes\r\n\r\n**System information**\r\n\r\nI've tried latest bitcoin release `v24.0.1`, master branch (built 77a36033b5ecbf8dedb917d680f4116786fd7375 commit) issue reproduces.\r\n\r\nSelf-built for Ubuntu 18.04 LTS.\r\n\r\nI've got bitcoin's datadir and wallet both on NVME drives, but running `listunspent` is painfully slow.",
    "user": {
      "login": "gituser",
      "id": 104405,
      "node_id": "MDQ6VXNlcjEwNDQwNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gituser",
      "html_url": "https://github.com/gituser",
      "followers_url": "https://api.github.com/users/gituser/followers",
      "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
      "organizations_url": "https://api.github.com/users/gituser/orgs",
      "repos_url": "https://api.github.com/users/gituser/repos",
      "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/gituser/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 20,
    "created_at": "2023-01-30T23:31:39Z",
    "updated_at": "2023-05-29T02:55:01Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 8393531422,
      "node_id": "LE_lADOABII585dLyvVzwAAAAH0SyAe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8393531422",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-30T23:31:39Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 1409570461,
      "node_id": "IC_kwDOABII585UBFad",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1409570461",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T00:30:44Z",
      "updated_at": "2023-01-31T00:30:44Z",
      "author_association": "MEMBER",
      "body": "These commands intentionally lock the wallet (and in the case of `getnewaddress` the script pubkey manager being called) in order that their results are guarenteed to be atomic and correct.\r\n\r\n`listunspent` must lock the wallet so that when it returns your list of unspent utxos these are certain to still be unspent by the time the function returns. In fact it will lock the wallet twice, [once while it fetches all available coins](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/rpc/coins.cpp#L640-L641) as outputs, and again [as it parses each output](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/rpc/coins.cpp#L644-L727) to provide context on it.\r\n\r\nMy understanding is that `getnewaddress` locks the wallet when generating new addresses to avoid e.g. a race between two calls to fetch a new address which could result in the same address being returned twice (or written to the db multiple times).\r\n\r\nI don't think performing either of these operations (nor `fundrawtransaction`) without blocking is avoidable. The remaining issue therefore is whether any of these operations can be sped up in bitcoin core descriptor wallets, to which I defer to others.\r\n\r\nAs an alternative, perhaps you could consider implementing some client side caching either on the `getnewaddress` or the `listunspent` calls to try and circumvent this?",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1409570461",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1409910146,
      "node_id": "IC_kwDOABII585UCYWC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1409910146",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T07:49:04Z",
      "updated_at": "2023-01-31T07:54:26Z",
      "author_association": "NONE",
      "body": "@willcl-ark thanks for the quick reply.\r\n\r\nHowever, If I run `getnewaddress` in parallel (e.g. using parallel) it fetches 1000 unique addresses without any issues in less than 5 secs:\r\n\r\ne.g. little script like this\r\n```\r\n#!/bin/bash\r\nWALLET=test\r\nUSER=yyy\r\nPASS=xxx\r\nTHREADS=1000\r\n\r\nif [ -z \"$1\" ]; then\r\n echo \"Usage: `basename $0` [threads]\"\r\n exit 1\r\nfi\r\n\r\nTHREADS=$1\r\nulimit -n 65535\r\n\r\nseq $THREADS|parallel -j$THREADS -n0 \"curl -s --user $USER:$PASS --data-binary '{\\\"jsonrpc\\\": \\\"1.0\\\", \\\"id\\\":\\\"curltest\\\", \\\"method\\\": \\\"getnewaddress\\\", \\\"params\\\": [] }' -H 'content-type: text/plain;' http://127.0.0.1:18332/wallet/$WALLET\"\r\n```\r\nResults in: \r\n```\r\n$ time ./gen_addresses.sh 1000 >/dev/null\r\nreal\t0m4.495s\r\nuser\t0m4.745s\r\nsys\t0m8.019s\r\n```\r\nSo that makes me wonder why `getnewaddress` isn't blocking fetching another address in parallel, whilst `listunspent` blocks entirety of the wallet.\r\n\r\nHow do I implement client side caching of `getnewaddress` or `listunspent`, if `listunspent` still locks wallet for at least 1 minute? That means at least 1 minute bitcoin wallet won't be able to respond to any other calls.\r\n\r\nCurrently my app is very simple:\r\n* it fetches new address by using `getnewaddress`\r\n* and if the user requests withdrawal it collects UTXO and combines them into transaction\r\n\r\nSo my problem is with 2) as it locks the wallet and 1) stops working resulting in service unavailability.\r\n\r\nOf course the best is to generate addresses completely offline, but I've wanted (for now) to use bitcoin wallet's functionality for that.",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1409910146",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "mentioned",
      "id": 8396418515,
      "node_id": "MEE_lADOABII585dLyvVzwAAAAH0dy3T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8396418515",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T07:49:04Z"
    },
    {
      "event": "subscribed",
      "id": 8396418527,
      "node_id": "SE_lADOABII585dLyvVzwAAAAH0dy3f",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8396418527",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T07:49:04Z"
    },
    {
      "event": "commented",
      "id": 1410443297,
      "node_id": "IC_kwDOABII585UEagh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410443297",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T14:20:43Z",
      "updated_at": "2023-01-31T14:20:43Z",
      "author_association": "MEMBER",
      "body": "I don't think you'll easily hit the contention lock on `getnewaddress` as it returns so fast, i.e. it does not block for long enough on any call. For me the entire RPC call takes about 10 ms or less, with aonly a fraction of that locking the wallet lock.\r\n\r\nTo cache `getnewaddress` you could perhaps call it some number of times on startup so that you have a cache of unused addresses in your client app, and periodically after that (rather than on demand).\r\n\r\nAre you calling `listunspent` RPC each time user wants to make a withdrawal, and if so I am curious as to why? If user funds are pooled, then could you not let Bitcoin Core's coin selection algorithms handle constructing transactions of any amount for you using available UTXOs, as an alternative (without knowing any more about how you are using the output of `listunspent`)?",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1410443297",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1410711066,
      "node_id": "IC_kwDOABII585UFb4a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410711066",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T16:39:59Z",
      "updated_at": "2023-01-31T16:40:54Z",
      "author_association": "NONE",
      "body": "> Are you calling `listunspent` RPC each time user wants to make a withdrawal, and if so I am curious as to why? If user funds are pooled, then could you not let Bitcoin Core's coin selection algorithms handle constructing transactions of any amount for you using available UTXOs, as an alternative (without knowing any more about how you are using the output of `listunspent`)?\r\n\r\nYes I do call `listunspent` every time I want to:\r\n1) accumulate small (close to dust) payments (e.g. < 0.01 BTC) into 1 large transaction (via crontab every hour or so) to limit number of unspent payments\r\n2) for user withdrawals I collect requests and construct 1 large transaction (every 5 minutes) with multiple withdrawal outputs with `fundrawtransaction`\r\n\r\nIn both cases there will be a lock on my system, I can't cache `listunspent` or `fundrawtransaction` because the UTXO are changing all the time (new transactions are arriving).",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1410711066",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1410730031,
      "node_id": "IC_kwDOABII585UFggv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410730031",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T16:49:58Z",
      "updated_at": "2023-01-31T16:49:58Z",
      "author_association": "MEMBER",
      "body": "I see. Well I don't think the wallet locks on these functions will be going anywhere, so I think best to consider how you can work around it...\r\n\r\nFor example, there are `query_options` in `listunspent` (see `bitcoin-cli help listunspent`):\r\n\r\n```\r\n5. query_options                             (json object, optional) JSON with query options\r\n     {\r\n       \"minimumAmount\": amount,              (numeric or string, optional, default=\"0.00\") Minimum value of each UTXO in BTC\r\n       \"maximumAmount\": amount,              (numeric or string, optional, default=unlimited) Maximum value of each UTXO in BTC\r\n       \"maximumCount\": n,                    (numeric, optional, default=unlimited) Maximum number of UTXOs\r\n       \"minimumSumAmount\": amount,           (numeric or string, optional, default=unlimited) Minimum sum value of all UTXOs in BTC\r\n       \"include_immature_coinbase\": bool,    (boolean, optional, default=false) Include immature coinbase UTXOs\r\n     }\r\n```\r\n\r\n...which might help reduce your query time if you only want to collect low-value UTXOs, by specifying max amount, count or maximum sumAmount for example?",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1410730031",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1410734920,
      "node_id": "IC_kwDOABII585UFhtI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410734920",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T16:53:37Z",
      "updated_at": "2023-01-31T16:53:37Z",
      "author_association": "MEMBER",
      "body": "`listunspent`, `fundrawtransaction`, and the `send*` RPCs all require figuring out the UTXOs that belong to the wallet. Currently, that means iterating through every single output of every transaction in the wallet, including received, sent, and unrelated, all while holding the wallet lock to ensure that atomicity of the operation. This can be very slow for large wallets (I think your wallets could be classified as such). We are working on improving the wallet so that it does not do this and is more performant, but it requires rewriting a large portion of the transaction handling code, so it's going pretty slowly. There unfortunately is not much that can be done about this other than using multiple smaller wallets rather than one very big one.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1410734920",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1410750324,
      "node_id": "IC_kwDOABII585UFld0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1410750324",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T17:04:27Z",
      "updated_at": "2023-01-31T17:04:27Z",
      "author_association": "NONE",
      "body": "> I see. Well I don't think the wallet locks on these functions will be going anywhere, so I think best to consider how you can work around it...\r\n> \r\n> For example, there are `query_options` in `listunspent` (see `bitcoin-cli help listunspent`):\r\n> \r\n> ```\r\n> 5. query_options                             (json object, optional) JSON with query options\r\n>      {\r\n>        \"minimumAmount\": amount,              (numeric or string, optional, default=\"0.00\") Minimum value of each UTXO in BTC\r\n>        \"maximumAmount\": amount,              (numeric or string, optional, default=unlimited) Maximum value of each UTXO in BTC\r\n>        \"maximumCount\": n,                    (numeric, optional, default=unlimited) Maximum number of UTXOs\r\n>        \"minimumSumAmount\": amount,           (numeric or string, optional, default=unlimited) Minimum sum value of all UTXOs in BTC\r\n>        \"include_immature_coinbase\": bool,    (boolean, optional, default=false) Include immature coinbase UTXOs\r\n>      }\r\n> ```\r\n> \r\n> ...which might help reduce your query time if you only want to collect low-value UTXOs, by specifying max amount, count or maximum sumAmount for example?\r\n\r\nThanks for the tip, but I'm already using only confirmed UTXOs and also got a filter on `maximumAmount`, but it's still slow..\r\n\r\nI'm also thinking about creating a copy of the wallet (identical) where I will be running slow operations like `listunspent` or `fundrawtransaction`.",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1410750324",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1411075133,
      "node_id": "IC_kwDOABII585UG0w9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1411075133",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T21:10:34Z",
      "updated_at": "2023-01-31T21:10:54Z",
      "author_association": "NONE",
      "body": "It seems to me slow `listunspent` is some kind of bitcoin's regression (might be?), as I have some test litecoin wallet (though it's bdb wallet v130000 not descriptors) with more than 19K unspent outputs and more than 80K transactions and `listunspent` works instantly in few ms.",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1411075133",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1411119579,
      "node_id": "IC_kwDOABII585UG_nb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1411119579",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-31T21:54:00Z",
      "updated_at": "2023-01-31T21:54:00Z",
      "author_association": "MEMBER",
      "body": "If you're able to, could you try [profiling with perf](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#performance-profiling-with-perf) to see where the time is being spent during `listunspent`?",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1411119579",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1411400147,
      "node_id": "IC_kwDOABII585UIEHT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1411400147",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T03:10:46Z",
      "updated_at": "2023-02-01T03:11:00Z",
      "author_association": "NONE",
      "body": "@achow101 there you go https://pastebin.com/raw/fSzSr6NF",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1411400147",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "mentioned",
      "id": 8405865514,
      "node_id": "MEE_lADOABII585dLyvVzwAAAAH1B1Qq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8405865514",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T03:11:01Z"
    },
    {
      "event": "subscribed",
      "id": 8405865529,
      "node_id": "SE_lADOABII585dLyvVzwAAAAH1B1Q5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8405865529",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T03:11:01Z"
    },
    {
      "event": "commented",
      "id": 1411428573,
      "node_id": "IC_kwDOABII585UILDd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1411428573",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T04:00:24Z",
      "updated_at": "2023-02-01T04:00:24Z",
      "author_association": "MEMBER",
      "body": "Hmm, it looks like it actually spends most of the time in `IsMine`, not in iterating the transactions. Around how many addresses does the wallet have?\r\n\r\nCould you try this [branch](https://github.com/achow101/bitcoin/tree/descspkm-hashmaps)? I've changed the map used in `IsMine` lookups to be an unordered map so it should be faster, but based on the profiling, I'm not sure if this is the main source of the slowdown.\r\n\r\nI'm working on generating a big wallet for testing, should be ready to reproduce this myself tomorrow.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1411428573",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1411765586,
      "node_id": "IC_kwDOABII585UJdVS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1411765586",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T09:52:22Z",
      "updated_at": "2023-02-01T09:53:51Z",
      "author_association": "NONE",
      "body": "> Hmm, it looks like it actually spends most of the time in `IsMine`, not in iterating the transactions. Around how many addresses does the wallet have?\r\n> \r\n> Could you try this [branch](https://github.com/achow101/bitcoin/tree/descspkm-hashmaps)? I've changed the map used in `IsMine` lookups to be an unordered map so it should be faster, but based on the profiling, I'm not sure if this is the main source of the slowdown.\r\n\r\nI've tried your branch and had similar issue with slow `listunspent` it even took more than 90 seconds:\r\n```\r\n time ./bitcoin-cli -rpcwallet=desc listunspent|grep txid|wc -l\r\n61\r\n\r\nreal\t2m53.541s\r\nuser\t0m0.005s\r\nsys\t0m0.000s\r\n```\r\n\r\nand perf report is similar, I'm pasting a snip here:\r\n\r\n```\r\n# Total Lost Samples: 0\r\n#\r\n# Samples: 12K of event 'cycles'\r\n# Event count (approx.): 404461969778\r\n#\r\n# Children      Self  Command         Shared Object        Symbol                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \r\n# ........  ........  ..............  ...................  ................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................\r\n#\r\n    99.85%     0.00%  b-httpworker.1  [unknown]            [.] 0xffffffffffffffff\r\n            |\r\n            ---0xffffffffffffffff\r\n               RPCHelpMan::HandleRequest\r\n               std::_Function_handler<UniValue (RPCHelpMan const&, JSONRPCRequest const&), wallet::listunspent()::{lambda(RPCHelpMan const&, JSONRPCRequest const&)#1}>::_M_invoke\r\n               wallet::listunspent()::{lambda(RPCHelpMan const&, JSONRPCRequest const&)#1}::operator()\r\n               wallet::AvailableCoinsListUnspent\r\n               wallet::AvailableCoins\r\n               |          \r\n               |--97.39%--wallet::CWallet::IsMine\r\n               |          |          \r\n               |          |--60.54%--wallet::DescriptorScriptPubKeyMan::IsMine\r\n               |          |          |          \r\n               |          |          |--47.50%--std::_Hashtable<CScript, std::pair<CScript const, int>, std::allocator<std::pair<CScript const, int> >, std::__detail::_Select1st, std::equal_to<CScript>, SaltedSipHasher, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<true, false, true> >::count\r\n               |          |          |          |          \r\n               |          |          |           --30.67%--SaltedSipHasher::operator()\r\n               |          |          |                     |          \r\n               |          |          |                     |--18.71%--CSipHasher::Write\r\n               |          |          |                     |          \r\n               |          |          |                     |--8.78%--CSipHasher::Finalize\r\n               |          |          |                     |          \r\n               |          |          |                      --2.03%--CSipHasher::CSipHasher\r\n               |          |          |          \r\n               |          |          |--5.72%--std::unique_lock<std::recursive_mutex>::unlock\r\n               |          |          |          |          \r\n               |          |          |           --4.33%--__GI___pthread_mutex_unlock (inlined)\r\n               |          |          |          \r\n               |          |           --4.62%--UniqueLock<AnnotatedMixin<std::recursive_mutex> >::UniqueLock\r\n               |          |                     |          \r\n               |          |                      --3.09%--__GI___pthread_mutex_lock (inlined)\r\n               |          |          \r\n               |           --22.32%--std::_Rb_tree_increment\r\n               |          \r\n                --2.34%--wallet::CachedTxIsFromMe\r\n                          wallet::CachedTxGetDebit\r\n                          wallet::GetCachableAmount\r\n                          wallet::CWallet::GetDebit\r\n                          wallet::CWallet::GetDebit\r\n                          |          \r\n                           --2.30%--wallet::CWallet::IsMine\r\n                                     |          \r\n                                      --1.51%--wallet::DescriptorScriptPubKeyMan::IsMine\r\n                                                |          \r\n                                                 --1.13%--std::_Hashtable<CScript, std::pair<CScript const, int>, std::allocator<std::pair<CScript const, int> >, std::__detail::_Select1st, std::equal_to<CScript>, SaltedSipHasher, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<true, false, true> >::count\r\n                                                           |          \r\n                                                            --0.77%--SaltedSipHasher::operator()\r\n\r\n```\r\n\r\n> I'm working on generating a big wallet for testing, should be ready to reproduce this myself tomorrow.\r\n\r\nGreat! Thank you.\r\n",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1411765586",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412242747,
      "node_id": "IC_kwDOABII585ULR07",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412242747",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T15:23:14Z",
      "updated_at": "2023-02-01T15:23:14Z",
      "author_association": "NONE",
      "body": "Maybe this PR will help https://github.com/bitcoin/bitcoin/pull/9939",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412242747",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412386397,
      "node_id": "IC_kwDOABII585UL05d",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412386397",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T16:53:35Z",
      "updated_at": "2023-02-01T16:53:35Z",
      "author_association": "MEMBER",
      "body": "I've generated a wallet that has ~7500 UTXOs, ~91000 addresses, and ~333000 transactions, `listunspent` takes ~2 seconds to run, and `listtransactions` ~20 seconds. I think I've produced a wallet with similar parameters as yours, but am not seeing nearly as big of a slowdown.\r\n\r\nHave you imported additional descriptors into your wallet?",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412386397",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412430789,
      "node_id": "IC_kwDOABII585UL_vF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412430789",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T17:20:52Z",
      "updated_at": "2023-02-01T17:20:52Z",
      "author_association": "MEMBER",
      "body": "> > Are you calling `listunspent` RPC each time user wants to make a withdrawal, and if so I am curious as to why? If user funds are pooled, then could you not let Bitcoin Core's coin selection algorithms handle constructing transactions of any amount for you using available UTXOs, as an alternative (without knowing any more about how you are using the output of `listunspent`)?\r\n> \r\n> Yes I do call `listunspent` every time I want to:\r\n> \r\n> 1. accumulate small (close to dust) payments (e.g. < 0.01 BTC) into 1 large transaction (via crontab every hour or so) to limit number of unspent payments\r\n> 2. for user withdrawals I collect requests and construct 1 large transaction (every 5 minutes) with multiple withdrawal outputs with `fundrawtransaction`\r\n> \r\n> In both cases there will be a lock on my system, I can't cache `listunspent` or `fundrawtransaction` because the UTXO are changing all the time (new transactions are arriving).\r\n\r\nAs `fundrawtransaction` doesn't allow you to pre-select inputs. How are you doing (1)?\r\n\r\nIf you are manually creating the tx by calling `listunspent` + `createrawtransaction`, then you could skip `fundrawtransaction` step and just call to `signrawtransactionwithwallet` (or, disable the `fundrawtransaction` \"add_inputs\" option which will command the wallet to skip the entire available coins fetching and selection process, which you don't need to execute as you are manually selecting the UTXOs that will be spent).\r\n\r\nFor (2), stuff like #25806 + what will come after it, will speedup the tx creation process (on big wallets the difference should be very noticeable).",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412430789",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412527127,
      "node_id": "IC_kwDOABII585UMXQX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412527127",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:28:11Z",
      "updated_at": "2023-02-01T18:28:25Z",
      "author_association": "NONE",
      "body": "> I've generated a wallet that has ~7500 UTXOs, ~91000 addresses, and ~333000 transactions, `listunspent` takes ~2 seconds to run, and `listtransactions` ~20 seconds. I think I've produced a wallet with similar parameters as yours, but am not seeing nearly as big of a slowdown.\r\n> \r\n> Have you imported additional descriptors into your wallet?\r\n\r\nYes I have imported descriptors for single addresses from my old legacy wallet (about 15K addresses).",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412527127",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412533053,
      "node_id": "IC_kwDOABII585UMYs9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412533053",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:33:03Z",
      "updated_at": "2023-02-01T18:35:02Z",
      "author_association": "NONE",
      "body": "> > > Are you calling `listunspent` RPC each time user wants to make a withdrawal, and if so I am curious as to why? If user funds are pooled, then could you not let Bitcoin Core's coin selection algorithms handle constructing transactions of any amount for you using available UTXOs, as an alternative (without knowing any more about how you are using the output of `listunspent`)?\r\n> > \r\n> > \r\n> > Yes I do call `listunspent` every time I want to:\r\n> > \r\n> > 1. accumulate small (close to dust) payments (e.g. < 0.01 BTC) into 1 large transaction (via crontab every hour or so) to limit number of unspent payments\r\n> > 2. for user withdrawals I collect requests and construct 1 large transaction (every 5 minutes) with multiple withdrawal outputs with `fundrawtransaction`\r\n> > \r\n> > In both cases there will be a lock on my system, I can't cache `listunspent` or `fundrawtransaction` because the UTXO are changing all the time (new transactions are arriving).\r\n> \r\n> As `fundrawtransaction` doesn't allow you to pre-select inputs. How are you doing (1)?\r\n> \r\n> If you are manually creating the tx by calling `listunspent` + `createrawtransaction`, then you could skip `fundrawtransaction` step and just call to `signrawtransactionwithwallet` (or, disable the `fundrawtransaction` \"add_inputs\" option which will command the wallet to skip the entire available coins fetching and selection process, which you don't need to execute as you are manually selecting the UTXOs that will be spent).\r\n\r\nI do use `fundrawtransaction()` in order to determine fee as it's complicated to calculate it manually because of all the different BTC type addresses.\r\n Yes, I create transaction with `createrawtransaction()` with txids from `listunspent`, then call `fundrawtransaction()` calc fee, minus that fee from overall amount of outputs and then call again `createrawtransaction()` + `fundrawtransaction()` just to be sure that there will be a single address in the outputs.\r\n\r\nAlso another solution is to pre-determine fee for hardcoded number of input UTXOs and minus it.\r\n\r\nIf you have a better solution I'd love to hear it.\r\n\r\n> \r\n> For (2), stuff like #25806 + what will come after it, will speedup the tx creation process (on big wallets the difference should be very noticeable).\r\n\r\nNice!",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412533053",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412539837,
      "node_id": "IC_kwDOABII585UMaW9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412539837",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:38:53Z",
      "updated_at": "2023-02-01T18:38:53Z",
      "author_association": "MEMBER",
      "body": "> Yes I have imported descriptors for single addresses from my old legacy wallet (about 15K addresses).\r\n\r\nAhh, I think that's the issue then. Based on the profiling, what's happening is that most of the time is being spent iterating through each imported descriptor. I believe #26008 should fix this for you, can you try that?",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412539837",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "commented",
      "id": 1412556699,
      "node_id": "IC_kwDOABII585UMeeb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412556699",
      "actor": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:54:12Z",
      "updated_at": "2023-02-01T18:54:36Z",
      "author_association": "NONE",
      "body": "> > Yes I have imported descriptors for single addresses from my old legacy wallet (about 15K addresses).\r\n> \r\n> Ahh, I think that's the issue then. Based on the profiling, what's happening is that most of the time is being spent iterating through each imported descriptor. I believe #26008 should fix this for you, can you try that?\r\n\r\nYes, this is it! Version of bitcoind from this #26008 pull request works just fine:\r\n```\r\n$ time ./bitcoin-cli -rpcwallet=desc listunspent|grep txid|wc -l\r\n314\r\n\r\nreal\t0m0.464s\r\nuser\t0m0.009s\r\nsys\t0m0.000s\r\n```\r\n\r\n@achow101 you're genius, thanks a lot!",
      "user": {
        "login": "gituser",
        "id": 104405,
        "node_id": "MDQ6VXNlcjEwNDQwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gituser",
        "html_url": "https://github.com/gituser",
        "followers_url": "https://api.github.com/users/gituser/followers",
        "following_url": "https://api.github.com/users/gituser/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gituser/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gituser/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
        "organizations_url": "https://api.github.com/users/gituser/orgs",
        "repos_url": "https://api.github.com/users/gituser/repos",
        "events_url": "https://api.github.com/users/gituser/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gituser/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1412556699",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    },
    {
      "event": "mentioned",
      "id": 8413565011,
      "node_id": "MEE_lADOABII585dLyvVzwAAAAH1fNBT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8413565011",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:54:13Z"
    },
    {
      "event": "subscribed",
      "id": 8413565030,
      "node_id": "SE_lADOABII585dLyvVzwAAAAH1fNBm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8413565030",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-02-01T18:54:13Z"
    },
    {
      "event": "commented",
      "id": 1566421689,
      "node_id": "IC_kwDOABII585dXbK5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1566421689",
      "actor": {
        "login": "Crypto2",
        "id": 7625236,
        "node_id": "MDQ6VXNlcjc2MjUyMzY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7625236?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypto2",
        "html_url": "https://github.com/Crypto2",
        "followers_url": "https://api.github.com/users/Crypto2/followers",
        "following_url": "https://api.github.com/users/Crypto2/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypto2/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypto2/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypto2/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypto2/orgs",
        "repos_url": "https://api.github.com/users/Crypto2/repos",
        "events_url": "https://api.github.com/users/Crypto2/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypto2/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-29T02:55:00Z",
      "updated_at": "2023-05-29T02:55:00Z",
      "author_association": "NONE",
      "body": "> `listunspent`, `fundrawtransaction`, and the `send*` RPCs all require figuring out the UTXOs that belong to the wallet. Currently, that means iterating through every single output of every transaction in the wallet, including received, sent, and unrelated, all while holding the wallet lock to ensure that atomicity of the operation.\r\n\r\nI've suggested before just having a second map of only unspents, should speed it up massively at the expense of some memory. Could be default off and have to enable in the config file/command line if that's a worry.",
      "user": {
        "login": "Crypto2",
        "id": 7625236,
        "node_id": "MDQ6VXNlcjc2MjUyMzY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7625236?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypto2",
        "html_url": "https://github.com/Crypto2",
        "followers_url": "https://api.github.com/users/Crypto2/followers",
        "following_url": "https://api.github.com/users/Crypto2/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypto2/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypto2/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypto2/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypto2/orgs",
        "repos_url": "https://api.github.com/users/Crypto2/repos",
        "events_url": "https://api.github.com/users/Crypto2/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypto2/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27002#issuecomment-1566421689",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27002"
    }
  ]
}