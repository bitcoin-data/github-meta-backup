{
  "type": "issue",
  "issue": {
    "id": 1692951498,
    "node_id": "I_kwDOABII585k6GPK",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/27558",
    "number": 27558,
    "state": "closed",
    "state_reason": "completed",
    "title": "Coinstats index corrupted after invalidateblock and clean shutdown",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nI tried running `invalidateblock` on a block a few hundred blocks behind the chain tip. While this command was running, I also ran `stop` and the node apparently shut down cleanly:\r\n\r\n<details>\r\n<summary>Last logs before shutdown</summary>\r\n\r\n```\r\n2023-05-02T18:31:17Z UpdateTip: new best=00000000000000000003518599da068e68cca93b3d74bcc25e240229f7a86293 height=787853 version=0x23608000 log2_work=94.154224 tx=830684559 date='2023-05-01T19:44:33Z' progress=0.999711 cache=18.5MiB(104112txo)\r\n2023-05-02T18:31:21Z UpdateTip: new best=00000000000000000003e3254dbe0c37627c01adf82b4582d40cdd9d40065e3b height=787852 version=0x3359c000 log2_work=94.154210 tx=830681309 date='2023-05-01T19:16:08Z' progress=0.999705 cache=19.1MiB(109976txo)\r\n2023-05-02T18:31:27Z UpdateTip: new best=00000000000000000001722f9798d3009acf467a22b15324cbd3a730df7b81d2 height=787851 version=0x32264000 log2_work=94.154197 tx=830676978 date='2023-05-01T19:08:10Z' progress=0.999704 cache=20.2MiB(119117txo)\r\n2023-05-02T18:31:31Z UpdateTip: new best=00000000000000000004fb8e18d4aa564406708db9dcf2e5a19841fb5243c2c5 height=787850 version=0x20000000 log2_work=94.154183 tx=830673049 date='2023-05-01T18:56:27Z' progress=0.999701 cache=21.2MiB(127290txo)\r\n2023-05-02T18:31:32Z addcon thread exit\r\n2023-05-02T18:31:32Z Shutdown: In progress...\r\n2023-05-02T18:31:32Z net thread exit\r\n2023-05-02T18:31:34Z opencon thread exit\r\n2023-05-02T18:31:35Z UpdateTip: new best=00000000000000000003b325732590843673742d287f78699f018e4be50f72b6 height=787849 version=0x20000000 log2_work=94.154169 tx=830668665 date='2023-05-01T18:42:36Z' progress=0.999698 cache=22.4MiB(137486txo)\r\n2023-05-02T18:31:35Z msghand thread exit\r\n2023-05-02T18:31:35Z InvalidChainFound: invalid block=00000000000000000004fb8e18d4aa564406708db9dcf2e5a19841fb5243c2c5  height=787850  log2_work=94.154183  date=2023-05-01T18:56:27Z\r\n2023-05-02T18:31:35Z InvalidChainFound:  current best=00000000000000000003b325732590843673742d287f78699f018e4be50f72b6  height=787849  log2_work=94.154169  date=2023-05-01T18:42:36Z\r\n2023-05-02T18:31:35Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat started\r\n2023-05-02T18:31:35Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n2023-05-02T18:31:35Z scheduler thread exit\r\n2023-05-02T18:31:35Z Writing 0 unbroadcast transactions to disk.\r\n2023-05-02T18:31:35Z Dumped mempool: 0.00475053s to copy, 0.0185962s to dump\r\n2023-05-02T18:31:35Z Shutdown: done\r\n```\r\n</details>\r\n\r\nHowever, after starting the node again, a corrupted coinstats index is detected and the node shuts down:\r\n\r\n<details>\r\n<summary>Logs</summary>\r\n\r\n```\r\n2023-05-02T18:31:53Z Bitcoin Core version v24.0.1 (release build)\r\n2023-05-02T18:31:53Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -upnp=0\r\n2023-05-02T18:31:53Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -natpmp=0\r\n2023-05-02T18:31:53Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -discover=0\r\n2023-05-02T18:31:53Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -listenonion=0\r\n2023-05-02T18:31:53Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -i2pacceptincoming=0\r\n2023-05-02T18:31:53Z Using the 'x86_shani(1way,2way)' SHA256 implementation\r\n2023-05-02T18:31:53Z Using RdSeed as an additional entropy source\r\n2023-05-02T18:31:53Z Using RdRand as an additional entropy source\r\n2023-05-02T18:31:53Z Default data directory /home/***/.bitcoin\r\n2023-05-02T18:31:53Z Using data directory /home/***/.bitcoin\r\n2023-05-02T18:31:53Z Config file: /home/***/.bitcoin/bitcoin.conf\r\n2023-05-02T18:31:53Z Config file arg: coinstatsindex=\"1\"\r\n2023-05-02T18:31:53Z Config file arg: dbcache=\"50\"\r\n2023-05-02T18:31:53Z Config file arg: disablewallet=\"1\"\r\n2023-05-02T18:31:53Z Config file arg: listen=\"0\"\r\n2023-05-02T18:31:53Z Config file arg: maxmempool=\"50\"\r\n2023-05-02T18:31:53Z Config file arg: maxorphantx=\"10\"\r\n2023-05-02T18:31:53Z Config file arg: prune=\"550\"\r\n2023-05-02T18:31:53Z Config file arg: rpcauth=****\r\n2023-05-02T18:31:53Z Config file arg: server=\"1\"\r\n2023-05-02T18:31:53Z Config file arg: zmqpubhashblock=\"tcp://127.0.0.1:28332\"\r\n2023-05-02T18:31:53Z Command-line arg: daemon=\"\"\r\n2023-05-02T18:31:53Z Using at most 125 automatic connections (1024 file descriptors available)\r\n2023-05-02T18:31:53Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2023-05-02T18:31:53Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2023-05-02T18:31:53Z Script verification uses 1 additional threads\r\n2023-05-02T18:31:53Z Wallet disabled!\r\n2023-05-02T18:31:53Z scheduler thread start\r\n2023-05-02T18:31:53Z [http] creating work queue of depth 16\r\n2023-05-02T18:31:53Z Using random cookie authentication.\r\n2023-05-02T18:31:53Z Generated RPC authentication cookie /home/***/.bitcoin/.cookie\r\n2023-05-02T18:31:53Z Using rpcauth authentication.\r\n2023-05-02T18:31:53Z [http] starting 4 worker threads\r\n2023-05-02T18:31:53Z Using /16 prefix for IP bucketing\r\n2023-05-02T18:31:53Z init message: Loading P2P addresses…\r\n2023-05-02T18:31:53Z Loaded 67959 addresses from peers.dat  156ms\r\n2023-05-02T18:31:53Z init message: Loading banlist…\r\n2023-05-02T18:31:53Z SetNetworkActive: true\r\n2023-05-02T18:31:53Z Cache configuration:\r\n2023-05-02T18:31:53Z * Using 2.0 MiB for block index database\r\n2023-05-02T18:31:53Z * Using 8.0 MiB for chain state database\r\n2023-05-02T18:31:53Z * Using 40.0 MiB for in-memory UTXO set (plus up to 47.7 MiB of unused mempool space)\r\n2023-05-02T18:31:53Z init message: Loading block index…\r\n2023-05-02T18:31:53Z Assuming ancestors of block 00000000000000000009c97098b5295f7e5f183ac811fb5d1534040adb93cabd have valid signatures.\r\n2023-05-02T18:31:53Z Setting nMinimumChainWork=00000000000000000000000000000000000000003404ba0801921119f903495e\r\n2023-05-02T18:31:53Z Prune configured to target 550 MiB on disk for block and undo files.\r\n2023-05-02T18:31:53Z Switching active chainstate to Chainstate [ibd] @ height -1 (null)\r\n2023-05-02T18:31:53Z Opening LevelDB in /home/***/.bitcoin/blocks/index\r\n2023-05-02T18:31:53Z Opened LevelDB successfully\r\n2023-05-02T18:31:53Z Using obfuscation key for /home/***/.bitcoin/blocks/index: 0000000000000000\r\n2023-05-02T18:31:56Z LoadBlockIndexDB: last block file = 3574\r\n2023-05-02T18:31:56Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=70, size=115412032, heights=787490...787975, time=2023-04-29...2023-05-02)\r\n2023-05-02T18:31:56Z Checking all blk files are present...\r\n2023-05-02T18:31:56Z LoadBlockIndexDB(): Block files have previously been pruned\r\n2023-05-02T18:31:57Z Opening LevelDB in /home/***/.bitcoin/chainstate\r\n2023-05-02T18:31:57Z Opened LevelDB successfully\r\n2023-05-02T18:31:57Z Using obfuscation key for /home/***/.bitcoin/chainstate: 7b252df66097f97f\r\n2023-05-02T18:31:57Z Loaded best chain: hashBestChain=00000000000000000003b325732590843673742d287f78699f018e4be50f72b6 height=787849 date=2023-05-01T18:42:36Z progress=0.999698\r\n2023-05-02T18:31:57Z init message: Verifying blocks…\r\n2023-05-02T18:31:57Z Verifying last 6 blocks at level 3\r\n2023-05-02T18:31:57Z [0%]...[16%]...[33%]...[50%]...[66%]...[83%]...[99%]...[DONE].\r\n2023-05-02T18:32:21Z No coin database inconsistencies in last 6 blocks (22146 transactions)\r\n2023-05-02T18:32:21Z  block index           27842ms\r\n2023-05-02T18:32:21Z Opening LevelDB in /home/***/.bitcoin/indexes/coinstats/db\r\n2023-05-02T18:32:21Z Opened LevelDB successfully\r\n2023-05-02T18:32:21Z Using obfuscation key for /home/***/.bitcoin/indexes/coinstats/db: 0000000000000000\r\n2023-05-02T18:32:21Z ERROR: CustomInit: Cannot read current coinstatsindex state; index may be corrupted\r\n2023-05-02T18:32:21Z Shutdown: In progress...\r\n2023-05-02T18:32:21Z scheduler thread exit\r\n2023-05-02T18:32:21Z Shutdown: done\r\n```\r\n</details>\r\n\n\n### Expected behaviour\n\nCoinstats index should not be corrupted.\n\n### Steps to reproduce\n\nWith coinstats index turned on run `invalidateblock` and while that's running run `stop`.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\nv24.0.1\n\n### Operating system and version\n\nDebian GNU/Linux 11 (bullseye)\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "vostrnad",
      "id": 43024885,
      "node_id": "MDQ6VXNlcjQzMDI0ODg1",
      "avatar_url": "https://avatars.githubusercontent.com/u/43024885?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vostrnad",
      "html_url": "https://github.com/vostrnad",
      "followers_url": "https://api.github.com/users/vostrnad/followers",
      "following_url": "https://api.github.com/users/vostrnad/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/vostrnad/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/vostrnad/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/vostrnad/subscriptions",
      "organizations_url": "https://api.github.com/users/vostrnad/orgs",
      "repos_url": "https://api.github.com/users/vostrnad/repos",
      "events_url": "https://api.github.com/users/vostrnad/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/vostrnad/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 5,
    "closed_at": "2023-05-17T17:27:57Z",
    "created_at": "2023-05-02T19:05:25Z",
    "updated_at": "2023-05-17T17:27:57Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1532965770,
      "node_id": "IC_kwDOABII585bXzOK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532965770",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:43:01Z",
      "updated_at": "2023-05-03T12:45:35Z",
      "author_association": "MEMBER",
      "body": "Thanks for this report @vostrnad.\r\n\r\nI have reproduced this issue sucessfully and am looking into the root cause.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```log\r\n2023-05-03T12:40:07Z InvalidChainFound: invalid block=0000002217824449bf6b7d8f9bc3cdb3407927712114a462376a991fea9f74af  height=141000  log2_work=40.653563  date=2023-05-01T05:44:57Z\r\n2023-05-03T12:40:07Z InvalidChainFound:  current best=0000010052eca20e8afb2fd62cb0b07ef3cbbaffe43068c825f2e09f80b2ab35  height=140999  log2_work=40.653552  date=2023-05-01T05:37:27Z\r\n2023-05-03T12:40:08Z tor: Thread interrupt\r\n2023-05-03T12:40:08Z Shutdown: In progress...\r\n2023-05-03T12:40:08Z opencon thread exit\r\n2023-05-03T12:40:08Z torcontrol thread exit\r\n2023-05-03T12:40:08Z addcon thread exit\r\n2023-05-03T12:40:08Z net thread exit\r\n2023-05-03T12:40:08Z msghand thread exit\r\n2023-05-03T12:40:08Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat started\r\n2023-05-03T12:40:08Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat completed (0.01s)\r\n2023-05-03T12:40:08Z scheduler thread exit\r\n2023-05-03T12:40:08Z Writing 0 unbroadcast transactions to disk.\r\n2023-05-03T12:40:08Z Dumped mempool: 9.263e-06s to copy, 0.00437868s to dump\r\n2023-05-03T12:40:08Z Shutdown: done\r\n\r\n\r\n\r\n\r\n\r\n2023-05-03T12:40:23Z Bitcoin Core version v24.0.1 (release build)\r\n2023-05-03T12:40:23Z Signet derived magic (message start): 0a03cf40\r\n2023-05-03T12:40:23Z Using the 'x86_shani(1way,2way)' SHA256 implementation\r\n2023-05-03T12:40:23Z Using RdSeed as an additional entropy source\r\n2023-05-03T12:40:23Z Using RdRand as an additional entropy source\r\n2023-05-03T12:40:23Z Default data directory /home/will/.bitcoin\r\n2023-05-03T12:40:23Z Using data directory /home/will/.bitcoin/signet\r\n2023-05-03T12:40:23Z Config file: /home/will/.bitcoin/bitcoin.conf\r\n2023-05-03T12:40:23Z Config file arg: [signet] blocksdir=\"/media/will/crucial1/bitcoin\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] coinstatsindex=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] daemon=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] fallbackfee=\"0.00001000\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] listen=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] port=\"38333\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] rpcpassword=****\r\n2023-05-03T12:40:23Z Config file arg: [signet] rpcuser=****\r\n2023-05-03T12:40:23Z Config file arg: [signet] server=\"1\"\r\n2023-05-03T12:40:23Z Command-line arg: signet=\"\"\r\n2023-05-03T12:40:23Z Using at most 125 automatic connections (1024 file descriptors available)\r\n2023-05-03T12:40:23Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2023-05-03T12:40:23Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2023-05-03T12:40:23Z Script verification uses 15 additional threads\r\n2023-05-03T12:40:23Z scheduler thread start\r\n2023-05-03T12:40:23Z [http] creating work queue of depth 16\r\n2023-05-03T12:40:23Z Config options rpcuser and rpcpassword will soon be deprecated. Locally-run instances may remove rpcuser to use cookie-based auth, or may be replaced with rpcauth. Please see share/rpcauth for rpcauth auth generation.\r\n2023-05-03T12:40:23Z [http] starting 4 worker threads\r\n2023-05-03T12:40:23Z Using wallet directory /home/will/.bitcoin/signet/wallets\r\n2023-05-03T12:40:23Z init message: Verifying wallet(s)…\r\n2023-05-03T12:40:23Z Using /16 prefix for IP bucketing\r\n2023-05-03T12:40:23Z init message: Loading P2P addresses…\r\n2023-05-03T12:40:23Z Loaded 2022 addresses from peers.dat  20ms\r\n2023-05-03T12:40:23Z init message: Loading banlist…\r\n2023-05-03T12:40:23Z SetNetworkActive: true\r\n2023-05-03T12:40:23Z Cache configuration:\r\n2023-05-03T12:40:23Z * Using 2.0 MiB for block index database\r\n2023-05-03T12:40:23Z * Using 8.0 MiB for chain state database\r\n2023-05-03T12:40:23Z * Using 440.0 MiB for in-memory UTXO set (plus up to 286.1 MiB of unused mempool space)\r\n2023-05-03T12:40:23Z init message: Loading block index…\r\n2023-05-03T12:40:23Z Assuming ancestors of block 000000d1a0e224fa4679d2fb2187ba55431c284fa1b74cbc8cfda866fd4d2c09 have valid signatures.\r\n2023-05-03T12:40:23Z Setting nMinimumChainWork=000000000000000000000000000000000000000000000000000001291fc22898\r\n2023-05-03T12:40:23Z Switching active chainstate to Chainstate [ibd] @ height -1 (null)\r\n2023-05-03T12:40:23Z Opening LevelDB in /home/will/.bitcoin/signet/blocks/index\r\n2023-05-03T12:40:23Z Opened LevelDB successfully\r\n2023-05-03T12:40:23Z Using obfuscation key for /home/will/.bitcoin/signet/blocks/index: 0000000000000000\r\n2023-05-03T12:40:24Z LoadBlockIndexDB: last block file = 4\r\n2023-05-03T12:40:24Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=32218, size=117995451, heights=109096...141321, time=2022-09-22...2023-05-03)\r\n2023-05-03T12:40:24Z Checking all blk files are present...\r\n2023-05-03T12:40:25Z Opening LevelDB in /home/will/.bitcoin/signet/chainstate\r\n2023-05-03T12:40:25Z Opened LevelDB successfully\r\n2023-05-03T12:40:25Z Using obfuscation key for /home/will/.bitcoin/signet/chainstate: 279a4349025ab109\r\n2023-05-03T12:40:25Z Loaded best chain: hashBestChain=0000010052eca20e8afb2fd62cb0b07ef3cbbaffe43068c825f2e09f80b2ab35 height=140999 date=2023-05-01T05:37:27Z progress=0.997935\r\n2023-05-03T12:40:25Z init message: Verifying blocks…\r\n2023-05-03T12:40:25Z Verifying last 6 blocks at level 3\r\n2023-05-03T12:40:25Z [0%]...[16%]...[33%]...[50%]...[66%]...[83%]...[99%]...[DONE].\r\n2023-05-03T12:40:25Z No coin database inconsistencies in last 6 blocks (9 transactions)\r\n2023-05-03T12:40:25Z  block index            2022ms\r\n2023-05-03T12:40:25Z Opening LevelDB in /home/will/.bitcoin/signet/indexes/coinstats/db\r\n2023-05-03T12:40:25Z Opened LevelDB successfully\r\n2023-05-03T12:40:25Z Using obfuscation key for /home/will/.bitcoin/signet/indexes/coinstats/db: 0000000000000000\r\n2023-05-03T12:40:25Z ERROR: CustomInit: Cannot read current coinstatsindex state; index may be corrupted\r\n2023-05-03T12:40:25Z Shutdown: In progress...\r\n2023-05-03T12:40:25Z scheduler thread exit\r\n2023-05-03T12:40:25Z Shutdown: done\r\n```\r\n\r\n</details>\r\n\r\nedit: I think this even occurred on my node after the `invalidateblock` command had finished",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1532965770",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558"
    },
    {
      "event": "mentioned",
      "id": 9155099347,
      "node_id": "MEE_lADOABII585k6GPKzwAAAAIhr7rT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9155099347",
      "actor": {
        "login": "vostrnad",
        "id": 43024885,
        "node_id": "MDQ6VXNlcjQzMDI0ODg1",
        "avatar_url": "https://avatars.githubusercontent.com/u/43024885?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vostrnad",
        "html_url": "https://github.com/vostrnad",
        "followers_url": "https://api.github.com/users/vostrnad/followers",
        "following_url": "https://api.github.com/users/vostrnad/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vostrnad/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vostrnad/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vostrnad/subscriptions",
        "organizations_url": "https://api.github.com/users/vostrnad/orgs",
        "repos_url": "https://api.github.com/users/vostrnad/repos",
        "events_url": "https://api.github.com/users/vostrnad/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vostrnad/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:43:01Z"
    },
    {
      "event": "subscribed",
      "id": 9155099363,
      "node_id": "SE_lADOABII585k6GPKzwAAAAIhr7rj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9155099363",
      "actor": {
        "login": "vostrnad",
        "id": 43024885,
        "node_id": "MDQ6VXNlcjQzMDI0ODg1",
        "avatar_url": "https://avatars.githubusercontent.com/u/43024885?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vostrnad",
        "html_url": "https://github.com/vostrnad",
        "followers_url": "https://api.github.com/users/vostrnad/followers",
        "following_url": "https://api.github.com/users/vostrnad/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vostrnad/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vostrnad/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vostrnad/subscriptions",
        "organizations_url": "https://api.github.com/users/vostrnad/orgs",
        "repos_url": "https://api.github.com/users/vostrnad/repos",
        "events_url": "https://api.github.com/users/vostrnad/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vostrnad/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:43:01Z"
    },
    {
      "event": "commented",
      "id": 1532968619,
      "node_id": "IC_kwDOABII585bXz6r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532968619",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:45:15Z",
      "updated_at": "2023-05-03T12:45:15Z",
      "author_association": "MEMBER",
      "body": "cc @mzumsande ",
      "user": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1532968619",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558"
    },
    {
      "event": "mentioned",
      "id": 9155119900,
      "node_id": "MEE_lADOABII585k6GPKzwAAAAIhsAsc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9155119900",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:45:15Z"
    },
    {
      "event": "subscribed",
      "id": 9155119908,
      "node_id": "SE_lADOABII585k6GPKzwAAAAIhsAsk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9155119908",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T12:45:15Z"
    },
    {
      "event": "commented",
      "id": 1533520155,
      "node_id": "IC_kwDOABII585bZ6kb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533520155",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T18:36:15Z",
      "updated_at": "2023-05-03T18:36:15Z",
      "author_association": "MEMBER",
      "body": "I haven't looked into the root cause yet, but some quick tests seem to suggest that this could be fixed by #25193 - at least I could reproduce it with master, but not with that branch.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1533520155",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558"
    },
    {
      "event": "commented",
      "id": 1533742759,
      "node_id": "IC_kwDOABII585baw6n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533742759",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-03T21:00:49Z",
      "updated_at": "2023-05-03T21:28:30Z",
      "author_association": "MEMBER",
      "body": "A more detailed explanation: The indexes have a `Rewind()` function to reverse the effects of blocks (which calls `CustomRewind` for the coinstats index). However, once the index is synced, `Rewind` will only be invoked through `BlockConnected()` validationinterface signals, not when blocks are disconnected. So when `invalidateblock` is called, the state of the coinstatsindex will still point to the old block (unless a new block is connected before the node is stopped).\r\n\r\nAfter restarting the node, the current logic in master sets the best block to the fork in the chain based on a locator - however, it doesn't rewind the state of the coinstatsindex as would be necessary to prevent corruption. With commit 5fafeec47185cd3fd0c079fcdc77f037971e8188 of #25193, we'd keep on loading the previous best block, and `ThreadSync` would then do the rewinding to the invalidated block - that way, corruption shouldn't be possible.\r\n\r\nAn additional change that would make sense to me is to let the indexes react to `BlockDisconnected` signals (by rewinding right when they happen). That would rewind the index immediately, and not only after the next startup, and seems useful in general. Of course it wouldn't help when the node is stopped midway through invalidateblock.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1533742759",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558"
    },
    {
      "event": "commented",
      "id": 1534309409,
      "node_id": "IC_kwDOABII585bc7Qh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1534309409",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-04T08:38:27Z",
      "updated_at": "2023-05-04T08:38:27Z",
      "author_association": "MEMBER",
      "body": "Thanks @mzumsande, I can confirm that that patch does fix the described issue for me too.",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1534309409",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27558"
    },
    {
      "event": "mentioned",
      "id": 9164486750,
      "node_id": "MEE_lADOABII585k6GPKzwAAAAIiPvhe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9164486750",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-04T08:38:28Z"
    },
    {
      "event": "subscribed",
      "id": 9164486773,
      "node_id": "SE_lADOABII585k6GPKzwAAAAIiPvh1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9164486773",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-04T08:38:28Z"
    },
    {
      "event": "connected",
      "id": 9164917943,
      "node_id": "COE_lADOABII585k6GPKzwAAAAIiRYy3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9164917943",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-04T09:13:18Z"
    },
    {
      "event": "closed",
      "id": 9272080451,
      "node_id": "CE_lADOABII585k6GPKzwAAAAIoqLhD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9272080451",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-17T17:27:57Z"
    }
  ]
}