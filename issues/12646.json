{
  "type": "issue",
  "issue": {
    "id": 303520583,
    "node_id": "MDU6SXNzdWUzMDM1MjA1ODM=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/12646",
    "number": 12646,
    "state": "closed",
    "state_reason": "completed",
    "title": "Assertion failure during rescan",
    "body": "I'm getting this when rescanning an old wallet:\r\n\r\n![image](https://user-images.githubusercontent.com/12032350/37155425-4a9219e2-22e3-11e8-8c7b-b5c8219c4f9f.png)\r\n\r\nI clicked ignore and rescanning continued. Eventually the GUI opened. When trying `dumpwallet` a \"runaway exception\" caused Bitcoin Core to exit. This is v16.0.\r\n\r\nHow would we go about addressing this? I cannot send the wallet file since it contains funds.\r\n\r\n`debug.log`:\r\n\r\n2018-03-08 13:55:01 Still rescanning. At block 459430. Progress=0.677853\r\n2018-03-08 13:55:58 AddToWalletIfInvolvingMe: Detected a used keypool key, mark all keypool key up to this key as used\r\n2018-03-08 14:12:33 AddToWalletIfInvolvingMe: Topping up keypool failed (locked wallet)\r\n2018-03-08 14:12:33 AddToWallet 2ed2b7d31cffc4af33a0cc44cbaed4b669dcd4849200456e81ce8d0350b20a61  new\r\n2018-03-08 14:12:33 Potential stale tip detected, will try using extra outbound peer (last tip update: 9016 seconds ago)\r\n2018-03-08 14:12:33 Still rescanning. At block 460132. Progress=0.681957\r\n2018-03-08 14:13:19 Potential stale tip detected, will try using extra outbound peer (last tip update: 9834 seconds ago)\r\n2018-03-08 14:13:33 Still rescanning. At block 461005. Progress=0.687196\r\n...\r\n2018-03-08 15:14:48  rescan             13546939ms\r\n2018-03-08 15:14:48 setKeyPool.size() = 98\r\n2018-03-08 15:14:48 mapWallet.size() = 65\r\n2018-03-08 15:14:48 mapAddressBook.size() = 4\r\n2018-03-08 15:14:48 mapBlockIndex.size() = 512418\r\n2018-03-08 15:14:48 nBestHeight = 512304\r\n2018-03-08 15:14:48 torcontrol thread start\r\n2018-03-08 15:14:48 init message: Loading P2P addresses...\r\n2018-03-08 15:14:49 Loaded 64280 addresses from peers.dat  796ms\r\n2018-03-08 15:14:49 init message: Loading banlist...\r\n2018-03-08 15:14:49 init message: Starting network threads...\r\n2018-03-08 15:14:49 net thread start\r\n2018-03-08 15:14:49 addcon thread start\r\n2018-03-08 15:14:49 dnsseed thread start\r\n2018-03-08 15:14:49 init message: Done loading\r\n2018-03-08 15:14:49 opencon thread start\r\n2018-03-08 15:14:49 msghand thread start\r\n2018-03-08 15:14:49 GUI: Platform customization: \"windows\"\r\n2018-03-08 15:14:49 GUI: PaymentServer::LoadRootCAs: Loaded  31  root certificates\r\n2018-03-08 15:15:00 Loading addresses from DNS seeds (could take a while)\r\n2018-03-08 15:15:00 0 addresses found from DNS seeds\r\n2018-03-08 15:15:00 dnsseed thread exit\r\n2018-03-08 15:15:20 Imported mempool transactions from disk: 290 succeeded, 0 failed, 0 expired, 0 already there\r\n2018-03-08 15:17:39 Potential stale tip detected, will try using extra outbound peer (last tip update: 13694 seconds ago)\r\n2018-03-08 15:23:28 tor: Thread interrupt\r\n2018-03-08 15:23:28 net thread exit\r\n2018-03-08 15:23:28 addcon thread exit\r\n2018-03-08 15:23:28 Shutdown: In progress...\r\n2018-03-08 15:23:28 torcontrol thread exit\r\n2018-03-08 15:23:28 msghand thread exit\r\n2018-03-08 15:23:31 opencon thread exit\r\n2018-03-08 15:23:32 scheduler thread interrupt\r\n2018-03-08 15:23:32 Dumped mempool: 0s to copy, 0.078s to dump\r\n2018-03-08 15:23:32 \r\n\r\n************************\r\nEXCEPTION: St13runtime_error       \r\nCDB: Error -30974, can't open database wallet.dat       \r\nC:\\Program Files\\Bitcoin\\bitcoin-qt.exe in Runaway exception       \r\n\r\n2018-03-08 15:23:37 CDBEnv::EnvShutdown: Error -30974 shutting down database environment: DB_RUNRECOVERY: Fatal error, run database recovery\r\n2018-03-08 15:24:21 \r\n\r\n\r\n",
    "user": {
      "login": "GSPP",
      "id": 12032350,
      "node_id": "MDQ6VXNlcjEyMDMyMzUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/GSPP",
      "html_url": "https://github.com/GSPP",
      "followers_url": "https://api.github.com/users/GSPP/followers",
      "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
      "organizations_url": "https://api.github.com/users/GSPP/orgs",
      "repos_url": "https://api.github.com/users/GSPP/repos",
      "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/GSPP/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 6,
    "closed_at": "2020-04-27T00:46:53Z",
    "created_at": "2018-03-08T15:28:10Z",
    "updated_at": "2022-02-15T10:43:43Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 1511392181,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDE1MTEzOTIxODE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1511392181",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-03-08T15:36:38Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "milestoned",
      "id": 1511393252,
      "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDE1MTEzOTMyNTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1511393252",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-03-08T15:37:10Z",
      "milestone": {
        "title": "0.16.1"
      }
    },
    {
      "event": "commented",
      "id": 371713113,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM3MTcxMzExMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371713113",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-03-09T04:53:17Z",
      "updated_at": "2018-03-09T04:53:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "Is this reproducible? Does it happens at the same level of progress if you try to rescan again?",
      "user": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-371713113",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "commented",
      "id": 372021787,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM3MjAyMTc4Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372021787",
      "actor": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-03-10T11:07:44Z",
      "updated_at": "2018-03-10T11:07:44Z",
      "author_association": "NONE",
      "body": "Yes it's reproducible and happens at the same level of progress.",
      "user": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-372021787",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "commented",
      "id": 378048488,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM3ODA0ODQ4OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378048488",
      "actor": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-04-02T21:13:25Z",
      "updated_at": "2018-04-02T21:13:25Z",
      "author_association": "MEMBER",
      "body": "This is an assert in `MarkReserveKeysAsUsed()`, introduced in https://github.com/bitcoin/bitcoin/commit/095142d1f93f39ad2b88dbe8d40140223a1b3900 (#11022)",
      "user": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-378048488",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "demilestoned",
      "id": 1632759382,
      "node_id": "MDE3OkRlbWlsZXN0b25lZEV2ZW50MTYzMjc1OTM4Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1632759382",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-17T19:18:57Z",
      "milestone": {
        "title": "0.16.1"
      }
    },
    {
      "event": "milestoned",
      "id": 1632759384,
      "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDE2MzI3NTkzODQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1632759384",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-17T19:18:57Z",
      "milestone": {
        "title": "0.16.2"
      }
    },
    {
      "event": "commented",
      "id": 391876717,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTg3NjcxNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/391876717",
      "actor": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-24T21:51:03Z",
      "updated_at": "2018-05-24T21:51:03Z",
      "author_association": "MEMBER",
      "body": "I've dug into this a bit, but I haven't been able to identify the bug yet.\r\n\r\nThe first assert is in `MarkReserveKeysAsUsed()`. This is called by `AddToWalletIfInvolvingMe()` if a transaction is seen which involves a keypool key in `m_pool_key_to_index`. `MarkReserveKeysAsUsed()` asserts that the keypool entry is either in `setInternalKeyPool` or `setExternalKeyPool`. This assertion failure indicates that the keypool is in an inconsistent state where a keypool entry isn't in the external keypool set or the internal keypool set.\r\n\r\nI've gone through all the places where `m_pool_key_to_index`, `setInternalKeyPool` and `setExternalKeyPool` are updated, and I can't see anywhere obvious that adds to `m_pool_key_to_index` without inserting into `set{In,Ex}ternalKeyPool` (or conversely deletes from `set{In,Ex}ternalKeyPool` without deleting from `m_pool_key_to_index`), except if `ReserveKeyFromKeyPool()` threw one of the `std::runtime_error`s, caught and continued:\r\n\r\n```\r\n        auto it = setKeyPool.begin();\r\n        nIndex = *it;\r\n        setKeyPool.erase(it);\r\n        if (!walletdb.ReadPool(nIndex, keypool)) {\r\n            throw std::runtime_error(std::string(__func__) + \": read failed\");\r\n        }\r\n        if (!HaveKey(keypool.vchPubKey.GetID())) {\r\n            throw std::runtime_error(std::string(__func__) + \": unknown key in key pool\");\r\n        }\r\n        if (keypool.fInternal != fReturningInternal) {\r\n            throw std::runtime_error(std::string(__func__) + \": keypool entry misclassified\");\r\n        }\r\n\r\n        assert(keypool.vchPubKey.IsValid());\r\n        m_pool_key_to_index.erase(keypool.vchPubKey.GetID());\r\n```\r\n\r\nOnce the assert is hit in `MarkReserveKeysAsUsed()` and you continued, I wouldn't be surprised if the wallet's internal data was corrupted further.\r\n\r\n@GSPP - a few questions:\r\n\r\n- have you managed to restore this wallet yet? I suspect trying on V0.15.1 will allow you to `dumpwallet`\r\n- you say this is an 'old' wallet. I presume that's before from V0.15? (ie before the HD wallet split which split the keypool into internal/external)\r\n- How large is your debug.log. Are you able to upload the full file somewhere?",
      "user": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-391876717",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "mentioned",
      "id": 1645401710,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MTY0NTQwMTcxMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1645401710",
      "actor": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-24T21:51:03Z"
    },
    {
      "event": "subscribed",
      "id": 1645401711,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDE2NDU0MDE3MTE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1645401711",
      "actor": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-24T21:51:03Z"
    },
    {
      "event": "commented",
      "id": 391985779,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTk4NTc3OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/391985779",
      "actor": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-25T08:47:15Z",
      "updated_at": "2018-05-25T08:47:15Z",
      "author_association": "NONE",
      "body": "I'd be willing to send the wallet to someone on the team. It's not a very important wallet. When you're done working on it I'd swipe the funds if there are any.",
      "user": {
        "login": "GSPP",
        "id": 12032350,
        "node_id": "MDQ6VXNlcjEyMDMyMzUw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12032350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GSPP",
        "html_url": "https://github.com/GSPP",
        "followers_url": "https://api.github.com/users/GSPP/followers",
        "following_url": "https://api.github.com/users/GSPP/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GSPP/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GSPP/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GSPP/subscriptions",
        "organizations_url": "https://api.github.com/users/GSPP/orgs",
        "repos_url": "https://api.github.com/users/GSPP/repos",
        "events_url": "https://api.github.com/users/GSPP/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GSPP/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-391985779",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "commented",
      "id": 392092906,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5MjA5MjkwNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/392092906",
      "actor": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-25T15:23:55Z",
      "updated_at": "2018-05-25T15:43:30Z",
      "author_association": "MEMBER",
      "body": "~I'm happy to take a look at the wallet.dat file, with the understanding that I can't be responsible for any funds in there. I won't take them, but I can't be responsible for them :)~\r\n\r\nEDIT: On second thoughts, I think this isn't a great idea. Please don't send the wallet file to me!\r\n\r\nInstead, I recommend you try restoring the wallet in v0.15 and sweep the funds to a new address.",
      "user": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-392092906",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/12646"
    },
    {
      "event": "demilestoned",
      "id": 1651884918,
      "node_id": "MDE3OkRlbWlsZXN0b25lZEV2ZW50MTY1MTg4NDkxOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1651884918",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-29T18:55:39Z",
      "milestone": {
        "title": "0.16.2"
      }
    },
    {
      "event": "milestoned",
      "id": 1651884919,
      "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDE2NTE4ODQ5MTk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1651884919",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-05-29T18:55:39Z",
      "milestone": {
        "title": "0.17.0"
      }
    },
    {
      "event": "demilestoned",
      "id": 1758972632,
      "node_id": "MDE3OkRlbWlsZXN0b25lZEV2ZW50MTc1ODk3MjYzMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1758972632",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-07-29T17:49:12Z",
      "milestone": {
        "title": "0.17.0"
      }
    },
    {
      "event": "labeled",
      "id": 1758972652,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDE3NTg5NzI2NTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1758972652",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-07-29T17:49:19Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "closed",
      "id": 3273572552,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzI3MzU3MjU1Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3273572552",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-27T00:46:54Z"
    },
    {
      "event": "locked",
      "id": 6073875473,
      "node_id": "LOE_lADOABII584SF1tHzwAAAAFqB_wR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6073875473",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T10:43:43Z",
      "lock_reason": "resolved"
    }
  ]
}