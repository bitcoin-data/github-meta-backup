{
  "type": "issue",
  "issue": {
    "id": 210173572,
    "node_id": "MDU6SXNzdWUyMTAxNzM1NzI=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/9854",
    "number": 9854,
    "state": "closed",
    "state_reason": "completed",
    "title": "Bitcoind 0.14.0rc1: OOM -> block marked invalid",
    "body": "### Describe the issue\r\n\r\nMy bitcoind v0.14.0rc1 running on a Raspberry Pi 3, OOMed while processing a block, but didn't shutdown. Instead, it simply marked the block as invalid, and continued running.\r\n\r\n### What version of bitcoin-core are you using?\r\n```\r\n2017-02-22 17:08:06 Bitcoin version v0.14.0.0-7d75a5a\r\n```\r\n\r\n### Any extra information that might be useful in the debugging process.\r\n\r\nbitcoin.conf:\r\n```\r\ndbcache=500\r\nblocksonly=1\r\ndebug=bench\r\n```\r\n\r\ndebug.log:\r\n```\r\n017-02-24 10:39:06 UpdateTip: new best=00000000000000002c54efc91a9c88f030ac8be8b07ccce1fd743769fcee0d7b height=316694 version=0x00000002 log2_work=80.285579 tx=44994328 date='2014-08-20 21:49:12' progress=0.226366 cache=494.0MiB(428034tx)\r\n2017-02-24 10:39:06   - Connect postprocess: 1.04ms [364.74s]\r\n2017-02-24 10:39:06 - Connect block: 28.42ms [31745.07s]\r\n2017-02-24 10:39:06 Pre-allocating up to position 0x8000000 in blk00167.dat\r\n2017-02-24 10:39:08 Prune: UnlinkPrunedFiles deleted blk/rev (00161)\r\n2017-02-24 10:39:15\r\n\r\n************************\r\nEXCEPTION: St9bad_alloc\r\nstd::bad_alloc\r\nbitcoin in ProcessMessages()\r\n\r\n2017-02-24 10:39:15 ProcessMessages(block, 300905 bytes) FAILED peer=345\r\n2017-02-24 10:39:40   - Load block from disk: 0.01ms [3425.64s]\r\n2017-02-24 10:39:40     - Sanity checks: 0.27ms [554.49s]\r\n2017-02-24 10:39:40     - Fork checks: 0.45ms [1527.74s]\r\n2017-02-24 10:39:40 ERROR: ConnectBlock(): inputs missing/spent\r\n2017-02-24 10:39:40 Misbehaving: 92.27.214.6:8333 peer=377 (0 -> 100) BAN THRESHOLD EXCEEDED\r\n2017-02-24 10:39:40 InvalidChainFound: invalid block=0000000000000000105e43d3721802e8799ae33a2f940123a1f500de53fc0a53  height=316695 log2_work=80.285679  date=2014-08-20 22:31:56\r\n2017-02-24 10:39:40 InvalidChainFound:  current best=00000000000000002c54efc91a9c88f030ac8be8b07ccce1fd743769fcee0d7b  height=316694 log2_work=80.285579  date=2014-08-20 21:49:12\r\n2017-02-24 10:39:40 ERROR: ConnectTip(): ConnectBlock 0000000000000000105e43d3721802e8799ae33a2f940123a1f500de53fc0a53 failed\r\n2017-02-24 10:39:40 InvalidChainFound: invalid block=0000000000000000105e43d3721802e8799ae33a2f940123a1f500de53fc0a53  height=316695  log2_work=80.285679  date=2014-08-20 22:31:56\r\n2017-02-24 10:39:40 InvalidChainFound:  current best=00000000000000002c54efc91a9c88f030ac8be8b07ccce1fd743769fcee0d7b  height=316694 log2_work=80.285579  date=2014-08-20 21:49:12\r\n2017-02-24 10:39:40 connect() to [2a02:810c:83c0:20c0:eb1f:a96b:1b81:813a]:8333 failed: Network is unreachable (101)\r\n```\r\n",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/21",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/21",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/21/labels",
      "id": 1823680,
      "node_id": "MDk6TWlsZXN0b25lMTgyMzY4MA==",
      "number": 21,
      "state": "closed",
      "title": "0.14.0",
      "description": "",
      "creator": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 0,
      "closed_issues": 156,
      "created_at": "2016-06-13T14:18:51Z",
      "updated_at": "2017-03-08T16:39:44Z",
      "closed_at": "2017-03-08T16:39:44Z"
    },
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 3,
    "closed_at": "2017-02-28T11:35:06Z",
    "created_at": "2017-02-24T22:18:54Z",
    "updated_at": "2021-09-08T12:35:36Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 282432193,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI4MjQzMjE5Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/282432193",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-24T23:20:14Z",
      "updated_at": "2017-02-25T00:01:58Z",
      "author_association": "MEMBER",
      "body": "Here's one approach: skip dealing with bad_alloc and terminate immediately: https://github.com/theuni/bitcoin/commit/28afe574567ba838d46959047282460dbab39b91\r\n\r\nEdit: I'm uneasy with all approaches that I've come up with, but bailing immediately seems like the least likely thing to cause issues. I believe in the case above, at least, this would have worked.\r\n\r\nEdit2: prevector calls malloc/realloc directly. So we'd either need to switch to new[] there, or call std::get_new_handler() directly.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9854#issuecomment-282432193",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854"
    },
    {
      "event": "labeled",
      "id": 976874513,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDk3Njg3NDUxMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/976874513",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-25T00:05:12Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "milestoned",
      "id": 976874613,
      "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDk3Njg3NDYxMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/976874613",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-25T00:05:17Z",
      "milestone": {
        "title": "0.14.0"
      }
    },
    {
      "event": "commented",
      "id": 282439090,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI4MjQzOTA5MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/282439090",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-25T00:07:05Z",
      "updated_at": "2017-02-25T00:07:05Z",
      "author_association": "MEMBER",
      "body": "One possible way to explain this (from IRC):\r\n\r\n\"10:39:08 Prune:\" is the prune called by AcceptBlock's FlushStateToDisk call (seems obvious given the Pre-allocating blk just above)....now, that flush call hit fDoFullFlush triggering a pcoinsTip->Flush(). OK, so now in CCoinsViewDB::BatchWrite we iterate over the entries in mapCoins, allocating memory for each one in the leveldb batch, erasing *AS WE GO*...at some point it ran out of memory, throwing bad_alloc and leaving pcoinsTip in an inconsistent state, but std::bad_alloc is not an std::runtime_error so the catch at the end of FlushStateToDisk didnt catch it. OK, phew, so now we go to connect the next block and fail to connect its inputs (without allocating new disk space). I /think/ that explains your debug.log without hand waving about hardware errors",
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9854#issuecomment-282439090",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854"
    },
    {
      "event": "commented",
      "id": 283016366,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI4MzAxNjM2Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/283016366",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-28T11:35:05Z",
      "updated_at": "2017-02-28T11:35:05Z",
      "author_association": "MEMBER",
      "body": "Worked around by #9856",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9854#issuecomment-283016366",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9854"
    },
    {
      "event": "closed",
      "id": 979993363,
      "node_id": "MDExOkNsb3NlZEV2ZW50OTc5OTkzMzYz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/979993363",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-02-28T11:35:06Z"
    },
    {
      "event": "locked",
      "id": 5272019272,
      "node_id": "LOE_lADOABII584Mhv6EzwAAAAE6PKFI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5272019272",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:35:36Z",
      "lock_reason": "resolved"
    }
  ]
}