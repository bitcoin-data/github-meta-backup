{
  "type": "issue",
  "issue": {
    "id": 1297965996,
    "node_id": "I_kwDOABII585NXWOs",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/25567",
    "number": 25567,
    "state": "closed",
    "state_reason": "completed",
    "title": "test: `testmempoolaccept` accepts transactions from `fail_txs` in `feature_csv_activation.py`",
    "body": "It is more a question than an issue. In `feature_csv_activation.py`, the same transactions that fail to be inserted in a block due to [Locktime requirement not satisfied](https://github.com/bitcoin/bitcoin/blob/5abbc9afec1874efe139ccdc988b4ae122aa472c/src/script/interpreter.cpp#L588-L589) are allowed in mempool.\r\nThis test does not change default mempool policy.\r\n\r\nShouldn't it be the same behavior in both cases?\r\n\r\n```diff\r\n        # All txs with nSequence 9 should fail either due to earlier mismatch or failing the CSV check\r\n        fail_txs = all_rlt_txs(bip112txs_vary_nSequence_9_v2)\r\n        fail_txs += [tx['tx'] for tx in bip112txs_vary_OP_CSV_9_v2 if not tx['sdf']]\r\n        for tx in fail_txs:\r\n            self.send_blocks([self.create_test_block([tx])], success=False,\r\n                             reject_reason='non-mandatory-script-verify-flag (Locktime requirement not satisfied)')\r\n\r\n+           self.miniwallet.sign_tx(tx)\r\n+           # testmempoolaccept will return 'allowed': True for these transactions\r\n+           print(self.nodes[0].testmempoolaccept(rawtxs=[tx.serialize().hex()]))\r\n```",
    "user": {
      "login": "w0xlt",
      "id": 94266259,
      "node_id": "U_kgDOBZ5jkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/w0xlt",
      "html_url": "https://github.com/w0xlt",
      "followers_url": "https://api.github.com/users/w0xlt/followers",
      "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
      "organizations_url": "https://api.github.com/users/w0xlt/orgs",
      "repos_url": "https://api.github.com/users/w0xlt/repos",
      "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/w0xlt/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 2,
    "closed_at": "2022-07-09T22:08:15Z",
    "created_at": "2022-07-07T19:20:57Z",
    "updated_at": "2022-07-09T22:08:16Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1178432583,
      "node_id": "IC_kwDOABII585GPXRH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1178432583",
      "actor": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-08T01:23:22Z",
      "updated_at": "2022-07-08T01:23:22Z",
      "author_association": "MEMBER",
      "body": "The transactions used in this test are consensus-valid, but don't follow the standard policy due to their scriptSig containing more than just push-only opcodes. If you want `testmempoolaccept` to return the same reject reason, you have to allow non-standard transactions via bitcoind parameter `-acceptnonstdtxn=1` and remove the `sign_tx(tx)` call (it modified the tx, which doesn't make any sense?):\r\n\r\n```diff\r\ndiff --git a/test/functional/feature_csv_activation.py b/test/functional/feature_csv_activation.py\r\nindex bff95c3b94..3cbb1df87d 100755\r\n--- a/test/functional/feature_csv_activation.py\r\n+++ b/test/functional/feature_csv_activation.py\r\n@@ -99,6 +99,7 @@ class BIP68_112_113Test(BitcoinTestFramework):\r\n             '-whitelist=noban@127.0.0.1',\r\n             f'-testactivationheight=csv@{CSV_ACTIVATION_HEIGHT}',\r\n             '-par=1',  # Use only one script thread to get the exact reject reason for testing\r\n+            '-acceptnonstdtxn=1',\r\n         ]]\r\n         self.supports_cli = False\r\n\r\n@@ -449,6 +450,7 @@ class BIP68_112_113Test(BitcoinTestFramework):\r\n         for tx in fail_txs:\r\n             self.send_blocks([self.create_test_block([tx])], success=False,\r\n                              reject_reason='non-mandatory-script-verify-flag (Locktime requirement not satisfied)')\r\n+            print(self.nodes[0].testmempoolaccept(rawtxs=[tx.serialize().hex()]))\r\n\r\n         # If SEQUENCE_LOCKTIME_DISABLE_FLAG is set in nSequence, tx should fail\r\n         fail_txs = [tx['tx'] for tx in bip112txs_vary_nSequence_v2 if tx['sdf']]\r\n```\r\n\r\nRunning this leads to:\r\n```\r\n$ ./test/functional/feature_csv_activation.py\r\n.....\r\n2022-07-08T01:21:38.906000Z TestFramework (INFO): Test version 2 txs\r\n[{'txid': 'c160925d142ea9d1fde2f53ea755ea6e2788e35ee8d1710bd266c8df0f3affd5', 'wtxid': 'c160925d142ea9d1fde2f53ea755ea6e2788e35ee8d1710bd266c8df0f3affd5', 'allo\r\nwed': False, 'reject-reason': 'non-mandatory-script-verify-flag (Locktime requirement not satisfied)'}]\r\n[{'txid': 'fff76e4287e73f3d4f6a711c75baf2d18a207677d2cc79a0f56857cc0a1b74fc', 'wtxid': 'fff76e4287e73f3d4f6a711c75baf2d18a207677d2cc79a0f56857cc0a1b74fc', 'allo\r\nwed': False, 'reject-reason': 'non-mandatory-script-verify-flag (Locktime requirement not satisfied)'}]\r\n[{'txid': 'cba3a92d10bf0357bcb7e090cb3f00a8aeaf6eed80b002b0ab7562c00cf87aa3', 'wtxid': 'cba3a92d10bf0357bcb7e090cb3f00a8aeaf6eed80b002b0ab7562c00cf87aa3', 'allo\r\nwed': False, 'reject-reason': 'non-mandatory-script-verify-flag (Locktime requirement not satisfied)'}]\r\n.....\r\n```",
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/25567#issuecomment-1178432583",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567"
    },
    {
      "event": "commented",
      "id": 1179613569,
      "node_id": "IC_kwDOABII585GT3mB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1179613569",
      "actor": {
        "login": "w0xlt",
        "id": 94266259,
        "node_id": "U_kgDOBZ5jkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/w0xlt",
        "html_url": "https://github.com/w0xlt",
        "followers_url": "https://api.github.com/users/w0xlt/followers",
        "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
        "organizations_url": "https://api.github.com/users/w0xlt/orgs",
        "repos_url": "https://api.github.com/users/w0xlt/repos",
        "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/w0xlt/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-09T22:08:15Z",
      "updated_at": "2022-07-09T22:08:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "@theStack thanks for clarifying. I didn't realize that this test originally doesn't support non-standard transactions.\r\nChanging it to `-acceptnonstdtxn=1`, I was able to catch the correct error message in #25570.",
      "user": {
        "login": "w0xlt",
        "id": 94266259,
        "node_id": "U_kgDOBZ5jkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/w0xlt",
        "html_url": "https://github.com/w0xlt",
        "followers_url": "https://api.github.com/users/w0xlt/followers",
        "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
        "organizations_url": "https://api.github.com/users/w0xlt/orgs",
        "repos_url": "https://api.github.com/users/w0xlt/repos",
        "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/w0xlt/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/25567#issuecomment-1179613569",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25567"
    },
    {
      "event": "closed",
      "id": 6964397180,
      "node_id": "CE_lADOABII585NXWOszwAAAAGfHER8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6964397180",
      "actor": {
        "login": "w0xlt",
        "id": 94266259,
        "node_id": "U_kgDOBZ5jkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/w0xlt",
        "html_url": "https://github.com/w0xlt",
        "followers_url": "https://api.github.com/users/w0xlt/followers",
        "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
        "organizations_url": "https://api.github.com/users/w0xlt/orgs",
        "repos_url": "https://api.github.com/users/w0xlt/repos",
        "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/w0xlt/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-09T22:08:16Z"
    },
    {
      "event": "mentioned",
      "id": 6964397183,
      "node_id": "MEE_lADOABII585NXWOszwAAAAGfHER_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6964397183",
      "actor": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-09T22:08:16Z"
    },
    {
      "event": "subscribed",
      "id": 6964397184,
      "node_id": "SE_lADOABII585NXWOszwAAAAGfHESA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6964397184",
      "actor": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-09T22:08:16Z"
    }
  ]
}