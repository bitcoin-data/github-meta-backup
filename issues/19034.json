{
  "type": "issue",
  "issue": {
    "id": 622126784,
    "node_id": "MDU6SXNzdWU2MjIxMjY3ODQ=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/19034",
    "number": 19034,
    "state": "open",
    "state_reason": null,
    "title": "Small memory leak when BerkeleyEnvironment::Open fails",
    "body": "Originally reported https://github.com/bitcoin/bitcoin/pull/18907#issuecomment-631153346\r\n\r\nThis happens when trying to load a wallet with corrupt logs. It can be reproduced running the wallet_db.py test from #18907@[`c6a2c26`](https://github.com/bitcoin/bitcoin/commits/c6a2c265f5d0b424fc8226c2f3426e82856779d0). From https://travis-ci.org/github/bitcoin/bitcoin/jobs/689013660#L4659: \r\n\r\n```\r\n==2504==ERROR: LeakSanitizer: detected memory leaks\r\nDirect leak of 65840 byte(s) in 2 object(s) allocated from:\r\n    #0 0x55b144d4adb3 in __interceptor_malloc (/home/travis/build/bitcoin/bitcoin/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/bitcoind+0x1c75db3)\r\n    #1 0x7f0207036cc4 in __os_malloc (/usr/lib/x86_64-linux-gnu/libdb_cxx-5.3.so+0x162cc4)\r\n    #2 0x19f3b1afb25218ff  (<unknown module>)\r\nSUMMARY: AddressSanitizer: 65840 byte(s) leaked in 2 allocation(s). \r\n```\r\n\r\nThe leak is known to happen at commits 274b9909f64aa617eb322850b799bc38c04f5f0c (initial commit) and e78c6820232865f21777bfeefadac0a1aea1fde2 (attempted fix) from #18907\r\n\r\nThis is probaby not a very severe issue, but it'd be good to track down the leak, fix it, and add the wallet_db test to have some test coverage for log recovery. All of this can be done independently of #18907, before or after it is merged.",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 1,
    "created_at": "2020-05-20T22:38:22Z",
    "updated_at": "2021-07-04T12:53:23Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 3358572067,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzNTg1NzIwNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3358572067",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-20T22:38:22Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 3358609395,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzNTg2MDkzOTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3358609395",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-20T22:55:04Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 764660846,
      "node_id": "MDEyOklzc3VlQ29tbWVudDc2NDY2MDg0Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/764660846",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-21T13:58:47Z",
      "updated_at": "2021-01-21T13:58:47Z",
      "author_association": "MEMBER",
      "body": "Opened #20974 to test this. Leak does still happen https://cirrus-ci.com/task/5428735379767296?command=ci#L4680\r\n\r\n```\r\n==36296==ERROR: LeakSanitizer: detected memory leaks\r\nDirect leak of 65840 byte(s) in 2 object(s) allocated from:\r\n    #0 0x55fe2c45d3bd in malloc (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/bitcoind+0x17733bd)\r\n    #1 0x7f03e35788c4 in __os_malloc (/lib/x86_64-linux-gnu/libdb_cxx-5.3.so+0x1698c4)\r\nSUMMARY: AddressSanitizer: 65840 byte(s) leaked in 2 allocation(s). \r\n```",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19034#issuecomment-764660846",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034"
    }
  ]
}