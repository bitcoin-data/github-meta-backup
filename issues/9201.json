{
  "type": "issue",
  "issue": {
    "id": 190970394,
    "node_id": "MDU6SXNzdWUxOTA5NzAzOTQ=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9201",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/9201",
    "number": 9201,
    "state": "closed",
    "state_reason": "completed",
    "title": "Importing privkey blocks p2p network traffic, results in connection resets and delayed TX relay",
    "body": "### Describe the setup\r\n```\r\n            +------+   +---------+   +------+\r\n            |proxy |   |node with|   | RPC  |\r\nInternet ---|node P|---|wallet W |---|client|\r\n            |0.13.1|   |0.13.1   |   |  R   |\r\n            +------+   +---------+   +------+\r\n            \\------------ LAN --------------/\r\n```\r\n\r\nbitcoin.conf from node W:\r\n```\r\nconnect=<IP from P>:8333\r\n[..]\r\n```\r\n\r\n### Describe the issue\r\n\r\n`W` is connected to `P` all the time. When `R` calls `importprivkey` on `W`, some time later while still rescanning, `W` will drop the connection to `P` with `socket sending timeout` (15:28:03).\r\n\r\n`W` then tries to reconnect to `P`. Between establishing the TCP connection (15:28:07) and sending the version message from `W` to `P` (15:51:5) there is a delay of more than 20 minutes, resulting in the connection being dropped after trying to send the version message 20 minutes late (15:51:58).\r\n\r\nIn our case right after importing the private key a TX is generated on `W` but not being relayed to `P` (15:51:58) because of the 2nd disconnect. The TX is then only rebroadcasted another 20 minutes later (16:10:25).\r\n\r\n### Can you reliably reproduce the issue?\r\n1. Call `importprivkey`\r\n2. When finished, call `sendfrom`\r\n\r\n### Expected behaviour\r\nConnection from `W` to `P` should not be disconnected, the created TX being relayed from `W` to `P` immediately.\r\n\r\n### Actual behaviour\r\nConnection from `W` to `P` gets disconnected. Relaying of created TX from `W` to `P` is delayed for ~20 minutes.\r\n\r\n### What version of bitcoin-core are you using?\r\nv0.13.1.0-g03422e5\r\n\r\n### debug.log of `W`\r\n\r\n```\r\n(privkey is being imported)\r\n\r\n2016-11-21 15:28:01 AddToWallet 4b..............................................................  \r\n2016-11-21 15:28:01 AddToWallet 7b..............................................................  \r\n2016-11-21 15:28:02 Still rescanning. At block 365458. Progress=0.613375\r\n2016-11-21 15:28:03 socket sending timeout: 1201s\r\n2016-11-21 15:28:03 disconnecting peer=1\r\n2016-11-21 15:28:07 trying connection PROXYIP:8333 lastseen=0.0hrs\r\n2016-11-21 15:28:07 Added connection to PROXYIP:8333 peer=2\r\n2016-11-21 15:28:09 AddToWallet 5d..............................................................  \r\n2016-11-21 15:28:09 AddToWallet 30..............................................................  \r\n[..]\r\n2016-11-21 15:51:57 AddToWallet 9e..............................................................  \r\n2016-11-21 15:51:58 AddToWallet 83..............................................................  \r\n2016-11-21 15:51:58 got inv: tx 0f0213b886bdd03ae131184d8edaeb1f75216cc25df00f4f1798f1cbcad69b5c  new peer=1\r\n2016-11-21 15:51:58 askfor witness-tx 0f0213b886bdd03ae131184d8edaeb1f75216cc25df00f4f1798f1cbcad69b5c  0 (00:00:00) peer=1\r\n2016-11-21 15:51:58 send version message: version 70014, blocks=439941, us=[::]:0, them=0.0.0.0:0, peer=2\r\n2016-11-21 15:51:58 sending: version (102 bytes) peer=2\r\n2016-11-21 15:51:58 Erased 100 orphan tx from peer 1\r\n2016-11-21 15:51:58 socket closed\r\n2016-11-21 15:51:58 disconnecting peer=2\r\n2016-11-21 15:51:58 keypool added key 7949, size=301\r\n2016-11-21 15:51:58 keypool reserve 7649\r\n2016-11-21 15:51:58 keypool keep 7649\r\n[..]\r\n2016-11-21 15:51:58 CommitTransaction\r\nCTransaction(hash=ec6eXXXXXX, ver=1, vin.size=5, vout.size=2, nLockTime=439941)\r\n[..]\r\n2016-11-21 15:51:58 AddToWallet ec6eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  new\r\n2016-11-21 15:51:58 Blockpolicy mempool tx ec6eXXXXXX not adding\r\n[..]\r\n2016-11-21 15:52:01 Flushing wallet.dat\r\n2016-11-21 15:52:01 Flushed wallet.dat 248ms\r\n2016-11-21 15:52:03 trying connection PROXYIP:8333 lastseen=0.0hrs\r\n2016-11-21 15:52:03 Added connection to PROXYIP:8333 peer=3\r\n2016-11-21 15:52:03 send version message: version 70014, blocks=439941, us=[::]:0, them=0.0.0.0:0, peer=3\r\n[..]\r\n2016-11-21 16:10:25 Relaying wtx ec6eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\r\n2016-11-21 16:10:25 ResendWalletTransactions: rebroadcast 1 unconfirmed transactions\r\n```",
    "user": {
      "login": "c0deright",
      "id": 20477825,
      "node_id": "MDQ6VXNlcjIwNDc3ODI1",
      "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/c0deright",
      "html_url": "https://github.com/c0deright",
      "followers_url": "https://api.github.com/users/c0deright/followers",
      "following_url": "https://api.github.com/users/c0deright/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/c0deright/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/c0deright/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
      "organizations_url": "https://api.github.com/users/c0deright/orgs",
      "repos_url": "https://api.github.com/users/c0deright/repos",
      "events_url": "https://api.github.com/users/c0deright/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/c0deright/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 1,
    "closed_at": "2019-10-16T15:08:43Z",
    "created_at": "2016-11-22T11:09:01Z",
    "updated_at": "2021-12-16T14:10:52Z"
  },
  "events": [
    {
      "event": "renamed",
      "id": 868019599,
      "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50ODY4MDE5NTk5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/868019599",
      "actor": {
        "login": "c0deright",
        "id": 20477825,
        "node_id": "MDQ6VXNlcjIwNDc3ODI1",
        "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/c0deright",
        "html_url": "https://github.com/c0deright",
        "followers_url": "https://api.github.com/users/c0deright/followers",
        "following_url": "https://api.github.com/users/c0deright/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/c0deright/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/c0deright/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
        "organizations_url": "https://api.github.com/users/c0deright/orgs",
        "repos_url": "https://api.github.com/users/c0deright/repos",
        "events_url": "https://api.github.com/users/c0deright/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/c0deright/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-11-22T11:14:27Z",
      "rename": {
        "from": "Importing privkey blocks p2p network traffic, results in connection resets",
        "to": "Importing privkey blocks p2p network traffic, results in connection resets and delayed TX relay"
      }
    },
    {
      "event": "labeled",
      "id": 868020841,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDg2ODAyMDg0MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/868020841",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-11-22T11:15:31Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "commented",
      "id": 542748551,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU0Mjc0ODU1MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542748551",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-16T15:08:43Z",
      "updated_at": "2019-10-16T15:08:43Z",
      "author_association": "MEMBER",
      "body": "wallet rescan no longer locks `cs_main` (all the time) after #11281 by @jonasschnelli , released in Bitcoin Core 0.16.0\r\n\r\nLet me know if you still see this issue",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9201#issuecomment-542748551",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9201"
    },
    {
      "event": "closed",
      "id": 2718015171,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjcxODAxNTE3MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2718015171",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-16T15:08:43Z"
    },
    {
      "event": "mentioned",
      "id": 2718015264,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MjcxODAxNTI2NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2718015264",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-16T15:08:44Z"
    },
    {
      "event": "subscribed",
      "id": 2718015267,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3MTgwMTUyNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2718015267",
      "actor": {
        "login": "jonasschnelli",
        "id": 178464,
        "node_id": "MDQ6VXNlcjE3ODQ2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonasschnelli",
        "html_url": "https://github.com/jonasschnelli",
        "followers_url": "https://api.github.com/users/jonasschnelli/followers",
        "following_url": "https://api.github.com/users/jonasschnelli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonasschnelli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonasschnelli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
        "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
        "repos_url": "https://api.github.com/users/jonasschnelli/repos",
        "events_url": "https://api.github.com/users/jonasschnelli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-16T15:08:44Z"
    },
    {
      "event": "locked",
      "id": 5778616379,
      "node_id": "LOE_lADOABII584LYfoazwAAAAFYbrA7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5778616379",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-12-16T14:10:52Z",
      "lock_reason": "resolved"
    }
  ]
}