{
  "type": "issue",
  "issue": {
    "id": 112426990,
    "node_id": "MDU6SXNzdWUxMTI0MjY5OTA=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/6861",
    "number": 6861,
    "state": "closed",
    "state_reason": "completed",
    "title": "Downloading headers from peers which are bootstrapping.",
    "body": "Core will send a `getheaders` message to every peer it connects to. Should a peer respond with the first 2000 headers, Core will begin to download the headers chain from scratch, despite already having these. This is particularly strange while in parallel, the fresh peer may also be actively downloading blocks from the fully synced node.\n\nThis check is what causes it to redownload the chain: https://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L4434 I worry about this, since incoming peers can also trigger this - and only have to have the first 2000 headers for it to work. \n\nSo I'm wondering if there's a reason or if it's a bug. I thought `headers` messages started at the _next_ best header in the main chain? Can we simply disregard a `headers` message that doesn't start with an unknown header? \n",
    "user": {
      "login": "afk11",
      "id": 5617245,
      "node_id": "MDQ6VXNlcjU2MTcyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5617245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/afk11",
      "html_url": "https://github.com/afk11",
      "followers_url": "https://api.github.com/users/afk11/followers",
      "following_url": "https://api.github.com/users/afk11/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/afk11/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/afk11/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/afk11/subscriptions",
      "organizations_url": "https://api.github.com/users/afk11/orgs",
      "repos_url": "https://api.github.com/users/afk11/repos",
      "events_url": "https://api.github.com/users/afk11/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/afk11/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 2,
    "closed_at": "2022-08-01T17:25:47Z",
    "created_at": "2015-10-20T18:11:52Z",
    "updated_at": "2022-08-01T17:25:47Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 149660411,
      "node_id": "MDEyOklzc3VlQ29tbWVudDE0OTY2MDQxMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/149660411",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2015-10-20T18:40:22Z",
      "updated_at": "2015-10-20T18:40:22Z",
      "author_association": "MEMBER",
      "body": "The `getheaders` message we send to our peers uses a block locator calculated from `pindexBestHeader`.\n\nOur peers, upon receving a `getheaders` message, should only return headers starting at the latest fork point between their tip and the tip of our locator.  So in the normal case, our peers wouldn't respond to a `getheaders` message by starting at block 1.  However, I think it is possible for a new node starting up to get an `inv` from a peer while its syncing the headers chain from one of its peers, and before `pindexBestHeader` is very far along.  In that situation I would expect that you could end up downloading most or all of the headers chain from two different peers at the same time.  This is similar to what is reported in #6755.\n\nThere is a comment in the code just below the line you linked, which is to continue from `pindexBestHeader` or `chainActive.Tip()` if the last header they send us is an ancestor of one of those.  Come to think of it, that might go a long way towards mitigating the issue in #6755.\n\nAlso it's not okay to disregard a `headers` message that doesn't start with an unknown header -- if our peer is behaving properly, they might well send us a header we already have, if our chain tip happened to be on a different fork at the time we sent them a `getheaders` message, which didn't include the header in question.  So it's possible for a valid headers message that would help us get to a more-work chain could start from a header that we already know about.\n",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/6861#issuecomment-149660411",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861"
    },
    {
      "event": "labeled",
      "id": 445282191,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDQ0NTI4MjE5MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/445282191",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2015-10-26T09:13:49Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "referenced",
      "id": 4064248154,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQwNjQyNDgxNTQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4064248154",
      "actor": {
        "login": "hdevalence",
        "id": 44879,
        "node_id": "MDQ6VXNlcjQ0ODc5",
        "avatar_url": "https://avatars.githubusercontent.com/u/44879?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hdevalence",
        "html_url": "https://github.com/hdevalence",
        "followers_url": "https://api.github.com/users/hdevalence/followers",
        "following_url": "https://api.github.com/users/hdevalence/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hdevalence/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hdevalence/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hdevalence/subscriptions",
        "organizations_url": "https://api.github.com/users/hdevalence/orgs",
        "repos_url": "https://api.github.com/users/hdevalence/repos",
        "events_url": "https://api.github.com/users/hdevalence/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hdevalence/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "7d1dc174ba8abaa844c727b5513ba8c91f84f680",
      "commit_url": "https://api.github.com/repos/ZcashFoundation/zebra/commits/7d1dc174ba8abaa844c727b5513ba8c91f84f680",
      "created_at": "2020-12-02T20:27:28Z"
    },
    {
      "event": "referenced",
      "id": 4065013873,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQwNjUwMTM4NzM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4065013873",
      "actor": {
        "login": "dconnolly",
        "id": 552961,
        "node_id": "MDQ6VXNlcjU1Mjk2MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/552961?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dconnolly",
        "html_url": "https://github.com/dconnolly",
        "followers_url": "https://api.github.com/users/dconnolly/followers",
        "following_url": "https://api.github.com/users/dconnolly/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dconnolly/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dconnolly/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dconnolly/subscriptions",
        "organizations_url": "https://api.github.com/users/dconnolly/orgs",
        "repos_url": "https://api.github.com/users/dconnolly/repos",
        "events_url": "https://api.github.com/users/dconnolly/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dconnolly/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "c04cc39a03d34dea75c4024e72e93d6d8ad640df",
      "commit_url": "https://api.github.com/repos/ZcashFoundation/zebra/commits/c04cc39a03d34dea75c4024e72e93d6d8ad640df",
      "created_at": "2020-12-03T00:44:26Z"
    },
    {
      "event": "commented",
      "id": 1201497504,
      "node_id": "IC_kwDOABII585HnWWg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201497504",
      "actor": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-01T17:25:47Z",
      "updated_at": "2022-08-01T17:25:47Z",
      "author_association": "MEMBER",
      "body": "Closing and pushing future discussions to #6755 around duplicate getheaders requests.",
      "user": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/6861#issuecomment-1201497504",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/6861"
    },
    {
      "event": "closed",
      "id": 7103473719,
      "node_id": "CE_lADOABII584Gs3_uzwAAAAGnZmg3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7103473719",
      "actor": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-01T17:25:47Z"
    }
  ]
}