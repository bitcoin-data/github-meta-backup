{
  "type": "issue",
  "issue": {
    "id": 30908197,
    "node_id": "MDU6SXNzdWUzMDkwODE5Nw==",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/4003",
    "number": 4003,
    "state": "closed",
    "state_reason": "completed",
    "title": "bitcoin-qt crashes every time I quit it",
    "body": "The wallet seems to run fine until I exit, and then I see:\n\n```\n[Thread 0x7fffa566a700 (LWP 9742) exited]\n[Thread 0x7fffa5ebb700 (LWP 9741) exited]\n[Thread 0x7fffa670c700 (LWP 9740) exited]\n\n\n************************\nEXCEPTION: St13runtime_error       \nCDB() : can't open database file wallet.dat, error -30973       \nbitcoin in Runaway exception       \n\nbitcoin: ../../src/allocators.h:41: LockedPageManagerBase<Locker>::~LockedPageManagerBase() [with Locker = MemoryPageLocker]: Assertion `this->GetLockedPageCount() == 0' failed.\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff4323f77 in __GI_raise (sig=sig@entry=6)\n    at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\n56  ../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.\n```\n\nThis happens each time I close the wallet application.\n\nI think it started happening after my laptop refused to resume from suspending one time and I had to power it down in a less than correct manner.\n\nIs there some way I can 'fix' the wallet?\n",
    "user": {
      "login": "dooglus",
      "id": 573356,
      "node_id": "MDQ6VXNlcjU3MzM1Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dooglus",
      "html_url": "https://github.com/dooglus",
      "followers_url": "https://api.github.com/users/dooglus/followers",
      "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
      "organizations_url": "https://api.github.com/users/dooglus/orgs",
      "repos_url": "https://api.github.com/users/dooglus/repos",
      "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/dooglus/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 4,
    "closed_at": "2014-05-13T06:52:35Z",
    "created_at": "2014-04-05T04:03:17Z",
    "updated_at": "2021-09-08T12:20:22Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 39633076,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjMzMDc2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39633076",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-04-05T09:15:06Z",
      "updated_at": "2014-04-05T09:15:06Z",
      "author_association": "MEMBER",
      "body": "This is very strange. Why would it be unable to open the database file but only when you shut down?\n\nIn any case, can you try (may need db4.8-util or similar package):\n\n``` bash\ncd ~/.bitcoin\nmv wallet.dat wallet.dat.backup\ndb4.8_dump wallet.dat.backup | db4.8_load wallet.dat\n```\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39633076",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003"
    },
    {
      "event": "commented",
      "id": 39646212,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjQ2MjEy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646212",
      "actor": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-04-05T18:13:02Z",
      "updated_at": "2014-04-05T18:13:02Z",
      "author_association": "CONTRIBUTOR",
      "body": "The first time I noticed the error was shortly after using rsync to copy my whole home directory over to a new laptop.  The one I was copying from was running bitcoin-qt at the time.  I figured that was a bad idea, so went to shut bitcoin-qt down and re-run the sync, and it was then that I saw the error message.  I was wondering if the problem could have been caused by rsync reading the wallet file while it was open.  But as I say, the laptop had frozen on resume shortly before this as well.\n\nI restarted bitcoin, it came up just fine, but again when I went to shut it down, I saw the same error again.\n\nAnd interestingly, even after copying everything over to the new laptop, I saw the same error on the new laptop the first time I ran it.  But just this morning I was able to shut it down without the error, so it looks like the problem eventually resolved itself.\n\nHere's a screenshot I took the first time the error happened.  Both dialogs are on the screen at the same time.\n\n![screenshot - 14-04-04 - 07 15 45 am](https://cloud.githubusercontent.com/assets/573356/2623414/1089aaea-bced-11e3-8d11-40d46c9de99b.png)\n\nI should probably mention that I'm using libdb5.3++-dev and had to use a ./configure flag for non-compatible wallets, but I've been using that for a long time.\n\nRunning the dump/load commands completes without error (on the new laptop where the problem is already apparently fixed), and makes the wallet considerably smaller:\n\n```\n$ cp ~/.bitcoin/wallet.dat wallet.dat.before\n$ db5.3_dump wallet.dat.before | db5.3_load wallet.dat.after\n$ ls -lh wallet.dat*\n-rw-r--r-- 1 chris chris 140M Apr  5 11:11 wallet.dat.after\n-rw------- 1 chris chris 151M Apr  5 11:10 wallet.dat.before\n$ \n```\n\nI'll try it on the old laptop where the error presumably still happens.\n",
      "user": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646212",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003"
    },
    {
      "event": "commented",
      "id": 39646679,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjQ2Njc5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646679",
      "actor": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-04-05T18:29:05Z",
      "updated_at": "2014-04-05T18:29:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "On the old laptop:\n\n```\n$ db5.3_dump wallet.dat.before | db5.3_load wallet.dat.after\n$ ls -l wallet.dat.*\n-rw-r--r-- 1 chris chris 146464768 Apr  5 11:19 wallet.dat.after\n-rw------- 1 chris chris 157814784 Apr  5 11:17 wallet.dat.before\n$ \n```\n\nThen I ran bitcoin-qt on the 'before' version of the wallet, and it did still crash on shutdown.  It definitely loaded up, showed the wallet balance, and started catching up with the blockchain.\n\n![screenshot - 14-04-05 - 11 27 12 am](https://cloud.githubusercontent.com/assets/573356/2623455/1b832216-bcf0-11e3-8a26-47191ae63bb3.png)\n",
      "user": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646679",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003"
    },
    {
      "event": "commented",
      "id": 39646994,
      "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjQ2OTk0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646994",
      "actor": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-04-05T18:38:49Z",
      "updated_at": "2014-04-05T18:38:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "Running bitcoin-qt with the 'wallet.dat.after' file created using those db util commands fixed the problem.  I can now start and close the wallet without error messages.\n",
      "user": {
        "login": "dooglus",
        "id": 573356,
        "node_id": "MDQ6VXNlcjU3MzM1Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/573356?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dooglus",
        "html_url": "https://github.com/dooglus",
        "followers_url": "https://api.github.com/users/dooglus/followers",
        "following_url": "https://api.github.com/users/dooglus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dooglus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dooglus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dooglus/subscriptions",
        "organizations_url": "https://api.github.com/users/dooglus/orgs",
        "repos_url": "https://api.github.com/users/dooglus/repos",
        "events_url": "https://api.github.com/users/dooglus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dooglus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646994",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4003"
    },
    {
      "event": "labeled",
      "id": 117219752,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDExNzIxOTc1Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/117219752",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-05-02T07:26:57Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "closed",
      "id": 120436459,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTIwNDM2NDU5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/120436459",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-05-13T06:52:35Z"
    },
    {
      "event": "locked",
      "id": 5271938190,
      "node_id": "LOE_lADOABII584B158lzwAAAAE6O2SO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5271938190",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:20:22Z",
      "lock_reason": "resolved"
    }
  ]
}