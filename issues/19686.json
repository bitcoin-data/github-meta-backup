{
  "type": "issue",
  "issue": {
    "id": 675493114,
    "node_id": "MDU6SXNzdWU2NzU0OTMxMTQ=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/19686",
    "number": 19686,
    "state": "closed",
    "state_reason": "completed",
    "title": "getnewaddress returns unsolvable addresses in watchonly wallet",
    "body": "<!-- Describe the issue -->\r\n\r\ngetnewaddress returns unsolvable addresses after import from descriptors in a watchonly wallet. Exported addresses using https://github.com/bitcoin-core/hwi and its getkeypool command. Imported using the importmulti command.\r\n\r\n<!--- What behavior did you expect? -->\r\n\r\ngetnewaddress returns solvable addresses.\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n\r\nBehavior varies based on which descriptors are imported.\r\n\r\nExample of all three types together [ output of `./hwi.py getkeypool --all` ]:\r\n`[{\"desc\": \"pkh([b5f66c19/44h/0h/0h]xpub6D8yeA6gG4MgNTANfvqvZTg3jyrs63YzDiJVnQ3o9Bn425a8zAqu3VQEaKQr3hkeBLE21AuJbZHApnJjWzWGmR4fjS2YBtpKraDKY5esNbp/0/*)#lfa0d60w\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": false, \"keypool\": true, \"active\": true, \"watchonly\": true}, {\"desc\": \"pkh([b5f66c19/44h/0h/0h]xpub6D8yeA6gG4MgNTANfvqvZTg3jyrs63YzDiJVnQ3o9Bn425a8zAqu3VQEaKQr3hkeBLE21AuJbZHApnJjWzWGmR4fjS2YBtpKraDKY5esNbp/1/*)#wacws0lk\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": true, \"keypool\": true, \"active\": true, \"watchonly\": true}, {\"desc\": \"wpkh([b5f66c19/84h/0h/0h]xpub6Bf8q3qTbFC3So4JoLBsEjMbCMHNhNUxiaZox3aEVumoE584mHhTq8wBr8jkw5ukoTW5K14nSssx8MyUq5fcmdoGcoo7wsVfPfbX5t2e51w/0/*)#vknsa5l5\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": false, \"keypool\": true, \"active\": true, \"watchonly\": true}, {\"desc\": \"wpkh([b5f66c19/84h/0h/0h]xpub6Bf8q3qTbFC3So4JoLBsEjMbCMHNhNUxiaZox3aEVumoE584mHhTq8wBr8jkw5ukoTW5K14nSssx8MyUq5fcmdoGcoo7wsVfPfbX5t2e51w/1/*)#azk3qp0v\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": true, \"keypool\": true, \"active\": true, \"watchonly\": true}, {\"desc\": \"sh(wpkh([b5f66c19/49h/0h/0h]xpub6DWmKTzgzCoPEtxSxAP5pnEXxfF8UNRSHWyDMeCivSqokTzK7owDh3GGficKiGuqBMcuTUZE32oe7wevwRZaotXYfE8ig2Lt6Jr1Ry6BwbU/0/*))#9j0eptl9\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": false, \"keypool\": true, \"active\": true, \"watchonly\": true}, {\"desc\": \"sh(wpkh([b5f66c19/49h/0h/0h]xpub6DWmKTzgzCoPEtxSxAP5pnEXxfF8UNRSHWyDMeCivSqokTzK7owDh3GGficKiGuqBMcuTUZE32oe7wevwRZaotXYfE8ig2Lt6Jr1Ry6BwbU/1/*))#snp0e526\", \"range\": [0, 300], \"timestamp\": \"now\", \"internal\": true, \"keypool\": true, \"active\": true, \"watchonly\": true}]`\r\n\r\nIf only legacy address descriptors (pkh) imported, then getnewaddress returns a solvable address for any address type.\r\n\r\nIf bech32 address descriptors (wpkh) imported:\r\n- `bitcoin-cli getnewaddress` returns a solvable address\r\n- `bitcoin-cli getnewaddress -addresstype legacy` returns an **unsolvable** address\r\n- `bitcoin-cli getnewaddress -addresstype p2sh-segwit` returns a solvable address\r\n\r\nIf 'sh(wpkh(' descriptors imported:\r\n- `bitcoin-cli getnewaddress` returns an **unsolvable** address\r\n- `bitcoin-cli getnewaddress -addresstype legacy` returns an **unsolvable** address\r\n- `bitcoin-cli getnewaddress -addresstype p2sh-segwit` returns a solvable address\r\n\r\nUnsure of behavior when all are imported together. Depends on how the addresses are stored/retrieved in the keypool. Unsolvable addresses are definitely possible to be returned (lost funds while attempting to create a psbt with hardware wallet which sent change to an unsolvable address).\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n**Steps to reproduce**\r\n- create new watchonly wallet\r\n- unload default wallet\r\n- export descriptors\r\n- use importmulti to import descriptors\r\n- call getnewaddress\r\n\r\nCan reliably reproduce. Returns the exact same (un)solvable addresses each time running through process.\r\n\r\n**System information**\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\nSelf-compiled bitcoin core v0.20.0.\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\nRunning Debian with Intel i5-3570 cpu, ssd.",
    "user": {
      "login": "infinitis",
      "id": 34695575,
      "node_id": "MDQ6VXNlcjM0Njk1NTc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/34695575?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/infinitis",
      "html_url": "https://github.com/infinitis",
      "followers_url": "https://api.github.com/users/infinitis/followers",
      "following_url": "https://api.github.com/users/infinitis/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/infinitis/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/infinitis/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/infinitis/subscriptions",
      "organizations_url": "https://api.github.com/users/infinitis/orgs",
      "repos_url": "https://api.github.com/users/infinitis/repos",
      "events_url": "https://api.github.com/users/infinitis/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/infinitis/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 2,
    "closed_at": "2022-07-25T15:20:56Z",
    "created_at": "2020-08-08T09:13:47Z",
    "updated_at": "2022-07-25T15:20:56Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 3635504195,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDM2MzU1MDQxOTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3635504195",
      "actor": {
        "login": "infinitis",
        "id": 34695575,
        "node_id": "MDQ6VXNlcjM0Njk1NTc1",
        "avatar_url": "https://avatars.githubusercontent.com/u/34695575?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/infinitis",
        "html_url": "https://github.com/infinitis",
        "followers_url": "https://api.github.com/users/infinitis/followers",
        "following_url": "https://api.github.com/users/infinitis/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/infinitis/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/infinitis/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/infinitis/subscriptions",
        "organizations_url": "https://api.github.com/users/infinitis/orgs",
        "repos_url": "https://api.github.com/users/infinitis/repos",
        "events_url": "https://api.github.com/users/infinitis/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/infinitis/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-08T09:13:47Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 670941338,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDk0MTMzOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670941338",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-08T15:25:32Z",
      "updated_at": "2020-08-08T15:25:32Z",
      "author_association": "MEMBER",
      "body": "It's surprising to me that the pkh descriptor always returns a solvable address while the sh(wpkh( descriptor only returns a solvable for p2sh-segwit. I would have expected this to be the opposite since sh(wpkh( imports more information.\r\n\r\nFor 0.21 onwards, you should use descriptor wallets which fix this entirely. You will only be able to get addresses for the descriptors that you import and there won't be any of this address type mutation.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19686#issuecomment-670941338",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686"
    },
    {
      "event": "commented",
      "id": 1194192501,
      "node_id": "IC_kwDOABII585HLe51",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1194192501",
      "actor": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-25T15:20:56Z",
      "updated_at": "2022-07-25T15:20:56Z",
      "author_association": "MEMBER",
      "body": "Confirmed with achow that this was solved by descriptors. Closing.",
      "user": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19686#issuecomment-1194192501",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19686"
    },
    {
      "event": "closed",
      "id": 7057540272,
      "node_id": "CE_lADOABII584oQzT6zwAAAAGkqYSw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7057540272",
      "actor": {
        "login": "adamjonas",
        "id": 755825,
        "node_id": "MDQ6VXNlcjc1NTgyNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/755825?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/adamjonas",
        "html_url": "https://github.com/adamjonas",
        "followers_url": "https://api.github.com/users/adamjonas/followers",
        "following_url": "https://api.github.com/users/adamjonas/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/adamjonas/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/adamjonas/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/adamjonas/subscriptions",
        "organizations_url": "https://api.github.com/users/adamjonas/orgs",
        "repos_url": "https://api.github.com/users/adamjonas/repos",
        "events_url": "https://api.github.com/users/adamjonas/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/adamjonas/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-07-25T15:20:56Z"
    }
  ]
}