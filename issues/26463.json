{
  "type": "issue",
  "issue": {
    "id": 1437445233,
    "node_id": "I_kwDOABII585Vraxx",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/26463",
    "number": 26463,
    "state": "closed",
    "state_reason": "completed",
    "title": "[wallet] when unloading a wallet which still rescans the wallet, the command should fail but bitcoind gets in a buggy state",
    "body": "<!-- This issue tracker is only for technical issues related to Bitcoin Core.\r\n\r\nGeneral bitcoin questions and/or support requests are best directed to the Bitcoin StackExchange at https://bitcoin.stackexchange.com.\r\n\r\nFor reporting security issues, please read instructions at https://bitcoincore.org/en/contact/.\r\n\r\nIf the node is \"stuck\" during sync or giving \"block checksum mismatch\" errors, please ensure your hardware is stable by running memtest and observe CPU temperature with a load-test tool such as linpack before creating an issue! -->\r\n\r\n<!-- Describe the issue -->\r\n\r\nI am loading descriptors into bitcoind using the rpcclient with the function: `importdescriptors`, it automatically starts rescanning the blockchain. Now when I try to unload the wallet, bitcoin-cli will allow me to do it (wallet disappears from the `listwallet` section, but it will not abort the rescan. Thats a problem bc now when trying to reload the wallet, the wallet sqlite db is locked by bitcoind and this wallet is unusable unitl the rescan is over. `abortrescan` will not work bc the wallet is not loaded anymore according to `bitcoin-cli listwallets`. The only solution for me was to delete the wallet dir and create a new wallet with the same name. Now everything works as expected, but as soon as I want to unload the wallet again, bitcoind crashes\r\n\r\n<!--- What behavior did you expect? -->\r\n\r\nThe `unloadwallet` function should internally abort the rescan and unload the wallet, so that it can be reloaded afterwards without waiting for the rescan. Or it should fail and leading the user to abort the rescan with `abortrescan`\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n\r\n* Create a descriptor wallet\r\n* Import a descriptor and unload the walllet while bitcoind is still rescanning\r\n* Now you are stuck bc abortrescan will not work bc wallet is not loaded and the only solution is to delete the wallet dir\r\n* Now Create a new wallet with the same name and import the descriptors again. When the wallet is faster synced then the old process still syncing, and you unload the wallet, bitcoind crashes\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n\r\n` Linux 5.10.103-v8+ #1529 SMP PREEMPT Tue Mar 8 12:26:46 GMT 2022 aarch64 GNU/Linux`\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\n\r\nbitcoind v.23.0 (release binary for raspberry pi)\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\n\r\n<!-- GUI-related issue? What is your operating system and its version? If Linux, what is your desktop environment and graphical shell? -->\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n",
    "user": {
      "login": "ziggie1984",
      "id": 90319354,
      "node_id": "MDQ6VXNlcjkwMzE5MzU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ziggie1984",
      "html_url": "https://github.com/ziggie1984",
      "followers_url": "https://api.github.com/users/ziggie1984/followers",
      "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
      "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
      "repos_url": "https://api.github.com/users/ziggie1984/repos",
      "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "closed_at": "2023-01-09T21:57:05Z",
    "created_at": "2022-11-06T15:37:17Z",
    "updated_at": "2023-01-09T21:57:05Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 7747493298,
      "node_id": "LE_lADOABII585VraxxzwAAAAHNyV2y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7747493298",
      "actor": {
        "login": "ziggie1984",
        "id": 90319354,
        "node_id": "MDQ6VXNlcjkwMzE5MzU0",
        "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ziggie1984",
        "html_url": "https://github.com/ziggie1984",
        "followers_url": "https://api.github.com/users/ziggie1984/followers",
        "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
        "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
        "repos_url": "https://api.github.com/users/ziggie1984/repos",
        "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-11-06T15:37:17Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 1304828848,
      "node_id": "IC_kwDOABII585Nxhuw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1304828848",
      "actor": {
        "login": "ziggie1984",
        "id": 90319354,
        "node_id": "MDQ6VXNlcjkwMzE5MzU0",
        "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ziggie1984",
        "html_url": "https://github.com/ziggie1984",
        "followers_url": "https://api.github.com/users/ziggie1984/followers",
        "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
        "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
        "repos_url": "https://api.github.com/users/ziggie1984/repos",
        "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-11-06T15:40:34Z",
      "updated_at": "2022-11-06T15:40:34Z",
      "author_association": "NONE",
      "body": "@achow101 maybe it works as expected, but according to my feeling `unloadwallet` should not do anything before the user did not abort the rescan",
      "user": {
        "login": "ziggie1984",
        "id": 90319354,
        "node_id": "MDQ6VXNlcjkwMzE5MzU0",
        "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ziggie1984",
        "html_url": "https://github.com/ziggie1984",
        "followers_url": "https://api.github.com/users/ziggie1984/followers",
        "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
        "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
        "repos_url": "https://api.github.com/users/ziggie1984/repos",
        "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/26463#issuecomment-1304828848",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463"
    },
    {
      "event": "mentioned",
      "id": 7747497482,
      "node_id": "MEE_lADOABII585VraxxzwAAAAHNyW4K",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7747497482",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-11-06T15:40:34Z"
    },
    {
      "event": "subscribed",
      "id": 7747497486,
      "node_id": "SE_lADOABII585VraxxzwAAAAHNyW4O",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7747497486",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-11-06T15:40:34Z"
    },
    {
      "event": "commented",
      "id": 1341530897,
      "node_id": "IC_kwDOABII585P9iMR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1341530897",
      "actor": {
        "login": "promag",
        "id": 3534524,
        "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/promag",
        "html_url": "https://github.com/promag",
        "followers_url": "https://api.github.com/users/promag/followers",
        "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
        "organizations_url": "https://api.github.com/users/promag/orgs",
        "repos_url": "https://api.github.com/users/promag/repos",
        "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/promag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-07T20:10:09Z",
      "updated_at": "2022-12-07T20:17:04Z",
      "author_association": "MEMBER",
      "body": "> I am loading descriptors into bitcoind using the rpcclient with the function: importdescriptors, it automatically starts rescanning the blockchain. Now when I try to unload the wallet,\r\n\r\nyou interrupted `bitcoin-cli importdescriptors` right?\r\n\r\n> bitcoin-cli will allow me to do it (wallet disappears from the listwallet section, but it will not abort the rescan\r\n\r\nand you also interrupted `bitcoin-cli unloadwallet` right?\r\n\r\nThese calls are blocking, interrupting on the command line doesn't interrupt on server side. Internally there is a thread scanning the chain and there is a thread waiting for unload release.\r\n\r\n> The unloadwallet function should internally abort the rescan and unload the wallet, so that it can be reloaded afterwards without waiting for the rescan. Or it should fail and leading the user to abort the rescan with abortrescan\r\n\r\nIMO it should just fail.",
      "user": {
        "login": "promag",
        "id": 3534524,
        "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/promag",
        "html_url": "https://github.com/promag",
        "followers_url": "https://api.github.com/users/promag/followers",
        "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
        "organizations_url": "https://api.github.com/users/promag/orgs",
        "repos_url": "https://api.github.com/users/promag/repos",
        "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/promag/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/26463#issuecomment-1341530897",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463"
    },
    {
      "event": "commented",
      "id": 1341752808,
      "node_id": "IC_kwDOABII585P-YXo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1341752808",
      "actor": {
        "login": "ziggie1984",
        "id": 90319354,
        "node_id": "MDQ6VXNlcjkwMzE5MzU0",
        "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ziggie1984",
        "html_url": "https://github.com/ziggie1984",
        "followers_url": "https://api.github.com/users/ziggie1984/followers",
        "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
        "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
        "repos_url": "https://api.github.com/users/ziggie1984/repos",
        "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-07T23:39:46Z",
      "updated_at": "2022-12-07T23:39:46Z",
      "author_association": "NONE",
      "body": "Yes and Yes.\r\n\r\nYes I think we maybe should just fail as long as the wallet in rescanning. Otherwise the is no option to escape and the `unloadwallet` command is not recoverable. So definitely on your side.",
      "user": {
        "login": "ziggie1984",
        "id": 90319354,
        "node_id": "MDQ6VXNlcjkwMzE5MzU0",
        "avatar_url": "https://avatars.githubusercontent.com/u/90319354?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ziggie1984",
        "html_url": "https://github.com/ziggie1984",
        "followers_url": "https://api.github.com/users/ziggie1984/followers",
        "following_url": "https://api.github.com/users/ziggie1984/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ziggie1984/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ziggie1984/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ziggie1984/subscriptions",
        "organizations_url": "https://api.github.com/users/ziggie1984/orgs",
        "repos_url": "https://api.github.com/users/ziggie1984/repos",
        "events_url": "https://api.github.com/users/ziggie1984/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ziggie1984/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/26463#issuecomment-1341752808",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26463"
    },
    {
      "event": "closed",
      "id": 8186247195,
      "node_id": "CE_lADOABII585VraxxzwAAAAHn8Dgb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8186247195",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "1aedc3b6c81ba5ecf96749be0fb59d873bfd6d49",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1aedc3b6c81ba5ecf96749be0fb59d873bfd6d49",
      "created_at": "2023-01-09T21:57:06Z"
    },
    {
      "event": "referenced",
      "id": 8194849967,
      "node_id": "REFE_lADOABII585VraxxzwAAAAHoc3yv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8194849967",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "1ab8c80040afb504e0af689447cfdb686780d533",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/1ab8c80040afb504e0af689447cfdb686780d533",
      "created_at": "2023-01-10T18:34:23Z"
    }
  ]
}