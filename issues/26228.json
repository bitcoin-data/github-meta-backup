{
  "type": "issue",
  "issue": {
    "id": 1393920854,
    "node_id": "I_kwDOABII585TFYtW",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/26228",
    "number": 26228,
    "state": "open",
    "state_reason": null,
    "title": "retry add onion after tor's controller closed connection",
    "body": "<!-- This issue tracker is only for technical issues related to Bitcoin Core.\r\n\r\nGeneral bitcoin questions and/or support requests are best directed to the Bitcoin StackExchange at https://bitcoin.stackexchange.com.\r\n\r\nFor reporting security issues, please read instructions at https://bitcoincore.org/en/contact/.\r\n\r\nIf the node is \"stuck\" during sync or giving \"block checksum mismatch\" errors, please ensure your hardware is stable by running memtest and observe CPU temperature with a load-test tool such as linpack before creating an issue! -->\r\n\r\n<!-- Describe the issue -->\r\nI am running Bitcoind on Qubes-Whonix.\r\nWhonix-Gateway is where tor resides, and every tor controller's command made by Whonix-Workstation to Whonix-Gateway is filtered by a proxy called onion-grater (upstream development is made by Tails OS)\r\n\r\nFrom this point on I will be referring to tor's controller simply by \"control\" or \"controller\".\r\n\r\nIf the control connection is closed by restarting onion-grater to apply new rules (even not regarding the bitcoind.yml) file, bitcoind will remove the current onion and won't be able to set it as address again.\r\n```\r\nRemoveLocal(myonion.onion:8333)\r\ntor: No supported authentication method\r\n```\r\nand `bitcoin-cli -netinfo`\r\n```\r\nLocal addresses: n/a\r\n```\r\nand of course none of my nodes listening to this address will continue working.\r\n\r\nADD_ONION command works the first time but not the second.\r\nThe problem occurs because bitcoind does not give time for the controller to restart the second time, so the authentication is not \"available yet\".\r\n\r\nIn fact, tor is not being reloaded or restarted, only the proxy, which is what bitcoind sees as the controller.\r\n\r\nThis happens because I am using bitcoind tor controller feature to send ADD_ONION.\r\nIf I set the onion service manually on the gateway, I wouldn't have this problem, but then the problem would be:\r\n- it wouldn't be pragmatically deleted, although I am rewriting it with `Flag=DiscardPK` anyway\r\n- it would stay as a file on the Gateway and the onion address would need to be manually inserted into the bitcoin.conf\r\n\r\n**Expected behavior**\r\n\r\n<!--- What behavior did you expect? -->\r\nI expect that after bitcoind can't authenticate to the controller, it tries again after some time.\r\nThis way, I can restart my controller without needing to restart bitcoind for it to get a onion listening address again.\r\n\r\n**Actual behavior**\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\nBitcoind removes current listening onion hostname and not retry to authenticate to the controller.\r\n\r\n**To reproduce**\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\nThis is difficult to reproduce on normal systems.\r\nFirst, Qubes may not interfere, so you could try to reproduce on Whonix KVM or Virtualbox or Tails OS (probably).\r\n\r\nIf you can't test on that setup, I would try to simple close the controller connection on a normal system and then see what bitcoind does to the listening onion address.\r\n\r\nAlso you need to add the bitcoind onion-grater profile, I don't know if Tails has, but for Whonix, I am using https://github.com/Whonix/onion-grater/blob/9addd1d6dd9671b18e5415a196b92d7f6ee5846c/usr/share/doc/onion-grater-merger/examples/40_bitcoind.yml\r\n\r\nIt is not the current Whonix onion-grater profile but it is the correct one and will be merged upstream soon.\r\n\r\nIf that is the case, add that profile to `/usr/local/etc/onion-grater-merger.d/40_bitcoind.yml`\r\n\r\nAlso set in the `bitcoin.conf` the onion binding to `bind=0.0.0.0:8334=onion` and not `127.0.0.1`. This makes the service listen on the Whonix internal interface and does not affect security. Restart bitcoind to apply changes.\r\n\r\nYou will also have to open the port on the Whonix-Workstation firewall.\r\n```\r\n$ sudo mkdir -p /usr/local/etc/whonix_firewall.d\r\n$ echo \"EXTERNAL_OPEN_PORTS+=\" 8334 \" | tee -a /usr/local/etc/whonix_firewall.d/50_user.conf`\r\n$ sudo whonix_firewall\r\n```\r\n\r\nTo view onion-grater logs, you need to enable debug mode on the Whonix-Gateway:\r\n```\r\n$ echo \"[Service]\r\n## Clear onion-grater default file '/lib/systemd/system/onion-grater.service'.\r\nExecStart=\r\n## Enable debug mode.\r\nExecStart=/usr/lib/onion-grater --listen-interface eth1 --debug\r\n\" | tee /usr/lib/systemd/system/onion-grater.service.d/50_user.conf\r\n$ sudo systemctl daemon-reload\r\n$ sudo systemctl restart onion-grater\r\n```\r\n\r\n\r\nThen after adding the profile, enabling onion-grater debug mode, restarting onion-grater and bitcoind, test if the address is reachable externally. Use the bitcoid option `connect=address.onion`, so you are sure it is connecting.\r\n\r\nIf it is, restart onion-grater.\r\n```\r\n$ sudo systemctl restart onion-grater\r\n```\r\n\r\nOn the bitcoin debug.logs, you should see the same error I saw above about removing onion address and not able to authenticate to the controller.\r\n\r\nBut that is not entirely correct, because I can issue an ADD_ONION manually and it will accept, but bitcoind does not try to issue ADD_ONION a second time.\r\n\r\n\r\n```\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): -> PROTOCOLINFO 1\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): <- 250-PROTOCOLINFO 1\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): <- 250-AUTH METHODS=NULL\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): <- 250-VERSION Tor=\"0.4.7.10\"\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): <- 250 OK\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): -> AUTHENTICATE\r\nhost onion-grater[149562]: 10.137.0.31:54044 (filter: 30_autogenerated): <- 250 OK\r\n```\r\nThe controller actually lets bitcoind authenticate, as seen from the onion-grater logs above. But I don't understand why bitcoind says it can't authenticate.\r\nThe ip doesn't matter, it is internal ip.\r\n\r\nWhat you should expect from onion-grater logs is the following:\r\n```\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): -> AUTHENTICATE\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): <- 250 OK\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): -> ADD_ONION NEW:ED25519-V3 Port=8333,0.0.0.0:8334\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): rewrote command:\r\nhost onion-grater[149562]:     ADD_ONION NEW:ED25519-V3 Port=8333,0.0.0.0:8334\r\nhost onion-grater[149562]: to:\r\nhost onion-grater[149562]:     ADD_ONION NEW:ED25519-V3 Port=8333,10.137.0.31:8334 Flags=DiscardPK\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): <- (multi-line)\r\nhost onion-grater[149562]:     250-ServiceID=myonionhostnamewithoutonion\r\nhost onion-grater[149562]:     250 OK\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): -> QUIT\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated): <- 250 closing connection\r\nhost onion-grater[149562]: 10.137.0.31:43566 (filter: 30_autogenerated) disconnected: client quit\r\n```\r\n\r\nYou could try on Whonix with `tor-ctrl` to authenticate after restarting onion-grater and it will work:\r\n```\r\n$ tor-ctrl ADD_ONION NEW:ED25519-V3 Port=8333,0.0.0.0:8334\r\n```\r\nand it will authenticate.\r\n\r\nBut for some unknown reason bitcoind does not reauthenticate to the controller.\r\n\r\nI understand that once the contoller connection closes, the commands send to the controller are not valid anymore. But bitcoind should be able to reauthenticate once it loses connection.\r\n\r\n**System information**\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\n\r\n<!-- GUI-related issue? What is your operating system and its version? If Linux, what is your desktop environment and graphical shell? -->\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n\r\nSystem information was already described above.\r\nI understand this may be difficult debug because it requires a system with onion-grater.\r\nBut it does not rely on Whonix or Tails or onion-grater package to fix this, as they are only restarting to read the new configuration, but bitcoind understand that as a connection that must be closed forever.\r\n\r\nIf you read all this and is open to make bitcoind retry to authenticate cleanly, I am open to help debug and instruct how to reproduce.",
    "user": {
      "login": "nyxnor",
      "id": 69700936,
      "node_id": "MDQ6VXNlcjY5NzAwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nyxnor",
      "html_url": "https://github.com/nyxnor",
      "followers_url": "https://api.github.com/users/nyxnor/followers",
      "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
      "organizations_url": "https://api.github.com/users/nyxnor/orgs",
      "repos_url": "https://api.github.com/users/nyxnor/repos",
      "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/nyxnor/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 2,
    "created_at": "2022-10-02T22:35:21Z",
    "updated_at": "2022-10-04T07:28:41Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 7502686051,
      "node_id": "LE_lADOABII585TFYtWzwAAAAG_Medj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7502686051",
      "actor": {
        "login": "nyxnor",
        "id": 69700936,
        "node_id": "MDQ6VXNlcjY5NzAwOTM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nyxnor",
        "html_url": "https://github.com/nyxnor",
        "followers_url": "https://api.github.com/users/nyxnor/followers",
        "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
        "organizations_url": "https://api.github.com/users/nyxnor/orgs",
        "repos_url": "https://api.github.com/users/nyxnor/repos",
        "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nyxnor/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-10-02T22:35:21Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 1265328913,
      "node_id": "IC_kwDOABII585La2MR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265328913",
      "actor": {
        "login": "nyxnor",
        "id": 69700936,
        "node_id": "MDQ6VXNlcjY5NzAwOTM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nyxnor",
        "html_url": "https://github.com/nyxnor",
        "followers_url": "https://api.github.com/users/nyxnor/followers",
        "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
        "organizations_url": "https://api.github.com/users/nyxnor/orgs",
        "repos_url": "https://api.github.com/users/nyxnor/repos",
        "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nyxnor/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-10-03T11:52:25Z",
      "updated_at": "2022-10-03T11:52:25Z",
      "author_association": "NONE",
      "body": "I restarted the controller proxy several times, onion-grater is consistent with its replies or ServiceID, but bitcoind is not, it says authentication not supported even when the reply contained the ServiceID. Each of the spaced lines are a time I restarted the tor controller's proxy:\r\n```\r\ntor: Got service ID OLDONION, advertising service OLDONION.onion:8333\r\nAddLocal(OLDONION.onion:8333,4)\r\n\r\nRemoveLocal(OLDONION.onion:8333)\r\ntor: No supported authentication method \r\n\r\ntor: No supported authentication method\r\n\r\ntor: No supported authentication method\r\n\r\ntor: Got service ID ANOTHERONION, advertising service ANOTHERONION.onion:8333\r\nAddLocal(ANOTHERONION.onion:8333,4)\r\n```\r\n\r\nAnd for some reason, on the last it did work.\r\nI was solely restarting onion-grater, sometimes bitcoind can't authenticate, sometimes it can, which is very strange.",
      "user": {
        "login": "nyxnor",
        "id": 69700936,
        "node_id": "MDQ6VXNlcjY5NzAwOTM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nyxnor",
        "html_url": "https://github.com/nyxnor",
        "followers_url": "https://api.github.com/users/nyxnor/followers",
        "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
        "organizations_url": "https://api.github.com/users/nyxnor/orgs",
        "repos_url": "https://api.github.com/users/nyxnor/repos",
        "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nyxnor/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1265328913",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228"
    },
    {
      "event": "commented",
      "id": 1265379900,
      "node_id": "IC_kwDOABII585LbCo8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265379900",
      "actor": {
        "login": "nyxnor",
        "id": 69700936,
        "node_id": "MDQ6VXNlcjY5NzAwOTM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nyxnor",
        "html_url": "https://github.com/nyxnor",
        "followers_url": "https://api.github.com/users/nyxnor/followers",
        "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
        "organizations_url": "https://api.github.com/users/nyxnor/orgs",
        "repos_url": "https://api.github.com/users/nyxnor/repos",
        "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nyxnor/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-10-03T12:38:23Z",
      "updated_at": "2022-10-03T12:38:23Z",
      "author_association": "NONE",
      "body": "Enabled tor debugging for bitcoind:\r\n```\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: Authentication successful\r\ntor: ADD_ONION successful\r\ntor: Got service ID OLDONION, advertising service OLDONION.onion:8333\r\n```\r\nrestarting the controller proxy\r\n```\r\ntor: End of stream\r\nRemoveLocal(OLDONION.onion:8333)\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: End of stream\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: No supported authentication method\r\n```\r\nand controller logs:\r\n```\r\n-> PROTOCOLINFO 1\r\n<- 250-PROTOCOLINFO 1\r\n<- 250-AUTH METHODS=NULL\r\n<- 250-VERSION Tor=\"0.4.7.10\"\r\n<- 250 OK\r\n-> AUTHENTICATE\r\n<- 250 OK\r\n```\r\n`->` client commands to the controller\r\n`<-` controller replies to the client\r\n\r\nYou can see bitcoind tries to use the NULL method that doesn't require a pass or cookie, and the controller let's bitcoind authenticate, but bitcoind does not\r\n\r\nSometimes bitcoind understand it can authenticate (`Authentication successful`), but then logs `No supported authentication method`, not creating the onion.\r\n```\r\ntor: Error connecting to Tor control socket\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Error connecting to Tor control socket\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Authentication successful\r\ntor: No supported authentication method\r\n```\r\nand by some change (which appear to be random), sometimes bitcoind gets the onion and uses it:\r\n```\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: Authentication successful\r\ntor: ADD_ONION successful\r\ntor: Got service ID NEWONION, advertising service NEWONION.onion:8333\r\n```\r\n\r\nTLDR:\r\n\r\nBitcoind always can get the onion after it is restarted.\r\nIf the onion is no long available because the controller connection closes for a second, then when it is available again, bitcoind can't get the onion hostname (ServiceID) reliably, sometimes it can, sometimes it can't and the controller is always replying, bitcoind doesn't get it sometimes for some reason.",
      "user": {
        "login": "nyxnor",
        "id": 69700936,
        "node_id": "MDQ6VXNlcjY5NzAwOTM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/69700936?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nyxnor",
        "html_url": "https://github.com/nyxnor",
        "followers_url": "https://api.github.com/users/nyxnor/followers",
        "following_url": "https://api.github.com/users/nyxnor/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nyxnor/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nyxnor/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nyxnor/subscriptions",
        "organizations_url": "https://api.github.com/users/nyxnor/orgs",
        "repos_url": "https://api.github.com/users/nyxnor/repos",
        "events_url": "https://api.github.com/users/nyxnor/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nyxnor/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1265379900",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26228"
    },
    {
      "event": "comment_deleted",
      "id": 7513547653,
      "node_id": "CDE_lADOABII585TFYtWzwAAAAG_16OF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7513547653",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-10-04T07:28:41Z"
    }
  ]
}