{
  "type": "issue",
  "issue": {
    "id": 23009897,
    "node_id": "MDU6SXNzdWUyMzAwOTg5Nw==",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/3290",
    "number": 3290,
    "state": "closed",
    "state_reason": "completed",
    "title": "pindexFirst->prev can overstep bounds in GetNextWorkRequired",
    "body": "Regarding the \"Mac Corruption Bug\" as discussed here:\n\nhttps://bitcointalk.org/index.php?topic=337294\n\nI noticed a number of people quoting this kind of error:\n\nAssertion failed: (pindexFirst), function GetNextWorkRequired, file ../litecoin/src/main.cpp, line 1149.\n\nThe relevant code in Bitcoin is in src/main.cpp:1026 (as of commit d980f9b7d687a1e60eecf3691b592d9806a30f4a):\n\n```\n// Go back by what we want to be 14 days worth of blocks\nconst CBlockIndex* pindexFirst = pindexLast;\nfor (int i = 0; pindexFirst && i < nInterval-1; i++)\n    pindexFirst = pindexFirst->pprev;\nassert(pindexFirst);\n```\n\nI assume that the error is due to the # of pindexFirst->pprev links being less than nInterval-1.  In that scenario, this code would walk pindexFirst all the way back until pprev is NULL.   The code then is faulty in that it is overstepping the walking back of pindexFirst by one.  Recommended code fix is to change the test as below:\n\n```\n// Go back by what we want to be 14 days worth of blocks\nconst CBlockIndex* pindexFirst = pindexLast;\nfor (int i = 0; pindexFirst->pprev && i < nInterval-1; i++)\n    pindexFirst = pindexFirst->pprev;\nassert(pindexFirst);\n```\n\nThe check for pindexLast being NULL is done in line 1031, so we are safe to check pindexFirst->pprev.\n\nlaanwj: edited title, as this is not about the mac corruption bug\n",
    "user": {
      "login": "kunstmusik",
      "id": 1622139,
      "node_id": "MDQ6VXNlcjE2MjIxMzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1622139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kunstmusik",
      "html_url": "https://github.com/kunstmusik",
      "followers_url": "https://api.github.com/users/kunstmusik/followers",
      "following_url": "https://api.github.com/users/kunstmusik/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/kunstmusik/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/kunstmusik/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/kunstmusik/subscriptions",
      "organizations_url": "https://api.github.com/users/kunstmusik/orgs",
      "repos_url": "https://api.github.com/users/kunstmusik/repos",
      "events_url": "https://api.github.com/users/kunstmusik/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/kunstmusik/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 234879,
        "node_id": "MDU6TGFiZWwyMzQ4Nzk=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/macOS",
        "name": "macOS",
        "description": "",
        "color": "660000",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 4,
    "closed_at": "2014-05-06T09:30:03Z",
    "created_at": "2013-11-20T18:11:05Z",
    "updated_at": "2021-09-08T12:20:13Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 32618429,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjE4NDI5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/32618429",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-01-17T16:06:35Z",
      "updated_at": "2014-01-17T16:06:35Z",
      "author_association": "MEMBER",
      "body": "I think this fix makes sense, unless it's supposed to be a fatal error to end up in GetWorkRequired without at least two weeks of blocks.\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3290#issuecomment-32618429",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290"
    },
    {
      "event": "commented",
      "id": 32625006,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjI1MDA2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/32625006",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-01-17T17:18:07Z",
      "updated_at": "2014-01-17T17:18:07Z",
      "author_association": "MEMBER",
      "body": "This fix will just mask another problem.\n\nThe first part of the function determines whether a retarget is necessary, which is only when the parent's block height + 1 is a multiple of 2016.\n\nThe assertion fails if we end up at NULL by going back 2015 blocks, which should always be safe, as the earliest height at which a reorg is necessary, is at height 2015.\n\nMy guess is that either the CBlockIndex tree is total garbage, or we have a block with height == -1.\n",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3290#issuecomment-32625006",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290"
    },
    {
      "event": "commented",
      "id": 32630985,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjMwOTg1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/32630985",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-01-17T18:19:58Z",
      "updated_at": "2014-01-17T18:19:58Z",
      "author_association": "MEMBER",
      "body": "This is a very common way that database corruption is detected.\n\nMaybe we could make an blockdberror_assert() function that offers to reindex when it is triggered.\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3290#issuecomment-32630985",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290"
    },
    {
      "event": "commented",
      "id": 42282516,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjgyNTE2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/42282516",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-05-06T09:30:03Z",
      "updated_at": "2014-05-06T09:30:03Z",
      "author_association": "MEMBER",
      "body": "The Mac leveldb corruption bug has been solved.\n\nThere is already another issue for improving leveldb error reporting/offer rebuilds instead of assertion errors: #2202 . Closing this one.\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3290#issuecomment-42282516",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3290"
    },
    {
      "event": "closed",
      "id": 118161272,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTE4MTYxMjcy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/118161272",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-05-06T09:30:03Z"
    },
    {
      "event": "referenced",
      "id": 3213220476,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDMyMTMyMjA0NzY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3213220476",
      "actor": {
        "login": "Bushstar",
        "id": 5293433,
        "node_id": "MDQ6VXNlcjUyOTM0MzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5293433?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Bushstar",
        "html_url": "https://github.com/Bushstar",
        "followers_url": "https://api.github.com/users/Bushstar/followers",
        "following_url": "https://api.github.com/users/Bushstar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Bushstar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Bushstar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Bushstar/subscriptions",
        "organizations_url": "https://api.github.com/users/Bushstar/orgs",
        "repos_url": "https://api.github.com/users/Bushstar/repos",
        "events_url": "https://api.github.com/users/Bushstar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Bushstar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "3c54f652786f44e1e2b1bd5de184c57a224254cf",
      "commit_url": "https://api.github.com/repos/Bushstar/omnicore/commits/3c54f652786f44e1e2b1bd5de184c57a224254cf",
      "created_at": "2020-04-08T09:10:48Z"
    },
    {
      "event": "referenced",
      "id": 3214893000,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDMyMTQ4OTMwMDA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3214893000",
      "actor": {
        "login": "Bushstar",
        "id": 5293433,
        "node_id": "MDQ6VXNlcjUyOTM0MzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5293433?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Bushstar",
        "html_url": "https://github.com/Bushstar",
        "followers_url": "https://api.github.com/users/Bushstar/followers",
        "following_url": "https://api.github.com/users/Bushstar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Bushstar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Bushstar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Bushstar/subscriptions",
        "organizations_url": "https://api.github.com/users/Bushstar/orgs",
        "repos_url": "https://api.github.com/users/Bushstar/repos",
        "events_url": "https://api.github.com/users/Bushstar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Bushstar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "7d39637b024cd347fac86bcb26cbe55a993e78d7",
      "commit_url": "https://api.github.com/repos/Bushstar/omnicore/commits/7d39637b024cd347fac86bcb26cbe55a993e78d7",
      "created_at": "2020-04-08T16:29:41Z"
    },
    {
      "event": "locked",
      "id": 5271937323,
      "node_id": "LOE_lADOABII584BXxppzwAAAAE6O2Er",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5271937323",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:20:13Z",
      "lock_reason": "resolved"
    }
  ]
}