{
  "type": "issue",
  "issue": {
    "id": 24804873,
    "node_id": "MDU6SXNzdWUyNDgwNDg3Mw==",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/3465",
    "number": 3465,
    "state": "closed",
    "state_reason": "completed",
    "title": "[RFC] Post-0.9 network/protocol/main refactor",
    "body": "Just writing this idea down, to get comments on it and let it materialize before we actually have time to implement it.\n\nCurrently, there is very weak separation of concerns between net.cpp, protocol.cpp and main.cpp. I believe there are 4 separate ones distinguishable:\n- Management of I/O between sockets and buffers, and peer management (mostly net.cpp).\n- Definition of the actual P2P messages, their (de)serialization, and perhaps some basic sanity checking on them (protocol.cpp, net.cpp and main.cpp).\n- Processing and interaction of P2P messages with the validation engine (datastructures mostly in net, code mostly in main).\n- Actual validation (main).\n\nI'd very much like to see these as separate modules with well-defined responsibilities:\n1) The \"peer interaction\" layer, which manages connections and network buffers, and does not expose any internal CNode data structure. It only allows writing to and reading from NodeId's, and management of the set of peers.\n2) The bitcoin P2P layer, which uses serialize.h and core.h to serialize/deserialize p2p messages. It probably has methods for sending any type of P2P message to peers, and signals for processing every incoming message type.\n3) The core validation engine (which manages the block tree, chain state, ..., but nothing peer-related). This has probably methods for processing a block or a transaction or a header (ProcessBlock, AcceptToMemoryPool, ...), and signals for notifying higher layers about blocks being connected/disconnected (probably with a distinction between internal changes, and public ones - the latter only trigger after a full succesful reorganization).\n4) The core-p2p glue, which depends both on main and the p2p layer, and maintains per-peer (indexed by NodeId) data relevant to interaction (almost all of CNode's current fields).\n\nFor example:\n- The set of banned IPs is in 1.\n- The definition of the message block and computation of the checksum is in 2.\n- Logic for connecting and disconnecting blocks is in 3.\n- Per-peer DoS scores are in 4.\n- IsInitialBlockDownload is in 4.\n\nOpen questions:\n- Join 1 and 2? In Bitcoin's context they are unlikely to be swapped without swapping the other. However:\n  - There could be different implementations of 1 for deeply different types of communication backend (from a local file, over freenet, from a satellite receiver, ...).\n  - There could be a bitcoin protocol v2, mostly rewritten from scratch, that can still be relayed over different types of networks.\n- Thread management. Where is the \"controller\" thread? If it is in 4, it means that other modules can not as easily plug into 2, as they become dependent on having a 4 present. On the other hand, making 2 the controller itself removes the knowledge about locking requirements in 4 from it.\n",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64584,
        "node_id": "MDU6TGFiZWw2NDU4NA==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
        "name": "Brainstorming",
        "color": "ebd775",
        "default": false
      },
      {
        "id": 135961,
        "node_id": "MDU6TGFiZWwxMzU5NjE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
        "name": "Refactoring",
        "color": "E6F6D6",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 3,
    "closed_at": "2017-12-06T21:58:26Z",
    "created_at": "2013-12-27T01:16:44Z",
    "updated_at": "2021-09-08T12:26:58Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 31253108,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMxMjUzMTA4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/31253108",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2013-12-27T08:58:50Z",
      "updated_at": "2013-12-27T08:58:50Z",
      "author_association": "MEMBER",
      "body": "Good points, agreed on the concept. \n\nEspecially separating out (3) and making it self-contained is important, as the validation part is what makes Bitcoin, and having it as a library would encourage diversity in clients. Other clients will want to have their own implementation of P2P network handling and the glue parts. \n\nRe: questions\n- Joining 1 and 2 makes sense. They could later be split if it becomes necessary, but planning forward too much for cases that aren't completely thought through is seldom constructive.\n- Seems safe to assume that that 4 (the glue) is always present if 1+2 are present. No matter how the other modules change, there will always be some glue needed to connect the P2P network to the validation engine.\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3465#issuecomment-31253108",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465"
    },
    {
      "event": "commented",
      "id": 31264673,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMxMjY0Njcz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/31264673",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2013-12-27T15:08:56Z",
      "updated_at": "2013-12-27T15:08:56Z",
      "author_association": "MEMBER",
      "body": "Indeed, clearly separating validation is a very nice goal on itself.\n\nAgree on keeping 1 and 2 together initially.\n\nRegarding 4 being present... what if I wanted to port bitcoin-seeder to run as a module using the Bitcoin reference codebase? It would use 1/2, but not 3/4.\n",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3465#issuecomment-31264673",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465"
    },
    {
      "event": "commented",
      "id": 274556159,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI3NDU1NjE1OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/274556159",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-01-23T17:26:08Z",
      "updated_at": "2017-01-23T17:26:08Z",
      "author_association": "MEMBER",
      "body": "3 and 4 have been separated in #9260.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3465#issuecomment-274556159",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3465"
    },
    {
      "event": "unlabeled",
      "id": 1374860094,
      "node_id": "MDE0OlVubGFiZWxlZEV2ZW50MTM3NDg2MDA5NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1374860094",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-12-06T14:16:40Z",
      "label": {
        "name": "Priority Low",
        "color": "ededed"
      }
    },
    {
      "event": "closed",
      "id": 1375747851,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTM3NTc0Nzg1MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1375747851",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-12-06T21:58:26Z"
    },
    {
      "event": "locked",
      "id": 5271973269,
      "node_id": "LOE_lADOABII584Ben4JzwAAAAE6O-2V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5271973269",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:26:58Z",
      "lock_reason": "resolved"
    }
  ]
}