{
  "type": "issue",
  "issue": {
    "id": 62396469,
    "node_id": "MDU6SXNzdWU2MjM5NjQ2OQ==",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/5917",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/5917/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/5917/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/5917/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/5917",
    "number": 5917,
    "state": "closed",
    "state_reason": "completed",
    "title": "ADDRMAN_GETADDR_MAX vs. MAX_ADDR_TO_SEND",
    "body": "Hello,\nlooking at the code which responds to a `getaddr`-message, I discovered that `addrman.GetAddr()` is only called once in main.cpp (see https://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L4054) to get addresses which are then queued via `PushAddress()`.\n`GetAddr_` returns random 23% (`ADDRMAN_GETADDR_MAX_PCT`) of the addrman's stored addresses, but no more than 2500.\nBut `PushAddress()` checks again against `MAX_ADDR_TO_SEND` which is 1000, as receiving nodes reject `addr` messages with a payload larger than 1000 addresses. And it replaces random addresses if the vector already has 1000 in it.\n\nThen, in `SendMessages()`, the addresses-vector is split again before sending in packages of 1000 addresses (but it should never be bigger than 1000, as `PushAddress()` already checked that?!).\n\nSo the number of addresses returned is 2500, then we select 1000 randomly out of these, then we check if they are more then 1000 (probably always false) and split the vector if they are, before we send them.\n\nI propose to get rid of one of the constants (I'd say `MAX_ADDR_TO_SEND`), and reduce `ADDRMAN_GETADDR_MAX` to 1000. \n\nWhat do you say? Am I missing something, or is this chain of reducing addresses just confusing bloat which can go away? See my pull request for minimal change, maybe some of the redundant checks can be removed, also?\n\nBest Regards!\n",
    "user": {
      "login": "tnull",
      "id": 521467,
      "node_id": "MDQ6VXNlcjUyMTQ2Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/521467?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tnull",
      "html_url": "https://github.com/tnull",
      "followers_url": "https://api.github.com/users/tnull/followers",
      "following_url": "https://api.github.com/users/tnull/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/tnull/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/tnull/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/tnull/subscriptions",
      "organizations_url": "https://api.github.com/users/tnull/orgs",
      "repos_url": "https://api.github.com/users/tnull/repos",
      "events_url": "https://api.github.com/users/tnull/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/tnull/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 0,
    "closed_at": "2015-03-20T10:29:16Z",
    "created_at": "2015-03-17T13:26:45Z",
    "updated_at": "2021-09-08T12:21:54Z"
  },
  "events": [
    {
      "event": "closed",
      "id": 260324356,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjYwMzI0MzU2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/260324356",
      "actor": {
        "login": "tnull",
        "id": 521467,
        "node_id": "MDQ6VXNlcjUyMTQ2Nw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/521467?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tnull",
        "html_url": "https://github.com/tnull",
        "followers_url": "https://api.github.com/users/tnull/followers",
        "following_url": "https://api.github.com/users/tnull/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/tnull/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/tnull/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/tnull/subscriptions",
        "organizations_url": "https://api.github.com/users/tnull/orgs",
        "repos_url": "https://api.github.com/users/tnull/repos",
        "events_url": "https://api.github.com/users/tnull/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/tnull/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2015-03-20T10:29:16Z"
    },
    {
      "event": "locked",
      "id": 5271946232,
      "node_id": "LOE_lADOABII584DuBg1zwAAAAE6O4P4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5271946232",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:21:54Z",
      "lock_reason": "resolved"
    }
  ]
}