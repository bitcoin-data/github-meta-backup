{
  "type": "issue",
  "issue": {
    "id": 394867349,
    "node_id": "MDU6SXNzdWUzOTQ4NjczNDk=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/15066",
    "number": 15066,
    "state": "closed",
    "state_reason": "completed",
    "title": "Unexpected dbcache behavior: complete invalidation after size limit is hit",
    "body": "<!-- Describe the issue -->\r\nI'm syncing a self compiled 0.17.0.1 node currently on my raspberry pi running raspbian and noticed a behavior wrt caching I can't explain. dbcache is set to 100MiB, which adds up to ~350MiB of cache incl the mempool extra of 250MiB. So far so good, bitcoind allocates ~800MB of ram which fits nicely into the pi's 1gb ram. I see the cache size grow as the node consumes blocks, but once cache is full, 2 strange things happen:\r\n\r\n1. cache size drops to zero and starts building up again. What I expect the system to do is pruning old cache entries by age or LRU or whatever, so the cache size stays roughly at max. I can see average block processing times raise from <10sec when cache is nearly full to ~20sec when cache is emptied and builds up again.\r\n\r\n2. Dropping the cache takes ~4min in which no blocks are processed. Why is that? dropping an in memory index and creating a new empty one should take milliseconds at best. Or is there more going on? However, there should be no drops at all in the first place imho.\r\n\r\nI made a pastebin of my debug.log entries (debug=1) at the time of the last 2 blocks where cache is building up to max size and the following 2 blocks after cache starts to rebuild again: https://pastebin.com/Z38MmgXj Can anyone enlighten me what and why this is happening?\r\n\r\nAdditional Info:\r\ndeamon starting command line: /usr/local/bin/bitcoind -conf=/home/bitcoin/.bitcoin/bitcoin.conf -pid=/home/bitcoin/.bitcoin/bitcoind.pid\r\n\r\nand bitcoin.conf:\r\ndaemon=1\r\nlogips=1\r\nmaxconnections=40\r\nmaxuploadtarget=5000\r\ntxindex=1\r\nrest=1\r\nserver=1\r\nwalletrbf=1\r\ndbcache=100",
    "user": {
      "login": "FieserKiller",
      "id": 8994134,
      "node_id": "MDQ6VXNlcjg5OTQxMzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8994134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/FieserKiller",
      "html_url": "https://github.com/FieserKiller",
      "followers_url": "https://api.github.com/users/FieserKiller/followers",
      "following_url": "https://api.github.com/users/FieserKiller/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/FieserKiller/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/FieserKiller/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/FieserKiller/subscriptions",
      "organizations_url": "https://api.github.com/users/FieserKiller/orgs",
      "repos_url": "https://api.github.com/users/FieserKiller/repos",
      "events_url": "https://api.github.com/users/FieserKiller/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/FieserKiller/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 2,
    "closed_at": "2018-12-30T13:36:52Z",
    "created_at": "2018-12-30T12:12:10Z",
    "updated_at": "2021-09-08T12:45:59Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 450560824,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MDU2MDgyNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/450560824",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-12-30T13:28:51Z",
      "updated_at": "2018-12-30T13:28:51Z",
      "author_association": "MEMBER",
      "body": "This is expected behavior. The \"cache\" is in fact a combined read cache and write buffer, meaning that a significant portion of the cache actually contains modified entries that haven't been written to disk yet.\r\n\r\nWhenever the size of the cache grows too large, all modified entries are written to disk. This interrupts the normal validation for now, due to complexities around keeping the state on disk consistent.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15066#issuecomment-450560824",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066"
    },
    {
      "event": "commented",
      "id": 450561318,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MDU2MTMxOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/450561318",
      "actor": {
        "login": "FieserKiller",
        "id": 8994134,
        "node_id": "MDQ6VXNlcjg5OTQxMzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8994134?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/FieserKiller",
        "html_url": "https://github.com/FieserKiller",
        "followers_url": "https://api.github.com/users/FieserKiller/followers",
        "following_url": "https://api.github.com/users/FieserKiller/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/FieserKiller/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/FieserKiller/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/FieserKiller/subscriptions",
        "organizations_url": "https://api.github.com/users/FieserKiller/orgs",
        "repos_url": "https://api.github.com/users/FieserKiller/repos",
        "events_url": "https://api.github.com/users/FieserKiller/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/FieserKiller/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-12-30T13:36:52Z",
      "updated_at": "2018-12-30T13:36:52Z",
      "author_association": "NONE",
      "body": "Alright, thx",
      "user": {
        "login": "FieserKiller",
        "id": 8994134,
        "node_id": "MDQ6VXNlcjg5OTQxMzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8994134?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/FieserKiller",
        "html_url": "https://github.com/FieserKiller",
        "followers_url": "https://api.github.com/users/FieserKiller/followers",
        "following_url": "https://api.github.com/users/FieserKiller/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/FieserKiller/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/FieserKiller/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/FieserKiller/subscriptions",
        "organizations_url": "https://api.github.com/users/FieserKiller/orgs",
        "repos_url": "https://api.github.com/users/FieserKiller/repos",
        "events_url": "https://api.github.com/users/FieserKiller/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/FieserKiller/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15066#issuecomment-450561318",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15066"
    },
    {
      "event": "closed",
      "id": 2048424889,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjA0ODQyNDg4OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2048424889",
      "actor": {
        "login": "FieserKiller",
        "id": 8994134,
        "node_id": "MDQ6VXNlcjg5OTQxMzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8994134?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/FieserKiller",
        "html_url": "https://github.com/FieserKiller",
        "followers_url": "https://api.github.com/users/FieserKiller/followers",
        "following_url": "https://api.github.com/users/FieserKiller/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/FieserKiller/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/FieserKiller/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/FieserKiller/subscriptions",
        "organizations_url": "https://api.github.com/users/FieserKiller/orgs",
        "repos_url": "https://api.github.com/users/FieserKiller/repos",
        "events_url": "https://api.github.com/users/FieserKiller/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/FieserKiller/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-12-30T13:36:52Z"
    },
    {
      "event": "locked",
      "id": 5272076258,
      "node_id": "LOE_lADOABII584XiTKVzwAAAAE6PX_i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5272076258",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:45:59Z",
      "lock_reason": "resolved"
    }
  ]
}