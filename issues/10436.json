{
  "type": "issue",
  "issue": {
    "id": 230162483,
    "node_id": "MDU6SXNzdWUyMzAxNjI0ODM=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/10436",
    "number": 10436,
    "state": "closed",
    "state_reason": "completed",
    "title": "Disconnected clients fill rpcworkqueue, block json-rpc",
    "body": "### Describe the issue\r\nRequests are kept waiting even after clients disconnect. The queue can go full, blocking further json-rpc calls. Usually not a problem, except when long polling. Long polling getblocktemplate will hold a slot until another block has been received. \r\n\r\n### Can you reliably reproduce the issue?\r\n#### If so, please list the steps to reproduce below:\r\n1. Long poll getblocktemplate\r\n2. Disconnect\r\n3. Repeat 1+2 until requests fail\r\n\r\n### Expected behaviour\r\nWorking json-rpc.\r\n\r\nSuggestion: throw away requests from disconnected clients. Maybe reserve some slots for quick (non long polling) requests so long polling requests can't as easily lock up json-rpc.\r\n\r\n### Actual behaviour\r\nAfter the long polling client reconnects a few times, there is the following error:\r\n\r\nWARNING: request rejected because http work queue depth exceeded, it can be increased with the -rpcworkqueue= setting\r\n\r\n### What version of bitcoin-core are you using?\r\n0.14.1\r\n",
    "user": {
      "login": "DrHaribo",
      "id": 854778,
      "node_id": "MDQ6VXNlcjg1NDc3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/854778?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrHaribo",
      "html_url": "https://github.com/DrHaribo",
      "followers_url": "https://api.github.com/users/DrHaribo/followers",
      "following_url": "https://api.github.com/users/DrHaribo/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/DrHaribo/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/DrHaribo/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/DrHaribo/subscriptions",
      "organizations_url": "https://api.github.com/users/DrHaribo/orgs",
      "repos_url": "https://api.github.com/users/DrHaribo/repos",
      "events_url": "https://api.github.com/users/DrHaribo/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/DrHaribo/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 4,
    "closed_at": "2020-04-26T01:11:11Z",
    "created_at": "2017-05-20T16:03:08Z",
    "updated_at": "2022-02-15T11:02:48Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 1090579642,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDEwOTA1Nzk2NDI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1090579642",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-20T16:04:23Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    },
    {
      "event": "commented",
      "id": 303050860,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMwMzA1MDg2MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/303050860",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-22T09:39:49Z",
      "updated_at": "2017-05-22T09:39:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "are you sure you're actually disconnecting?  some http libraries are broken and leave the connections up.",
      "user": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10436#issuecomment-303050860",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436"
    },
    {
      "event": "commented",
      "id": 330983987,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMzMDk4Mzk4Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/330983987",
      "actor": {
        "login": "DrHaribo",
        "id": 854778,
        "node_id": "MDQ6VXNlcjg1NDc3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/854778?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrHaribo",
        "html_url": "https://github.com/DrHaribo",
        "followers_url": "https://api.github.com/users/DrHaribo/followers",
        "following_url": "https://api.github.com/users/DrHaribo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrHaribo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrHaribo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrHaribo/subscriptions",
        "organizations_url": "https://api.github.com/users/DrHaribo/orgs",
        "repos_url": "https://api.github.com/users/DrHaribo/repos",
        "events_url": "https://api.github.com/users/DrHaribo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrHaribo/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-09-20T21:18:24Z",
      "updated_at": "2017-09-20T21:18:24Z",
      "author_association": "NONE",
      "body": "Yes, I'm sure I'm disconnecting.\r\n\r\nI have a simple regtest network set up with 2 nodes. I have bit1 and bit2 shell commands to run bitcoin-cli for the two separate nodes.\r\n\r\nFirst I run \"bit1 getblocktemplate\" to get a longpollid. Then I construct a simple longpoll request ala:\r\n```\r\nPOST / HTTP/1.0\r\nHost: localhost\r\nAuthorization: Basic BASE64-AUTH-HERE\r\nContent-Length: 131\r\n\r\n{\"method\":\"getblocktemplate\",\"params\":[{\"longpollid\":\"3bb959dad7927110f61d66b60cbf185513adf3b7e0a1879d672e82d2f41660f252\"}],\"id\":1}\r\n```\r\n\r\nNow in one window I telnet to the rpc port of the bit1 node and paste in this request. In another window I do \"killall telnet\" to disconnect. I repeat this a few times to fill all the slots.\r\n\r\nAt this point all the telnet processes are dead. There is no active connection to the RPC port.\r\n\r\nNow I do \"bit1 getinfo\" in one window. It hangs. No RPC works with node 1 at this point.\r\nThen in another window I do \"bit2 generate 1\". Now the \"bit1 getinfo\" completes. As soon as node 1 receives a block from node 2 the longpoll is triggered and all slots are freed up. RPC works again.\r\n",
      "user": {
        "login": "DrHaribo",
        "id": 854778,
        "node_id": "MDQ6VXNlcjg1NDc3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/854778?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrHaribo",
        "html_url": "https://github.com/DrHaribo",
        "followers_url": "https://api.github.com/users/DrHaribo/followers",
        "following_url": "https://api.github.com/users/DrHaribo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrHaribo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrHaribo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrHaribo/subscriptions",
        "organizations_url": "https://api.github.com/users/DrHaribo/orgs",
        "repos_url": "https://api.github.com/users/DrHaribo/repos",
        "events_url": "https://api.github.com/users/DrHaribo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrHaribo/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10436#issuecomment-330983987",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436"
    },
    {
      "event": "commented",
      "id": 619463004,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYxOTQ2MzAwNA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619463004",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-26T01:11:03Z",
      "updated_at": "2020-04-26T01:11:03Z",
      "author_association": "MEMBER",
      "body": "I've created more than 100 longpolls, but couldn't reproduce.\r\n\r\nThis was the diff I used:\r\n\r\n```diff\r\ndiff --git a/test/functional/mining_getblocktemplate_longpoll.py b/test/functional/mining_getblocktemplate_longpoll.py\r\nindex 6d0b241e57..eacf71cf22 100755\r\n--- a/test/functional/mining_getblocktemplate_longpoll.py\r\n+++ b/test/functional/mining_getblocktemplate_longpoll.py\r\n@@ -9,20 +9,19 @@ from decimal import Decimal\r\n from test_framework.test_framework import BitcoinTestFramework\r\n from test_framework.util import get_rpc_proxy, random_transaction\r\n \r\n+from multiprocessing import Process\r\n+\r\n import threading\r\n \r\n-class LongpollThread(threading.Thread):\r\n-    def __init__(self, node):\r\n-        threading.Thread.__init__(self)\r\n+def LongpollThread(node):\r\n         # query current longpollid\r\n         template = node.getblocktemplate({'rules': ['segwit']})\r\n-        self.longpollid = template['longpollid']\r\n+        longpollid = template['longpollid']\r\n         # create a new connection to the node, we can't use the same\r\n         # connection from two threads\r\n-        self.node = get_rpc_proxy(node.url, 1, timeout=600, coveragedir=node.coverage_dir)\r\n+        node = get_rpc_proxy(node.url, 1, timeout=600, coveragedir=node.coverage_dir)\r\n \r\n-    def run(self):\r\n-        self.node.getblocktemplate({'longpollid': self.longpollid, 'rules': ['segwit']})\r\n+        node.getblocktemplate({'longpollid': longpollid, 'rules': ['segwit']})\r\n \r\n class GetBlockTemplateLPTest(BitcoinTestFramework):\r\n     def set_test_params(self):\r\n@@ -42,8 +41,13 @@ class GetBlockTemplateLPTest(BitcoinTestFramework):\r\n         assert template2['longpollid'] == longpollid\r\n \r\n         # Test 1: test that the longpolling wait if we do nothing\r\n-        thr = LongpollThread(self.nodes[0])\r\n-        thr.start()\r\n+        for i in range(1000):\r\n+         print(i)\r\n+         p = Process(target=LongpollThread,args=(self.nodes[0],))\r\n+         p.start()\r\n+         import time\r\n+         time.sleep(1)\r\n+         p.terminate()\r\n         # check that thread still lives\r\n         thr.join(5)  # wait 5 seconds or until thread exits\r\n         assert thr.is_alive()\r\n",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10436#issuecomment-619463004",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436"
    },
    {
      "event": "commented",
      "id": 619463010,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYxOTQ2MzAxMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619463010",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-26T01:11:11Z",
      "updated_at": "2020-04-26T01:11:11Z",
      "author_association": "MEMBER",
      "body": "Is this still an issue with a recent version of Bitcoin Core? If yes, what are the steps to reproduce?",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10436#issuecomment-619463010",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10436"
    },
    {
      "event": "closed",
      "id": 3272427659,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzI3MjQyNzY1OQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3272427659",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-26T01:11:11Z"
    },
    {
      "event": "locked",
      "id": 6074004430,
      "node_id": "LOE_lADOABII584NuAAzzwAAAAFqCfPO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6074004430",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T11:02:48Z",
      "lock_reason": "resolved"
    }
  ]
}