{
  "type": "issue",
  "issue": {
    "id": 433286720,
    "node_id": "MDU6SXNzdWU0MzMyODY3MjA=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/15819",
    "number": 15819,
    "state": "closed",
    "state_reason": "completed",
    "title": "macOS: crash while loading wallet with berkeley-db@4",
    "body": "On macOS 10.14.4 with Homebrew berkeley-db@4 4.8.30 using master (4f4ef3138b06b405d9d8877ddc4a3492a2512c41) `bitcoind` crashes when loading an existing wallet or creating a new one.\r\n\r\n```\r\n2019-04-15T10:28:15Z init message: Verifying wallet(s)...\r\n2019-04-15T10:28:15Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n2019-04-15T10:28:15Z Using wallet /Users/bitcoin/Library/Application Support/Bitcoin/testnet3/wallets/A\r\n2019-04-15T10:28:15Z BerkeleyEnvironment::Open: LogDir=/Users/bitcoin/Library/Application Support/Bitcoin/testnet3/wallets/A/database ErrorFile=/Users/bitcoin/Library/Application Support/Bitcoin/testnet3/wallets/A/db.log\r\nProcess 87520 stopped\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x10000)\r\n    frame #0: 0x0000000102445d8e libdb_cxx-4.8.dylib`__lock_get_lk_max_locks + 53\r\nlibdb_cxx-4.8.dylib`__lock_get_lk_max_locks:\r\n->  0x102445d8e <+53>: movl   %eax, (%rsi)\r\n    0x102445d90 <+55>: xorl   %eax, %eax\r\n    0x102445d92 <+57>: popq   %rbp\r\n    0x102445d93 <+58>: retq\r\nTarget 0: (bitcoind) stopped.\r\n(lldb) bt\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x10000)\r\n  * frame #0: 0x0000000102445d8e libdb_cxx-4.8.dylib`__lock_get_lk_max_locks + 53\r\n    frame #1: 0x00000001023c4afa libdb_cxx-4.8.dylib`DbEnv::get_lk_max_locks(unsigned int*) + 46\r\n    frame #2: 0x0000000100458dbf bitcoind`BerkeleyEnvironment::Open(this=<unavailable>, retry=<unavailable>) at db.cpp:195:12 [opt]\r\n    frame #3: 0x000000010045abab bitcoind`BerkeleyBatch::VerifyEnvironment(file_path=<unavailable>, errorStr=\"\") at db.cpp:417:15 [opt]\r\n    frame #4: 0x00000001004fb295 bitcoind`CWallet::Verify(chain=0x0000000102a02990, location=0x00007ffeefbfed50, salvage_wallet=false, error_string=\"\", warning_string=<unavailable>) at wallet.cpp:3972:14 [opt]\r\n    frame #5: 0x0000000100477628 bitcoind`VerifyWallets(chain=0x0000000102a02990, wallet_files=<unavailable>) at load.cpp:56:31 [opt]\r\n    frame #6: 0x00000001000727b9 bitcoind`AppInitMain(interfaces=<unavailable>) at init.cpp:1321:22 [opt]\r\n    frame #7: 0x0000000100004592 bitcoind`AppInit(argc=<unavailable>, argv=0x00007ffeefbff418) at bitcoind.cpp:171:16 [opt]\r\n    frame #8: 0x0000000100004042 bitcoind`main(argc=<unavailable>, argv=<unavailable>) at bitcoind.cpp:201:13 [opt]\r\n    frame #9: 0x00007fff7edfc3d5 libdyld.dylib`start + 1\r\n    frame #10: 0x00007fff7edfc3d5 libdyld.dylib`start + 1\r\n(lldb)\r\n```\r\n\r\nThe crash does not happen when using depends. It also does not happen with a more recent BDB version using `--with-incompatible-bdb` (this requires uninstalling berkeley-db@4).",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 234879,
        "node_id": "MDU6TGFiZWwyMzQ4Nzk=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/macOS",
        "name": "macOS",
        "description": "",
        "color": "660000",
        "default": false
      },
      {
        "id": 159815356,
        "node_id": "MDU6TGFiZWwxNTk4MTUzNTY=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Upstream",
        "name": "Upstream",
        "color": "bfd4f2",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 9,
    "closed_at": "2019-04-24T09:44:11Z",
    "created_at": "2019-04-15T13:36:22Z",
    "updated_at": "2022-02-15T11:16:34Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 2276631450,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDIyNzY2MzE0NTA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2276631450",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-15T13:37:15Z",
      "label": {
        "name": "macOS",
        "color": "660000"
      }
    },
    {
      "event": "commented",
      "id": 483255518,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzI1NTUxOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483255518",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-15T13:39:29Z",
      "updated_at": "2019-04-15T13:39:29Z",
      "author_association": "MEMBER",
      "body": "If nobody can reproduce this, I might try nuking and reinstalling Homebrew entirely.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-483255518",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 483258772,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzI1ODc3Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483258772",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-15T13:48:06Z",
      "updated_at": "2019-04-15T13:48:06Z",
      "author_association": "MEMBER",
      "body": "I presume the functional tests (and unit tests?) fail?",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-483258772",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "labeled",
      "id": 2276680752,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDIyNzY2ODA3NTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2276680752",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-15T13:52:29Z",
      "label": {
        "name": "Upstream",
        "color": "bfd4f2"
      }
    },
    {
      "event": "commented",
      "id": 483262387,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzI2MjM4Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483262387",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-15T13:57:13Z",
      "updated_at": "2019-04-15T13:57:13Z",
      "author_association": "MEMBER",
      "body": "I should add: I can run with `-nowallet` without a crash (until I load a wallet).\r\n\r\nFunctional tests fail. Most unit tests pass, but the PSBT one threw an error last time I tried.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-483262387",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 483563613,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzU2MzYxMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483563613",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-16T08:29:03Z",
      "updated_at": "2019-04-16T11:44:17Z",
      "author_association": "MEMBER",
      "body": "I'd be a bit surprised if the `brew` installed `berkeley-db@4` was the sole cause of this issue (fwiw I'm not seeing any issues with it and `master`). That formula has only changed a couple times over the last few years.\r\n\r\nThe most recent [change](https://github.com/Homebrew/homebrew-core/pull/32552) was to fix compiling with Xcode 10, which is just applying [this patch](https://raw.githubusercontent.com/Homebrew/formula-patches/4c55b1/berkeley-db%404/clang.diff). That patch is equivalent to what we apply in [depends](https://github.com/bitcoin/bitcoin/blob/598323911e930d67e678e464353eb570ad3bf2b7/depends/packages/bdb.mk#L17), and that we download in [contrib/install_db4.sh](https://github.com/bitcoin/bitcoin/blob/598323911e930d67e678e464353eb570ad3bf2b7/contrib/install_db4.sh#L68).\r\n\r\nIs it possible that you've (re)installed `berkeley-db@4`, or compiled with outdated Xcode/command line tools/macOS headers installed, and that could be the cause of the issue?\r\n\r\nDo you have a copy of that `A` env that others could test with? \r\n\r\n> If nobody can reproduce this, I might try nuking and reinstalling Homebrew entirely.\r\n\r\nI'd hold off on doing that (unless you have an easy way to reset to your current installed packages etc). What's the output of `brew doctor`?\r\nCan you try completely removing and installing `berkeley-db@4` and check if the issue persists?",
      "user": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-483563613",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 483624525,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzYyNDUyNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483624525",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-16T11:40:57Z",
      "updated_at": "2019-04-16T11:40:57Z",
      "author_association": "MEMBER",
      "body": "I don't think wallet A is interesting (though there's a good chance it was created with a newer BDB version), because it also crashed when creating a fresh wallet.\r\n\r\nI also don't think `berkeley-db@4` the sole cause. I tried removing and reinstalling `berkeley-db@4` (though not `berkeley-db` yet). I also didn't try older versions of master, so it's not even certain that anything there caused it.\r\n\r\n`brew doctor` doesn't show seem interesting, but [here it is](https://gist.github.com/Sjors/94e766a953d8d8966fa6eae94489f4d2).\r\n\r\nThe other strange thing is that when I remove `berkeley-db@4` and use `--with-incompatible-bdb` the following doesn't go away: `CPPFLAGS -I/usr/local/Cellar/berkeley-db@4`. That directory is empty. I tried both `make distclean` and `git clean -dfx` with no effect. ",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-483624525",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 486148798,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NjE0ODc5OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/486148798",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-24T09:44:11Z",
      "updated_at": "2019-04-24T09:44:11Z",
      "author_association": "MEMBER",
      "body": "I reinstalled all of Homebrew and also used `berkeley-db4` (as specified in the [docs]()) instead of `berkeley-db@4`. This results in a slightly different CPPFLAGS `-I/usr/local/opt/berkeley-db@4/include`. No more crash.\r\n\r\nThe [macOS build instructions](https://github.com/bitcoin/bitcoin/blob/master/doc/build-osx.md#dependencies) also specify `berkeley-db4`. I can't remember what the reason was that I switched to `berkeley-db@4`.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-486148798",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "closed",
      "id": 2296613256,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjI5NjYxMzI1Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2296613256",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-04-24T09:44:11Z"
    },
    {
      "event": "commented",
      "id": 491408000,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MTQwODAwMA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491408000",
      "actor": {
        "login": "jingzhehu",
        "id": 17802061,
        "node_id": "MDQ6VXNlcjE3ODAyMDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/17802061?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jingzhehu",
        "html_url": "https://github.com/jingzhehu",
        "followers_url": "https://api.github.com/users/jingzhehu/followers",
        "following_url": "https://api.github.com/users/jingzhehu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jingzhehu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jingzhehu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jingzhehu/subscriptions",
        "organizations_url": "https://api.github.com/users/jingzhehu/orgs",
        "repos_url": "https://api.github.com/users/jingzhehu/repos",
        "events_url": "https://api.github.com/users/jingzhehu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jingzhehu/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-05-10T19:42:23Z",
      "updated_at": "2019-05-10T19:42:23Z",
      "author_association": "NONE",
      "body": "I run into the same problems as Sjors - `make check` producing errors \r\n\r\n> fatal error: in \"psbt_wallet_tests/psbt_updater_test\": memory access violation at address: 0x02800000: no mapping at fault address\r\n\r\nAfter I did `brew uninstall berkeley-db; brew reinstall berkeley-db4` and `./autogen.sh && ./configure --without-gui && make -j16`, the `make check -j16` part passed without error. ",
      "user": {
        "login": "jingzhehu",
        "id": 17802061,
        "node_id": "MDQ6VXNlcjE3ODAyMDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/17802061?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jingzhehu",
        "html_url": "https://github.com/jingzhehu",
        "followers_url": "https://api.github.com/users/jingzhehu/followers",
        "following_url": "https://api.github.com/users/jingzhehu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jingzhehu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jingzhehu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jingzhehu/subscriptions",
        "organizations_url": "https://api.github.com/users/jingzhehu/orgs",
        "repos_url": "https://api.github.com/users/jingzhehu/repos",
        "events_url": "https://api.github.com/users/jingzhehu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jingzhehu/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-491408000",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 666959482,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY2Njk1OTQ4Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666959482",
      "actor": {
        "login": "jakeleventhal",
        "id": 15133828,
        "node_id": "MDQ6VXNlcjE1MTMzODI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/15133828?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jakeleventhal",
        "html_url": "https://github.com/jakeleventhal",
        "followers_url": "https://api.github.com/users/jakeleventhal/followers",
        "following_url": "https://api.github.com/users/jakeleventhal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jakeleventhal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jakeleventhal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jakeleventhal/subscriptions",
        "organizations_url": "https://api.github.com/users/jakeleventhal/orgs",
        "repos_url": "https://api.github.com/users/jakeleventhal/repos",
        "events_url": "https://api.github.com/users/jakeleventhal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jakeleventhal/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-07-31T06:45:44Z",
      "updated_at": "2020-07-31T06:45:44Z",
      "author_association": "CONTRIBUTOR",
      "body": "Seeing this same issue on the new Big Sur beta 3 for OS X\r\n```\r\nconfigure: WARNING: NO SHARED LATCH IMPLEMENTATION FOUND FOR THIS PLATFORM.\r\nconfigure: error: Unable to find a mutex implementation\r\n\r\nDo not report this issue to Homebrew/brew or Homebrew/core!\r\n\r\n\r\nError: You are using macOS 11.0.\r\nWe do not provide support for this pre-release version.\r\nYou will encounter build failures with some formulae.\r\nPlease create pull requests instead of asking for help on Homebrew's GitHub,\r\nDiscourse, Twitter or IRC. You are responsible for resolving any issues you\r\nexperience while you are running this pre-release version.\r\n```",
      "user": {
        "login": "jakeleventhal",
        "id": 15133828,
        "node_id": "MDQ6VXNlcjE1MTMzODI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/15133828?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jakeleventhal",
        "html_url": "https://github.com/jakeleventhal",
        "followers_url": "https://api.github.com/users/jakeleventhal/followers",
        "following_url": "https://api.github.com/users/jakeleventhal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jakeleventhal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jakeleventhal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jakeleventhal/subscriptions",
        "organizations_url": "https://api.github.com/users/jakeleventhal/orgs",
        "repos_url": "https://api.github.com/users/jakeleventhal/repos",
        "events_url": "https://api.github.com/users/jakeleventhal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jakeleventhal/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-666959482",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "commented",
      "id": 667232288,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzIzMjI4OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667232288",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-07-31T17:05:43Z",
      "updated_at": "2020-07-31T17:05:43Z",
      "author_association": "MEMBER",
      "body": "@jakeleventhal let's move that to #19406 or #19411; this is a different issue.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/15819#issuecomment-667232288",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15819"
    },
    {
      "event": "mentioned",
      "id": 3609446976,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzYwOTQ0Njk3Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3609446976",
      "actor": {
        "login": "jakeleventhal",
        "id": 15133828,
        "node_id": "MDQ6VXNlcjE1MTMzODI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/15133828?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jakeleventhal",
        "html_url": "https://github.com/jakeleventhal",
        "followers_url": "https://api.github.com/users/jakeleventhal/followers",
        "following_url": "https://api.github.com/users/jakeleventhal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jakeleventhal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jakeleventhal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jakeleventhal/subscriptions",
        "organizations_url": "https://api.github.com/users/jakeleventhal/orgs",
        "repos_url": "https://api.github.com/users/jakeleventhal/repos",
        "events_url": "https://api.github.com/users/jakeleventhal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jakeleventhal/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-07-31T17:05:44Z"
    },
    {
      "event": "subscribed",
      "id": 3609446979,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDM2MDk0NDY5Nzk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3609446979",
      "actor": {
        "login": "jakeleventhal",
        "id": 15133828,
        "node_id": "MDQ6VXNlcjE1MTMzODI4",
        "avatar_url": "https://avatars.githubusercontent.com/u/15133828?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jakeleventhal",
        "html_url": "https://github.com/jakeleventhal",
        "followers_url": "https://api.github.com/users/jakeleventhal/followers",
        "following_url": "https://api.github.com/users/jakeleventhal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jakeleventhal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jakeleventhal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jakeleventhal/subscriptions",
        "organizations_url": "https://api.github.com/users/jakeleventhal/orgs",
        "repos_url": "https://api.github.com/users/jakeleventhal/repos",
        "events_url": "https://api.github.com/users/jakeleventhal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jakeleventhal/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-07-31T17:05:44Z"
    },
    {
      "event": "locked",
      "id": 6074096857,
      "node_id": "LOE_lADOABII584Z025AzwAAAAFqC1zZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6074096857",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T11:16:34Z",
      "lock_reason": "resolved"
    }
  ]
}