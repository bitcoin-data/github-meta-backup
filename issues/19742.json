{
  "type": "issue",
  "issue": {
    "id": 679945708,
    "node_id": "MDU6SXNzdWU2Nzk5NDU3MDg=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/19742",
    "number": 19742,
    "state": "closed",
    "state_reason": "completed",
    "title": "In-memory UTXO cache is flushed too frequently when pruning",
    "body": "**Is your feature request related to a problem? Please describe.**\r\nI'm experimenting `assumevalid=0` (full validation) by running two bitcoin-qt on my laptop, one of which is `-connect`ing to `127.0.0.1`.\r\nIn hope that my hard drive would wear as little as possible (also to accelerate the syncing process as much as possible), I set `dbcache` to 10240 MiB, then pointed `blocksdir` to a ramdisk.\r\nThen I found Bitcoin Core didn't work as my expectation. The files under `chainstate` directory were still read/written frequently.\r\nI think these lines from debug.log should explain what was going on:\r\n```\r\n2020-08-16T17:29:01Z UpdateTip: new best=000000000000066cccef1be790592e559ec4f1cd18f8683554a6bcecb87f8f97 height=154467 version=0x00000001 log2_work=67.223948 tx=1904617 date='2011-11-23T09:49:28Z' progress=0.003424 cache=40.7MiB(276733txo)\r\n2020-08-16T17:29:01Z UpdateTip: new best=00000000000009879303cae0f79181c45eecf749eecd56976c369a546ba7d78e height=154468 version=0x00000001 log2_work=67.223991 tx=1904624 date='2011-11-23T09:49:41Z' progress=0.003424 cache=40.7MiB(276741txo)\r\n2020-08-16T17:29:01Z UpdateTip: new best=0000000000000aa936ad49eb0f7f3342fd8f193960c7fac1571b0625d5aed9de height=154469 version=0x00000001 log2_work=67.224033 tx=1904633 date='2011-11-23T09:55:22Z' progress=0.003424 cache=40.7MiB(276730txo)\r\n2020-08-16T17:29:01Z Pre-allocating up to position 0xd00000 in rev00005.dat\r\n2020-08-16T17:29:01Z Prune: UnlinkPrunedFiles deleted blk/rev (00002)\r\n2020-08-16T17:29:01Z FlushStateToDisk: write coins cache to disk (276837 coins, 42709kB) started\r\n2020-08-16T17:29:02Z FlushStateToDisk: write coins cache to disk (276837 coins, 42709kB) completed (0.59s)\r\n2020-08-16T17:29:02Z UpdateTip: new best=0000000000000bf0a84c8f47fa804644fab66081f4d1207009e09ffe8b1dd272 height=154470 version=0x00000001 log2_work=67.224076 tx=1904752 date='2011-11-23T10:08:52Z' progress=0.003424 cache=6.9MiB(0txo)\r\n2020-08-16T17:29:02Z UpdateTip: new best=0000000000000823d28d3053a071d12e57072b93733a2e57047dff4aac495a6e height=154471 version=0x00000001 log2_work=67.224119 tx=1904756 date='2011-11-23T10:10:42Z' progress=0.003424 cache=6.9MiB(15txo)\r\n2020-08-16T17:29:02Z UpdateTip: new best=0000000000000b8732b07e326bde0a79f91e4808a5683a77c0fc85728a4ca06b height=154472 version=0x00000001 log2_work=67.224162 tx=1904777 date='2011-11-23T10:16:37Z' progress=0.003424 cache=6.9MiB(154txo)\r\n```\r\n\r\n**The log shows that in-memory UTXO cache is flushed too frequently.**\r\n\r\nI then found nothing to control the cache flushing behavoir.\r\n\r\nPreviously I had once done a full sync with similar settings (except that pruning was not enabled, and the blockchain was downloaded from the P2P network, rather than localhost), if I recalled correctly, the cache didn't flush until I finally shut down the full node.\r\n\r\n**Describe the solution you'd like**\r\nProvide an option to control how often the UTXO cache should be flushed, so that the user can take his/her own responsibility for consequences (loss of syncing progress) of system crash/power loss etc.\r\n\r\nIt's also well known that consumer HDDs are flooded with sh*tty DM-SMR models. I think it's really worthwhile to trade such \"crash tolerance\" for performance improvement if there's plenty of RAM. \r\n\r\nThere's also a relatively high chance for a user to take out his/her old spare laptop to run the full node, so that even if more and more PCs come with SSD only in the future, it's still meaningful to take care of this issue.\r\n\r\n**Describe alternatives you've considered**\r\n\r\n**Additional context**",
    "user": {
      "login": "andronoob",
      "id": 4075106,
      "node_id": "MDQ6VXNlcjQwNzUxMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4075106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andronoob",
      "html_url": "https://github.com/andronoob",
      "followers_url": "https://api.github.com/users/andronoob/followers",
      "following_url": "https://api.github.com/users/andronoob/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/andronoob/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/andronoob/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/andronoob/subscriptions",
      "organizations_url": "https://api.github.com/users/andronoob/orgs",
      "repos_url": "https://api.github.com/users/andronoob/repos",
      "events_url": "https://api.github.com/users/andronoob/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/andronoob/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 2,
    "closed_at": "2020-08-17T07:16:30Z",
    "created_at": "2020-08-17T05:31:27Z",
    "updated_at": "2022-02-15T10:48:37Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 3660210986,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDM2NjAyMTA5ODY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3660210986",
      "actor": {
        "login": "andronoob",
        "id": 4075106,
        "node_id": "MDQ6VXNlcjQwNzUxMDY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4075106?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andronoob",
        "html_url": "https://github.com/andronoob",
        "followers_url": "https://api.github.com/users/andronoob/followers",
        "following_url": "https://api.github.com/users/andronoob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andronoob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andronoob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andronoob/subscriptions",
        "organizations_url": "https://api.github.com/users/andronoob/orgs",
        "repos_url": "https://api.github.com/users/andronoob/repos",
        "events_url": "https://api.github.com/users/andronoob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andronoob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-17T05:31:27Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 674672013,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY3NDY3MjAxMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674672013",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-17T05:53:40Z",
      "updated_at": "2020-08-17T05:53:40Z",
      "author_association": "MEMBER",
      "body": "This is a known issue with pruning. See #11315",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19742#issuecomment-674672013",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742"
    },
    {
      "event": "renamed",
      "id": 3660272697,
      "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50MzY2MDI3MjY5Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3660272697",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-17T05:56:59Z",
      "rename": {
        "from": "In-memory UTXO cache is flushed too frequently",
        "to": "In-memory UTXO cache is flushed too frequently when pruning"
      }
    },
    {
      "event": "commented",
      "id": 674707731,
      "node_id": "MDEyOklzc3VlQ29tbWVudDY3NDcwNzczMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674707731",
      "actor": {
        "login": "andronoob",
        "id": 4075106,
        "node_id": "MDQ6VXNlcjQwNzUxMDY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4075106?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andronoob",
        "html_url": "https://github.com/andronoob",
        "followers_url": "https://api.github.com/users/andronoob/followers",
        "following_url": "https://api.github.com/users/andronoob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andronoob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andronoob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andronoob/subscriptions",
        "organizations_url": "https://api.github.com/users/andronoob/orgs",
        "repos_url": "https://api.github.com/users/andronoob/repos",
        "events_url": "https://api.github.com/users/andronoob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andronoob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-17T07:16:30Z",
      "updated_at": "2020-08-17T07:16:30Z",
      "author_association": "NONE",
      "body": "I'm sorry. I'll close this since it's duplicate.",
      "user": {
        "login": "andronoob",
        "id": 4075106,
        "node_id": "MDQ6VXNlcjQwNzUxMDY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4075106?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andronoob",
        "html_url": "https://github.com/andronoob",
        "followers_url": "https://api.github.com/users/andronoob/followers",
        "following_url": "https://api.github.com/users/andronoob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andronoob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andronoob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andronoob/subscriptions",
        "organizations_url": "https://api.github.com/users/andronoob/orgs",
        "repos_url": "https://api.github.com/users/andronoob/repos",
        "events_url": "https://api.github.com/users/andronoob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andronoob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19742#issuecomment-674707731",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19742"
    },
    {
      "event": "closed",
      "id": 3660515606,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzY2MDUxNTYwNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3660515606",
      "actor": {
        "login": "andronoob",
        "id": 4075106,
        "node_id": "MDQ6VXNlcjQwNzUxMDY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4075106?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andronoob",
        "html_url": "https://github.com/andronoob",
        "followers_url": "https://api.github.com/users/andronoob/followers",
        "following_url": "https://api.github.com/users/andronoob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andronoob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andronoob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andronoob/subscriptions",
        "organizations_url": "https://api.github.com/users/andronoob/orgs",
        "repos_url": "https://api.github.com/users/andronoob/repos",
        "events_url": "https://api.github.com/users/andronoob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andronoob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-08-17T07:16:30Z"
    },
    {
      "event": "locked",
      "id": 6073909238,
      "node_id": "LOE_lADOABII584ohyXszwAAAAFqCH_2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6073909238",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T10:48:37Z",
      "lock_reason": "resolved"
    }
  ]
}